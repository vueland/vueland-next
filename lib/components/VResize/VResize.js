import { h, ref, computed, reactive, defineComponent, onMounted, onBeforeUnmount, } from 'vue';
import { positionProps } from '../../composables/use-position';
import { useColors } from '../../composables/use-colors';
export default defineComponent({
    name: 'v-resize',
    props: {
        emit: {
            type: Boolean,
            default: false,
        },
        customClass: {
            type: String,
        },
        minSize: {
            type: [String, Number],
            default: 50,
        },
        color: {
            type: String,
            default: 'primary',
        },
        ...positionProps(),
    },
    emits: ['resize'],
    setup(props, { emit }) {
        const data = reactive({
            parentNode: null,
            startOffset: null,
            offsetTop: 0,
            offsetLeft: 0,
            parentHeight: 0,
            parentWidth: 0,
            marginLeft: 0,
            marginTop: 0,
            left: 0,
            top: 0,
            isActive: false,
        });
        const resizeRef = ref(null);
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const classes = computed(() => {
            return {
                'v-resize': true,
                'v-resize--active': data.isActive,
                'v-resize--top': props.top,
                'v-resize--bottom': props.bottom,
                'v-resize--right': props.right,
                'v-resize--left': props.left,
                [props.customClass]: !!props.customClass,
                ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
            };
        });
        const styles = computed(() => ({
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        const isDirectY = computed(() => {
            return props.top || props.bottom;
        });
        const isNeedReverse = computed(() => {
            return props.top || props.left;
        });
        const currentSize = computed(() => {
            return isDirectY.value ? data.parentHeight : data.parentWidth;
        });
        const sizeProp = computed(() => {
            return isDirectY.value ? 'height' : 'width';
        });
        const reverseDirection = computed(() => {
            return props.top ? 'top' : 'left';
        });
        const reverseOffsetKey = computed(() => {
            const side = reverseDirection.value;
            return 'offset' + side[0].toUpperCase() + side.slice(1);
        });
        const offset = computed(() => {
            return isDirectY.value ? data.offsetTop : data.offsetLeft;
        });
        const direction = computed(() => {
            return isDirectY.value ? 'clientY' : 'clientX';
        });
        function moveReverse(size) {
            const { parentNode, left, top } = data;
            const reverseTo = reverseDirection.value;
            const value = !isDirectY.value
                ? currentSize.value - size + left
                : currentSize.value - size + top;
            parentNode.style[reverseTo] = `${value}px`;
        }
        function setOrEmitSize(size) {
            if (props.emit)
                return emit('resize', size);
            data.parentNode.style[sizeProp.value] = `${size}px`;
            isNeedReverse.value && moveReverse(size);
        }
        function resize(e) {
            let size;
            if (isNeedReverse.value) {
                size =
                    currentSize.value -
                        (e[direction.value] - offset.value) +
                        data.startOffset;
            }
            else {
                size =
                    currentSize.value +
                        (e[direction.value] -
                            currentSize.value -
                            offset.value -
                            data.startOffset);
            }
            size > props.minSize && setOrEmitSize(size);
        }
        function resetMinMaxStyles() {
            if (isDirectY.value) {
                data.parentNode.style.maxHeight = '';
                data.parentNode.style.minHeight = '';
            }
            else {
                data.parentNode.style.maxWidth = '';
                data.parentNode.style.minWidth = '';
            }
        }
        function setParent() {
            const parent = resizeRef.value.parentNode;
            data.parentNode = parent;
        }
        function computeSizes() {
            const { top, left, height, width, marginLeft, marginTop } = getComputedStyle(data.parentNode);
            data.offsetTop = data.parentNode.offsetTop;
            data.offsetLeft = data.parentNode.offsetLeft;
            data.marginLeft = parseFloat(marginLeft);
            data.marginTop = parseFloat(marginTop);
            data.parentHeight = parseFloat(height);
            data.parentWidth = parseFloat(width);
            data.top = parseFloat(top);
            data.left = parseFloat(left);
        }
        function setStartPositions() {
            const side = reverseDirection.value;
            const offset = reverseOffsetKey.value;
            if (data[side] === data[offset]) {
                data.parentNode.style[side] = `${data[offset]}px`;
            }
        }
        function disableSelection(e) {
            e.preventDefault();
        }
        function initResize(e) {
            if (!data.isActive) {
                data.isActive = true;
                computeSizes();
                resetMinMaxStyles();
                setStartPositions();
                setStartOffset(e);
            }
            requestAnimationFrame(() => resize(e));
        }
        function setStartOffset(e) {
            if (isNeedReverse.value)
                data.startOffset = e[direction.value];
            else
                data.startOffset = e[direction.value] - currentSize.value;
            data.startOffset -= offset.value;
        }
        function reset() {
            data.isActive = false;
            resetMinMaxStyles();
        }
        function onMouseup() {
            reset();
            removeHandlers();
        }
        function onMousedown() {
            document.addEventListener('mousemove', initResize);
            document.addEventListener('mouseup', onMouseup);
            document.addEventListener('selectstart', disableSelection);
        }
        function removeHandlers() {
            document.removeEventListener('mousemove', initResize);
            document.removeEventListener('mouseup', onMouseup);
            document.removeEventListener('selectstart', disableSelection);
        }
        onMounted(() => {
            setParent();
        });
        onBeforeUnmount(() => {
            document.removeEventListener('mousedown', onMousedown);
        });
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
                key: 'resize',
                ref: resizeRef,
                onMousedown,
            };
            return h('div', propsData);
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJlc2l6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZSZXNpemUvVlJlc2l6ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsQ0FBQyxFQUNELEdBQUcsRUFDSCxRQUFRLEVBQ1IsUUFBUSxFQUNSLGVBQWUsRUFDZixTQUFTLEVBQ1QsZUFBZSxHQUNoQixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFtQnhELGVBQWUsZUFBZSxDQUFDO0lBQzdCLElBQUksRUFBRSxVQUFVO0lBRWhCLEtBQUssRUFBRTtRQUNMLElBQUksRUFBRTtZQUNKLElBQUksRUFBRSxPQUFPO1lBQ2IsT0FBTyxFQUFFLEtBQUs7U0FDZjtRQUVELFdBQVcsRUFBRTtZQUNYLElBQUksRUFBRSxNQUFNO1NBQ2I7UUFFRCxPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxTQUFTO1NBQ25CO1FBQ0QsR0FBRyxhQUFhLEVBQUU7S0FDWjtJQUVSLEtBQUssRUFBRSxDQUFDLFFBQVEsQ0FBQztJQUVqQixLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFO1FBQ25CLE1BQU0sSUFBSSxHQUFlLFFBQVEsQ0FBQztZQUNoQyxVQUFVLEVBQUUsSUFBSTtZQUNoQixXQUFXLEVBQUUsSUFBSTtZQUNqQixTQUFTLEVBQUUsQ0FBQztZQUNaLFVBQVUsRUFBRSxDQUFDO1lBQ2IsWUFBWSxFQUFFLENBQUM7WUFDZixXQUFXLEVBQUUsQ0FBQztZQUNkLFVBQVUsRUFBRSxDQUFDO1lBQ2IsU0FBUyxF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QUVGLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQTtRQUN4RCxDQUFDLENBQUMsQ0FBQTtRQUVGLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztnQkFDcEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO2dCQUNuQixHQUFHLEVBQUUsUUFBUTtnQkFDYixHQUFHLEVBQUUsU0FBUztnQkFDZCxXQUFXO2FBQ1osQ0FBQTtZQUNELE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQTtRQUM1QixDQUFDLENBQUE7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVnVlIEFQSVxuaW1wb3J0IHtcbiAgaCxcbiAgcmVmLFxuICBjb21wdXRlZCxcbiAgcmVhY3RpdmUsXG4gIGRlZmluZUNvbXBvbmVudCxcbiAgb25Nb3VudGVkLFxuICBvbkJlZm9yZVVubW91bnQsXG59IGZyb20gJ3Z1ZSdcblxuLy8gRWZmZWN0c1xuaW1wb3J0IHsgcG9zaXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1wb3NpdGlvbidcbmltcG9ydCB7IHVzZUNvbG9ycyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1jb2xvcnMnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSB9IGZyb20gJ3Z1ZSdcblxudHlwZSBSZXNpemVEYXRhID0ge1xuICBwYXJlbnROb2RlOiBIVE1MRWxlbWVudCB8IG51bGxcbiAgc3RhcnRPZmZzZXQ6IG51bWJlciB8IG51bGxcbiAgb2Zmc2V0VG9wOiBudW1iZXJcbiAgb2Zmc2V0TGVmdDogbnVtYmVyXG4gIHBhcmVudEhlaWdodDogbnVtYmVyXG4gIHBhcmVudFdpZHRoOiBudW1iZXJcbiAgbWFyZ2luTGVmdDogbnVtYmVyXG4gIG1hcmdpblRvcDogbnVtYmVyXG4gIGxlZnQ6IG51bWJlclxuICB0b3A6IG51bWJlclxuICBpc0FjdGl2ZTogYm9vbGVhblxufVxuXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1yZXNpemUnLFxuXG4gIHByb3BzOiB7XG4gICAgZW1pdDoge1xuICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIH0sXG5cbiAgICBjdXN0b21DbGFzczoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgIH0sXG5cbiAgICBtaW5TaXplOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogNTAsXG4gICAgfSxcbiAgICBjb2xvcjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJ3ByaW1hcnknLFxuICAgIH0sXG4gICAgLi4ucG9zaXRpb25Qcm9wcygpLFxuICB9IGFzIGFueSxcblxuICBlbWl0czogWydyZXNpemUnXSxcblxuICBzZXR1cChwcm9wcywgeyBlbWl0IH0pOiAoKSA9PiBWTm9kZSB7XG4gICAgY29uc3QgZGF0YTogUmVzaXplRGF0YSA9IHJlYWN0aXZlKHtcbiAgICAgIHBhcmVudE5vZGU6IG51bGwsXG4gICAgICBzdGFydE9mZnNldDogbnVsbCxcbiAgICAgIG9mZnNldFRvcDogMCxcbiAgICAgIG9mZnNldExlZnQ6IDAsXG4gICAgICBwYXJlbnRIZWlnaHQ6IDAsXG4gICAgICBwYXJlbnRXaWR0aDogMCxcbiAgICAgIG1hcmdpbkxlZnQ6IDAsXG4gICAgICBtYXJnaW5Ub3A6IDAsXG4gICAgICBsZWZ0OiAwLFxuICAgICAgdG9wOiAwLFxuICAgICAgaXNBY3RpdmU6IGZhbHNlLFxuICAgIH0pXG5cbiAgICBjb25zdCByZXNpemVSZWYgPSByZWY8SFRNTEVsZW1lbnQgfCBudWxsPihudWxsKVxuXG4gICAgY29uc3QgeyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IsIHNldEJhY2tncm91bmRDc3NDb2xvciB9ID0gdXNlQ29sb3JzKClcblxuICAgIGNvbnN0IGNsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgJ3YtcmVzaXplJzogdHJ1ZSxcbiAgICAgICAgJ3YtcmVzaXplLS1hY3RpdmUnOiBkYXRhLmlzQWN0aXZlLFxuICAgICAgICAndi1yZXNpemUtLXRvcCc6IHByb3BzLnRvcCxcbiAgICAgICAgJ3YtcmVzaXplLS1ib3R0b20nOiBwcm9wcy5ib3R0b20sXG4gICAgICAgICd2LXJlc2l6ZS0tcmlnaHQnOiBwcm9wcy5yaWdodCxcbiAgICAgICAgJ3YtcmVzaXplLS1sZWZ0JzogcHJvcHMubGVmdCxcbiAgICAgICAgW3Byb3BzLmN1c3RvbUNsYXNzXTogISFwcm9wcy5jdXN0b21DbGFzcyxcbiAgICAgICAgLi4uKHByb3BzLmNvbG9yID8gc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yKHByb3BzLmNvbG9yKSA6IHt9KSxcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQoKCkgPT4gKHtcbiAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldEJhY2tncm91bmRDc3NDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBpc0RpcmVjdFkgPSBjb21wdXRlZDxib29sZWFuPigoKSA9PiB7XG4gICAgICByZXR1cm4gcHJvcHMudG9wIHx8IHByb3BzLmJvdHRvbVxuICAgIH0pXG5cbiAgICBjb25zdCBpc05lZWRSZXZlcnNlID0gY29tcHV0ZWQ8Ym9vbGVhbj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHByb3BzLnRvcCB8fCBwcm9wcy5sZWZ0XG4gICAgfSlcblxuICAgIGNvbnN0IGN1cnJlbnRTaXplID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gaXNEaXJlY3RZLnZhbHVlID8gZGF0YS5wYXJlbnRIZWlnaHQhIDogZGF0YS5wYXJlbnRXaWR0aCFcbiAgICB9KVxuXG4gICAgY29uc3Qgc2l6ZVByb3AgPSBjb21wdXRlZDxzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBpc0RpcmVjdFkudmFsdWUgPyAnaGVpZ2h0JyA6ICd3aWR0aCdcbiAgICB9KVxuXG4gICAgY29uc3QgcmV2ZXJzZURpcmVjdGlvbiA9IGNvbXB1dGVkPHN0cmluZz4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHByb3BzLnRvcCA/ICd0b3AnIDogJ2xlZnQnXG4gICAgfSlcblxuICAgIGNvbnN0IHJldmVyc2VPZmZzZXRLZXkgPSBjb21wdXRlZDxzdHJpbmc+KCgpID0+IHtcbiAgICAgIGNvbnN0IHNpZGUgPSByZXZlcnNlRGlyZWN0aW9uLnZhbHVlXG4gICAgICByZXR1cm4gJ29mZnNldCcgKyBzaWRlWzBdLnRvVXBwZXJDYXNlKCkgKyBzaWRlLnNsaWNlKDEpXG4gICAgfSlcblxuICAgIGNvbnN0IG9mZnNldCA9IGNvbXB1dGVkPG51bWJlcj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGlzRGlyZWN0WS52YWx1ZSA/IGRhdGEub2Zmc2V0VG9wISA6IGRhdGEub2Zmc2V0TGVmdCFcbiAgICB9KVxuXG4gICAgY29uc3QgZGlyZWN0aW9uID0gY29tcHV0ZWQ8c3RyaW5nPigoKSA9PiB7XG4gICAgICByZXR1cm4gaXNEaXJlY3RZLnZhbHVlID8gJ2NsaWVudFknIDogJ2NsaWVudFgnXG4gICAgfSlcblxuICAgIGZ1bmN0aW9uIG1vdmVSZXZlcnNlKHNpemUpIHtcbiAgICAgIGNvbnN0IHsgcGFyZW50Tm9kZSwgbGVmdCwgdG9wIH0gPSBkYXRhXG4gICAgICBjb25zdCByZXZlcnNlVG8gPSByZXZlcnNlRGlyZWN0aW9uLnZhbHVlXG5cbiAgICAgIGNvbnN0IHZhbHVlID0gIWlzRGlyZWN0WS52YWx1ZVxuICAgICAgICA/IGN1cnJlbnRTaXplLnZhbHVlIC0gc2l6ZSArIGxlZnRcbiAgICAgICAgOiBjdXJyZW50U2l6ZS52YWx1ZSAtIHNpemUgKyB0b3BcblxuICAgICAgcGFyZW50Tm9kZSEuc3R5bGVbcmV2ZXJzZVRvXSA9IGAke3ZhbHVlfXB4YFxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNldE9yRW1pdFNpemUoc2l6ZSkge1xuICAgICAgaWYgKHByb3BzLmVtaXQpIHJldHVybiBlbWl0KCdyZXNpemUnLCBzaXplKVxuXG4gICAgICBkYXRhLnBhcmVudE5vZGUhLnN0eWxlW3NpemVQcm9wLnZhbHVlXSA9IGAke3NpemV9cHhgXG5cbiAgICAgIGlzTmVlZFJldmVyc2UudmFsdWUgJiYgbW92ZVJldmVyc2Uoc2l6ZSlcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZXNpemUoZSkge1xuICAgICAgbGV0IHNpemVcblxuICAgICAgaWYgKGlzTmVlZFJldmVyc2UudmFsdWUpIHtcbiAgICAgICAgc2l6ZSA9XG4gICAgICAgICAgY3VycmVudFNpemUudmFsdWUgLVxuICAgICAgICAgIChlW2RpcmVjdGlvbi52YWx1ZV0gLSBvZmZzZXQudmFsdWUpICtcbiAgICAgICAgICBkYXRhLnN0YXJ0T2Zmc2V0IVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc2l6ZSA9XG4gICAgICAgICAgY3VycmVudFNpemUudmFsdWUgK1xuICAgICAgICAgIChlW2RpcmVjdGlvbi52YWx1ZV0gLVxuICAgICAgICAgICAgY3VycmVudFNpemUudmFsdWUgLVxuICAgICAgICAgICAgb2Zmc2V0LnZhbHVlIC1cbiAgICAgICAgICAgIGRhdGEuc3RhcnRPZmZzZXQhKVxuICAgICAgfVxuXG4gICAgICBzaXplID4gcHJvcHMubWluU2l6ZSAmJiBzZXRPckVtaXRTaXplKHNpemUpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcmVzZXRNaW5NYXhTdHlsZXMoKSB7XG4gICAgICBpZiAoaXNEaXJlY3RZLnZhbHVlKSB7XG4gICAgICAgIGRhdGEucGFyZW50Tm9kZSEuc3R5bGUubWF4SGVpZ2h0ID0gJydcbiAgICAgICAgZGF0YS5wYXJlbnROb2RlIS5zdHlsZS5taW5IZWlnaHQgPSAnJ1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZGF0YS5wYXJlbnROb2RlIS5zdHlsZS5tYXhXaWR0aCA9ICcnXG4gICAgICAgIGRhdGEucGFyZW50Tm9kZSEuc3R5bGUubWluV2lkdGggPSAnJ1xuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNldFBhcmVudCgpIHtcbiAgICAgIGNvbnN0IHBhcmVudCA9IHJlc2l6ZVJlZi52YWx1ZSEucGFyZW50Tm9kZVxuICAgICAgZGF0YS5wYXJlbnROb2RlID0gcGFyZW50IGFzIEhUTUxFbGVtZW50XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gY29tcHV0ZVNpemVzKCkge1xuICAgICAgY29uc3QgeyB0b3AsIGxlZnQsIGhlaWdodCwgd2lkdGgsIG1hcmdpbkxlZnQsIG1hcmdpblRvcCB9ID1cbiAgICAgICAgZ2V0Q29tcHV0ZWRTdHlsZShkYXRhLnBhcmVudE5vZGUhKVxuXG4gICAgICBkYXRhLm9mZnNldFRvcCA9IGRhdGEucGFyZW50Tm9kZSEub2Zmc2V0VG9wXG4gICAgICBkYXRhLm9mZnNldExlZnQgPSBkYXRhLnBhcmVudE5vZGUhLm9mZnNldExlZnRcbiAgICAgIGRhdGEubWFyZ2luTGVmdCA9IHBhcnNlRmxvYXQobWFyZ2luTGVmdClcbiAgICAgIGRhdGEubWFyZ2luVG9wID0gcGFyc2VGbG9hdChtYXJnaW5Ub3ApXG4gICAgICBkYXRhLnBhcmVudEhlaWdodCA9IHBhcnNlRmxvYXQoaGVpZ2h0KVxuICAgICAgZGF0YS5wYXJlbnRXaWR0aCA9IHBhcnNlRmxvYXQod2lkdGgpXG4gICAgICBkYXRhLnRvcCA9IHBhcnNlRmxvYXQodG9wKVxuICAgICAgZGF0YS5sZWZ0ID0gcGFyc2VGbG9hdChsZWZ0KVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNldFN0YXJ0UG9zaXRpb25zKCkge1xuICAgICAgY29uc3Qgc2lkZSA9IHJldmVyc2VEaXJlY3Rpb24udmFsdWVcbiAgICAgIGNvbnN0IG9mZnNldCA9IHJldmVyc2VPZmZzZXRLZXkudmFsdWVcblxuICAgICAgaWYgKGRhdGFbc2lkZV0gPT09IGRhdGFbb2Zmc2V0XSkge1xuICAgICAgICBkYXRhLnBhcmVudE5vZGUhLnN0eWxlW3NpZGVdID0gYCR7ZGF0YVtvZmZzZXRdfXB4YFxuICAgICAgfVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGRpc2FibGVTZWxlY3Rpb24oZSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaW5pdFJlc2l6ZShlKSB7XG4gICAgICBpZiAoIWRhdGEuaXNBY3RpdmUpIHtcbiAgICAgICAgZGF0YS5pc0FjdGl2ZSA9IHRydWVcbiAgICAgICAgY29tcHV0ZVNpemVzKClcbiAgICAgICAgcmVzZXRNaW5NYXhTdHlsZXMoKVxuICAgICAgICBzZXRTdGFydFBvc2l0aW9ucygpXG4gICAgICAgIHNldFN0YXJ0T2Zmc2V0KGUpXG4gICAgICB9XG5cbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiByZXNpemUoZSkpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2V0U3RhcnRPZmZzZXQoZSkge1xuICAgICAgaWYgKGlzTmVlZFJldmVyc2UudmFsdWUpIGRhdGEuc3RhcnRPZmZzZXQgPSBlW2RpcmVjdGlvbi52YWx1ZV1cbiAgICAgIGVsc2UgZGF0YS5zdGFydE9mZnNldCA9IGVbZGlyZWN0aW9uLnZhbHVlXSAtIGN1cnJlbnRTaXplLnZhbHVlXG5cbiAgICAgIGRhdGEuc3RhcnRPZmZzZXQhIC09IG9mZnNldC52YWx1ZVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHJlc2V0KCkge1xuICAgICAgZGF0YS5pc0FjdGl2ZSA9IGZhbHNlXG4gICAgICByZXNldE1pbk1heFN0eWxlcygpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gb25Nb3VzZXVwKCkge1xuICAgICAgcmVzZXQoKVxuICAgICAgcmVtb3ZlSGFuZGxlcnMoKVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIG9uTW91c2Vkb3duKCkge1xuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaW5pdFJlc2l6ZSlcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBvbk1vdXNldXApXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3RzdGFydCcsIGRpc2FibGVTZWxlY3Rpb24pXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcmVtb3ZlSGFuZGxlcnMoKSB7XG4gICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCBpbml0UmVzaXplKVxuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIG9uTW91c2V1cClcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3NlbGVjdHN0YXJ0JywgZGlzYWJsZVNlbGVjdGlvbilcbiAgICB9XG5cbiAgICBvbk1vdW50ZWQoKCkgPT4ge1xuICAgICAgc2V0UGFyZW50KClcbiAgICB9KVxuXG4gICAgb25CZWZvcmVVbm1vdW50KCgpID0+IHtcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIG9uTW91c2Vkb3duKVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjbGFzczogY2xhc3Nlcy52YWx1ZSxcbiAgICAgICAgc3R5bGU6IHN0eWxlcy52YWx1ZSxcbiAgICAgICAga2V5OiAncmVzaXplJyxcbiAgICAgICAgcmVmOiByZXNpemVSZWYsXG4gICAgICAgIG9uTW91c2Vkb3duLFxuICAgICAgfVxuICAgICAgcmV0dXJuIGgoJ2RpdicsIHByb3BzRGF0YSlcbiAgICB9XG4gIH0sXG59KVxuIl19