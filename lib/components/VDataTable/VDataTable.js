import { h, watch, computed, defineComponent, reactive } from 'vue';
import { useColors } from '../../composables/use-colors';
import { VDataTableHeader } from './VDataTableHeader';
import { VDataTableBody } from './VDataTableBody';
import { VDataTableFooter } from './VDataTableFooter';
import { addScopedSlot } from '../../helpers';
export default defineComponent({
    name: 'v-data-table',
    props: {
        cols: {
            type: Array,
            default: () => [],
        },
        rows: {
            type: Array,
            default: () => [],
        },
        showSequence: Boolean,
        showCheckbox: Boolean,
        align: {
            type: String,
            validator: (val) => ['left', 'center', 'right'].includes(val),
        },
        color: {
            type: String,
            default: '',
        },
        headerOptions: {
            type: Object,
            default: () => ({}),
        },
        footerOptions: {
            type: Object,
            default: () => ({}),
        },
        customFilter: Function,
    },
    emits: [
        'last-page',
        'select:row',
        'click:row',
        'dblclick:row',
        'contextmenu:row',
    ],
    setup(props, { slots, emit }) {
        const data = reactive({
            cols: [],
            rows: [],
            checkedRows: [],
            rowsOnPage: 20,
            page: 1,
            isAllRowsChecked: false,
        });
        const { setBackgroundCssColor, setBackgroundClassNameColor } = useColors();
        const filters = {};
        const classes = computed(() => ({
            'v-data-table': true,
            ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
        }));
        const styles = computed(() => ({
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        const headerOptions = computed(() => ({
            color: props.color,
            dark: props.dark,
            ...props.headerOptions,
        }));
        const footerOptions = computed(() => ({
            color: props.color,
            dark: props.dark,
            ...props.footerOptions,
        }));
        const pages = computed(() => {
            return Math.ceil(data.rows?.length / data.rowsOnPage);
        });
        const firstOnPage = computed(() => {
            return data.page === 1 ? 1 : (data.page - 1) * data.rowsOnPage + 1;
        });
        const lastOnPage = computed(() => {
            return data.page * data.rowsOnPage > data.rows?.length
                ? data.rows?.length
                : data.page * data.rowsOnPage;
        });
        const pageCorrection = computed(() => {
            if ((data.page - 1) * data.rowsOnPage > data.rows?.length) {
                return Math.ceil((data.page * data.rowsOnPage - data.rows?.length) / data.rowsOnPage);
            }
            return null;
        });
        watch(() => props.cols, (to) => (data.cols = to), { immediate: true });
        watch(() => props.rows, (to) => (data.rows = to), { immediate: true });
        const onSelectAll = (value) => {
            data.isAllRowsChecked = value;
            data.rows.forEach((row) => (row.checked = value));
        };
        const onSelect = (rows) => {
            data.checkedRows = rows;
            emit('select:row', data.checkedRows);
        };
        const onPrevPage = (num) => {
            data.page = data.page > 1 ? data.page + num : data.page;
        };
        const onNextPage = (num) => {
            if (data.rows.length - data.page * data.rowsOnPage > 0) {
                data.page += num;
            }
        };
        const onSort = (col) => {
            if (col.sorted) {
                col.sorted = !col.sorted;
                return sortColumn(col);
            }
            data.cols.forEach((c) => (c.sorted = col.key === c.key));
            sortColumn(col);
        };
        const sortColumn = (col) => {
            if (!col.sorted) {
                return data.rows?.reverse();
            }
            const executor = col.sort ||
                ((a, b) => {
                    if (col.format)
                        return col.format(a) > col.format(b) ? 1 : -1;
                    if (col.sorted)
                        return a[col.key] > b[col.key] ? 1 : -1;
                });
            data.rows?.sort(executor);
        };
        const onFilter = ({ value, col }) => {
            if (!value && filters[col.key])
                delete filters[col.key];
            if (value)
                filters[col.key] = value;
            if (col.filter) {
                return (data.rows = col.filter({ value, col }));
            }
            if (props.customFilter) {
                return props.customFilter(filters);
            }
            if (!Object.keys(filters).length) {
                return (data.rows = props.rows);
            }
            data.rows = filterRows(props.rows, props.cols);
            data.page = 1;
        };
        const onSelectRowsCount = (count) => {
            data.rowsOnPage = count;
        };
        const filterRows = (rows, cols) => {
            const filterKeys = Object.keys(filters);
            return rows.reduce((acc, row) => {
                const rowResults = [];
                filterKeys.forEach((key) => {
                    const { format } = cols.find((col) => col.key === key);
                    const value = format ? format(row) : row[key];
                    const rowKeyValue = `${value}`.toLowerCase();
                    const filterValue = `${filters[key]}`.toLowerCase();
                    if (rowKeyValue.includes(filterValue)) {
                        rowResults.push(row[key]);
                    }
                });
                if (rowResults.length === filterKeys.length &&
                    rowResults.every((value) => !!value)) {
                    acc.push(row);
                }
                return acc;
            }, []);
        };
        const genTableTools = () => {
            const propsData = { class: 'v-data-table__toolbar' };
            return h('div', propsData, {
                default: () => slots.toolbar && slots.toolbar(),
            });
        };
        const genTableHeader = () => {
            const propsData = {
                cols: data.cols,
                color: props.color,
                showCheckbox: props.showCheckbox,
                dark: props.dark,
                align: props.align,
                showSequence: props.showSequence,
                options: headerOptions.value,
                onFilter,
                onSort,
                onSelectAll,
            };
            const content = data.cols.reduce((acc, col) => {
                const slotName = `${col.key}-filter`;
                if (col && slots[slotName]) {
                    acc[slotName] = addScopedSlot(slotName, slots);
                }
                return acc;
            }, {});
            content.header = addScopedSlot('header', slots);
            return h(VDataTableHeader, propsData, content);
        };
        const genTableBody = () => {
            const propsData = {
                cols: data.cols,
                rows: data.rows,
                page: data.page,
                rowsOnPage: data.rowsOnPage,
                showCheckbox: props.showCheckbox,
                checkAllRows: data.isAllRowsChecked,
                align: props.align,
                dark: props.dark,
                showSequence: props.showSequence,
                color: props.color,
                onSelect,
                ['onClick:row']: (e) => emit('click:row', e),
                ['onDblclick:row']: (e) => emit('dblclick:row', e),
                ['onContextmenu:row']: (e) => emit('contextmenu:row', e),
            };
            const content = props.cols.reduce((acc, col) => {
                if (col && slots[col.key]) {
                    acc[col.key] = addScopedSlot(col.key, slots);
                }
                return acc;
            }, {});
            return h(VDataTableBody, propsData, content);
        };
        const genTableFooter = () => {
            const propsData = {
                pages: pages.value,
                page: data.page,
                firstOnPage: firstOnPage.value,
                lastOnPage: lastOnPage.value,
                pageCorrection: pageCorrection.value,
                rowsOnPage: data.rowsOnPage,
                rowsLength: data.rows?.length,
                options: footerOptions.value,
                onPrevPage,
                onNextPage,
                onSelectRowsCount,
                onLastPage: () => emit('last-page', props.rows.length),
                onCorrectPage: (val) => (data.page += val),
            };
            const content = slots['pagination-text']
                ? {
                    ['pagination-text']: () => slots['pagination-text'] &&
                        slots['pagination-text']({
                            start: firstOnPage.value,
                            last: lastOnPage.value,
                            length: data.rows?.length,
                        }),
                }
                : '';
            return h(VDataTableFooter, propsData, content);
        };
        const genTableInner = () => {
            const propsData = {
                class: 'v-data-table__inner',
            };
            return h('div', propsData, [genTableHeader(), genTableBody()]);
        };
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
            };
            return h('div', propsData, [
                slots.toolbar && genTableTools(),
                genTableInner(),
                genTableFooter(),
            ]);
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZEYXRhVGFibGUvVkRhdGFUYWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxNQUFNLEtBQUssQ0FBQTtBQUduRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFJeEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFDckQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pELE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFBO0FBR3JELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFxQjdDLGVBQWUsZUFBZSxDQUFDO0lBQzdCLElBQUksRUFBRSxjQUFjO0lBQ3BCLEtBQUssRUFBRTtRQUNMLElBQUksRUFBRTtZQUNKLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7U0FDbEI7UUFDRCxJQUFJLEVBQUU7WUFDSixJQUFJLEVBQUUsS0FBSztZQUNYLE9BQU8sRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFO1NBQ2xCO1FBQ0QsWUFBWSxFQUFFLE9BQU87UUFDckIsWUFBWSxFQUFFLE9BQU87UUFDckIsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLE1BQU07WUFDWixTQUFTLEVBQUUsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO1NBQzlEO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsRUFBRTtTQUNaO1FBQ0QsYUFB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U0FBUyxHQUFHO2dCQUNoQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7Z0JBQ3BCLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSzthQUNwQixDQUFBO1lBRUQsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRTtnQkFDekIsS0FBSyxDQUFDLE9BQU8sSUFBSSxhQUFhLEVBQUU7Z0JBQ2hDLGFBQWEsRUFBRTtnQkFDZixjQUFjLEVBQUU7YUFDakIsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFBO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7IGgsIHdhdGNoLCBjb21wdXRlZCwgZGVmaW5lQ29tcG9uZW50LCByZWFjdGl2ZSB9IGZyb20gJ3Z1ZSdcblxuLy8gRWZmZWN0c1xuaW1wb3J0IHsgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWNvbG9ycydcbi8vIGltcG9ydCB7IHVzZVRoZW1lIH0gZnJvbSAnLi4vLi4vZWZmZWN0cy91c2UtdGhlbWUnXG5cbi8vIENvbXBvbmVudHNcbmltcG9ydCB7IFZEYXRhVGFibGVIZWFkZXIgfSBmcm9tICcuL1ZEYXRhVGFibGVIZWFkZXInXG5pbXBvcnQgeyBWRGF0YVRhYmxlQm9keSB9IGZyb20gJy4vVkRhdGFUYWJsZUJvZHknXG5pbXBvcnQgeyBWRGF0YVRhYmxlRm9vdGVyIH0gZnJvbSAnLi9WRGF0YVRhYmxlRm9vdGVyJ1xuXG4vLyBIZWxwZXJzXG5pbXBvcnQgeyBhZGRTY29wZWRTbG90IH0gZnJvbSAnLi4vLi4vaGVscGVycydcblxuLy8gVHlwZXNcbmltcG9ydCB7IFZOb2RlLCBQcm9wVHlwZSB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7XG4gIERhdGFDb2x1bW4sXG4gIERhdGFDb2x1bW5Qcm9wcyxcbiAgRm9vdGVyT3B0aW9ucyxcbiAgSGVhZGVyT3B0aW9ucyxcbiAgVGFibGVGaWx0ZXIsXG59IGZyb20gJy4uLy4uLy4uL3R5cGVzJ1xuXG50eXBlIFRhYmxlU3RhdGUgPSB7XG4gIGNvbHM6IERhdGFDb2x1bW5bXVxuICByb3dzOiB7IFtrZXk6IHN0cmluZ106IGFueSB9W11cbiAgY2hlY2tlZFJvd3M6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXVxuICByb3dzT25QYWdlOiBudW1iZXJcbiAgcGFnZTogbnVtYmVyXG4gIGlzQWxsUm93c0NoZWNrZWQ6IGJvb2xlYW5cbn1cblxuZXhwb3J0IGRlZmF1bHQgZGVmaW5lQ29tcG9uZW50KHtcbiAgbmFtZTogJ3YtZGF0YS10YWJsZScsXG4gIHByb3BzOiB7XG4gICAgY29sczoge1xuICAgICAgdHlwZTogQXJyYXksXG4gICAgICBkZWZhdWx0OiAoKSA9PiBbXSxcbiAgICB9LFxuICAgIHJvd3M6IHtcbiAgICAgIHR5cGU6IEFycmF5LFxuICAgICAgZGVmYXVsdDogKCkgPT4gW10sXG4gICAgfSxcbiAgICBzaG93U2VxdWVuY2U6IEJvb2xlYW4sXG4gICAgc2hvd0NoZWNrYm94OiBCb29sZWFuLFxuICAgIGFsaWduOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICB2YWxpZGF0b3I6ICh2YWwpID0+IFsnbGVmdCcsICdjZW50ZXInLCAncmlnaHQnXS5pbmNsdWRlcyh2YWwpLFxuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICcnLFxuICAgIH0sXG4gICAgaGVhZGVyT3B0aW9uczoge1xuICAgICAgdHlwZTogT2JqZWN0IGFzIFByb3BUeXBlPEhlYWRlck9wdGlvbnM+LFxuICAgICAgZGVmYXVsdDogKCkgPT4gKHt9KSxcbiAgICB9LFxuICAgIGZvb3Rlck9wdGlvbnM6IHtcbiAgICAgIHR5cGU6IE9iamVjdCBhcyBQcm9wVHlwZTxGb290ZXJPcHRpb25zPixcbiAgICAgIGRlZmF1bHQ6ICgpID0+ICh7fSksXG4gICAgfSxcbiAgICBjdXN0b21GaWx0ZXI6IEZ1bmN0aW9uLFxuICB9IGFzIGFueSxcblxuICBlbWl0czogW1xuICAgICdsYXN0LXBhZ2UnLFxuICAgICdzZWxlY3Q6cm93JyxcbiAgICAnY2xpY2s6cm93JyxcbiAgICAnZGJsY2xpY2s6cm93JyxcbiAgICAnY29udGV4dG1lbnU6cm93JyxcbiAgXSxcblxuICBzZXR1cChwcm9wcywgeyBzbG90cywgZW1pdCB9KSB7XG4gICAgY29uc3QgZGF0YSA9IHJlYWN0aXZlPFRhYmxlU3RhdGU+KHtcbiAgICAgIGNvbHM6IFtdLFxuICAgICAgcm93czogW10sXG4gICAgICBjaGVja2VkUm93czogW10sXG4gICAgICByb3dzT25QYWdlOiAyMCxcbiAgICAgIHBhZ2U6IDEsXG4gICAgICBpc0FsbFJvd3NDaGVja2VkOiBmYWxzZSxcbiAgICB9KVxuXG4gICAgY29uc3QgeyBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IsIHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvciB9ID0gdXNlQ29sb3JzKClcblxuICAgIGNvbnN0IGZpbHRlcnMgPSB7fVxuXG4gICAgY29uc3QgY2xhc3NlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PigoKSA9PiAoe1xuICAgICAgJ3YtZGF0YS10YWJsZSc6IHRydWUsXG4gICAgICAuLi4ocHJvcHMuY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IocHJvcHMuY29sb3IpIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQoKCkgPT4gKHtcbiAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldEJhY2tncm91bmRDc3NDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBoZWFkZXJPcHRpb25zID0gY29tcHV0ZWQ8SGVhZGVyT3B0aW9ucz4oKCkgPT4gKHtcbiAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgIGRhcms6IHByb3BzLmRhcmssXG4gICAgICAuLi5wcm9wcy5oZWFkZXJPcHRpb25zLFxuICAgIH0pKVxuXG4gICAgY29uc3QgZm9vdGVyT3B0aW9ucyA9IGNvbXB1dGVkPEZvb3Rlck9wdGlvbnM+KCgpID0+ICh7XG4gICAgICBjb2xvcjogcHJvcHMuY29sb3IsXG4gICAgICBkYXJrOiBwcm9wcy5kYXJrLFxuICAgICAgLi4ucHJvcHMuZm9vdGVyT3B0aW9ucyxcbiAgICB9KSlcblxuICAgIGNvbnN0IHBhZ2VzID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gTWF0aC5jZWlsKGRhdGEucm93cz8ubGVuZ3RoIC8gZGF0YS5yb3dzT25QYWdlKVxuICAgIH0pXG5cbiAgICBjb25zdCBmaXJzdE9uUGFnZSA9IGNvbXB1dGVkPG51bWJlcj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGRhdGEucGFnZSA9PT0gMSA/IDEgOiAoZGF0YS5wYWdlIC0gMSkgKiBkYXRhLnJvd3NPblBhZ2UgKyAxXG4gICAgfSlcblxuICAgIGNvbnN0IGxhc3RPblBhZ2UgPSBjb21wdXRlZDxudW1iZXI+KCgpID0+IHtcbiAgICAgIHJldHVybiBkYXRhLnBhZ2UgKiBkYXRhLnJvd3NPblBhZ2UgPiBkYXRhLnJvd3M/Lmxlbmd0aFxuICAgICAgICA/IGRhdGEucm93cz8ubGVuZ3RoXG4gICAgICAgIDogZGF0YS5wYWdlICogZGF0YS5yb3dzT25QYWdlXG4gICAgfSlcblxuICAgIGNvbnN0IHBhZ2VDb3JyZWN0aW9uID0gY29tcHV0ZWQ8bnVtYmVyIHwgbnVsbD4oKCkgPT4ge1xuICAgICAgaWYgKChkYXRhLnBhZ2UgLSAxKSAqIGRhdGEucm93c09uUGFnZSA+IGRhdGEucm93cz8ubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBNYXRoLmNlaWwoXG4gICAgICAgICAgKGRhdGEucGFnZSAqIGRhdGEucm93c09uUGFnZSAtIGRhdGEucm93cz8ubGVuZ3RoKSAvIGRhdGEucm93c09uUGFnZSxcbiAgICAgICAgKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbnVsbFxuICAgIH0pXG5cbiAgICB3YXRjaChcbiAgICAgICgpID0+IHByb3BzLmNvbHMsXG4gICAgICAodG8pID0+IChkYXRhLmNvbHMgPSB0byksXG4gICAgICB7IGltbWVkaWF0ZTogdHJ1ZSB9LFxuICAgIClcblxuICAgIHdhdGNoKFxuICAgICAgKCkgPT4gcHJvcHMucm93cyxcbiAgICAgICh0bykgPT4gKGRhdGEucm93cyA9IHRvKSxcbiAgICAgIHsgaW1tZWRpYXRlOiB0cnVlIH0sXG4gICAgKVxuXG4gICAgY29uc3Qgb25TZWxlY3RBbGwgPSAodmFsdWU6IGJvb2xlYW4pID0+IHtcbiAgICAgIGRhdGEuaXNBbGxSb3dzQ2hlY2tlZCA9IHZhbHVlXG4gICAgICBkYXRhLnJvd3MuZm9yRWFjaCgocm93KSA9PiAocm93LmNoZWNrZWQgPSB2YWx1ZSkpXG4gICAgfVxuXG4gICAgY29uc3Qgb25TZWxlY3QgPSA8VCBleHRlbmRzIFRhYmxlU3RhdGVbJ3Jvd3MnXT4ocm93czogVCkgPT4ge1xuICAgICAgZGF0YS5jaGVja2VkUm93cyA9IHJvd3NcbiAgICAgIGVtaXQoJ3NlbGVjdDpyb3cnLCBkYXRhLmNoZWNrZWRSb3dzKVxuICAgIH1cblxuICAgIGNvbnN0IG9uUHJldlBhZ2UgPSAobnVtOiBudW1iZXIpID0+IHtcbiAgICAgIGRhdGEucGFnZSA9IGRhdGEucGFnZSA+IDEgPyBkYXRhLnBhZ2UgKyBudW0gOiBkYXRhLnBhZ2VcbiAgICB9XG5cbiAgICBjb25zdCBvbk5leHRQYWdlID0gKG51bTogbnVtYmVyKSA9PiB7XG4gICAgICBpZiAoZGF0YS5yb3dzLmxlbmd0aCAtIGRhdGEucGFnZSAqIGRhdGEucm93c09uUGFnZSA+IDApIHtcbiAgICAgICAgZGF0YS5wYWdlICs9IG51bVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IG9uU29ydCA9IDxUIGV4dGVuZHMgRGF0YUNvbHVtbiwgUyBleHRlbmRzIERhdGFDb2x1bW5Qcm9wcz4oXG4gICAgICBjb2w6IFQgJiBTLFxuICAgICkgPT4ge1xuICAgICAgaWYgKGNvbC5zb3J0ZWQpIHtcbiAgICAgICAgY29sLnNvcnRlZCA9ICFjb2wuc29ydGVkXG4gICAgICAgIHJldHVybiBzb3J0Q29sdW1uKGNvbClcbiAgICAgIH1cblxuICAgICAgZGF0YS5jb2xzLmZvckVhY2goKGM6IFQgJiBTKSA9PiAoYy5zb3J0ZWQgPSBjb2wua2V5ID09PSBjLmtleSkpXG5cbiAgICAgIHNvcnRDb2x1bW4oY29sKVxuICAgIH1cblxuICAgIGNvbnN0IHNvcnRDb2x1bW4gPSA8VCBleHRlbmRzIERhdGFDb2x1bW4sIFMgZXh0ZW5kcyBEYXRhQ29sdW1uUHJvcHM+KFxuICAgICAgY29sOiBUICYgUyxcbiAgICApID0+IHtcbiAgICAgIGlmICghY29sLnNvcnRlZCkge1xuICAgICAgICByZXR1cm4gZGF0YS5yb3dzPy5yZXZlcnNlKClcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXhlY3V0b3IgPVxuICAgICAgICBjb2wuc29ydCB8fFxuICAgICAgICAoKGEsIGIpID0+IHtcbiAgICAgICAgICBpZiAoY29sLmZvcm1hdCkgcmV0dXJuIGNvbC5mb3JtYXQoYSkgPiBjb2wuZm9ybWF0KGIpID8gMSA6IC0xXG4gICAgICAgICAgaWYgKGNvbC5zb3J0ZWQpIHJldHVybiBhW2NvbC5rZXldID4gYltjb2wua2V5XSA/IDEgOiAtMVxuICAgICAgICB9KVxuXG4gICAgICBkYXRhLnJvd3M/LnNvcnQoZXhlY3V0b3IgYXMgYW55KVxuICAgIH1cblxuICAgIGNvbnN0IG9uRmlsdGVyID0gKHsgdmFsdWUsIGNvbCB9OiBUYWJsZUZpbHRlcikgPT4ge1xuICAgICAgaWYgKCF2YWx1ZSAmJiBmaWx0ZXJzW2NvbC5rZXldKSBkZWxldGUgZmlsdGVyc1tjb2wua2V5XVxuXG4gICAgICBpZiAodmFsdWUpIGZpbHRlcnNbY29sLmtleV0gPSB2YWx1ZVxuXG4gICAgICBpZiAoY29sLmZpbHRlcikge1xuICAgICAgICByZXR1cm4gKGRhdGEucm93cyA9IGNvbC5maWx0ZXIoeyB2YWx1ZSwgY29sIH0pKVxuICAgICAgfVxuICAgICAgaWYgKHByb3BzLmN1c3RvbUZpbHRlcikge1xuICAgICAgICByZXR1cm4gcHJvcHMuY3VzdG9tRmlsdGVyKGZpbHRlcnMgYXMgYW55KVxuICAgICAgfVxuICAgICAgaWYgKCFPYmplY3Qua2V5cyhmaWx0ZXJzKS5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIChkYXRhLnJvd3MgPSBwcm9wcy5yb3dzKVxuICAgICAgfVxuXG4gICAgICBkYXRhLnJvd3MgPSBmaWx0ZXJSb3dzKHByb3BzLnJvd3MsIHByb3BzLmNvbHMpXG4gICAgICBkYXRhLnBhZ2UgPSAxXG4gICAgfVxuXG4gICAgY29uc3Qgb25TZWxlY3RSb3dzQ291bnQgPSAoY291bnQ6IG51bWJlcikgPT4ge1xuICAgICAgZGF0YS5yb3dzT25QYWdlID0gY291bnRcbiAgICB9XG5cbiAgICBjb25zdCBmaWx0ZXJSb3dzID0gPFQsIEMgZXh0ZW5kcyBEYXRhQ29sdW1uPihyb3dzOiBUW10sIGNvbHM6IENbXSkgPT4ge1xuICAgICAgY29uc3QgZmlsdGVyS2V5cyA9IE9iamVjdC5rZXlzKGZpbHRlcnMpXG5cbiAgICAgIHJldHVybiByb3dzLnJlZHVjZSgoYWNjLCByb3cpID0+IHtcbiAgICAgICAgY29uc3Qgcm93UmVzdWx0czogVFtdID0gW11cblxuICAgICAgICBmaWx0ZXJLZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHsgZm9ybWF0IH0gPSBjb2xzLmZpbmQoKGNvbCkgPT4gY29sLmtleSA9PT0ga2V5KSBhcyBEYXRhQ29sdW1uXG5cbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGZvcm1hdCA/IGZvcm1hdChyb3cpIDogcm93W2tleV1cblxuICAgICAgICAgIGNvbnN0IHJvd0tleVZhbHVlID0gYCR7IHZhbHVlIH1gLnRvTG93ZXJDYXNlKClcbiAgICAgICAgICBjb25zdCBmaWx0ZXJWYWx1ZSA9IGAkeyBmaWx0ZXJzW2tleV0gfWAudG9Mb3dlckNhc2UoKVxuXG4gICAgICAgICAgaWYgKHJvd0tleVZhbHVlLmluY2x1ZGVzKGZpbHRlclZhbHVlKSkge1xuICAgICAgICAgICAgcm93UmVzdWx0cy5wdXNoKHJvd1trZXldKVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcblxuICAgICAgICBpZiAoXG4gICAgICAgICAgcm93UmVzdWx0cy5sZW5ndGggPT09IGZpbHRlcktleXMubGVuZ3RoICYmXG4gICAgICAgICAgcm93UmVzdWx0cy5ldmVyeSgodmFsdWUpID0+ICEhdmFsdWUpXG4gICAgICAgICkge1xuICAgICAgICAgIGFjYy5wdXNoKHJvdylcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhY2NcbiAgICAgIH0sIFtdIGFzIFRbXSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UYWJsZVRvb2xzID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHsgY2xhc3M6ICd2LWRhdGEtdGFibGVfX3Rvb2xiYXInIH1cblxuICAgICAgcmV0dXJuIGgoJ2RpdicsIHByb3BzRGF0YSwge1xuICAgICAgICBkZWZhdWx0OiAoKSA9PiBzbG90cy50b29sYmFyICYmIHNsb3RzLnRvb2xiYXIoKSxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuVGFibGVIZWFkZXIgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjb2xzOiBkYXRhLmNvbHMsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgICAgc2hvd0NoZWNrYm94OiBwcm9wcy5zaG93Q2hlY2tib3gsXG4gICAgICAgIGRhcms6IHByb3BzLmRhcmssXG4gICAgICAgIGFsaWduOiBwcm9wcy5hbGlnbixcbiAgICAgICAgc2hvd1NlcXVlbmNlOiBwcm9wcy5zaG93U2VxdWVuY2UsXG4gICAgICAgIG9wdGlvbnM6IGhlYWRlck9wdGlvbnMudmFsdWUsXG4gICAgICAgIG9uRmlsdGVyLFxuICAgICAgICBvblNvcnQsXG4gICAgICAgIG9uU2VsZWN0QWxsLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBjb250ZW50ID0gZGF0YS5jb2xzLnJlZHVjZSgoYWNjLCBjb2wpID0+IHtcbiAgICAgICAgY29uc3Qgc2xvdE5hbWUgPSBgJHsgY29sLmtleSB9LWZpbHRlcmBcblxuICAgICAgICBpZiAoY29sICYmIHNsb3RzW3Nsb3ROYW1lXSkge1xuICAgICAgICAgIGFjY1tzbG90TmFtZV0gPSBhZGRTY29wZWRTbG90KHNsb3ROYW1lLCBzbG90cylcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhY2NcbiAgICAgIH0sIHt9IGFzIGFueSlcblxuICAgICAgY29udGVudC5oZWFkZXIgPSBhZGRTY29wZWRTbG90KCdoZWFkZXInLCBzbG90cylcblxuICAgICAgcmV0dXJuIGgoVkRhdGFUYWJsZUhlYWRlciwgcHJvcHNEYXRhLCBjb250ZW50KVxuICAgIH1cblxuICAgIGNvbnN0IGdlblRhYmxlQm9keSA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNvbHM6IGRhdGEuY29scyxcbiAgICAgICAgcm93czogZGF0YS5yb3dzLFxuICAgICAgICBwYWdlOiBkYXRhLnBhZ2UsXG4gICAgICAgIHJvd3NPblBhZ2U6IGRhdGEucm93c09uUGFnZSxcbiAgICAgICAgc2hvd0NoZWNrYm94OiBwcm9wcy5zaG93Q2hlY2tib3gsXG4gICAgICAgIGNoZWNrQWxsUm93czogZGF0YS5pc0FsbFJvd3NDaGVja2VkLFxuICAgICAgICBhbGlnbjogcHJvcHMuYWxpZ24sXG4gICAgICAgIGRhcms6IHByb3BzLmRhcmssXG4gICAgICAgIHNob3dTZXF1ZW5jZTogcHJvcHMuc2hvd1NlcXVlbmNlLFxuICAgICAgICBjb2xvcjogcHJvcHMuY29sb3IsXG4gICAgICAgIG9uU2VsZWN0LFxuICAgICAgICBbJ29uQ2xpY2s6cm93J106IChlKSA9PiBlbWl0KCdjbGljazpyb3cnLCBlKSxcbiAgICAgICAgWydvbkRibGNsaWNrOnJvdyddOiAoZSkgPT4gZW1pdCgnZGJsY2xpY2s6cm93JywgZSksXG4gICAgICAgIFsnb25Db250ZXh0bWVudTpyb3cnXTogKGUpID0+IGVtaXQoJ2NvbnRleHRtZW51OnJvdycsIGUpLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBjb250ZW50ID0gcHJvcHMuY29scy5yZWR1Y2UoKGFjYywgY29sKSA9PiB7XG4gICAgICAgIGlmIChjb2wgJiYgc2xvdHNbY29sLmtleV0pIHtcbiAgICAgICAgICBhY2NbY29sLmtleV0gPSBhZGRTY29wZWRTbG90KGNvbC5rZXksIHNsb3RzKVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2NcbiAgICAgIH0sIHt9KVxuXG4gICAgICByZXR1cm4gaChWRGF0YVRhYmxlQm9keSwgcHJvcHNEYXRhLCBjb250ZW50KVxuICAgIH1cblxuICAgIGNvbnN0IGdlblRhYmxlRm9vdGVyID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgcGFnZXM6IHBhZ2VzLnZhbHVlLFxuICAgICAgICBwYWdlOiBkYXRhLnBhZ2UsXG4gICAgICAgIGZpcnN0T25QYWdlOiBmaXJzdE9uUGFnZS52YWx1ZSxcbiAgICAgICAgbGFzdE9uUGFnZTogbGFzdE9uUGFnZS52YWx1ZSxcbiAgICAgICAgcGFnZUNvcnJlY3Rpb246IHBhZ2VDb3JyZWN0aW9uLnZhbHVlLFxuICAgICAgICByb3dzT25QYWdlOiBkYXRhLnJvd3NPblBhZ2UsXG4gICAgICAgIHJvd3NMZW5ndGg6IGRhdGEucm93cz8ubGVuZ3RoLFxuICAgICAgICBvcHRpb25zOiBmb290ZXJPcHRpb25zLnZhbHVlLFxuICAgICAgICBvblByZXZQYWdlLFxuICAgICAgICBvbk5leHRQYWdlLFxuICAgICAgICBvblNlbGVjdFJvd3NDb3VudCxcbiAgICAgICAgb25MYXN0UGFnZTogKCkgPT4gZW1pdCgnbGFzdC1wYWdlJywgcHJvcHMucm93cy5sZW5ndGgpLFxuICAgICAgICBvbkNvcnJlY3RQYWdlOiAodmFsKSA9PiAoZGF0YS5wYWdlICs9IHZhbCksXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBzbG90c1sncGFnaW5hdGlvbi10ZXh0J11cbiAgICAgICAgPyB7XG4gICAgICAgICAgWydwYWdpbmF0aW9uLXRleHQnXTogKCkgPT5cbiAgICAgICAgICAgIHNsb3RzWydwYWdpbmF0aW9uLXRleHQnXSAmJlxuICAgICAgICAgICAgc2xvdHNbJ3BhZ2luYXRpb24tdGV4dCddKHtcbiAgICAgICAgICAgICAgc3RhcnQ6IGZpcnN0T25QYWdlLnZhbHVlLFxuICAgICAgICAgICAgICBsYXN0OiBsYXN0T25QYWdlLnZhbHVlLFxuICAgICAgICAgICAgICBsZW5ndGg6IGRhdGEucm93cz8ubGVuZ3RoLFxuICAgICAgICAgICAgfSksXG4gICAgICAgIH1cbiAgICAgICAgOiAnJ1xuXG4gICAgICByZXR1cm4gaChWRGF0YVRhYmxlRm9vdGVyLCBwcm9wc0RhdGEsIGNvbnRlbnQpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuVGFibGVJbm5lciA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiAndi1kYXRhLXRhYmxlX19pbm5lcicsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKCdkaXYnLCBwcm9wc0RhdGEsIFtnZW5UYWJsZUhlYWRlcigpLCBnZW5UYWJsZUJvZHkoKV0pXG4gICAgfVxuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMudmFsdWUsXG4gICAgICAgIHN0eWxlOiBzdHlsZXMudmFsdWUsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKCdkaXYnLCBwcm9wc0RhdGEsIFtcbiAgICAgICAgc2xvdHMudG9vbGJhciAmJiBnZW5UYWJsZVRvb2xzKCksXG4gICAgICAgIGdlblRhYmxlSW5uZXIoKSxcbiAgICAgICAgZ2VuVGFibGVGb290ZXIoKSxcbiAgICAgIF0pXG4gICAgfVxuICB9LFxufSlcbiJdfQ==