import { ref, reactive, computed } from 'vue';
export function autoPositionProps() {
    return {
        positionX: {
            type: Number,
            default: 0
        },
        positionY: {
            type: Number,
            default: 0
        }
    };
}
export function useAutoPosition(props) {
    const dimensions = reactive({
        activator: {
            top: 0,
            left: 0,
            bottom: 0,
            right: 0,
            width: 0,
            height: 0
        },
        content: {
            top: 0,
            left: 0,
            bottom: 0,
            right: 0,
            width: 0,
            height: 0
        },
        pageYOffset: 0,
        pageWidth: 0
    });
    const contentRef = ref(null);
    const offsetY = +props.offsetY;
    let activator;
    let content;
    let contentBottomBorder = 0;
    const getRect = (el) => {
        const rect = el.getBoundingClientRect();
        return {
            top: rect.top,
            left: rect.left,
            bottom: rect.bottom,
            right: rect.right,
            width: rect.width,
            height: rect.height
        };
    };
    const isAbsolutePositioned = computed(() => {
        return !!props.positionY || !!props.positionX;
    });
    const getInnerHeight = () => {
        if (!window)
            return 0;
        return innerHeight || document.documentElement.clientHeight;
    };
    const getScrollTop = () => {
        if (!window)
            return 0;
        return pageYOffset || document.documentElement.scrollTop;
    };
    const getScrollLeft = () => {
        if (!window)
            return 0;
        return pageXOffset || document.documentElement.scrollLeft;
    };
    const getContentAbsoluteBottomPoint = () => {
        return dimensions.content.height + props.positionY + getScrollTop();
    };
    const getContentBottomBorder = () => {
        const { activator, content } = dimensions;
        if (props.bottom) {
            return content.height + activator.top + activator.height;
        }
        if (props.top) {
            return activator.top;
        }
        return content.height + activator.top;
    };
    const calcContentBottomPosition = () => {
        const fullHeight = getScrollTop() + getInnerHeight();
        const contentBottomPosition = isAbsolutePositioned.value
            ? getContentAbsoluteBottomPoint()
            : getContentBottomBorder();
        return fullHeight - contentBottomPosition;
    };
    const calcAbsoluteTop = () => {
        const topPosition = props.positionY + getScrollTop();
        if (offsetY >= contentBottomBorder) {
            return topPosition + contentBottomBorder - offsetY;
        }
        return topPosition;
    };
    const calcBottomPosition = () => {
        const { activator, content } = dimensions;
        if (offsetY >= contentBottomBorder) {
            return activator.top - content.height - offsetY;
        }
        return activator.top + activator.height + offsetY;
    };
    const calcTopPosition = () => {
        const { activator, content } = dimensions;
        if (content.height + getScrollTop() + offsetY > activator.top) {
            return activator.top + activator.height;
        }
        return activator.top - content.height;
    };
    const calcContentAutoPosition = () => {
        if (offsetY >= contentBottomBorder) {
            return dimensions.activator.top + contentBottomBorder - offsetY;
        }
        return dimensions.activator.top;
    };
    const calcPositionY = () => {
        contentBottomBorder = calcContentBottomPosition();
        if (props.positionY)
            return calcAbsoluteTop();
        if (props.bottom)
            return calcBottomPosition();
        if (props.top)
            return calcTopPosition();
        return calcContentAutoPosition();
    };
    const calcPositionX = () => {
        if (props.positionX)
            return props.positionX + getScrollLeft();
        return dimensions.activator.left;
    };
    const snapShot = (cb) => {
        requestAnimationFrame(() => {
            if (!content || content.style.display !== 'none')
                return cb();
            content.style.display = 'inline-block';
            cb();
            content.style.display = 'none';
        });
    };
    const updateDimensions = () => {
        return new Promise((resolve) => {
            snapShot(() => {
                activator && setActivatorDimensions();
                content && setContentDimensions();
                resolve();
            });
        });
    };
    const setActivatorDimensions = () => {
        dimensions.activator = getRect(activator);
        dimensions.activator.height = activator.offsetHeight;
        dimensions.activator.top = dimensions.activator.top + getScrollTop();
        dimensions.activator.left = dimensions.activator.left + getScrollLeft();
    };
    const setContentDimensions = () => {
        const rect = activator
            ? dimensions.activator
            : getRect(content);
        dimensions.content.height = content.offsetHeight;
        dimensions.content.top = calcPositionY();
        dimensions.content.left = calcPositionX();
        dimensions.content.width = rect.width;
    };
    const setDimensions = (activatorEl) => {
        if (!activator && !content) {
            activator = activatorEl;
            content = contentRef.value;
        }
        return updateDimensions();
    };
    return {
        dimensions,
        contentRef,
        setDimensions,
        updateDimensions
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWF1dG8tcG9zaXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9zYWJsZXMvdXNlLWF1dG8tcG9zaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sS0FBSyxDQUFBO0FBVTdDLE1BQU0sVUFBVSxpQkFBaUI7SUFDL0IsT0FBTztRQUNMLFNBQVMsRUFBRTtZQUNULElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLENBQUM7U0FDWDtRQUNELFNBQVMsRUFBRTtZQUNULElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLENBQUM7U0FDWDtLQUNGLENBQUE7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLGVBQWUsQ0FBQyxLQUFLO0lBQ25DLE1BQU0sVUFBVSxHQUFHLFFBQVEsQ0FBaUI7UUFDMUMsU0FBUyxFQUFFO1lBQ1QsR0FBRyxFQUFFLENBQUM7WUFDTixJQUFJLEVBQUUsQ0FBQztZQUNQLE1BQU0sRUFBRSxDQUFDO1lBQ1QsS0FBSyxFQUFFLENBQUM7WUFDUixLQUFLLEVBQUUsQ0FBQztZQUNSLE1BQU0sRUFBRSxDQUFDO1NBQ1Y7UUFDRCxPQUFPLEVBQUU7WUFDUCxHQUFHLEVBQUUsQ0FBQztZQUNOLElBQUksRUFBRSxDQUFDO1lBQ1AsTUFBTSxFQUFFLENBQUM7WUFDVCxLQUFLLEVBQUUsQ0FBQztZQUNSLEtBQUssRUFBRSxDQUFDO1lBQ1IsTUFBTSxFQUFFLENBQUM7U0FDVjtRQUNELFdBQVcsRUFBRSxDQUFDO1FBQ2QsU0FBUyxFQUFFLENBQUM7S0FDYixDQUFDLENBQUE7SUFFRixNQUFNLFVBQVUsR0FBRyxHQUFHLENBQXFCLElBQUksQ0FBQyxDQUFBO0lBQ2hELE1BQU0sT0FBTyxHQUFXLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQTtJQUd0QyxJQUFJLFNBQXNCLENBQUE7SUFDMUIsSUFBSSxP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b3J0IHsgRGltZW5zaW9ucyB9IGZyb20gJy4uLy4uL3R5cGVzJ1xuXG50eXBlIE1haW5EaW1lbnNpb25zID0ge1xuICBhY3RpdmF0b3I6IERpbWVuc2lvbnNcbiAgY29udGVudDogRGltZW5zaW9uc1xuICBwYWdlWU9mZnNldDogbnVtYmVyXG4gIHBhZ2VXaWR0aDogbnVtYmVyXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhdXRvUG9zaXRpb25Qcm9wcygpe1xuICByZXR1cm4ge1xuICAgIHBvc2l0aW9uWDoge1xuICAgICAgdHlwZTogTnVtYmVyLFxuICAgICAgZGVmYXVsdDogMFxuICAgIH0sXG4gICAgcG9zaXRpb25ZOiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICBkZWZhdWx0OiAwXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1c2VBdXRvUG9zaXRpb24ocHJvcHMpe1xuICBjb25zdCBkaW1lbnNpb25zID0gcmVhY3RpdmU8TWFpbkRpbWVuc2lvbnM+KHtcbiAgICBhY3RpdmF0b3I6IHtcbiAgICAgIHRvcDogMCxcbiAgICAgIGxlZnQ6IDAsXG4gICAgICBib3R0b206IDAsXG4gICAgICByaWdodDogMCxcbiAgICAgIHdpZHRoOiAwLFxuICAgICAgaGVpZ2h0OiAwXG4gICAgfSxcbiAgICBjb250ZW50OiB7XG4gICAgICB0b3A6IDAsXG4gICAgICBsZWZ0OiAwLFxuICAgICAgYm90dG9tOiAwLFxuICAgICAgcmlnaHQ6IDAsXG4gICAgICB3aWR0aDogMCxcbiAgICAgIGhlaWdodDogMFxuICAgIH0sXG4gICAgcGFnZVlPZmZzZXQ6IDAsXG4gICAgcGFnZVdpZHRoOiAwXG4gIH0pXG5cbiAgY29uc3QgY29udGVudFJlZiA9IHJlZjxIVE1MRWxlbWVudCB8IG51bGw+KG51bGwpXG4gIGNvbnN0IG9mZnNldFk6IG51bWJlciA9ICtwcm9wcy5vZmZzZXRZXG4gIC8vIGNvbnN0IG9mZnNldFg6IG51bWJlciA9ICtwcm9wcy5vZmZzZXRYXG5cbiAgbGV0IGFjdGl2YXRvcjogSFRNTEVsZW1lbnRcbiAgbGV0IGNvbnRlbnQ6IEhUTUxFbGVtZW50XG4gIGxldCBjb250ZW50Qm90dG9tQm9yZGVyOiBudW1iZXIgPSAwXG5cbiAgY29uc3QgZ2V0UmVjdCA9IChlbDogSFRNTEVsZW1lbnQpID0+IHtcbiAgICBjb25zdCByZWN0ID0gZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcblxuICAgIHJldHVybiB7XG4gICAgICB0b3A6IHJlY3QudG9wLFxuICAgICAgbGVmdDogcmVjdC5sZWZ0LFxuICAgICAgYm90dG9tOiByZWN0LmJvdHRvbSxcbiAgICAgIHJpZ2h0OiByZWN0LnJpZ2h0LFxuICAgICAgd2lkdGg6IHJlY3Qud2lkdGgsXG4gICAgICBoZWlnaHQ6IHJlY3QuaGVpZ2h0XG4gICAgfVxuICB9XG5cbiAgY29uc3QgaXNBYnNvbHV0ZVBvc2l0aW9uZWQgPSBjb21wdXRlZDxib29sZWFuPigoKSA9PiB7XG4gICAgcmV0dXJuICEhcHJvcHMucG9zaXRpb25ZIHx8ICEhcHJvcHMucG9zaXRpb25YXG4gIH0pXG5cbiAgY29uc3QgZ2V0SW5uZXJIZWlnaHQgPSAoKTogbnVtYmVyID0+IHtcbiAgICBpZiAoIXdpbmRvdykgcmV0dXJuIDBcblxuICAgIHJldHVybiBpbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0XG4gIH1cblxuICBjb25zdCBnZXRTY3JvbGxUb3AgPSAoKTogbnVtYmVyID0+IHtcbiAgICBpZiAoIXdpbmRvdykgcmV0dXJuIDBcblxuICAgIHJldHVybiBwYWdlWU9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wXG4gIH1cblxuICBjb25zdCBnZXRTY3JvbGxMZWZ0ID0gKCk6IG51bWJlciA9PiB7XG4gICAgaWYgKCF3aW5kb3cpIHJldHVybiAwXG5cbiAgICByZXR1cm4gcGFnZVhPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnRcbiAgfVxuXG4gIGNvbnN0IGdldENvbnRlbnRBYnNvbHV0ZUJvdHRvbVBvaW50ID0gKCkgPT4ge1xuICAgIHJldHVybiBkaW1lbnNpb25zLmNvbnRlbnQuaGVpZ2h0ICsgcHJvcHMucG9zaXRpb25ZICsgZ2V0U2Nyb2xsVG9wKClcbiAgfVxuXG4gIGNvbnN0IGdldENvbnRlbnRCb3R0b21Cb3JkZXIgPSAoKSA9PiB7XG4gICAgY29uc3QgeyBhY3RpdmF0b3IsIGNvbnRlbnQgfSA9IGRpbWVuc2lvbnNcblxuICAgIGlmIChwcm9wcy5ib3R0b20pIHtcbiAgICAgIHJldHVybiBjb250ZW50LmhlaWdodCArIGFjdGl2YXRvci50b3AgKyBhY3RpdmF0b3IuaGVpZ2h0XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLnRvcCkge1xuICAgICAgcmV0dXJuIGFjdGl2YXRvci50b3BcbiAgICB9XG5cbiAgICByZXR1cm4gY29udGVudC5oZWlnaHQgKyBhY3RpdmF0b3IudG9wXG4gIH1cblxuICBjb25zdCBjYWxjQ29udGVudEJvdHRvbVBvc2l0aW9uID0gKCkgPT4ge1xuICAgIGNvbnN0IGZ1bGxIZWlnaHQgPSBnZXRTY3JvbGxUb3AoKSArIGdldElubmVySGVpZ2h0KClcblxuICAgIGNvbnN0IGNvbnRlbnRCb3R0b21Qb3NpdGlvbiA9IGlzQWJzb2x1dGVQb3NpdGlvbmVkLnZhbHVlXG4gICAgICA/IGdldENvbnRlbnRBYnNvbHV0ZUJvdHRvbVBvaW50KClcbiAgICAgIDogZ2V0Q29udGVudEJvdHRvbUJvcmRlcigpXG5cbiAgICByZXR1cm4gZnVsbEhlaWdodCAtIGNvbnRlbnRCb3R0b21Qb3NpdGlvblxuICB9XG5cbiAgY29uc3QgY2FsY0Fic29sdXRlVG9wID0gKCkgPT4ge1xuICAgIGNvbnN0IHRvcFBvc2l0aW9uID0gcHJvcHMucG9zaXRpb25ZICsgZ2V0U2Nyb2xsVG9wKClcblxuICAgIGlmIChvZmZzZXRZID49IGNvbnRlbnRCb3R0b21Cb3JkZXIpIHtcbiAgICAgIHJldHVybiB0b3BQb3NpdGlvbiArIGNvbnRlbnRCb3R0b21Cb3JkZXIgLSBvZmZzZXRZXG4gICAgfVxuXG4gICAgcmV0dXJuIHRvcFBvc2l0aW9uXG4gIH1cblxuICBjb25zdCBjYWxjQm90dG9tUG9zaXRpb24gPSAoKSA9PiB7XG4gICAgY29uc3QgeyBhY3RpdmF0b3IsIGNvbnRlbnQgfSA9IGRpbWVuc2lvbnNcblxuICAgIGlmIChvZmZzZXRZID49IGNvbnRlbnRCb3R0b21Cb3JkZXIpIHtcbiAgICAgIHJldHVybiBhY3RpdmF0b3IudG9wIC0gY29udGVudC5oZWlnaHQgLSBvZmZzZXRZXG4gICAgfVxuXG4gICAgcmV0dXJuIGFjdGl2YXRvci50b3AgKyBhY3RpdmF0b3IuaGVpZ2h0ICsgb2Zmc2V0WVxuICB9XG5cbiAgY29uc3QgY2FsY1RvcFBvc2l0aW9uID0gKCkgPT4ge1xuICAgIGNvbnN0IHsgYWN0aXZhdG9yLCBjb250ZW50IH0gPSBkaW1lbnNpb25zXG5cbiAgICBpZiAoY29udGVudC5oZWlnaHQgKyBnZXRTY3JvbGxUb3AoKSArIG9mZnNldFkgPiBhY3RpdmF0b3IudG9wKSB7XG4gICAgICByZXR1cm4gYWN0aXZhdG9yLnRvcCArIGFjdGl2YXRvci5oZWlnaHRcbiAgICB9XG5cbiAgICByZXR1cm4gYWN0aXZhdG9yLnRvcCAtIGNvbnRlbnQuaGVpZ2h0XG4gIH1cblxuICBjb25zdCBjYWxjQ29udGVudEF1dG9Qb3NpdGlvbiA9ICgpID0+IHtcbiAgICBpZiAob2Zmc2V0WSA+PSBjb250ZW50Qm90dG9tQm9yZGVyKSB7XG4gICAgICByZXR1cm4gZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wICsgY29udGVudEJvdHRvbUJvcmRlciAtIG9mZnNldFlcbiAgICB9XG5cbiAgICByZXR1cm4gZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wXG4gIH1cblxuICBjb25zdCBjYWxjUG9zaXRpb25ZID0gKCk6IG51bWJlciA9PiB7XG4gICAgY29udGVudEJvdHRvbUJvcmRlciA9IGNhbGNDb250ZW50Qm90dG9tUG9zaXRpb24oKVxuXG4gICAgaWYgKHByb3BzLnBvc2l0aW9uWSkgcmV0dXJuIGNhbGNBYnNvbHV0ZVRvcCgpXG4gICAgaWYgKHByb3BzLmJvdHRvbSkgcmV0dXJuIGNhbGNCb3R0b21Qb3NpdGlvbigpXG4gICAgaWYgKHByb3BzLnRvcCkgcmV0dXJuIGNhbGNUb3BQb3NpdGlvbigpXG5cbiAgICByZXR1cm4gY2FsY0NvbnRlbnRBdXRvUG9zaXRpb24oKVxuICB9XG5cbiAgY29uc3QgY2FsY1Bvc2l0aW9uWCA9ICgpOiBudW1iZXIgPT4ge1xuICAgIGlmIChwcm9wcy5wb3NpdGlvblgpIHJldHVybiBwcm9wcy5wb3NpdGlvblggKyBnZXRTY3JvbGxMZWZ0KClcblxuICAgIHJldHVybiBkaW1lbnNpb25zLmFjdGl2YXRvci5sZWZ0XG4gIH1cblxuICBjb25zdCBzbmFwU2hvdCA9IChjYjogKCkgPT4gYW55KSA9PiB7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmICghY29udGVudCB8fCBjb250ZW50LnN0eWxlLmRpc3BsYXkgIT09ICdub25lJykgcmV0dXJuIGNiKClcbiAgICAgIGNvbnRlbnQuc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUtYmxvY2snXG4gICAgICBjYigpXG4gICAgICBjb250ZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICB9KVxuICB9XG5cbiAgY29uc3QgdXBkYXRlRGltZW5zaW9ucyA9ICgpOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHNuYXBTaG90KCgpID0+IHtcbiAgICAgICAgYWN0aXZhdG9yICYmIHNldEFjdGl2YXRvckRpbWVuc2lvbnMoKVxuICAgICAgICBjb250ZW50ICYmIHNldENvbnRlbnREaW1lbnNpb25zKClcbiAgICAgICAgcmVzb2x2ZSgpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBjb25zdCBzZXRBY3RpdmF0b3JEaW1lbnNpb25zID0gKCkgPT4ge1xuICAgIGRpbWVuc2lvbnMuYWN0aXZhdG9yID0gZ2V0UmVjdChhY3RpdmF0b3IpXG5cbiAgICBkaW1lbnNpb25zLmFjdGl2YXRvci5oZWlnaHQgPSBhY3RpdmF0b3Iub2Zmc2V0SGVpZ2h0XG4gICAgZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wID0gZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wICsgZ2V0U2Nyb2xsVG9wKClcbiAgICBkaW1lbnNpb25zLmFjdGl2YXRvci5sZWZ0ID0gZGltZW5zaW9ucy5hY3RpdmF0b3IubGVmdCArIGdldFNjcm9sbExlZnQoKVxuICB9XG5cbiAgY29uc3Qgc2V0Q29udGVudERpbWVuc2lvbnMgPSAoKSA9PiB7XG4gICAgY29uc3QgcmVjdCA9IGFjdGl2YXRvclxuICAgICAgPyBkaW1lbnNpb25zLmFjdGl2YXRvclxuICAgICAgOiBnZXRSZWN0KGNvbnRlbnQpXG5cbiAgICBkaW1lbnNpb25zLmNvbnRlbnQuaGVpZ2h0ID0gY29udGVudC5vZmZzZXRIZWlnaHRcbiAgICBkaW1lbnNpb25zLmNvbnRlbnQudG9wID0gY2FsY1Bvc2l0aW9uWSgpXG4gICAgZGltZW5zaW9ucy5jb250ZW50LmxlZnQgPSBjYWxjUG9zaXRpb25YKClcbiAgICBkaW1lbnNpb25zLmNvbnRlbnQud2lkdGggPSByZWN0LndpZHRoXG4gIH1cblxuICBjb25zdCBzZXREaW1lbnNpb25zID0gKGFjdGl2YXRvckVsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgIGlmICghYWN0aXZhdG9yICYmICFjb250ZW50KSB7XG4gICAgICBhY3RpdmF0b3IgPSBhY3RpdmF0b3JFbFxuICAgICAgY29udGVudCA9IGNvbnRlbnRSZWYudmFsdWUhXG4gICAgfVxuXG4gICAgcmV0dXJuIHVwZGF0ZURpbWVuc2lvbnMoKVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBkaW1lbnNpb25zLFxuICAgIGNvbnRlbnRSZWYsXG4gICAgc2V0RGltZW5zaW9ucyxcbiAgICB1cGRhdGVEaW1lbnNpb25zXG4gIH1cbn1cbiJdfQ==