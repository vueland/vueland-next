import { defineComponent, watch, h, withDirectives, computed, onMounted, onBeforeUnmount, vShow, } from 'vue';
import { autoPositionProps, useAutoPosition, } from '../../composables/use-auto-position';
import { activatorProps, useActivator } from '../../composables/use-activator';
import { useDetach } from '../../composables/use-detach';
import { useElevation } from '../../composables/use-elevation';
import { useToggle } from '../../composables/use-toggle';
import { useTransition } from '../../composables/use-transition';
import { positionProps } from '../../composables/use-position';
import { convertToUnit } from '../../helpers';
import { clickOutside, resize } from '../../directives';
export default defineComponent({
    name: 'v-menu',
    directives: {
        clickOutside,
        resize,
    },
    props: {
        maxHeight: {
            type: [Number, String],
            default: 200,
        },
        width: {
            type: [Number, String],
            default: 0,
        },
        zIndex: {
            type: [String, Number],
            default: 10,
        },
        openOnHover: Boolean,
        openOnClick: Boolean,
        openOnContextmenu: Boolean,
        closeOnClick: {
            type: Boolean,
            default: true,
        },
        elevation: {
            type: [Number, String],
            default: 10,
        },
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        modelValue: Boolean,
        inputActivator: {
            type: String,
            default: '',
        },
        ...positionProps(),
        ...autoPositionProps(),
        ...activatorProps(),
    },
    emits: ['show', 'hide'],
    setup(props, { emit, slots }) {
        const { elevationClasses } = useElevation(props);
        const { isActive } = useToggle(props);
        const { contentRef, setDimensions, dimensions } = useAutoPosition(props);
        const { setDetached, removeDetached } = useDetach();
        const { activatorRef, getActivator, genActivatorListeners, addActivatorEvents, removeActivatorEvents, } = useActivator(props);
        const setDimensionsOn = (e, flag) => {
            setDimensions(getActivator(e)).then(() => {
                requestAnimationFrame(() => (isActive.value = flag));
            });
        };
        const handlers = {
            click: (e) => setDimensionsOn(e, props.openOnClick),
            mouseenter: (e) => setDimensionsOn(e, props.openOnHover),
            mouseleave: (e) => setDimensionsOn(e, !props.openOnHover),
            contextmenu: (e) => setDimensionsOn(e, props.openOnContextmenu),
        };
        const listeners = genActivatorListeners(props, handlers);
        const directive = computed(() => {
            return isActive.value
                ? {
                    handler: (e) => {
                        if (props.internalActivator &&
                            activatorRef.value.contains(e.target))
                            return;
                        isActive.value = false;
                    },
                    closeConditional: props.closeOnClick,
                }
                : undefined;
        });
        const calcWidth = computed(() => {
            return props.width || +dimensions.content.width;
        });
        watch(isActive, (to) => {
            to && emit('show');
            !to && emit('hide');
        });
        watch(() => [props.positionY, props.positionX], () => setDimensions(activatorRef.value));
        watch(() => props.modelValue, (to) => {
            isActive.value = false;
            setTimeout(() => (isActive.value = to));
        });
        const contentClasses = computed(() => ({
            'v-menu__content': true,
            ...elevationClasses.value,
        }));
        const contentStyles = computed(() => ({
            top: convertToUnit(dimensions.content.top),
            left: convertToUnit(dimensions.content.left),
            zIndex: props.zIndex,
        }));
        const onContentClick = () => {
            isActive.value = !props.closeOnClick;
        };
        const onResize = () => {
            if (!isActive.value)
                return;
            requestAnimationFrame(() => setDimensions(activatorRef.value));
        };
        const genActivatorSlot = () => {
            if (slots.activator) {
                const slotContent = slots.activator({ on: listeners });
                if (typeof slotContent[0].type === 'object') {
                    return h('div', { ref: activatorRef }, h(slotContent[0]));
                }
                return h(slotContent[0], { ref: activatorRef });
            }
            return null;
        };
        const genContentSlot = () => {
            const propsData = {
                ref: contentRef,
                class: contentClasses.value,
                style: contentStyles.value,
                onClick: onContentClick,
            };
            const slotContent = h('div', {
                class: 'v-menu__slot',
                style: {
                    maxHeight: convertToUnit(props.maxHeight),
                    width: convertToUnit(calcWidth.value),
                },
            }, [slots.default && slots.default()]);
            const content = h('div', propsData, slotContent);
            const directives = [
                [vShow, isActive.value],
                [resize, onResize],
                [clickOutside, directive.value],
            ];
            return withDirectives(content, directives);
        };
        onMounted(() => {
            activatorRef.value = getActivator();
            addActivatorEvents();
            setDetached(contentRef.value);
        });
        onBeforeUnmount(() => {
            removeActivatorEvents();
            removeDetached(contentRef.value);
        });
        return () => [
            h('div', { class: { 'v-menu': true } }),
            slots.activator && genActivatorSlot(),
            useTransition(genContentSlot(), 'fade'),
        ];
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WTWVudS9WTWVudS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLEtBQUssRUFDTCxDQUFDLEVBQ0QsY0FBYyxFQUNkLFFBQVEsRUFDUixTQUFTLEVBQ1QsZUFBZSxFQUNmLEtBQUssR0FHTixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsZUFBZSxHQUNoQixNQUFNLHFDQUFxQyxDQUFBO0FBQzVDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDOUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUM5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBQ2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUc5RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFFdkQsZUFBZSxlQUFlLENBQUM7SUFDN0IsSUFBSSxFQUFFLFFBQVE7SUFDZCxVQUFVLEVBQUU7UUFDVixZQUFZO1FBQ1osTUFBTTtLQUNQO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVBQUUsR0FBRztTQUNiO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVB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V0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFNLENBQUMsQ0FBQTtRQUNoQyxDQUFDLENBQUMsQ0FBQTtRQUVGLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIscUJBQXFCLEVBQUUsQ0FBQTtZQUN2QixjQUFjLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxDQUFBO1FBQ25DLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNYLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN2QyxLQUFLLENBQUMsU0FBUyxJQUFJLGdCQUFnQixFQUFFO1lBQ3JDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLENBQUM7U0FDeEMsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBWdWUgQVBJXG5pbXBvcnQge1xuICBkZWZpbmVDb21wb25lbnQsXG4gIHdhdGNoLFxuICBoLFxuICB3aXRoRGlyZWN0aXZlcyxcbiAgY29tcHV0ZWQsXG4gIG9uTW91bnRlZCxcbiAgb25CZWZvcmVVbm1vdW50LFxuICB2U2hvdyxcbiAgVk5vZGUsXG4gIERpcmVjdGl2ZUFyZ3VtZW50cyxcbn0gZnJvbSAndnVlJ1xuXG4vLyBDb21wb3NhYmxlXG5pbXBvcnQge1xuICBhdXRvUG9zaXRpb25Qcm9wcyxcbiAgdXNlQXV0b1Bvc2l0aW9uLFxufSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtYXV0by1wb3NpdGlvbidcbmltcG9ydCB7IGFjdGl2YXRvclByb3BzLCB1c2VBY3RpdmF0b3IgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtYWN0aXZhdG9yJ1xuaW1wb3J0IHsgdXNlRGV0YWNoIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWRldGFjaCdcbmltcG9ydCB7IHVzZUVsZXZhdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1lbGV2YXRpb24nXG5pbXBvcnQgeyB1c2VUb2dnbGUgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtdG9nZ2xlJ1xuaW1wb3J0IHsgdXNlVHJhbnNpdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS10cmFuc2l0aW9uJ1xuaW1wb3J0IHsgcG9zaXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1wb3NpdGlvbidcblxuLy8gSGVscGVyc1xuaW1wb3J0IHsgY29udmVydFRvVW5pdCB9IGZyb20gJy4uLy4uL2hlbHBlcnMnXG5cbi8vIERpcmVjdGl2ZXNcbmltcG9ydCB7IGNsaWNrT3V0c2lkZSwgcmVzaXplIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcydcblxuZXhwb3J0IGRlZmF1bHQgZGVmaW5lQ29tcG9uZW50KHtcbiAgbmFtZTogJ3YtbWVudScsXG4gIGRpcmVjdGl2ZXM6IHtcbiAgICBjbGlja091dHNpZGUsXG4gICAgcmVzaXplLFxuICB9LFxuICBwcm9wczoge1xuICAgIG1heEhlaWdodDoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDIwMCxcbiAgICB9LFxuICAgIHdpZHRoOiB7XG4gICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgICAgZGVmYXVsdDogMCxcbiAgICB9LFxuICAgIHpJbmRleDoge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDEwLFxuICAgIH0sXG4gICAgb3Blbk9uSG92ZXI6IEJvb2xlYW4sXG4gICAgb3Blbk9uQ2xpY2s6IEJvb2xlYW4sXG4gICAgb3Blbk9uQ29udGV4dG1lbnU6IEJvb2xlYW4sXG4gICAgY2xvc2VPbkNsaWNrOiB7XG4gICAgICB0eXBlOiBCb29sZWFuLFxuICAgICAgZGVmYXVsdDogdHJ1ZSxcbiAgICB9LFxuICAgIGVsZXZhdGlvbjoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDEwLFxuICAgIH0sXG4gICAgb2Zmc2V0WDoge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDIwLFxuICAgIH0sXG4gICAgb2Zmc2V0WToge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDIwLFxuICAgIH0sXG4gICAgbW9kZWxWYWx1ZTogQm9vbGVhbixcbiAgICBpbnB1dEFjdGl2YXRvcjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICAuLi5wb3NpdGlvblByb3BzKCksXG4gICAgLi4uYXV0b1Bvc2l0aW9uUHJvcHMoKSxcbiAgICAuLi5hY3RpdmF0b3JQcm9wcygpLFxuICB9LFxuXG4gIGVtaXRzOiBbJ3Nob3cnLCAnaGlkZSddLFxuXG4gIHNldHVwKHByb3BzLCB7IGVtaXQsIHNsb3RzIH0pIHtcbiAgICBjb25zdCB7IGVsZXZhdGlvbkNsYXNzZXMgfSA9IHVzZUVsZXZhdGlvbihwcm9wcylcbiAgICBjb25zdCB7IGlzQWN0aXZlIH0gPSB1c2VUb2dnbGUocHJvcHMpXG4gICAgY29uc3QgeyBjb250ZW50UmVmLCBzZXREaW1lbnNpb25zLCBkaW1lbnNpb25zIH0gPSB1c2VBdXRvUG9zaXRpb24ocHJvcHMpXG4gICAgY29uc3QgeyBzZXREZXRhY2hlZCwgcmVtb3ZlRGV0YWNoZWQgfSA9IHVzZURldGFjaCgpXG4gICAgY29uc3Qge1xuICAgICAgYWN0aXZhdG9yUmVmLFxuICAgICAgZ2V0QWN0aXZhdG9yLFxuICAgICAgZ2VuQWN0aXZhdG9yTGlzdGVuZXJzLFxuICAgICAgYWRkQWN0aXZhdG9yRXZlbnRzLFxuICAgICAgcmVtb3ZlQWN0aXZhdG9yRXZlbnRzLFxuICAgIH0gPSB1c2VBY3RpdmF0b3IocHJvcHMpXG5cbiAgICBjb25zdCBzZXREaW1lbnNpb25zT24gPSAoZSwgZmxhZykgPT4ge1xuICAgICAgc2V0RGltZW5zaW9ucyhnZXRBY3RpdmF0b3IoZSkhKS50aGVuKCgpID0+IHtcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IChpc0FjdGl2ZS52YWx1ZSA9IGZsYWcpKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBoYW5kbGVycyA9IHtcbiAgICAgIGNsaWNrOiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsIHByb3BzLm9wZW5PbkNsaWNrKSxcbiAgICAgIG1vdXNlZW50ZXI6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgcHJvcHMub3Blbk9uSG92ZXIpLFxuICAgICAgbW91c2VsZWF2ZTogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCAhcHJvcHMub3Blbk9uSG92ZXIpLFxuICAgICAgY29udGV4dG1lbnU6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgcHJvcHMub3Blbk9uQ29udGV4dG1lbnUpLFxuICAgIH1cblxuICAgIGNvbnN0IGxpc3RlbmVycyA9IGdlbkFjdGl2YXRvckxpc3RlbmVycyhwcm9wcywgaGFuZGxlcnMpXG5cbiAgICBjb25zdCBkaXJlY3RpdmUgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgICByZXR1cm4gaXNBY3RpdmUudmFsdWVcbiAgICAgICAgPyB7XG4gICAgICAgICAgaGFuZGxlcjogKGUpID0+IHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgcHJvcHMuaW50ZXJuYWxBY3RpdmF0b3IgJiZcbiAgICAgICAgICAgICAgYWN0aXZhdG9yUmVmLnZhbHVlLmNvbnRhaW5zKGUudGFyZ2V0KVxuICAgICAgICAgICAgKSByZXR1cm5cbiAgICAgICAgICAgIGlzQWN0aXZlLnZhbHVlID0gZmFsc2VcbiAgICAgICAgICB9LFxuICAgICAgICAgICAgY2xvc2VDb25kaXRpb25hbDogcHJvcHMuY2xvc2VPbkNsaWNrLFxuICAgICAgICAgIH1cbiAgICAgICAgOiB1bmRlZmluZWRcbiAgICB9KVxuXG4gICAgY29uc3QgY2FsY1dpZHRoID0gY29tcHV0ZWQ8bnVtYmVyIHwgc3RyaW5nPigoKSA9PiB7XG4gICAgICByZXR1cm4gcHJvcHMud2lkdGggfHwgK2RpbWVuc2lvbnMuY29udGVudC53aWR0aFxuICAgIH0pXG5cbiAgICB3YXRjaChpc0FjdGl2ZSwgKHRvKSA9PiB7XG4gICAgICB0byAmJiBlbWl0KCdzaG93JylcbiAgICAgICF0byAmJiBlbWl0KCdoaWRlJylcbiAgICB9KVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBbcHJvcHMucG9zaXRpb25ZLCBwcm9wcy5wb3NpdGlvblhdLFxuICAgICAgKCkgPT4gc2V0RGltZW5zaW9ucyhhY3RpdmF0b3JSZWYudmFsdWUhKVxuICAgIClcblxuICAgIHdhdGNoKFxuICAgICAgKCkgPT4gcHJvcHMubW9kZWxWYWx1ZSxcbiAgICAgICh0bykgPT4ge1xuICAgICAgICBpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gKGlzQWN0aXZlLnZhbHVlID0gdG8pKVxuICAgICAgfVxuICAgIClcblxuICAgIGNvbnN0IGNvbnRlbnRDbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+ICh7XG4gICAgICAndi1tZW51X19jb250ZW50JzogdHJ1ZSxcbiAgICAgIC4uLmVsZXZhdGlvbkNsYXNzZXMudmFsdWUsXG4gICAgfSkpXG5cbiAgICBjb25zdCBjb250ZW50U3R5bGVzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgc3RyaW5nIHwgbnVtYmVyPj4oKCkgPT4gKHtcbiAgICAgIHRvcDogY29udmVydFRvVW5pdChkaW1lbnNpb25zLmNvbnRlbnQudG9wKSEsXG4gICAgICBsZWZ0OiBjb252ZXJ0VG9Vbml0KGRpbWVuc2lvbnMuY29udGVudC5sZWZ0KSEsXG4gICAgICB6SW5kZXg6IHByb3BzLnpJbmRleCxcbiAgICB9KSkgYXMgYW55XG5cbiAgICBjb25zdCBvbkNvbnRlbnRDbGljayA9ICgpID0+IHtcbiAgICAgIGlzQWN0aXZlLnZhbHVlID0gIXByb3BzLmNsb3NlT25DbGlja1xuICAgIH1cblxuICAgIGNvbnN0IG9uUmVzaXplID0gKCkgPT4ge1xuICAgICAgaWYgKCFpc0FjdGl2ZS52YWx1ZSkgcmV0dXJuXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gc2V0RGltZW5zaW9ucyhhY3RpdmF0b3JSZWYudmFsdWUhKSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5BY3RpdmF0b3JTbG90ID0gKCk6IE1heWJlPFZOb2RlPiA9PiB7XG4gICAgICBpZiAoc2xvdHMuYWN0aXZhdG9yKSB7XG4gICAgICAgIGNvbnN0IHNsb3RDb250ZW50ID0gc2xvdHMuYWN0aXZhdG9yKHsgb246IGxpc3RlbmVycyB9KVxuXG4gICAgICAgIGlmICh0eXBlb2Ygc2xvdENvbnRlbnQhWzBdLnR5cGUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgcmV0dXJuIGgoJ2RpdicsIHsgcmVmOiBhY3RpdmF0b3JSZWYgfSwgaChzbG90Q29udGVudCFbMF0pKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGgoc2xvdENvbnRlbnQhWzBdLCB7IHJlZjogYWN0aXZhdG9yUmVmIH0pXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuQ29udGVudFNsb3QgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICByZWY6IGNvbnRlbnRSZWYsXG4gICAgICAgIGNsYXNzOiBjb250ZW50Q2xhc3Nlcy52YWx1ZSxcbiAgICAgICAgc3R5bGU6IGNvbnRlbnRTdHlsZXMudmFsdWUsXG4gICAgICAgIG9uQ2xpY2s6IG9uQ29udGVudENsaWNrLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBzbG90Q29udGVudCA9IGgoXG4gICAgICAgICdkaXYnLFxuICAgICAgICB7XG4gICAgICAgICAgY2xhc3M6ICd2LW1lbnVfX3Nsb3QnLFxuICAgICAgICAgIHN0eWxlOiB7XG4gICAgICAgICAgICBtYXhIZWlnaHQ6IGNvbnZlcnRUb1VuaXQocHJvcHMubWF4SGVpZ2h0KSxcbiAgICAgICAgICAgIHdpZHRoOiBjb252ZXJ0VG9Vbml0KGNhbGNXaWR0aC52YWx1ZSksXG4gICAgICAgICAgfSxcbiAgICAgICAgfSxcbiAgICAgICAgW3Nsb3RzLmRlZmF1bHQgJiYgc2xvdHMuZGVmYXVsdCgpXVxuICAgICAgKVxuXG4gICAgICBjb25zdCBjb250ZW50ID0gaCgnZGl2JywgcHJvcHNEYXRhLCBzbG90Q29udGVudClcblxuICAgICAgY29uc3QgZGlyZWN0aXZlczogRGlyZWN0aXZlQXJndW1lbnRzID0gW1xuICAgICAgICBbdlNob3csIGlzQWN0aXZlLnZhbHVlXSxcbiAgICAgICAgW3Jlc2l6ZSwgb25SZXNpemVdLFxuICAgICAgICBbY2xpY2tPdXRzaWRlLCBkaXJlY3RpdmUudmFsdWVdLFxuICAgICAgXVxuXG4gICAgICByZXR1cm4gd2l0aERpcmVjdGl2ZXMoY29udGVudCwgZGlyZWN0aXZlcylcbiAgICB9XG5cbiAgICBvbk1vdW50ZWQoKCkgPT4ge1xuICAgICAgYWN0aXZhdG9yUmVmLnZhbHVlID0gZ2V0QWN0aXZhdG9yKClcblxuICAgICAgYWRkQWN0aXZhdG9yRXZlbnRzKClcbiAgICAgIHNldERldGFjaGVkKGNvbnRlbnRSZWYudmFsdWUhKVxuICAgIH0pXG5cbiAgICBvbkJlZm9yZVVubW91bnQoKCkgPT4ge1xuICAgICAgcmVtb3ZlQWN0aXZhdG9yRXZlbnRzKClcbiAgICAgIHJlbW92ZURldGFjaGVkKGNvbnRlbnRSZWYudmFsdWUhKVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4gW1xuICAgICAgaCgnZGl2JywgeyBjbGFzczogeyAndi1tZW51JzogdHJ1ZSB9IH0pLFxuICAgICAgc2xvdHMuYWN0aXZhdG9yICYmIGdlbkFjdGl2YXRvclNsb3QoKSxcbiAgICAgIHVzZVRyYW5zaXRpb24oZ2VuQ29udGVudFNsb3QoKSwgJ2ZhZGUnKSxcbiAgICBdXG4gIH0sXG59KVxuIl19