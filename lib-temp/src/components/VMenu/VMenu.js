import { defineComponent, watch, h, withDirectives, computed, onMounted, onBeforeUnmount, vShow, } from 'vue';
import { autoPositionProps, useAutoPosition, } from '../../composable/use-auto-position';
import { activatorProps, useActivator } from '../../composable/use-activator';
import { useDetach } from '../../composable/use-detach';
import { useElevation } from '../../composable/use-elevation';
import { useToggle } from '../../composable/use-toggle';
import { useTransition } from '../../composable/use-transition';
import { positionProps } from '../../composable/use-position';
import { convertToUnit } from '../../helpers';
import { clickOutside, resize } from '../../directives';
export const VMenu = defineComponent({
    name: 'v-menu',
    directives: {
        clickOutside,
        resize,
    },
    props: {
        maxHeight: {
            type: [Number, String],
            default: 200,
        },
        width: {
            type: [Number, String],
            default: 0,
        },
        zIndex: {
            type: [String, Number],
            default: 10,
        },
        openOnHover: Boolean,
        openOnClick: Boolean,
        openOnContextmenu: Boolean,
        closeOnClick: {
            type: Boolean,
            default: true,
        },
        elevation: {
            type: [Number, String],
            default: 10,
        },
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        modelValue: Boolean,
        inputActivator: {
            type: String,
            default: '',
        },
        ...positionProps(),
        ...autoPositionProps(),
        ...activatorProps(),
    },
    emits: ['show', 'hide'],
    setup(props, { emit, slots }) {
        const { elevationClasses } = useElevation(props);
        const { isActive } = useToggle(props);
        const { contentRef, setDimensions, dimensions } = useAutoPosition(props);
        const { setDetached, removeDetached } = useDetach();
        const { activatorRef, getActivator, genActivatorListeners, addActivatorEvents, removeActivatorEvents, } = useActivator(props);
        const setDimensionsOn = (e, flag) => {
            setDimensions(getActivator(e)).then(() => {
                requestAnimationFrame(() => (isActive.value = flag));
            });
        };
        const handlers = {
            click: (e) => setDimensionsOn(e, props.openOnClick),
            mouseenter: (e) => setDimensionsOn(e, props.openOnHover),
            mouseleave: (e) => setDimensionsOn(e, !props.openOnHover),
            contextmenu: (e) => setDimensionsOn(e, props.openOnContextmenu),
        };
        const listeners = genActivatorListeners(props, handlers);
        const directive = computed(() => {
            return isActive.value
                ? {
                    handler: () => (isActive.value = false),
                    closeConditional: props.closeOnClick,
                }
                : undefined;
        });
        const calcWidth = computed(() => {
            return props.width || +dimensions.content.width;
        });
        watch(isActive, (to) => {
            to && emit('show');
            !to && emit('hide');
        });
        watch(() => [props.positionY, props.positionX], () => setDimensions(activatorRef.value));
        watch(() => props.modelValue, (to) => {
            isActive.value = false;
            setTimeout(() => (isActive.value = to));
        });
        const contentClasses = computed(() => ({
            'v-menu__content': true,
            ...elevationClasses.value,
        }));
        const contentStyles = computed(() => ({
            top: convertToUnit(dimensions.content.top),
            left: convertToUnit(dimensions.content.left),
            zIndex: props.zIndex,
        }));
        const onContentClick = () => {
            isActive.value = !props.closeOnClick;
        };
        const onResize = () => {
            if (!isActive.value)
                return;
            requestAnimationFrame(() => setDimensions(activatorRef.value));
        };
        const genActivatorSlot = () => {
            if (slots.activator) {
                const slotContent = slots.activator({ on: listeners });
                if (typeof slotContent[0].type === 'object') {
                    return h('div', { ref: activatorRef }, h(slotContent[0]));
                }
                return h(slotContent[0], { ref: activatorRef });
            }
            return null;
        };
        const genContentSlot = () => {
            const propsData = {
                ref: contentRef,
                class: contentClasses.value,
                style: contentStyles.value,
                onClick: onContentClick,
            };
            const slotContent = h('div', {
                class: 'v-menu__slot',
                style: {
                    maxHeight: convertToUnit(props.maxHeight),
                    width: convertToUnit(calcWidth.value),
                },
            }, [slots.default && slots.default()]);
            const content = h('div', propsData, slotContent);
            const directives = [
                [vShow, isActive.value],
                [resize, onResize],
                [clickOutside, directive.value],
            ];
            return withDirectives(content, directives);
        };
        onMounted(() => {
            activatorRef.value = getActivator();
            addActivatorEvents();
            setDetached(contentRef.value);
        });
        onBeforeUnmount(() => {
            removeActivatorEvents();
            removeDetached(contentRef.value);
        });
        return () => [
            h('div', { class: { 'v-menu': true } }),
            slots.activator && genActivatorSlot(),
            useTransition(genContentSlot(), 'fade'),
        ];
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WTWVudS9WTWVudS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLEtBQUssRUFDTCxDQUFDLEVBQ0QsY0FBYyxFQUNkLFFBQVEsRUFDUixTQUFTLEVBQ1QsZUFBZSxFQUNmLEtBQUssR0FHTixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsZUFBZSxHQUNoQixNQUFNLG9DQUFvQyxDQUFBO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0NBQWdDLENBQUE7QUFDN0UsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBQ3ZELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFDdkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQTtBQUc3RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFJdkQsTUFBTSxDQUFDLE1BQU0sS0FBSyxHQUFHLGVBQWUsQ0FBQztJQUNuQyxJQUFJLEVBQUUsUUFBUTtJQUNkLFVBQVUsRUFBRTtRQUNWLFlBQVk7UUFDWixNQUFNO0tBQ1A7SUFDRCxLQUFLLEVBQUU7UUFDTCxTQUFTLEVBQUU7WUFDVCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxHQUFHO1NBQ2I7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFB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RUFBRSxDQUFBO1lBQ3ZCLGNBQWMsQ0FBQyxVQUFVLENBQUMsS0FBTSxDQUFDLENBQUE7UUFDbkMsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ1gsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ3ZDLEtBQUssQ0FBQyxTQUFTLElBQUksZ0JBQWdCLEVBQUU7WUFDckMsYUFBYSxDQUFDLGNBQWMsRUFBRSxFQUFFLE1BQU0sQ0FBQztTQUN4QyxDQUFBO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7XG4gIGRlZmluZUNvbXBvbmVudCxcbiAgd2F0Y2gsXG4gIGgsXG4gIHdpdGhEaXJlY3RpdmVzLFxuICBjb21wdXRlZCxcbiAgb25Nb3VudGVkLFxuICBvbkJlZm9yZVVubW91bnQsXG4gIHZTaG93LFxuICBWTm9kZSxcbiAgRGlyZWN0aXZlQXJndW1lbnRzLFxufSBmcm9tICd2dWUnXG5cbi8vIENvbXBvc2FibGVcbmltcG9ydCB7XG4gIGF1dG9Qb3NpdGlvblByb3BzLFxuICB1c2VBdXRvUG9zaXRpb24sXG59IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWF1dG8tcG9zaXRpb24nXG5pbXBvcnQgeyBhY3RpdmF0b3JQcm9wcywgdXNlQWN0aXZhdG9yIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZS91c2UtYWN0aXZhdG9yJ1xuaW1wb3J0IHsgdXNlRGV0YWNoIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZS91c2UtZGV0YWNoJ1xuaW1wb3J0IHsgdXNlRWxldmF0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZS91c2UtZWxldmF0aW9uJ1xuaW1wb3J0IHsgdXNlVG9nZ2xlIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZS91c2UtdG9nZ2xlJ1xuaW1wb3J0IHsgdXNlVHJhbnNpdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLXRyYW5zaXRpb24nXG5pbXBvcnQgeyBwb3NpdGlvblByb3BzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZS91c2UtcG9zaXRpb24nXG5cbi8vIEhlbHBlcnNcbmltcG9ydCB7IGNvbnZlcnRUb1VuaXQgfSBmcm9tICcuLi8uLi9oZWxwZXJzJ1xuXG4vLyBEaXJlY3RpdmVzXG5pbXBvcnQgeyBjbGlja091dHNpZGUsIHJlc2l6ZSB9IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMnXG5cbmltcG9ydCB7IE1heWJlIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMvYmFzZSdcblxuZXhwb3J0IGNvbnN0IFZNZW51ID0gZGVmaW5lQ29tcG9uZW50KHtcbiAgbmFtZTogJ3YtbWVudScsXG4gIGRpcmVjdGl2ZXM6IHtcbiAgICBjbGlja091dHNpZGUsXG4gICAgcmVzaXplLFxuICB9LFxuICBwcm9wczoge1xuICAgIG1heEhlaWdodDoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDIwMCxcbiAgICB9LFxuICAgIHdpZHRoOiB7XG4gICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgICAgZGVmYXVsdDogMCxcbiAgICB9LFxuICAgIHpJbmRleDoge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDEwLFxuICAgIH0sXG4gICAgb3Blbk9uSG92ZXI6IEJvb2xlYW4sXG4gICAgb3Blbk9uQ2xpY2s6IEJvb2xlYW4sXG4gICAgb3Blbk9uQ29udGV4dG1lbnU6IEJvb2xlYW4sXG4gICAgY2xvc2VPbkNsaWNrOiB7XG4gICAgICB0eXBlOiBCb29sZWFuLFxuICAgICAgZGVmYXVsdDogdHJ1ZSxcbiAgICB9LFxuICAgIGVsZXZhdGlvbjoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDEwLFxuICAgIH0sXG4gICAgb2Zmc2V0WDoge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDIwLFxuICAgIH0sXG4gICAgb2Zmc2V0WToge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDIwLFxuICAgIH0sXG4gICAgbW9kZWxWYWx1ZTogQm9vbGVhbixcbiAgICBpbnB1dEFjdGl2YXRvcjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICAuLi5wb3NpdGlvblByb3BzKCksXG4gICAgLi4uYXV0b1Bvc2l0aW9uUHJvcHMoKSxcbiAgICAuLi5hY3RpdmF0b3JQcm9wcygpLFxuICB9LFxuXG4gIGVtaXRzOiBbJ3Nob3cnLCAnaGlkZSddLFxuXG4gIHNldHVwKHByb3BzLCB7IGVtaXQsIHNsb3RzIH0pIHtcbiAgICBjb25zdCB7IGVsZXZhdGlvbkNsYXNzZXMgfSA9IHVzZUVsZXZhdGlvbihwcm9wcylcbiAgICBjb25zdCB7IGlzQWN0aXZlIH0gPSB1c2VUb2dnbGUocHJvcHMpXG4gICAgY29uc3QgeyBjb250ZW50UmVmLCBzZXREaW1lbnNpb25zLCBkaW1lbnNpb25zIH0gPSB1c2VBdXRvUG9zaXRpb24ocHJvcHMpXG4gICAgY29uc3QgeyBzZXREZXRhY2hlZCwgcmVtb3ZlRGV0YWNoZWQgfSA9IHVzZURldGFjaCgpXG4gICAgY29uc3Qge1xuICAgICAgYWN0aXZhdG9yUmVmLFxuICAgICAgZ2V0QWN0aXZhdG9yLFxuICAgICAgZ2VuQWN0aXZhdG9yTGlzdGVuZXJzLFxuICAgICAgYWRkQWN0aXZhdG9yRXZlbnRzLFxuICAgICAgcmVtb3ZlQWN0aXZhdG9yRXZlbnRzLFxuICAgIH0gPSB1c2VBY3RpdmF0b3IocHJvcHMpXG5cbiAgICBjb25zdCBzZXREaW1lbnNpb25zT24gPSAoZSwgZmxhZykgPT4ge1xuICAgICAgc2V0RGltZW5zaW9ucyhnZXRBY3RpdmF0b3IoZSkhKS50aGVuKCgpID0+IHtcbiAgICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IChpc0FjdGl2ZS52YWx1ZSA9IGZsYWcpKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBoYW5kbGVycyA9IHtcbiAgICAgIGNsaWNrOiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsIHByb3BzLm9wZW5PbkNsaWNrKSxcbiAgICAgIG1vdXNlZW50ZXI6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgcHJvcHMub3Blbk9uSG92ZXIpLFxuICAgICAgbW91c2VsZWF2ZTogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCAhcHJvcHMub3Blbk9uSG92ZXIpLFxuICAgICAgY29udGV4dG1lbnU6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgcHJvcHMub3Blbk9uQ29udGV4dG1lbnUpLFxuICAgIH1cblxuICAgIGNvbnN0IGxpc3RlbmVycyA9IGdlbkFjdGl2YXRvckxpc3RlbmVycyhwcm9wcywgaGFuZGxlcnMpXG5cbiAgICBjb25zdCBkaXJlY3RpdmUgPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgICByZXR1cm4gaXNBY3RpdmUudmFsdWVcbiAgICAgICAgPyB7XG4gICAgICAgICAgICBoYW5kbGVyOiAoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSBmYWxzZSksXG4gICAgICAgICAgICBjbG9zZUNvbmRpdGlvbmFsOiBwcm9wcy5jbG9zZU9uQ2xpY2ssXG4gICAgICAgICAgfVxuICAgICAgICA6IHVuZGVmaW5lZFxuICAgIH0pXG5cbiAgICBjb25zdCBjYWxjV2lkdGggPSBjb21wdXRlZDxudW1iZXIgfCBzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy53aWR0aCB8fCArZGltZW5zaW9ucy5jb250ZW50LndpZHRoXG4gICAgfSlcblxuICAgIHdhdGNoKGlzQWN0aXZlLCAodG8pID0+IHtcbiAgICAgIHRvICYmIGVtaXQoJ3Nob3cnKVxuICAgICAgIXRvICYmIGVtaXQoJ2hpZGUnKVxuICAgIH0pXG5cbiAgICB3YXRjaChcbiAgICAgICgpID0+IFtwcm9wcy5wb3NpdGlvblksIHByb3BzLnBvc2l0aW9uWF0sXG4gICAgICAoKSA9PiBzZXREaW1lbnNpb25zKGFjdGl2YXRvclJlZi52YWx1ZSEpXG4gICAgKVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5tb2RlbFZhbHVlLFxuICAgICAgKHRvKSA9PiB7XG4gICAgICAgIGlzQWN0aXZlLnZhbHVlID0gZmFsc2VcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSB0bykpXG4gICAgICB9XG4gICAgKVxuXG4gICAgY29uc3QgY29udGVudENsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4gKHtcbiAgICAgICd2LW1lbnVfX2NvbnRlbnQnOiB0cnVlLFxuICAgICAgLi4uZWxldmF0aW9uQ2xhc3Nlcy52YWx1ZSxcbiAgICB9KSlcblxuICAgIGNvbnN0IGNvbnRlbnRTdHlsZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBudW1iZXI+PigoKSA9PiAoe1xuICAgICAgdG9wOiBjb252ZXJ0VG9Vbml0KGRpbWVuc2lvbnMuY29udGVudC50b3ApISxcbiAgICAgIGxlZnQ6IGNvbnZlcnRUb1VuaXQoZGltZW5zaW9ucy5jb250ZW50LmxlZnQpISxcbiAgICAgIHpJbmRleDogcHJvcHMuekluZGV4LFxuICAgIH0pKSBhcyBhbnlcblxuICAgIGNvbnN0IG9uQ29udGVudENsaWNrID0gKCkgPT4ge1xuICAgICAgaXNBY3RpdmUudmFsdWUgPSAhcHJvcHMuY2xvc2VPbkNsaWNrXG4gICAgfVxuXG4gICAgY29uc3Qgb25SZXNpemUgPSAoKSA9PiB7XG4gICAgICBpZiAoIWlzQWN0aXZlLnZhbHVlKSByZXR1cm5cbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBzZXREaW1lbnNpb25zKGFjdGl2YXRvclJlZi52YWx1ZSEpKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkFjdGl2YXRvclNsb3QgPSAoKTogTWF5YmU8Vk5vZGU+ID0+IHtcbiAgICAgIGlmIChzbG90cy5hY3RpdmF0b3IpIHtcbiAgICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPSBzbG90cy5hY3RpdmF0b3IoeyBvbjogbGlzdGVuZXJzIH0pXG5cbiAgICAgICAgaWYgKHR5cGVvZiBzbG90Q29udGVudCFbMF0udHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICByZXR1cm4gaCgnZGl2JywgeyByZWY6IGFjdGl2YXRvclJlZiB9LCBoKHNsb3RDb250ZW50IVswXSkpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaChzbG90Q29udGVudCFbMF0sIHsgcmVmOiBhY3RpdmF0b3JSZWYgfSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBnZW5Db250ZW50U2xvdCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIHJlZjogY29udGVudFJlZixcbiAgICAgICAgY2xhc3M6IGNvbnRlbnRDbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogY29udGVudFN0eWxlcy52YWx1ZSxcbiAgICAgICAgb25DbGljazogb25Db250ZW50Q2xpY2ssXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNsb3RDb250ZW50ID0gaChcbiAgICAgICAgJ2RpdicsXG4gICAgICAgIHtcbiAgICAgICAgICBjbGFzczogJ3YtbWVudV9fc2xvdCcsXG4gICAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAgIG1heEhlaWdodDogY29udmVydFRvVW5pdChwcm9wcy5tYXhIZWlnaHQpLFxuICAgICAgICAgICAgd2lkdGg6IGNvbnZlcnRUb1VuaXQoY2FsY1dpZHRoLnZhbHVlKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBbc2xvdHMuZGVmYXVsdCAmJiBzbG90cy5kZWZhdWx0KCldXG4gICAgICApXG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBoKCdkaXYnLCBwcm9wc0RhdGEsIHNsb3RDb250ZW50KVxuXG4gICAgICBjb25zdCBkaXJlY3RpdmVzOiBEaXJlY3RpdmVBcmd1bWVudHMgPSBbXG4gICAgICAgIFt2U2hvdywgaXNBY3RpdmUudmFsdWVdLFxuICAgICAgICBbcmVzaXplLCBvblJlc2l6ZV0sXG4gICAgICAgIFtjbGlja091dHNpZGUsIGRpcmVjdGl2ZS52YWx1ZV0sXG4gICAgICBdXG5cbiAgICAgIHJldHVybiB3aXRoRGlyZWN0aXZlcyhjb250ZW50LCBkaXJlY3RpdmVzKVxuICAgIH1cblxuICAgIG9uTW91bnRlZCgoKSA9PiB7XG4gICAgICBhY3RpdmF0b3JSZWYudmFsdWUgPSBnZXRBY3RpdmF0b3IoKVxuXG4gICAgICBhZGRBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgc2V0RGV0YWNoZWQoY29udGVudFJlZi52YWx1ZSEpXG4gICAgfSlcblxuICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7XG4gICAgICByZW1vdmVBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgcmVtb3ZlRGV0YWNoZWQoY29udGVudFJlZi52YWx1ZSEpXG4gICAgfSlcblxuICAgIHJldHVybiAoKSA9PiBbXG4gICAgICBoKCdkaXYnLCB7IGNsYXNzOiB7ICd2LW1lbnUnOiB0cnVlIH0gfSksXG4gICAgICBzbG90cy5hY3RpdmF0b3IgJiYgZ2VuQWN0aXZhdG9yU2xvdCgpLFxuICAgICAgdXNlVHJhbnNpdGlvbihnZW5Db250ZW50U2xvdCgpLCAnZmFkZScpLFxuICAgIF1cbiAgfSxcbn0pXG4iXX0=