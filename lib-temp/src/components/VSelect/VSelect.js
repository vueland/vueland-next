import './VSelect.scss';
import { h, reactive, computed, defineComponent, withDirectives, watch, inject, onBeforeUnmount, } from 'vue';
import { validateProps, useValidate } from '../../effects/use-validate';
import { colorProps, useColors } from '../../effects/use-colors';
import { VInput } from '../VInput';
import { VSelectList } from './VSelectList';
import { vClickOutside } from '../../directives';
export const VSelect = defineComponent({
    name: 'v-select',
    props: {
        label: String,
        items: Array,
        dark: Boolean,
        valueKey: String,
        idKey: String,
        listColor: String,
        disabled: Boolean,
        readonly: Boolean,
        modelValue: [Array, String, Object],
        ...validateProps(),
        ...colorProps(),
    },
    setup(props, { emit, attrs }) {
        const state = reactive({
            selected: null,
            focused: false,
            isMenuActive: false,
        });
        const { setTextColor } = useColors();
        const { validate, dirty, update, errorState, validateClasses, validationState, } = useValidate(props);
        const fields = inject('fields');
        const validateValue = () => {
            return props.rules?.length && validate(state.selected || props.modelValue);
        };
        const directive = computed(() => {
            return state.focused ? {
                handler: onBlur,
                closeConditional: true,
            } : undefined;
        });
        const classes = computed(() => ({
            'v-select': true,
            'v-select--disabled': props.disabled,
            'v-select--focused': state.focused,
            ...validateClasses.value,
        }));
        watch(() => props.modelValue, value => (state.selected = value), { immediate: true });
        if (fields?.value && props.rules?.length) {
            fields.value.push(validateValue);
        }
        function toggleState() {
            state.focused = !state.focused;
            state.isMenuActive = !state.isMenuActive;
        }
        function onBlur() {
            requestAnimationFrame(validateValue);
            setTimeout(toggleState, 50);
            emit('blur');
        }
        function onClick() {
            dirty();
            update(errorState.innerError);
            toggleState();
            emit('focus');
        }
        function selectItem(it) {
            state.selected = it;
            emit('select', it);
            emit('update:modelValue', it);
        }
        function genInput() {
            const selectedValue = typeof state.selected === 'string' ?
                state.selected : state.selected[props.valueKey];
            const color = props.dark ? 'white' : '';
            const propsData = {
                value: selectedValue,
                disabled: props.disabled,
                readonly: props.readonly,
                class: {
                    'v-select__input': true,
                },
                ...attrs,
                onClick,
            };
            return h('input', setTextColor(color, propsData));
        }
        function genSelectList() {
            const propsData = {
                items: props.items,
                valueKey: props.valueKey,
                idKey: props.idKey,
                active: state.isMenuActive,
                color: props.dark ? 'white' : '',
                listColor: props.listColor,
                onSelect: it => selectItem(it),
            };
            return h(VSelectList, propsData);
        }
        function genSelect() {
            const selectVNode = h('div', {
                class: classes.value,
            }, [genInput(), genSelectList()]);
            return withDirectives(selectVNode, [[vClickOutside, directive.value]]);
        }
        onBeforeUnmount(() => {
            if (fields.value) {
                fields.value = fields.value.filter(v => v !== validateValue);
            }
        });
        return () => {
            const propsData = {
                label: props.label,
                focused: state.focused,
                hasState: !!state.selected,
                hasError: errorState.innerError,
                dark: !!props.dark,
                color: validationState.value,
                disabled: !!props.disabled,
                isDirty: !!errorState.isDirty,
                message: errorState.innerErrorMessage,
            };
            return h(VInput, propsData, {
                select: () => (props.items?.length ? genSelect() : null),
            });
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlNlbGVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZTZWxlY3QvVlNlbGVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLGdCQUFnQixDQUFBO0FBR3ZCLE9BQU8sRUFDTCxDQUFDLEVBQ0QsUUFBUSxFQUNSLFFBQVEsRUFDUixlQUFlLEVBQ2YsY0FBYyxFQUNkLEtBQUssRUFDTCxNQUFNLEVBQ04sZUFBZSxHQUNoQixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUE7QUFDdkUsT0FBTyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQTtBQU1oRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFHM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBU2hELE1BQU0sQ0FBQyxNQUFNLE9BQU8sR0FBRyxlQUFlLENBQUM7SUFDckMsSUFBSSxFQUFFLFVBQVU7SUFFaEIsS0FBSyxFQUFFO1FBQ0wsS0FBSyxFQUFFLE1BQU07UUFDYixLQUFLLEVBQUUsS0FBSztRQUNaLElBQUksRUFBRSxPQUFPO1FBQ2IsUUFBUSxFQUFFLE1BQU07UUFDaEIsS0FBSyxFQUFFLE1BQU07UUFDYixTQUFTLEVBQUUsTUFBTTtRQUNqQixRQUFRLEVBQUUsT0FBTztRQUNqQixRQUFRLEVBQUUsT0FBTztRQUNqQixVQUFVLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQztRQUNuQyxHQUFHLGFBQWEsRUFBRTtRQUNsQixHQUFHLFVBQVUsRUFBRTtLQUNUO0lBRVIsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUU7UUFDMUIsTUFBTSxLQUFLLEdBQWdCLFFBQVEsQ0FBQztZQUNsQyxRQUFRLEVBQUUsSUFBSTtZQUNkLE9BQU8sRUFBRSxLQUFLO1lBQ2QsWUFBWSxFQUFFLEtBQUs7U0FDcEIsQ0FBQyxDQUFBO1FBRUYsTUFBTSxFQUFFLFlBQVksRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFBO1FBRXBDLE1BQU0sRUFDSixRQUFRLEVBQ1IsS0FBSyxFQUNMLE1BQU0sRUFDTixVQUFVLEVBQ1YsZUFBZSxFQUNmLGVBQWUsR0FDaEIsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFdEIsTUFBTSxNQUFNLEdBQTJCLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUV2RCxNQUFNLGFBQWEsR0FBRyxHQUFHLEVBQUU7WUFDekIsT0FBTyxLQUFLLENBQUMsS0FBSyxFQUFFLE1BQU0sSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDNUUsQ0FBQyxDQUFBO1FBRUQsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUM5QixPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNyQixPQUFPLEVBQUUsTUFBTTtnQkFDZixnQkFBZ0IsRUFBRSxJQUFJO2FBQ3ZCLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQTtRQUNmLENBQUMsQ0FBQyxDQUFBO1FBRUYsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUEwQixHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELFVBQVUsRUFBRSxJQUFJO1lBQ2hCLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxRQUFRO1lBQ3BDLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxPQUFPO1lBQ2xDLEdBQUcsZUFBZSxDQUFDLEtBQUs7U0FDekIsQ0FBQyxDQUFDLENBQUE7UUFFSCxLQUFLLENBQ0gsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLFVBQVUsRUFDdEIsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLEdBQUcsS0FBWSxDQUFDLEVBQ3hDLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxDQUNwQixDQUFBO1FBRUQsSUFBSSxNQUFNLEVBQUUsS0FBSyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFO1lBQ3hDLE1BQU8sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1NBQ2xDO1FBRUQsU0FBUyxXQUFXO1lBQ2xCLEtBQUssQ0FBQyxPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFBO1lBQzlCLEtBQUssQ0FBQyxZQUFZLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFBO1FBQzFDLENBQUM7UUFFRCxTQUFTLE1BQU07WUFDYixxQkFBcUIsQ0FBQyxhQUFhLENBQUMsQ0FBQTtZQUNwQyxVQUFVLENBQUMsV0FBVyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1lBQzNCLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNkLENBQUM7UUFFRCxTQUFTLE9BQU87WUFDZCxLQUFLLEVBQUUsQ0FBQTtZQUNQLE1BQU0sQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDN0IsV0FBVyxFQUFFLENBQUE7WUFDYixJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDZixDQUFDO1FBRUQsU0FBUyxVQUFVLENBQUMsRUFBRTtZQUNwQixLQUFLLENBQUMsUUFBUSxHQUFHLEVBQUUsQ0FBQTtZQUNuQixJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1lBQ2xCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUMvQixDQUFDO1FBRUQsU0FBUyxRQUFRO1lBQ2YsTUFBTSxhQUFhLEdBQUcsT0FBTyxLQUFLLENBQUMsUUFBUSxLQUFLLFFBQVEsQ0FBQyxDQUFDO2dCQUN4RCxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxRQUFrQixDQUFDLENBQUE7WUFFM0QsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7WUFFdkMsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLEtBQUssRUFBRSxhQUFhO2dCQUNwQixRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVE7Z0JBQ3hCLFFBQVEsRUFBRSxLQUFLLENBQUMsUUFBUTtnQkFDeEIsS0FBSyxFQUFFO29CQUNMLGlCQUFpQixFQUFFLElBQUk7aUJBQ3hCO2dCQUNELEdBQUcsS0FBSztnQkFDUixPQUFPO2FBQ1IsQ0FBQTtZQUNELE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxZQUFZLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUE7UUFDbkQsQ0FBQztRQUVELFNBQVMsYUFBYTtZQUNwQixNQUFNLFNBQVMsR0FBRztnQkFDaEIsS0FBSyxFQUFFLEtBQUssQ0FBQyxLQUFLO2dCQUNsQixRQUFRLEVBQUUsS0FBSyxDQUFDLFFBQVE7Z0JBQ3hCLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSztnQkFDbEIsTUFBTSxFQUFFLEtBQUssQ0FBQyxZQUFZO2dCQUMxQixLQUFLLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNoQyxTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVM7Z0JBQzFCLFFBQVEsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUM7YUFDL0IsQ0FBQTtZQUNELE9BQU8sQ0FBQyxDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQTtRQUNsQyxDQUFDO1FBRUQsU0FBUyxTQUFTO1lBQ2hCLE1BQU0sV0FBVyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUU7Z0JBQ3pCLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSzthQUNyQixFQUNELENBQUMsUUFBUSxFQUFFLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FDOUIsQ0FBQTtZQUVELE9BQU8sY0FBYyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsYUFBYSxFQUFFLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDeEUsQ0FBQztRQUVELGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIsSUFBSSxNQUFPLENBQUMsS0FBSyxFQUFFO2dCQUNqQixNQUFPLENBQUMsS0FBSyxHQUFHLE1BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLGFBQWEsQ0FBQyxDQUFBO2FBQy9EO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLEdBQUcsRUFBRTtZQUNWLE1BQU0sU0FBUyxHQUFHO2dCQUNoQixLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUs7Z0JBQ2xCLE9BQU8sRUFBRSxLQUFLLENBQUMsT0FBTztnQkFDdEIsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUTtnQkFDMUIsUUFBUSxFQUFFLFVBQVUsQ0FBQyxVQUFVO2dCQUMvQixJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJO2dCQUNsQixLQUFLLEVBQUUsZUFBZSxDQUFDLEtBQUs7Z0JBQzVCLFFBQVEsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLFFBQVE7Z0JBQzFCLE9BQU8sRUFBRSxDQUFDLENBQUMsVUFBVSxDQUFDLE9BQU87Z0JBQzdCLE9BQU8sRUFBRSxVQUFVLENBQUMsaUJBQWlCO2FBQy9CLENBQUE7WUFFUixPQUFPLENBQUMsQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFO2dCQUN4QixNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQzthQUN6RCxDQUNGLENBQUE7UUFDSCxDQUFDLENBQUE7SUFFSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gU3R5bGVzXG5pbXBvcnQgJy4vVlNlbGVjdC5zY3NzJ1xuXG4vLyBWdWUgQVBJXG5pbXBvcnQge1xuICBoLFxuICByZWFjdGl2ZSxcbiAgY29tcHV0ZWQsXG4gIGRlZmluZUNvbXBvbmVudCxcbiAgd2l0aERpcmVjdGl2ZXMsXG4gIHdhdGNoLFxuICBpbmplY3QsXG4gIG9uQmVmb3JlVW5tb3VudCxcbn0gZnJvbSAndnVlJ1xuXG4vLyBFZmZlY3RzXG5pbXBvcnQgeyB2YWxpZGF0ZVByb3BzLCB1c2VWYWxpZGF0ZSB9IGZyb20gJy4uLy4uL2VmZmVjdHMvdXNlLXZhbGlkYXRlJ1xuaW1wb3J0IHsgY29sb3JQcm9wcywgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vZWZmZWN0cy91c2UtY29sb3JzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUsIFJlZiB9IGZyb20gJ3Z1ZSdcblxuLy8gQ29tcG9uZW50c1xuaW1wb3J0IHsgVklucHV0IH0gZnJvbSAnLi4vVklucHV0J1xuaW1wb3J0IHsgVlNlbGVjdExpc3QgfSBmcm9tICcuL1ZTZWxlY3RMaXN0J1xuXG4vLyBEaXJlY3RpdmVzXG5pbXBvcnQgeyB2Q2xpY2tPdXRzaWRlIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcydcblxuXG50eXBlIFNlbGVjdFN0YXRlID0ge1xuICBzZWxlY3RlZDogYW55IHwgbnVsbFxuICBmb2N1c2VkOiBib29sZWFuXG4gIGlzTWVudUFjdGl2ZTogYm9vbGVhblxufVxuXG5leHBvcnQgY29uc3QgVlNlbGVjdCA9IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LXNlbGVjdCcsXG5cbiAgcHJvcHM6IHtcbiAgICBsYWJlbDogU3RyaW5nLFxuICAgIGl0ZW1zOiBBcnJheSxcbiAgICBkYXJrOiBCb29sZWFuLFxuICAgIHZhbHVlS2V5OiBTdHJpbmcsXG4gICAgaWRLZXk6IFN0cmluZyxcbiAgICBsaXN0Q29sb3I6IFN0cmluZyxcbiAgICBkaXNhYmxlZDogQm9vbGVhbixcbiAgICByZWFkb25seTogQm9vbGVhbixcbiAgICBtb2RlbFZhbHVlOiBbQXJyYXksIFN0cmluZywgT2JqZWN0XSxcbiAgICAuLi52YWxpZGF0ZVByb3BzKCksXG4gICAgLi4uY29sb3JQcm9wcygpLFxuICB9IGFzIGFueSxcblxuICBzZXR1cChwcm9wcywgeyBlbWl0LCBhdHRycyB9KTogKCkgPT4gVk5vZGUge1xuICAgIGNvbnN0IHN0YXRlOiBTZWxlY3RTdGF0ZSA9IHJlYWN0aXZlKHtcbiAgICAgIHNlbGVjdGVkOiBudWxsLFxuICAgICAgZm9jdXNlZDogZmFsc2UsXG4gICAgICBpc01lbnVBY3RpdmU6IGZhbHNlLFxuICAgIH0pXG5cbiAgICBjb25zdCB7IHNldFRleHRDb2xvciB9ID0gdXNlQ29sb3JzKClcblxuICAgIGNvbnN0IHtcbiAgICAgIHZhbGlkYXRlLFxuICAgICAgZGlydHksXG4gICAgICB1cGRhdGUsXG4gICAgICBlcnJvclN0YXRlLFxuICAgICAgdmFsaWRhdGVDbGFzc2VzLFxuICAgICAgdmFsaWRhdGlvblN0YXRlLFxuICAgIH0gPSB1c2VWYWxpZGF0ZShwcm9wcylcblxuICAgIGNvbnN0IGZpZWxkczogUmVmPGFueVtdPiB8IHVuZGVmaW5lZCA9IGluamVjdCgnZmllbGRzJylcblxuICAgIGNvbnN0IHZhbGlkYXRlVmFsdWUgPSAoKSA9PiB7XG4gICAgICByZXR1cm4gcHJvcHMucnVsZXM/Lmxlbmd0aCAmJiB2YWxpZGF0ZShzdGF0ZS5zZWxlY3RlZCB8fCBwcm9wcy5tb2RlbFZhbHVlKVxuICAgIH1cblxuICAgIGNvbnN0IGRpcmVjdGl2ZSA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICAgIHJldHVybiBzdGF0ZS5mb2N1c2VkID8ge1xuICAgICAgICBoYW5kbGVyOiBvbkJsdXIsXG4gICAgICAgIGNsb3NlQ29uZGl0aW9uYWw6IHRydWUsXG4gICAgICB9IDogdW5kZWZpbmVkXG4gICAgfSlcblxuICAgIGNvbnN0IGNsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4gKHtcbiAgICAgICd2LXNlbGVjdCc6IHRydWUsXG4gICAgICAndi1zZWxlY3QtLWRpc2FibGVkJzogcHJvcHMuZGlzYWJsZWQsXG4gICAgICAndi1zZWxlY3QtLWZvY3VzZWQnOiBzdGF0ZS5mb2N1c2VkLFxuICAgICAgLi4udmFsaWRhdGVDbGFzc2VzLnZhbHVlLFxuICAgIH0pKVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5tb2RlbFZhbHVlLFxuICAgICAgdmFsdWUgPT4gKHN0YXRlLnNlbGVjdGVkID0gdmFsdWUgYXMgYW55KSxcbiAgICAgIHsgaW1tZWRpYXRlOiB0cnVlIH0sXG4gICAgKVxuXG4gICAgaWYgKGZpZWxkcz8udmFsdWUgJiYgcHJvcHMucnVsZXM/Lmxlbmd0aCkge1xuICAgICAgZmllbGRzIS52YWx1ZS5wdXNoKHZhbGlkYXRlVmFsdWUpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gdG9nZ2xlU3RhdGUoKSB7XG4gICAgICBzdGF0ZS5mb2N1c2VkID0gIXN0YXRlLmZvY3VzZWRcbiAgICAgIHN0YXRlLmlzTWVudUFjdGl2ZSA9ICFzdGF0ZS5pc01lbnVBY3RpdmVcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBvbkJsdXIoKSB7XG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUodmFsaWRhdGVWYWx1ZSlcbiAgICAgIHNldFRpbWVvdXQodG9nZ2xlU3RhdGUsIDUwKVxuICAgICAgZW1pdCgnYmx1cicpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gb25DbGljaygpIHtcbiAgICAgIGRpcnR5KClcbiAgICAgIHVwZGF0ZShlcnJvclN0YXRlLmlubmVyRXJyb3IpXG4gICAgICB0b2dnbGVTdGF0ZSgpXG4gICAgICBlbWl0KCdmb2N1cycpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2VsZWN0SXRlbShpdCkge1xuICAgICAgc3RhdGUuc2VsZWN0ZWQgPSBpdFxuICAgICAgZW1pdCgnc2VsZWN0JywgaXQpXG4gICAgICBlbWl0KCd1cGRhdGU6bW9kZWxWYWx1ZScsIGl0KVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdlbklucHV0KCk6IFZOb2RlIHtcbiAgICAgIGNvbnN0IHNlbGVjdGVkVmFsdWUgPSB0eXBlb2Ygc3RhdGUuc2VsZWN0ZWQgPT09ICdzdHJpbmcnID9cbiAgICAgICAgc3RhdGUuc2VsZWN0ZWQgOiBzdGF0ZS5zZWxlY3RlZFtwcm9wcy52YWx1ZUtleSBhcyBzdHJpbmddXG5cbiAgICAgIGNvbnN0IGNvbG9yID0gcHJvcHMuZGFyayA/ICd3aGl0ZScgOiAnJ1xuXG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIHZhbHVlOiBzZWxlY3RlZFZhbHVlLFxuICAgICAgICBkaXNhYmxlZDogcHJvcHMuZGlzYWJsZWQsXG4gICAgICAgIHJlYWRvbmx5OiBwcm9wcy5yZWFkb25seSxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1zZWxlY3RfX2lucHV0JzogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgLi4uYXR0cnMsXG4gICAgICAgIG9uQ2xpY2ssXG4gICAgICB9XG4gICAgICByZXR1cm4gaCgnaW5wdXQnLCBzZXRUZXh0Q29sb3IoY29sb3IsIHByb3BzRGF0YSkpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2VuU2VsZWN0TGlzdCgpOiBWTm9kZSB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGl0ZW1zOiBwcm9wcy5pdGVtcyxcbiAgICAgICAgdmFsdWVLZXk6IHByb3BzLnZhbHVlS2V5LFxuICAgICAgICBpZEtleTogcHJvcHMuaWRLZXksXG4gICAgICAgIGFjdGl2ZTogc3RhdGUuaXNNZW51QWN0aXZlLFxuICAgICAgICBjb2xvcjogcHJvcHMuZGFyayA/ICd3aGl0ZScgOiAnJyxcbiAgICAgICAgbGlzdENvbG9yOiBwcm9wcy5saXN0Q29sb3IsXG4gICAgICAgIG9uU2VsZWN0OiBpdCA9PiBzZWxlY3RJdGVtKGl0KSxcbiAgICAgIH1cbiAgICAgIHJldHVybiBoKFZTZWxlY3RMaXN0LCBwcm9wc0RhdGEpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2VuU2VsZWN0KCk6IFZOb2RlIHtcbiAgICAgIGNvbnN0IHNlbGVjdFZOb2RlID0gaCgnZGl2Jywge1xuICAgICAgICAgIGNsYXNzOiBjbGFzc2VzLnZhbHVlLFxuICAgICAgICB9LFxuICAgICAgICBbZ2VuSW5wdXQoKSwgZ2VuU2VsZWN0TGlzdCgpXSxcbiAgICAgIClcblxuICAgICAgcmV0dXJuIHdpdGhEaXJlY3RpdmVzKHNlbGVjdFZOb2RlLCBbW3ZDbGlja091dHNpZGUsIGRpcmVjdGl2ZS52YWx1ZV1dKVxuICAgIH1cblxuICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7XG4gICAgICBpZiAoZmllbGRzIS52YWx1ZSkge1xuICAgICAgICBmaWVsZHMhLnZhbHVlID0gZmllbGRzIS52YWx1ZS5maWx0ZXIodiA9PiB2ICE9PSB2YWxpZGF0ZVZhbHVlKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBsYWJlbDogcHJvcHMubGFiZWwsXG4gICAgICAgIGZvY3VzZWQ6IHN0YXRlLmZvY3VzZWQsXG4gICAgICAgIGhhc1N0YXRlOiAhIXN0YXRlLnNlbGVjdGVkLFxuICAgICAgICBoYXNFcnJvcjogZXJyb3JTdGF0ZS5pbm5lckVycm9yLFxuICAgICAgICBkYXJrOiAhIXByb3BzLmRhcmssXG4gICAgICAgIGNvbG9yOiB2YWxpZGF0aW9uU3RhdGUudmFsdWUsXG4gICAgICAgIGRpc2FibGVkOiAhIXByb3BzLmRpc2FibGVkLFxuICAgICAgICBpc0RpcnR5OiAhIWVycm9yU3RhdGUuaXNEaXJ0eSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3JTdGF0ZS5pbm5lckVycm9yTWVzc2FnZSxcbiAgICAgIH0gYXMgYW55XG5cbiAgICAgIHJldHVybiBoKFZJbnB1dCwgcHJvcHNEYXRhLCB7XG4gICAgICAgICAgc2VsZWN0OiAoKSA9PiAocHJvcHMuaXRlbXM/Lmxlbmd0aCA/IGdlblNlbGVjdCgpIDogbnVsbCksXG4gICAgICAgIH0sXG4gICAgICApXG4gICAgfVxuXG4gIH0sXG59KVxuIl19