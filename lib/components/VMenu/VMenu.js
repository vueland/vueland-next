import { defineComponent, watch, h, withDirectives, computed, onMounted, onBeforeUnmount, vShow, } from 'vue';
import { autoPositionProps, useAutoPosition, } from '../../composables/use-auto-position';
import { activatorProps, useActivator } from '../../composables/use-activator';
import { useDetach } from '../../composables/use-detach';
import { useElevation } from '../../composables/use-elevation';
import { useToggle } from '../../composables/use-toggle';
import { useTransition } from '../../composables/use-transition';
import { positionProps } from '../../composables/use-position';
import { convertToUnit } from '../../helpers';
import { clickOutside, resize } from '../../directives';
export default defineComponent({
    name: 'v-menu',
    directives: {
        clickOutside,
        resize,
    },
    props: {
        maxHeight: {
            type: [Number, String],
            default: 200,
        },
        width: {
            type: [Number, String],
            default: 0,
        },
        zIndex: {
            type: [String, Number],
            default: 10,
        },
        openOnHover: Boolean,
        openOnClick: Boolean,
        openOnContextmenu: Boolean,
        closeOnClick: {
            type: Boolean,
            default: true,
        },
        elevation: {
            type: [Number, String],
            default: 10,
        },
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        modelValue: Boolean,
        inputActivator: {
            type: String,
            default: '',
        },
        ...positionProps(),
        ...autoPositionProps(),
        ...activatorProps(),
    },
    emits: ['show', 'hide'],
    setup(props, { emit, slots }) {
        const { elevationClasses } = useElevation(props);
        const { isActive } = useToggle(props);
        const { contentRef, setDimensions, dimensions } = useAutoPosition(props);
        const { setDetached, removeDetached } = useDetach();
        const { activatorRef, getActivator, genActivatorListeners, addActivatorEvents, removeActivatorEvents, } = useActivator(props);
        const setDimensionsOn = (e, flag) => {
            setDimensions(getActivator(e)).then(() => {
                requestAnimationFrame(() => (isActive.value = flag));
            });
        };
        const handlers = {
            click: (e) => setDimensionsOn(e, props.openOnClick),
            mouseenter: (e) => setDimensionsOn(e, props.openOnHover),
            mouseleave: (e) => setDimensionsOn(e, !props.openOnHover),
            contextmenu: (e) => setDimensionsOn(e, props.openOnContextmenu),
        };
        const listeners = genActivatorListeners(props, handlers);
        const directive = computed(() => {
            return isActive.value
                ? {
                    handler: (e) => {
                        if (props.internalActivator &&
                            activatorRef.value.contains(e.target))
                            return;
                        isActive.value = false;
                    },
                    closeConditional: props.closeOnClick,
                }
                : undefined;
        });
        const calcWidth = computed(() => {
            return props.width || +dimensions.content.width;
        });
        watch(isActive, (to) => {
            to && emit('show');
            !to && emit('hide');
        });
        watch(() => [props.positionY, props.positionX], () => setDimensions(activatorRef.value));
        watch(() => props.modelValue, (to) => {
            isActive.value = false;
            setTimeout(() => (isActive.value = to));
        });
        const contentClasses = computed(() => ({
            'v-menu__content': true,
            ...elevationClasses.value,
        }));
        const contentStyles = computed(() => ({
            top: convertToUnit(dimensions.content.top),
            left: convertToUnit(dimensions.content.left),
            zIndex: props.zIndex,
        }));
        const onContentClick = () => {
            isActive.value = !props.closeOnClick;
        };
        const onResize = () => {
            if (!isActive.value)
                return;
            requestAnimationFrame(() => setDimensions(activatorRef.value));
        };
        const genActivatorSlot = () => {
            if (slots.activator) {
                const slotContent = slots.activator({ on: listeners });
                if (typeof slotContent[0].type === 'object') {
                    return h('div', { ref: activatorRef }, h(slotContent[0]));
                }
                return h(slotContent[0], { ref: activatorRef });
            }
            return null;
        };
        const genContentSlot = () => {
            const propsData = {
                ref: contentRef,
                class: contentClasses.value,
                style: contentStyles.value,
                onClick: onContentClick,
            };
            const slotContent = h('div', {
                class: 'v-menu__slot',
                style: {
                    maxHeight: convertToUnit(props.maxHeight),
                    width: convertToUnit(calcWidth.value),
                },
            }, [slots.default && slots.default()]);
            const content = h('div', propsData, slotContent);
            const directives = [
                [vShow, isActive.value],
                [resize, onResize],
                [clickOutside, directive.value],
            ];
            return withDirectives(content, directives);
        };
        onMounted(() => {
            activatorRef.value = getActivator();
            addActivatorEvents();
            setDetached(contentRef.value);
        });
        onBeforeUnmount(() => {
            removeActivatorEvents();
            removeDetached(contentRef.value);
        });
        return () => [
            h('div', { class: { 'v-menu': true } }),
            slots.activator && genActivatorSlot(),
            useTransition(genContentSlot(), 'fade'),
        ];
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WTWVudS9WTWVudS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLEtBQUssRUFDTCxDQUFDLEVBQ0QsY0FBYyxFQUNkLFFBQVEsRUFDUixTQUFTLEVBQ1QsZUFBZSxFQUNmLEtBQUssR0FHTixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsZUFBZSxHQUNoQixNQUFNLHFDQUFxQyxDQUFBO0FBQzVDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDOUUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUM5RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDeEQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBQ2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUc5RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFJdkQsZUFBZSxlQUFlLENBQUM7SUFDN0IsSUFBSSxFQUFFLFFBQVE7SUFDZCxVQUFVLEVBQUU7UUFDVixZQUFZO1FBQ1osTUFBTTtLQUNQO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVBQUUsR0FBRztTQUNiO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVB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V0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFNLENBQUMsQ0FBQTtRQUNoQyxDQUFDLENBQUMsQ0FBQTtRQUVGLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIscUJBQXFCLEVBQUUsQ0FBQTtZQUN2QixjQUFjLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxDQUFBO1FBQ25DLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNYLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN2QyxLQUFLLENBQUMsU0FBUyxJQUFJLGdCQUFnQixFQUFFO1lBQ3JDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLENBQUM7U0FDeEMsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBWdWUgQVBJXG5pbXBvcnQge1xuICBkZWZpbmVDb21wb25lbnQsXG4gIHdhdGNoLFxuICBoLFxuICB3aXRoRGlyZWN0aXZlcyxcbiAgY29tcHV0ZWQsXG4gIG9uTW91bnRlZCxcbiAgb25CZWZvcmVVbm1vdW50LFxuICB2U2hvdyxcbiAgVk5vZGUsXG4gIERpcmVjdGl2ZUFyZ3VtZW50cyxcbn0gZnJvbSAndnVlJ1xuXG4vLyBDb21wb3NhYmxlXG5pbXBvcnQge1xuICBhdXRvUG9zaXRpb25Qcm9wcyxcbiAgdXNlQXV0b1Bvc2l0aW9uLFxufSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtYXV0by1wb3NpdGlvbidcbmltcG9ydCB7IGFjdGl2YXRvclByb3BzLCB1c2VBY3RpdmF0b3IgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtYWN0aXZhdG9yJ1xuaW1wb3J0IHsgdXNlRGV0YWNoIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWRldGFjaCdcbmltcG9ydCB7IHVzZUVsZXZhdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1lbGV2YXRpb24nXG5pbXBvcnQgeyB1c2VUb2dnbGUgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtdG9nZ2xlJ1xuaW1wb3J0IHsgdXNlVHJhbnNpdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS10cmFuc2l0aW9uJ1xuaW1wb3J0IHsgcG9zaXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1wb3NpdGlvbidcblxuLy8gSGVscGVyc1xuaW1wb3J0IHsgY29udmVydFRvVW5pdCB9IGZyb20gJy4uLy4uL2hlbHBlcnMnXG5cbi8vIERpcmVjdGl2ZXNcbmltcG9ydCB7IGNsaWNrT3V0c2lkZSwgcmVzaXplIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcydcblxuaW1wb3J0IHsgTWF5YmUgfSBmcm9tICcuLi8uLi8uLi90eXBlcy9iYXNlJ1xuXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1tZW51JyxcbiAgZGlyZWN0aXZlczoge1xuICAgIGNsaWNrT3V0c2lkZSxcbiAgICByZXNpemUsXG4gIH0sXG4gIHByb3BzOiB7XG4gICAgbWF4SGVpZ2h0OiB7XG4gICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgICAgZGVmYXVsdDogMjAwLFxuICAgIH0sXG4gICAgd2lkdGg6IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgekluZGV4OiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMTAsXG4gICAgfSxcbiAgICBvcGVuT25Ib3ZlcjogQm9vbGVhbixcbiAgICBvcGVuT25DbGljazogQm9vbGVhbixcbiAgICBvcGVuT25Db250ZXh0bWVudTogQm9vbGVhbixcbiAgICBjbG9zZU9uQ2xpY2s6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICBkZWZhdWx0OiB0cnVlLFxuICAgIH0sXG4gICAgZWxldmF0aW9uOiB7XG4gICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgICAgZGVmYXVsdDogMTAsXG4gICAgfSxcbiAgICBvZmZzZXRYOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMjAsXG4gICAgfSxcbiAgICBvZmZzZXRZOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMjAsXG4gICAgfSxcbiAgICBtb2RlbFZhbHVlOiBCb29sZWFuLFxuICAgIGlucHV0QWN0aXZhdG9yOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJyxcbiAgICB9LFxuICAgIC4uLnBvc2l0aW9uUHJvcHMoKSxcbiAgICAuLi5hdXRvUG9zaXRpb25Qcm9wcygpLFxuICAgIC4uLmFjdGl2YXRvclByb3BzKCksXG4gIH0sXG5cbiAgZW1pdHM6IFsnc2hvdycsICdoaWRlJ10sXG5cbiAgc2V0dXAocHJvcHMsIHsgZW1pdCwgc2xvdHMgfSkge1xuICAgIGNvbnN0IHsgZWxldmF0aW9uQ2xhc3NlcyB9ID0gdXNlRWxldmF0aW9uKHByb3BzKVxuICAgIGNvbnN0IHsgaXNBY3RpdmUgfSA9IHVzZVRvZ2dsZShwcm9wcylcbiAgICBjb25zdCB7IGNvbnRlbnRSZWYsIHNldERpbWVuc2lvbnMsIGRpbWVuc2lvbnMgfSA9IHVzZUF1dG9Qb3NpdGlvbihwcm9wcylcbiAgICBjb25zdCB7IHNldERldGFjaGVkLCByZW1vdmVEZXRhY2hlZCB9ID0gdXNlRGV0YWNoKClcbiAgICBjb25zdCB7XG4gICAgICBhY3RpdmF0b3JSZWYsXG4gICAgICBnZXRBY3RpdmF0b3IsXG4gICAgICBnZW5BY3RpdmF0b3JMaXN0ZW5lcnMsXG4gICAgICBhZGRBY3RpdmF0b3JFdmVudHMsXG4gICAgICByZW1vdmVBY3RpdmF0b3JFdmVudHMsXG4gICAgfSA9IHVzZUFjdGl2YXRvcihwcm9wcylcblxuICAgIGNvbnN0IHNldERpbWVuc2lvbnNPbiA9IChlLCBmbGFnKSA9PiB7XG4gICAgICBzZXREaW1lbnNpb25zKGdldEFjdGl2YXRvcihlKSEpLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gKGlzQWN0aXZlLnZhbHVlID0gZmxhZykpXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xuICAgICAgY2xpY2s6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgcHJvcHMub3Blbk9uQ2xpY2spLFxuICAgICAgbW91c2VlbnRlcjogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCBwcm9wcy5vcGVuT25Ib3ZlciksXG4gICAgICBtb3VzZWxlYXZlOiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsICFwcm9wcy5vcGVuT25Ib3ZlciksXG4gICAgICBjb250ZXh0bWVudTogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCBwcm9wcy5vcGVuT25Db250ZXh0bWVudSksXG4gICAgfVxuXG4gICAgY29uc3QgbGlzdGVuZXJzID0gZ2VuQWN0aXZhdG9yTGlzdGVuZXJzKHByb3BzLCBoYW5kbGVycylcblxuICAgIGNvbnN0IGRpcmVjdGl2ZSA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICAgIHJldHVybiBpc0FjdGl2ZS52YWx1ZVxuICAgICAgICA/IHtcbiAgICAgICAgICBoYW5kbGVyOiAoZSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBwcm9wcy5pbnRlcm5hbEFjdGl2YXRvciAmJlxuICAgICAgICAgICAgICBhY3RpdmF0b3JSZWYudmFsdWUuY29udGFpbnMoZS50YXJnZXQpXG4gICAgICAgICAgICApIHJldHVyblxuICAgICAgICAgICAgaXNBY3RpdmUudmFsdWUgPSBmYWxzZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgICBjbG9zZUNvbmRpdGlvbmFsOiBwcm9wcy5jbG9zZU9uQ2xpY2ssXG4gICAgICAgICAgfVxuICAgICAgICA6IHVuZGVmaW5lZFxuICAgIH0pXG5cbiAgICBjb25zdCBjYWxjV2lkdGggPSBjb21wdXRlZDxudW1iZXIgfCBzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy53aWR0aCB8fCArZGltZW5zaW9ucy5jb250ZW50LndpZHRoXG4gICAgfSlcblxuICAgIHdhdGNoKGlzQWN0aXZlLCAodG8pID0+IHtcbiAgICAgIHRvICYmIGVtaXQoJ3Nob3cnKVxuICAgICAgIXRvICYmIGVtaXQoJ2hpZGUnKVxuICAgIH0pXG5cbiAgICB3YXRjaChcbiAgICAgICgpID0+IFtwcm9wcy5wb3NpdGlvblksIHByb3BzLnBvc2l0aW9uWF0sXG4gICAgICAoKSA9PiBzZXREaW1lbnNpb25zKGFjdGl2YXRvclJlZi52YWx1ZSEpXG4gICAgKVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5tb2RlbFZhbHVlLFxuICAgICAgKHRvKSA9PiB7XG4gICAgICAgIGlzQWN0aXZlLnZhbHVlID0gZmFsc2VcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSB0bykpXG4gICAgICB9XG4gICAgKVxuXG4gICAgY29uc3QgY29udGVudENsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4gKHtcbiAgICAgICd2LW1lbnVfX2NvbnRlbnQnOiB0cnVlLFxuICAgICAgLi4uZWxldmF0aW9uQ2xhc3Nlcy52YWx1ZSxcbiAgICB9KSlcblxuICAgIGNvbnN0IGNvbnRlbnRTdHlsZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBudW1iZXI+PigoKSA9PiAoe1xuICAgICAgdG9wOiBjb252ZXJ0VG9Vbml0KGRpbWVuc2lvbnMuY29udGVudC50b3ApISxcbiAgICAgIGxlZnQ6IGNvbnZlcnRUb1VuaXQoZGltZW5zaW9ucy5jb250ZW50LmxlZnQpISxcbiAgICAgIHpJbmRleDogcHJvcHMuekluZGV4LFxuICAgIH0pKSBhcyBhbnlcblxuICAgIGNvbnN0IG9uQ29udGVudENsaWNrID0gKCkgPT4ge1xuICAgICAgaXNBY3RpdmUudmFsdWUgPSAhcHJvcHMuY2xvc2VPbkNsaWNrXG4gICAgfVxuXG4gICAgY29uc3Qgb25SZXNpemUgPSAoKSA9PiB7XG4gICAgICBpZiAoIWlzQWN0aXZlLnZhbHVlKSByZXR1cm5cbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBzZXREaW1lbnNpb25zKGFjdGl2YXRvclJlZi52YWx1ZSEpKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkFjdGl2YXRvclNsb3QgPSAoKTogTWF5YmU8Vk5vZGU+ID0+IHtcbiAgICAgIGlmIChzbG90cy5hY3RpdmF0b3IpIHtcbiAgICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPSBzbG90cy5hY3RpdmF0b3IoeyBvbjogbGlzdGVuZXJzIH0pXG5cbiAgICAgICAgaWYgKHR5cGVvZiBzbG90Q29udGVudCFbMF0udHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICByZXR1cm4gaCgnZGl2JywgeyByZWY6IGFjdGl2YXRvclJlZiB9LCBoKHNsb3RDb250ZW50IVswXSkpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaChzbG90Q29udGVudCFbMF0sIHsgcmVmOiBhY3RpdmF0b3JSZWYgfSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBnZW5Db250ZW50U2xvdCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIHJlZjogY29udGVudFJlZixcbiAgICAgICAgY2xhc3M6IGNvbnRlbnRDbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogY29udGVudFN0eWxlcy52YWx1ZSxcbiAgICAgICAgb25DbGljazogb25Db250ZW50Q2xpY2ssXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNsb3RDb250ZW50ID0gaChcbiAgICAgICAgJ2RpdicsXG4gICAgICAgIHtcbiAgICAgICAgICBjbGFzczogJ3YtbWVudV9fc2xvdCcsXG4gICAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAgIG1heEhlaWdodDogY29udmVydFRvVW5pdChwcm9wcy5tYXhIZWlnaHQpLFxuICAgICAgICAgICAgd2lkdGg6IGNvbnZlcnRUb1VuaXQoY2FsY1dpZHRoLnZhbHVlKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBbc2xvdHMuZGVmYXVsdCAmJiBzbG90cy5kZWZhdWx0KCldXG4gICAgICApXG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBoKCdkaXYnLCBwcm9wc0RhdGEsIHNsb3RDb250ZW50KVxuXG4gICAgICBjb25zdCBkaXJlY3RpdmVzOiBEaXJlY3RpdmVBcmd1bWVudHMgPSBbXG4gICAgICAgIFt2U2hvdywgaXNBY3RpdmUudmFsdWVdLFxuICAgICAgICBbcmVzaXplLCBvblJlc2l6ZV0sXG4gICAgICAgIFtjbGlja091dHNpZGUsIGRpcmVjdGl2ZS52YWx1ZV0sXG4gICAgICBdXG5cbiAgICAgIHJldHVybiB3aXRoRGlyZWN0aXZlcyhjb250ZW50LCBkaXJlY3RpdmVzKVxuICAgIH1cblxuICAgIG9uTW91bnRlZCgoKSA9PiB7XG4gICAgICBhY3RpdmF0b3JSZWYudmFsdWUgPSBnZXRBY3RpdmF0b3IoKVxuXG4gICAgICBhZGRBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgc2V0RGV0YWNoZWQoY29udGVudFJlZi52YWx1ZSEpXG4gICAgfSlcblxuICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7XG4gICAgICByZW1vdmVBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgcmVtb3ZlRGV0YWNoZWQoY29udGVudFJlZi52YWx1ZSEpXG4gICAgfSlcblxuICAgIHJldHVybiAoKSA9PiBbXG4gICAgICBoKCdkaXYnLCB7IGNsYXNzOiB7ICd2LW1lbnUnOiB0cnVlIH0gfSksXG4gICAgICBzbG90cy5hY3RpdmF0b3IgJiYgZ2VuQWN0aXZhdG9yU2xvdCgpLFxuICAgICAgdXNlVHJhbnNpdGlvbihnZW5Db250ZW50U2xvdCgpLCAnZmFkZScpLFxuICAgIF1cbiAgfSxcbn0pXG4iXX0=