import { ref, reactive, computed } from 'vue';
export function autoPositionProps() {
    return {
        positionX: {
            type: Number,
            default: 0
        },
        positionY: {
            type: Number,
            default: 0
        }
    };
}
export function useAutoPosition(props) {
    const dimensions = reactive({
        activator: {
            top: 0,
            left: 0,
            bottom: 0,
            right: 0,
            width: 0,
            height: 0
        },
        content: {
            top: 0,
            left: 0,
            bottom: 0,
            right: 0,
            width: 0,
            height: 0
        },
        pageYOffset: 0,
        pageWidth: 0
    });
    const contentRef = ref(null);
    const offsetY = +props.offsetY;
    let activator;
    let content;
    let contentBottomBorder = 0;
    const getRect = (el) => {
        const rect = el.getBoundingClientRect();
        return {
            top: rect.top,
            left: rect.left,
            bottom: rect.bottom,
            right: rect.right,
            width: rect.width,
            height: rect.height
        };
    };
    const isAbsolutePositioned = computed(() => {
        return !!props.positionY || !!props.positionX;
    });
    const getInnerHeight = () => {
        if (!window)
            return 0;
        return innerHeight || document.documentElement.clientHeight;
    };
    const getScrollTop = () => {
        if (!window)
            return 0;
        return pageYOffset || document.documentElement.scrollTop;
    };
    const getScrollLeft = () => {
        if (!window)
            return 0;
        return pageXOffset || document.documentElement.scrollLeft;
    };
    const getContentAbsoluteBottomPoint = () => {
        return dimensions.content.height + props.positionY + getScrollTop();
    };
    const getContentBottomBorder = () => {
        const { activator, content } = dimensions;
        if (props.bottom) {
            return content.height + activator.top + activator.height;
        }
        if (props.top) {
            return activator.top;
        }
        return content.height + activator.top;
    };
    const calcContentBottomPosition = () => {
        const fullHeight = getScrollTop() + getInnerHeight();
        const contentBottomPosition = isAbsolutePositioned.value
            ? getContentAbsoluteBottomPoint()
            : getContentBottomBorder();
        return fullHeight - contentBottomPosition;
    };
    const calcAbsoluteTop = () => {
        const topPosition = props.positionY + getScrollTop();
        if (offsetY >= contentBottomBorder) {
            return topPosition + contentBottomBorder - offsetY;
        }
        return topPosition;
    };
    const calcBottomPosition = () => {
        const { activator, content } = dimensions;
        if (offsetY >= contentBottomBorder) {
            return activator.top - content.height - offsetY;
        }
        return activator.top + activator.height + offsetY;
    };
    const calcTopPosition = () => {
        const { activator, content } = dimensions;
        if (content.height + getScrollTop() + offsetY > activator.top) {
            return activator.top + activator.height;
        }
        return activator.top - content.height;
    };
    const calcContentAutoPosition = () => {
        if (offsetY >= contentBottomBorder) {
            return dimensions.activator.top + contentBottomBorder - offsetY;
        }
        return dimensions.activator.top;
    };
    const calcPositionY = () => {
        contentBottomBorder = calcContentBottomPosition();
        if (props.positionY)
            return calcAbsoluteTop();
        if (props.bottom)
            return calcBottomPosition();
        if (props.top)
            return calcTopPosition();
        return calcContentAutoPosition();
    };
    const calcPositionX = () => {
        if (props.positionX)
            return props.positionX + getScrollLeft();
        return dimensions.activator.left;
    };
    const snapShot = (cb) => {
        requestAnimationFrame(() => {
            if (!content || content.style.display !== 'none')
                return cb();
            content.style.display = 'inline-block';
            cb();
            content.style.display = 'none';
        });
    };
    const updateDimensions = () => {
        return new Promise((resolve) => {
            snapShot(() => {
                activator && setActivatorDimensions();
                content && setContentDimensions();
                resolve();
            });
        });
    };
    const setActivatorDimensions = () => {
        dimensions.activator = getRect(activator);
        dimensions.activator.height = activator.offsetHeight;
        dimensions.activator.top = dimensions.activator.top + getScrollTop();
        dimensions.activator.left = dimensions.activator.left + getScrollLeft();
    };
    const setContentDimensions = () => {
        const rect = activator
            ? dimensions.activator
            : getRect(content);
        dimensions.content.height = content.offsetHeight;
        dimensions.content.top = calcPositionY();
        dimensions.content.left = calcPositionX();
        dimensions.content.width = rect.width;
    };
    const setDimensions = (activatorEl) => {
        if (!activator && !content) {
            activator = activatorEl;
            content = contentRef.value;
        }
        return updateDimensions();
    };
    return {
        dimensions,
        contentRef,
        setDimensions,
        updateDimensions
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWF1dG8tcG9zaXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy92dWVsYW5kL3NyYy9jb21wb3NhYmxlcy91c2UtYXV0by1wb3NpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFVN0MsTUFBTSxVQUFVLGlCQUFpQjtJQUMvQixPQUFPO1FBQ0wsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsQ0FBQztTQUNYO0tBQ0YsQ0FBQTtBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUsZUFBZSxDQUFDLEtBQUs7SUFDbkMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFpQjtRQUMxQyxTQUFTLEVBQUU7WUFDVCxHQUFHLEVBQUUsQ0FBQztZQUNOLElBQUksRUFBRSxDQUFDO1lBQ1AsTUFBTSxFQUFFLENBQUM7WUFDVCxLQUFLLEVBQUUsQ0FBQztZQUNSLEtBQUssRUFBRSxDQUFDO1lBQ1IsTUFBTSxFQUFFLENBQUM7U0FDVjtRQUNELE9BQU8sRUFBRTtZQUNQLEdBQUcsRUFBRSxDQUFDO1lBQ04sSUFBSSxFQUFFLENBQUM7WUFDUCxNQUFNLEVBQUUsQ0FBQztZQUNULEtBQUssRUFBRSxDQUFDO1lBQ1IsS0FBSyxFQUFFLENBQUM7WUFDUixNQUFNLEVBQUUsQ0FBQztTQUNWO1FBQ0QsV0FBVyxFQUFFLENBQUM7UUFDZCxTQUFTLEVBQUUsQ0FBQztLQUNiLENBQUMsQ0FBQTtJQUVGLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBcUIsSUFBSSxDQUFDLENBQUE7SUFDaEQsTUFBTSxPQUFPLEdBQVcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFBO0lBR3RDLElBQUks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cHV0ZWQgfSBmcm9tICd2dWUnXG5pbXBvcnQgeyBEaW1lbnNpb25zIH0gZnJvbSAnLi4vLi4vdHlwZXMnXG5cbnR5cGUgTWFpbkRpbWVuc2lvbnMgPSB7XG4gIGFjdGl2YXRvcjogRGltZW5zaW9uc1xuICBjb250ZW50OiBEaW1lbnNpb25zXG4gIHBhZ2VZT2Zmc2V0OiBudW1iZXJcbiAgcGFnZVdpZHRoOiBudW1iZXJcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGF1dG9Qb3NpdGlvblByb3BzKCl7XG4gIHJldHVybiB7XG4gICAgcG9zaXRpb25YOiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICBkZWZhdWx0OiAwXG4gICAgfSxcbiAgICBwb3NpdGlvblk6IHtcbiAgICAgIHR5cGU6IE51bWJlcixcbiAgICAgIGRlZmF1bHQ6IDBcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZUF1dG9Qb3NpdGlvbihwcm9wcyl7XG4gIGNvbnN0IGRpbWVuc2lvbnMgPSByZWFjdGl2ZTxNYWluRGltZW5zaW9ucz4oe1xuICAgIGFjdGl2YXRvcjoge1xuICAgICAgdG9wOiAwLFxuICAgICAgbGVmdDogMCxcbiAgICAgIGJvdHRvbTogMCxcbiAgICAgIHJpZ2h0OiAwLFxuICAgICAgd2lkdGg6IDAsXG4gICAgICBoZWlnaHQ6IDBcbiAgICB9LFxuICAgIGNvbnRlbnQ6IHtcbiAgICAgIHRvcDogMCxcbiAgICAgIGxlZnQ6IDAsXG4gICAgICBib3R0b206IDAsXG4gICAgICByaWdodDogMCxcbiAgICAgIHdpZHRoOiAwLFxuICAgICAgaGVpZ2h0OiAwXG4gICAgfSxcbiAgICBwYWdlWU9mZnNldDogMCxcbiAgICBwYWdlV2lkdGg6IDBcbiAgfSlcblxuICBjb25zdCBjb250ZW50UmVmID0gcmVmPEhUTUxFbGVtZW50IHwgbnVsbD4obnVsbClcbiAgY29uc3Qgb2Zmc2V0WTogbnVtYmVyID0gK3Byb3BzLm9mZnNldFlcbiAgLy8gY29uc3Qgb2Zmc2V0WDogbnVtYmVyID0gK3Byb3BzLm9mZnNldFhcblxuICBsZXQgYWN0aXZhdG9yOiBIVE1MRWxlbWVudFxuICBsZXQgY29udGVudDogSFRNTEVsZW1lbnRcbiAgbGV0IGNvbnRlbnRCb3R0b21Cb3JkZXI6IG51bWJlciA9IDBcblxuICBjb25zdCBnZXRSZWN0ID0gKGVsOiBIVE1MRWxlbWVudCkgPT4ge1xuICAgIGNvbnN0IHJlY3QgPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvcDogcmVjdC50b3AsXG4gICAgICBsZWZ0OiByZWN0LmxlZnQsXG4gICAgICBib3R0b206IHJlY3QuYm90dG9tLFxuICAgICAgcmlnaHQ6IHJlY3QucmlnaHQsXG4gICAgICB3aWR0aDogcmVjdC53aWR0aCxcbiAgICAgIGhlaWdodDogcmVjdC5oZWlnaHRcbiAgICB9XG4gIH1cblxuICBjb25zdCBpc0Fic29sdXRlUG9zaXRpb25lZCA9IGNvbXB1dGVkPGJvb2xlYW4+KCgpID0+IHtcbiAgICByZXR1cm4gISFwcm9wcy5wb3NpdGlvblkgfHwgISFwcm9wcy5wb3NpdGlvblhcbiAgfSlcblxuICBjb25zdCBnZXRJbm5lckhlaWdodCA9ICgpOiBudW1iZXIgPT4ge1xuICAgIGlmICghd2luZG93KSByZXR1cm4gMFxuXG4gICAgcmV0dXJuIGlubmVySGVpZ2h0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHRcbiAgfVxuXG4gIGNvbnN0IGdldFNjcm9sbFRvcCA9ICgpOiBudW1iZXIgPT4ge1xuICAgIGlmICghd2luZG93KSByZXR1cm4gMFxuXG4gICAgcmV0dXJuIHBhZ2VZT2Zmc2V0IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3BcbiAgfVxuXG4gIGNvbnN0IGdldFNjcm9sbExlZnQgPSAoKTogbnVtYmVyID0+IHtcbiAgICBpZiAoIXdpbmRvdykgcmV0dXJuIDBcblxuICAgIHJldHVybiBwYWdlWE9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsTGVmdFxuICB9XG5cbiAgY29uc3QgZ2V0Q29udGVudEFic29sdXRlQm90dG9tUG9pbnQgPSAoKSA9PiB7XG4gICAgcmV0dXJuIGRpbWVuc2lvbnMuY29udGVudC5oZWlnaHQgKyBwcm9wcy5wb3NpdGlvblkgKyBnZXRTY3JvbGxUb3AoKVxuICB9XG5cbiAgY29uc3QgZ2V0Q29udGVudEJvdHRvbUJvcmRlciA9ICgpID0+IHtcbiAgICBjb25zdCB7IGFjdGl2YXRvciwgY29udGVudCB9ID0gZGltZW5zaW9uc1xuXG4gICAgaWYgKHByb3BzLmJvdHRvbSkge1xuICAgICAgcmV0dXJuIGNvbnRlbnQuaGVpZ2h0ICsgYWN0aXZhdG9yLnRvcCArIGFjdGl2YXRvci5oZWlnaHRcbiAgICB9XG5cbiAgICBpZiAocHJvcHMudG9wKSB7XG4gICAgICByZXR1cm4gYWN0aXZhdG9yLnRvcFxuICAgIH1cblxuICAgIHJldHVybiBjb250ZW50LmhlaWdodCArIGFjdGl2YXRvci50b3BcbiAgfVxuXG4gIGNvbnN0IGNhbGNDb250ZW50Qm90dG9tUG9zaXRpb24gPSAoKSA9PiB7XG4gICAgY29uc3QgZnVsbEhlaWdodCA9IGdldFNjcm9sbFRvcCgpICsgZ2V0SW5uZXJIZWlnaHQoKVxuXG4gICAgY29uc3QgY29udGVudEJvdHRvbVBvc2l0aW9uID0gaXNBYnNvbHV0ZVBvc2l0aW9uZWQudmFsdWVcbiAgICAgID8gZ2V0Q29udGVudEFic29sdXRlQm90dG9tUG9pbnQoKVxuICAgICAgOiBnZXRDb250ZW50Qm90dG9tQm9yZGVyKClcblxuICAgIHJldHVybiBmdWxsSGVpZ2h0IC0gY29udGVudEJvdHRvbVBvc2l0aW9uXG4gIH1cblxuICBjb25zdCBjYWxjQWJzb2x1dGVUb3AgPSAoKSA9PiB7XG4gICAgY29uc3QgdG9wUG9zaXRpb24gPSBwcm9wcy5wb3NpdGlvblkgKyBnZXRTY3JvbGxUb3AoKVxuXG4gICAgaWYgKG9mZnNldFkgPj0gY29udGVudEJvdHRvbUJvcmRlcikge1xuICAgICAgcmV0dXJuIHRvcFBvc2l0aW9uICsgY29udGVudEJvdHRvbUJvcmRlciAtIG9mZnNldFlcbiAgICB9XG5cbiAgICByZXR1cm4gdG9wUG9zaXRpb25cbiAgfVxuXG4gIGNvbnN0IGNhbGNCb3R0b21Qb3NpdGlvbiA9ICgpID0+IHtcbiAgICBjb25zdCB7IGFjdGl2YXRvciwgY29udGVudCB9ID0gZGltZW5zaW9uc1xuXG4gICAgaWYgKG9mZnNldFkgPj0gY29udGVudEJvdHRvbUJvcmRlcikge1xuICAgICAgcmV0dXJuIGFjdGl2YXRvci50b3AgLSBjb250ZW50LmhlaWdodCAtIG9mZnNldFlcbiAgICB9XG5cbiAgICByZXR1cm4gYWN0aXZhdG9yLnRvcCArIGFjdGl2YXRvci5oZWlnaHQgKyBvZmZzZXRZXG4gIH1cblxuICBjb25zdCBjYWxjVG9wUG9zaXRpb24gPSAoKSA9PiB7XG4gICAgY29uc3QgeyBhY3RpdmF0b3IsIGNvbnRlbnQgfSA9IGRpbWVuc2lvbnNcblxuICAgIGlmIChjb250ZW50LmhlaWdodCArIGdldFNjcm9sbFRvcCgpICsgb2Zmc2V0WSA+IGFjdGl2YXRvci50b3ApIHtcbiAgICAgIHJldHVybiBhY3RpdmF0b3IudG9wICsgYWN0aXZhdG9yLmhlaWdodFxuICAgIH1cblxuICAgIHJldHVybiBhY3RpdmF0b3IudG9wIC0gY29udGVudC5oZWlnaHRcbiAgfVxuXG4gIGNvbnN0IGNhbGNDb250ZW50QXV0b1Bvc2l0aW9uID0gKCkgPT4ge1xuICAgIGlmIChvZmZzZXRZID49IGNvbnRlbnRCb3R0b21Cb3JkZXIpIHtcbiAgICAgIHJldHVybiBkaW1lbnNpb25zLmFjdGl2YXRvci50b3AgKyBjb250ZW50Qm90dG9tQm9yZGVyIC0gb2Zmc2V0WVxuICAgIH1cblxuICAgIHJldHVybiBkaW1lbnNpb25zLmFjdGl2YXRvci50b3BcbiAgfVxuXG4gIGNvbnN0IGNhbGNQb3NpdGlvblkgPSAoKTogbnVtYmVyID0+IHtcbiAgICBjb250ZW50Qm90dG9tQm9yZGVyID0gY2FsY0NvbnRlbnRCb3R0b21Qb3NpdGlvbigpXG5cbiAgICBpZiAocHJvcHMucG9zaXRpb25ZKSByZXR1cm4gY2FsY0Fic29sdXRlVG9wKClcbiAgICBpZiAocHJvcHMuYm90dG9tKSByZXR1cm4gY2FsY0JvdHRvbVBvc2l0aW9uKClcbiAgICBpZiAocHJvcHMudG9wKSByZXR1cm4gY2FsY1RvcFBvc2l0aW9uKClcblxuICAgIHJldHVybiBjYWxjQ29udGVudEF1dG9Qb3NpdGlvbigpXG4gIH1cblxuICBjb25zdCBjYWxjUG9zaXRpb25YID0gKCk6IG51bWJlciA9PiB7XG4gICAgaWYgKHByb3BzLnBvc2l0aW9uWCkgcmV0dXJuIHByb3BzLnBvc2l0aW9uWCArIGdldFNjcm9sbExlZnQoKVxuXG4gICAgcmV0dXJuIGRpbWVuc2lvbnMuYWN0aXZhdG9yLmxlZnRcbiAgfVxuXG4gIGNvbnN0IHNuYXBTaG90ID0gKGNiOiAoKSA9PiBhbnkpID0+IHtcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgaWYgKCFjb250ZW50IHx8IGNvbnRlbnQuc3R5bGUuZGlzcGxheSAhPT0gJ25vbmUnKSByZXR1cm4gY2IoKVxuICAgICAgY29udGVudC5zdHlsZS5kaXNwbGF5ID0gJ2lubGluZS1ibG9jaydcbiAgICAgIGNiKClcbiAgICAgIGNvbnRlbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJ1xuICAgIH0pXG4gIH1cblxuICBjb25zdCB1cGRhdGVEaW1lbnNpb25zID0gKCk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgc25hcFNob3QoKCkgPT4ge1xuICAgICAgICBhY3RpdmF0b3IgJiYgc2V0QWN0aXZhdG9yRGltZW5zaW9ucygpXG4gICAgICAgIGNvbnRlbnQgJiYgc2V0Q29udGVudERpbWVuc2lvbnMoKVxuICAgICAgICByZXNvbHZlKClcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGNvbnN0IHNldEFjdGl2YXRvckRpbWVuc2lvbnMgPSAoKSA9PiB7XG4gICAgZGltZW5zaW9ucy5hY3RpdmF0b3IgPSBnZXRSZWN0KGFjdGl2YXRvcilcblxuICAgIGRpbWVuc2lvbnMuYWN0aXZhdG9yLmhlaWdodCA9IGFjdGl2YXRvci5vZmZzZXRIZWlnaHRcbiAgICBkaW1lbnNpb25zLmFjdGl2YXRvci50b3AgPSBkaW1lbnNpb25zLmFjdGl2YXRvci50b3AgKyBnZXRTY3JvbGxUb3AoKVxuICAgIGRpbWVuc2lvbnMuYWN0aXZhdG9yLmxlZnQgPSBkaW1lbnNpb25zLmFjdGl2YXRvci5sZWZ0ICsgZ2V0U2Nyb2xsTGVmdCgpXG4gIH1cblxuICBjb25zdCBzZXRDb250ZW50RGltZW5zaW9ucyA9ICgpID0+IHtcbiAgICBjb25zdCByZWN0ID0gYWN0aXZhdG9yXG4gICAgICA/IGRpbWVuc2lvbnMuYWN0aXZhdG9yXG4gICAgICA6IGdldFJlY3QoY29udGVudClcblxuICAgIGRpbWVuc2lvbnMuY29udGVudC5oZWlnaHQgPSBjb250ZW50Lm9mZnNldEhlaWdodFxuICAgIGRpbWVuc2lvbnMuY29udGVudC50b3AgPSBjYWxjUG9zaXRpb25ZKClcbiAgICBkaW1lbnNpb25zLmNvbnRlbnQubGVmdCA9IGNhbGNQb3NpdGlvblgoKVxuICAgIGRpbWVuc2lvbnMuY29udGVudC53aWR0aCA9IHJlY3Qud2lkdGhcbiAgfVxuXG4gIGNvbnN0IHNldERpbWVuc2lvbnMgPSAoYWN0aXZhdG9yRWw6IEhUTUxFbGVtZW50KSA9PiB7XG4gICAgaWYgKCFhY3RpdmF0b3IgJiYgIWNvbnRlbnQpIHtcbiAgICAgIGFjdGl2YXRvciA9IGFjdGl2YXRvckVsXG4gICAgICBjb250ZW50ID0gY29udGVudFJlZi52YWx1ZSFcbiAgICB9XG5cbiAgICByZXR1cm4gdXBkYXRlRGltZW5zaW9ucygpXG4gIH1cblxuICByZXR1cm4ge1xuICAgIGRpbWVuc2lvbnMsXG4gICAgY29udGVudFJlZixcbiAgICBzZXREaW1lbnNpb25zLFxuICAgIHVwZGF0ZURpbWVuc2lvbnNcbiAgfVxufVxuIl19