import { h, ref, reactive, computed, defineComponent, onBeforeMount } from 'vue';
import { validationProps } from '../../composables/use-validation';
import { useColors } from '../../composables/use-colors';
import { VInput } from '../VInput';
import { VSelectList } from '../VSelect';
import { VMenu } from '../VMenu';
import { VProgressLinear } from '../VProgressLinear';
import { getKeyValueFromTarget } from '../../helpers';
export default defineComponent({
    name: 'v-autocomplete',
    props: {
        label: String,
        items: Array,
        dark: Boolean,
        valueKey: String,
        idKey: String,
        listColor: String,
        disabled: Boolean,
        typeable: Boolean,
        loading: Boolean,
        modelValue: {
            default: null,
        },
        color: {
            type: String,
            default: 'primary',
        },
        ...validationProps(),
    },
    emits: [
        'input',
        'blur',
        'focus',
        'select',
        'update:modelValue',
        'update:value',
    ],
    setup(props, { emit }) {
        const state = reactive({
            focused: false,
            isMenuActive: false,
            search: '',
            select: null,
        });
        const { setTextCssColor, setTextClassNameColor } = useColors();
        const activator = ref(null);
        const classes = computed(() => ({
            'v-autocomplete': true,
            'v-autocomplete--disabled': props.disabled,
            'v-autocomplete--focused': state.focused,
            ...(props.color ? setTextClassNameColor(props.color) : {}),
        }));
        const styles = computed(() => ({
            ...(props.color ? setTextCssColor(props.color) : {}),
        }));
        const valueProperty = computed(() => {
            return props.modelValue || props.value;
        });
        const inputValue = computed(() => {
            return props.valueKey && valueProperty.value
                ? getKeyValueFromTarget(props.valueKey, valueProperty.value)
                : valueProperty.value;
        });
        const onFocus = () => {
            state.focused = true;
            state.isMenuActive = true;
            emit('focus');
        };
        const onBlur = () => {
            if (!valueProperty.value && !state.search)
                state.search = '';
            if (!state.search && valueProperty.value)
                state.search = inputValue.value;
            state.focused = false;
            emit('blur');
        };
        const onInput = (e) => {
            state.search = e.target.value;
            emit('input', e.target.value);
        };
        const onClear = () => {
            state.search = '';
            state.select = null;
            emit('select', null);
            emit('update:modelValue', null);
            emit('update:value', null);
        };
        const onSelect = (it) => {
            state.search = props.valueKey
                ? getKeyValueFromTarget(props.valueKey, it)
                : it;
            state.select = it;
            emit('select', it);
            emit('update:modelValue', it);
            emit('update:value', it);
        };
        const genInput = () => {
            return h('input', {
                value: state.search,
                disabled: props.disabled,
                readonly: props.readonly && !props.typeable,
                ref: activator,
                class: 'v-autocomplete__input',
                onInput,
                onFocus,
                onBlur,
            });
        };
        const genAutocompleteList = () => {
            return h(VSelectList, {
                items: props.items,
                valueKey: props.valueKey,
                idKey: props.idKey,
                active: state.isMenuActive,
                color: props.dark ? 'white' : props.color,
                listColor: props.listColor,
                select: state.select,
                onSelect,
            });
        };
        const genMenu = () => {
            return h(VMenu, {
                activator: activator.value,
                openOnClick: true,
                maxHeight: 240,
                bottom: true,
                onHide: () => (state.isMenuActive = state.focused),
            }, {
                default: genAutocompleteList,
            });
        };
        const genLinearProgress = () => {
            return h('div', {
                class: { 'v-autocomplete__loading': true },
            }, h(VProgressLinear, {
                height: 2,
                indeterminate: true,
                color: props.color,
                backgroundColor: props.color,
            }));
        };
        const genAutocomplete = () => {
            return h('div', {
                class: classes.value,
                style: styles.value,
            }, [
                genInput(),
                props.loading && genLinearProgress(),
                activator.value && genMenu(),
            ]);
        };
        onBeforeMount(() => {
            state.select = valueProperty.value;
            state.search = inputValue.value;
        });
        return () => {
            const propsData = {
                label: props.label,
                focused: state.isMenuActive,
                hasState: !!state.search,
                dark: props.dark,
                disabled: props.disabled,
                clearable: props.clearable,
                color: props.color,
                rules: props.rules,
                value: valueProperty.value || state.search,
                onClear,
            };
            return h(VInput, propsData, {
                'text-field': () => genAutocomplete(),
            });
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkF1dG9jb21wbGV0ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZBdXRvY29tcGxldGUvVkF1dG9jb21wbGV0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLGVBQWUsRUFBRSxhQUFhLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFHaEYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBQ2xFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQU14RCxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBQ2xDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxZQUFZLENBQUE7QUFDeEMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUNoQyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFHcEQsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sZUFBZSxDQUFBO0FBU3JELGVBQWUsZUFBZSxDQUFDO0lBQzdCLElBQUksRUFBRSxnQkFBZ0I7SUFDdEIsS0FBSyxFQUFFO1FBQ0wsS0FBSyxFQUFFLE1BQU07UUFDYixLQUFLLEVBQUUsS0FBSztRQUNaLElBQUksRUFBRSxPQUFPO1FBQ2IsUUFBUSxFQUFFLE1BQU07UUFDaEIsS0FBSyxFQUFFLE1BQU07UUFDYixTQUFTLEVBQUUsTUFBTTtRQUNqQixRQUFRLEVBQUUsT0FBTztRQUNqQixRQUFRLEVBQUUsT0FBTztRQUNqQixPQUFPLEVBQUUsT0FBTztRQUNoQixVQUFVLEVBQUU7WUFDVixPQUFPLEVBQUUsSUFBSTtTQUNkO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsU0FBUztTQUNuQjtRQUNELEdBQUcsZUFBZSxFQUFF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ZXNDb250ZW50IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7IGgsIHJlZiwgcmVhY3RpdmUsIGNvbXB1dGVkLCBkZWZpbmVDb21wb25lbnQsIG9uQmVmb3JlTW91bnQgfSBmcm9tICd2dWUnXG5cbi8vIEVmZmVjdHNcbmltcG9ydCB7IHZhbGlkYXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS12YWxpZGF0aW9uJ1xuaW1wb3J0IHsgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWNvbG9ycydcblxuLy8gVHlwZXNcbmltcG9ydCB7IFZOb2RlIH0gZnJvbSAndnVlJ1xuXG4vLyBDb21wb25lbnRzXG5pbXBvcnQgeyBWSW5wdXQgfSBmcm9tICcuLi9WSW5wdXQnXG5pbXBvcnQgeyBWU2VsZWN0TGlzdCB9IGZyb20gJy4uL1ZTZWxlY3QnXG5pbXBvcnQgeyBWTWVudSB9IGZyb20gJy4uL1ZNZW51J1xuaW1wb3J0IHsgVlByb2dyZXNzTGluZWFyIH0gZnJvbSAnLi4vVlByb2dyZXNzTGluZWFyJ1xuXG4vLyBIZWxwZXJzXG5pbXBvcnQgeyBnZXRLZXlWYWx1ZUZyb21UYXJnZXQgfSBmcm9tICcuLi8uLi9oZWxwZXJzJ1xuXG50eXBlIFNlbGVjdFN0YXRlID0ge1xuICBmb2N1c2VkOiBib29sZWFuXG4gIGlzTWVudUFjdGl2ZTogYm9vbGVhblxuICBzZWFyY2g6IHN0cmluZ1xuICBzZWxlY3Q6IGFueVxufVxuXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1hdXRvY29tcGxldGUnLFxuICBwcm9wczoge1xuICAgIGxhYmVsOiBTdHJpbmcsXG4gICAgaXRlbXM6IEFycmF5LFxuICAgIGRhcms6IEJvb2xlYW4sXG4gICAgdmFsdWVLZXk6IFN0cmluZyxcbiAgICBpZEtleTogU3RyaW5nLFxuICAgIGxpc3RDb2xvcjogU3RyaW5nLFxuICAgIGRpc2FibGVkOiBCb29sZWFuLFxuICAgIHR5cGVhYmxlOiBCb29sZWFuLFxuICAgIGxvYWRpbmc6IEJvb2xlYW4sXG4gICAgbW9kZWxWYWx1ZToge1xuICAgICAgZGVmYXVsdDogbnVsbCxcbiAgICB9LFxuICAgIGNvbG9yOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAncHJpbWFyeScsXG4gICAgfSxcbiAgICAuLi52YWxpZGF0aW9uUHJvcHMoKSxcbiAgfSBhcyBhbnksXG5cbiAgZW1pdHM6IFtcbiAgICAnaW5wdXQnLFxuICAgICdibHVyJyxcbiAgICAnZm9jdXMnLFxuICAgICdzZWxlY3QnLFxuICAgICd1cGRhdGU6bW9kZWxWYWx1ZScsXG4gICAgJ3VwZGF0ZTp2YWx1ZScsXG4gIF0sXG5cbiAgc2V0dXAocHJvcHMsIHsgZW1pdCB9KTogKCkgPT4gVk5vZGUge1xuICAgIGNvbnN0IHN0YXRlOiBTZWxlY3RTdGF0ZSA9IHJlYWN0aXZlKHtcbiAgICAgIGZvY3VzZWQ6IGZhbHNlLFxuICAgICAgaXNNZW51QWN0aXZlOiBmYWxzZSxcbiAgICAgIHNlYXJjaDogJycsXG4gICAgICBzZWxlY3Q6IG51bGwsXG4gICAgfSlcblxuICAgIGNvbnN0IHsgc2V0VGV4dENzc0NvbG9yLCBzZXRUZXh0Q2xhc3NOYW1lQ29sb3IgfSA9IHVzZUNvbG9ycygpXG4gICAgY29uc3QgYWN0aXZhdG9yID0gcmVmKG51bGwpXG5cbiAgICBjb25zdCBjbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+ICh7XG4gICAgICAndi1hdXRvY29tcGxldGUnOiB0cnVlLFxuICAgICAgJ3YtYXV0b2NvbXBsZXRlLS1kaXNhYmxlZCc6IHByb3BzLmRpc2FibGVkLFxuICAgICAgJ3YtYXV0b2NvbXBsZXRlLS1mb2N1c2VkJzogc3RhdGUuZm9jdXNlZCxcbiAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldFRleHRDbGFzc05hbWVDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBzdHlsZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+PigoKSA9PiAoe1xuICAgICAgLi4uKHByb3BzLmNvbG9yID8gc2V0VGV4dENzc0NvbG9yKHByb3BzLmNvbG9yKSA6IHt9KSxcbiAgICB9KSlcblxuICAgIGNvbnN0IHZhbHVlUHJvcGVydHkgPSBjb21wdXRlZDxhbnk+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy5tb2RlbFZhbHVlIHx8IHByb3BzLnZhbHVlXG4gICAgfSlcblxuICAgIGNvbnN0IGlucHV0VmFsdWUgPSBjb21wdXRlZDxzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy52YWx1ZUtleSAmJiB2YWx1ZVByb3BlcnR5LnZhbHVlXG4gICAgICAgID8gZ2V0S2V5VmFsdWVGcm9tVGFyZ2V0KHByb3BzLnZhbHVlS2V5LCB2YWx1ZVByb3BlcnR5LnZhbHVlKVxuICAgICAgICA6IHZhbHVlUHJvcGVydHkudmFsdWVcbiAgICB9KVxuXG4gICAgY29uc3Qgb25Gb2N1cyA9ICgpID0+IHtcbiAgICAgIHN0YXRlLmZvY3VzZWQgPSB0cnVlXG4gICAgICBzdGF0ZS5pc01lbnVBY3RpdmUgPSB0cnVlXG4gICAgICBlbWl0KCdmb2N1cycpXG4gICAgfVxuXG4gICAgY29uc3Qgb25CbHVyID0gKCkgPT4ge1xuICAgICAgaWYgKCF2YWx1ZVByb3BlcnR5LnZhbHVlICYmICFzdGF0ZS5zZWFyY2gpIHN0YXRlLnNlYXJjaCA9ICcnXG4gICAgICBpZiAoIXN0YXRlLnNlYXJjaCAmJiB2YWx1ZVByb3BlcnR5LnZhbHVlKSBzdGF0ZS5zZWFyY2ggPSBpbnB1dFZhbHVlLnZhbHVlXG4gICAgICBzdGF0ZS5mb2N1c2VkID0gZmFsc2VcbiAgICAgIGVtaXQoJ2JsdXInKVxuICAgIH1cblxuICAgIGNvbnN0IG9uSW5wdXQgPSAoZSkgPT4ge1xuICAgICAgc3RhdGUuc2VhcmNoID0gZS50YXJnZXQudmFsdWVcbiAgICAgIGVtaXQoJ2lucHV0JywgZS50YXJnZXQudmFsdWUpXG4gICAgfVxuXG4gICAgY29uc3Qgb25DbGVhciA9ICgpID0+IHtcbiAgICAgIHN0YXRlLnNlYXJjaCA9ICcnXG4gICAgICBzdGF0ZS5zZWxlY3QgPSBudWxsXG4gICAgICBlbWl0KCdzZWxlY3QnLCBudWxsKVxuICAgICAgZW1pdCgndXBkYXRlOm1vZGVsVmFsdWUnLCBudWxsKVxuICAgICAgZW1pdCgndXBkYXRlOnZhbHVlJywgbnVsbClcbiAgICB9XG5cbiAgICBjb25zdCBvblNlbGVjdCA9IChpdCkgPT4ge1xuICAgICAgc3RhdGUuc2VhcmNoID0gcHJvcHMudmFsdWVLZXlcbiAgICAgICAgPyBnZXRLZXlWYWx1ZUZyb21UYXJnZXQocHJvcHMudmFsdWVLZXksIGl0KVxuICAgICAgICA6IGl0XG4gICAgICBzdGF0ZS5zZWxlY3QgPSBpdFxuICAgICAgZW1pdCgnc2VsZWN0JywgaXQpXG4gICAgICBlbWl0KCd1cGRhdGU6bW9kZWxWYWx1ZScsIGl0KVxuICAgICAgZW1pdCgndXBkYXRlOnZhbHVlJywgaXQpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuSW5wdXQgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgcmV0dXJuIGgoJ2lucHV0Jywge1xuICAgICAgICB2YWx1ZTogc3RhdGUuc2VhcmNoLFxuICAgICAgICBkaXNhYmxlZDogcHJvcHMuZGlzYWJsZWQsXG4gICAgICAgIHJlYWRvbmx5OiBwcm9wcy5yZWFkb25seSAmJiAhcHJvcHMudHlwZWFibGUsXG4gICAgICAgIHJlZjogYWN0aXZhdG9yLFxuICAgICAgICBjbGFzczogJ3YtYXV0b2NvbXBsZXRlX19pbnB1dCcsXG4gICAgICAgIG9uSW5wdXQsXG4gICAgICAgIG9uRm9jdXMsXG4gICAgICAgIG9uQmx1cixcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuQXV0b2NvbXBsZXRlTGlzdCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICByZXR1cm4gaChWU2VsZWN0TGlzdCwge1xuICAgICAgICBpdGVtczogcHJvcHMuaXRlbXMsXG4gICAgICAgIHZhbHVlS2V5OiBwcm9wcy52YWx1ZUtleSxcbiAgICAgICAgaWRLZXk6IHByb3BzLmlkS2V5LFxuICAgICAgICBhY3RpdmU6IHN0YXRlLmlzTWVudUFjdGl2ZSxcbiAgICAgICAgY29sb3I6IHByb3BzLmRhcmsgPyAnd2hpdGUnIDogcHJvcHMuY29sb3IsXG4gICAgICAgIGxpc3RDb2xvcjogcHJvcHMubGlzdENvbG9yLFxuICAgICAgICBzZWxlY3Q6IHN0YXRlLnNlbGVjdCxcbiAgICAgICAgb25TZWxlY3QsXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGdlbk1lbnUgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgcmV0dXJuIGgoXG4gICAgICAgIFZNZW51LFxuICAgICAgICB7XG4gICAgICAgICAgYWN0aXZhdG9yOiBhY3RpdmF0b3IudmFsdWUhLFxuICAgICAgICAgIG9wZW5PbkNsaWNrOiB0cnVlLFxuICAgICAgICAgIG1heEhlaWdodDogMjQwLFxuICAgICAgICAgIGJvdHRvbTogdHJ1ZSxcbiAgICAgICAgICBvbkhpZGU6ICgpID0+IChzdGF0ZS5pc01lbnVBY3RpdmUgPSBzdGF0ZS5mb2N1c2VkKSxcbiAgICAgICAgfSxcbiAgICAgICAge1xuICAgICAgICAgIGRlZmF1bHQ6IGdlbkF1dG9jb21wbGV0ZUxpc3QsXG4gICAgICAgIH1cbiAgICAgIClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5MaW5lYXJQcm9ncmVzcyA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICByZXR1cm4gaChcbiAgICAgICAgJ2RpdicsXG4gICAgICAgIHtcbiAgICAgICAgICBjbGFzczogeyAndi1hdXRvY29tcGxldGVfX2xvYWRpbmcnOiB0cnVlIH0sXG4gICAgICAgIH0sXG4gICAgICAgIGgoVlByb2dyZXNzTGluZWFyLCB7XG4gICAgICAgICAgaGVpZ2h0OiAyLFxuICAgICAgICAgIGluZGV0ZXJtaW5hdGU6IHRydWUsXG4gICAgICAgICAgY29sb3I6IHByb3BzLmNvbG9yLFxuICAgICAgICAgIGJhY2tncm91bmRDb2xvcjogcHJvcHMuY29sb3IsXG4gICAgICAgIH0pXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuQXV0b2NvbXBsZXRlID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIHJldHVybiBoKFxuICAgICAgICAnZGl2JyxcbiAgICAgICAge1xuICAgICAgICAgIGNsYXNzOiBjbGFzc2VzLnZhbHVlLFxuICAgICAgICAgIHN0eWxlOiBzdHlsZXMudmFsdWUsXG4gICAgICAgIH0sXG4gICAgICAgIFtcbiAgICAgICAgICBnZW5JbnB1dCgpLFxuICAgICAgICAgIHByb3BzLmxvYWRpbmcgJiYgZ2VuTGluZWFyUHJvZ3Jlc3MoKSxcbiAgICAgICAgICBhY3RpdmF0b3IudmFsdWUgJiYgZ2VuTWVudSgpLFxuICAgICAgICBdXG4gICAgICApXG4gICAgfVxuXG4gICAgb25CZWZvcmVNb3VudCgoKSA9PiB7XG4gICAgICBzdGF0ZS5zZWxlY3QgPSB2YWx1ZVByb3BlcnR5LnZhbHVlXG4gICAgICBzdGF0ZS5zZWFyY2ggPSBpbnB1dFZhbHVlLnZhbHVlXG4gICAgfSlcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGxhYmVsOiBwcm9wcy5sYWJlbCxcbiAgICAgICAgZm9jdXNlZDogc3RhdGUuaXNNZW51QWN0aXZlLFxuICAgICAgICBoYXNTdGF0ZTogISFzdGF0ZS5zZWFyY2gsXG4gICAgICAgIGRhcms6IHByb3BzLmRhcmssXG4gICAgICAgIGRpc2FibGVkOiBwcm9wcy5kaXNhYmxlZCxcbiAgICAgICAgY2xlYXJhYmxlOiBwcm9wcy5jbGVhcmFibGUsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgICAgcnVsZXM6IHByb3BzLnJ1bGVzLFxuICAgICAgICB2YWx1ZTogdmFsdWVQcm9wZXJ0eS52YWx1ZSB8fCBzdGF0ZS5zZWFyY2gsXG4gICAgICAgIG9uQ2xlYXIsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZJbnB1dCwgcHJvcHNEYXRhLCB7XG4gICAgICAgICd0ZXh0LWZpZWxkJzogKCkgPT4gZ2VuQXV0b2NvbXBsZXRlKCksXG4gICAgICB9KVxuICAgIH1cbiAgfSxcbn0pXG4iXX0=