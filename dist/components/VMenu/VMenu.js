import { defineComponent, watch, h, withDirectives, computed, onMounted, onBeforeUnmount, vShow, } from 'vue';
import { autoPositionProps, useAutoPosition, } from '../../composable/use-auto-position';
import { activatorProps, useActivator } from '../../composable/use-activator';
import { useDetach } from '../../composable/use-detach';
import { useElevation } from '../../composable/use-elevation';
import { useToggle } from '../../composable/use-toggle';
import { useTransition } from '../../composable/use-transition';
import { positionProps } from '../../composable/use-position';
import { convertToUnit } from '../../helpers';
import { clickOutside, resize } from '../../directives';
export default defineComponent({
    name: 'v-menu',
    directives: {
        clickOutside,
        resize,
    },
    props: {
        maxHeight: {
            type: [Number, String],
            default: 200,
        },
        width: {
            type: [Number, String],
            default: 0,
        },
        zIndex: {
            type: [String, Number],
            default: 10,
        },
        openOnHover: Boolean,
        openOnClick: Boolean,
        openOnContextmenu: Boolean,
        closeOnClick: {
            type: Boolean,
            default: true,
        },
        elevation: {
            type: [Number, String],
            default: 10,
        },
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        modelValue: Boolean,
        inputActivator: {
            type: String,
            default: '',
        },
        ...positionProps(),
        ...autoPositionProps(),
        ...activatorProps(),
    },
    emits: ['show', 'hide'],
    setup(props, { emit, slots }) {
        const { elevationClasses } = useElevation(props);
        const { isActive } = useToggle(props);
        const { contentRef, setDimensions, dimensions } = useAutoPosition(props);
        const { setDetached, removeDetached } = useDetach();
        const { activatorRef, getActivator, genActivatorListeners, addActivatorEvents, removeActivatorEvents, } = useActivator(props);
        const setDimensionsOn = (e, flag) => {
            setDimensions(getActivator(e)).then(() => {
                requestAnimationFrame(() => (isActive.value = flag));
            });
        };
        const handlers = {
            click: (e) => setDimensionsOn(e, props.openOnClick),
            mouseenter: (e) => setDimensionsOn(e, props.openOnHover),
            mouseleave: (e) => setDimensionsOn(e, !props.openOnHover),
            contextmenu: (e) => setDimensionsOn(e, props.openOnContextmenu),
        };
        const listeners = genActivatorListeners(props, handlers);
        const directive = computed(() => {
            return isActive.value
                ? {
                    handler: (e) => {
                        if (props.internalActivator &&
                            activatorRef.value.contains(e.target))
                            return;
                        isActive.value = false;
                    },
                    closeConditional: props.closeOnClick,
                }
                : undefined;
        });
        const calcWidth = computed(() => {
            return props.width || +dimensions.content.width;
        });
        watch(isActive, (to) => {
            to && emit('show');
            !to && emit('hide');
        });
        watch(() => [props.positionY, props.positionX], () => setDimensions(activatorRef.value));
        watch(() => props.modelValue, (to) => {
            isActive.value = false;
            setTimeout(() => (isActive.value = to));
        });
        const contentClasses = computed(() => ({
            'v-menu__content': true,
            ...elevationClasses.value,
        }));
        const contentStyles = computed(() => ({
            top: convertToUnit(dimensions.content.top),
            left: convertToUnit(dimensions.content.left),
            zIndex: props.zIndex,
        }));
        const onContentClick = () => {
            isActive.value = !props.closeOnClick;
        };
        const onResize = () => {
            if (!isActive.value)
                return;
            requestAnimationFrame(() => setDimensions(activatorRef.value));
        };
        const genActivatorSlot = () => {
            if (slots.activator) {
                const slotContent = slots.activator({ on: listeners });
                if (typeof slotContent[0].type === 'object') {
                    return h('div', { ref: activatorRef }, h(slotContent[0]));
                }
                return h(slotContent[0], { ref: activatorRef });
            }
            return null;
        };
        const genContentSlot = () => {
            const propsData = {
                ref: contentRef,
                class: contentClasses.value,
                style: contentStyles.value,
                onClick: onContentClick,
            };
            const slotContent = h('div', {
                class: 'v-menu__slot',
                style: {
                    maxHeight: convertToUnit(props.maxHeight),
                    width: convertToUnit(calcWidth.value),
                },
            }, [slots.default && slots.default()]);
            const content = h('div', propsData, slotContent);
            const directives = [
                [vShow, isActive.value],
                [resize, onResize],
                [clickOutside, directive.value],
            ];
            return withDirectives(content, directives);
        };
        onMounted(() => {
            activatorRef.value = getActivator();
            addActivatorEvents();
            setDetached(contentRef.value);
        });
        onBeforeUnmount(() => {
            removeActivatorEvents();
            removeDetached(contentRef.value);
        });
        return () => [
            h('div', { class: { 'v-menu': true } }),
            slots.activator && genActivatorSlot(),
            useTransition(genContentSlot(), 'fade'),
        ];
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WTWVudS9WTWVudS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLEtBQUssRUFDTCxDQUFDLEVBQ0QsY0FBYyxFQUNkLFFBQVEsRUFDUixTQUFTLEVBQ1QsZUFBZSxFQUNmLEtBQUssR0FHTixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFDTCxpQkFBaUIsRUFDakIsZUFBZSxHQUNoQixNQUFNLG9DQUFvQyxDQUFBO0FBQzNDLE9BQU8sRUFBRSxjQUFjLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0NBQWdDLENBQUE7QUFDN0UsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBQ3ZELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFDdkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQTtBQUc3RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFJdkQsZUFBZSxlQUFlLENBQUM7SUFDN0IsSUFBSSxFQUFFLFFBQVE7SUFDZCxVQUFVLEVBQUU7UUFDVixZQUFZO1FBQ1osTUFBTTtLQUNQO0lBQ0QsS0FBSyxFQUFFO1FBQ0wsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVBQUUsR0FBRztTQUNiO1FBQ0QsS0FBSyxFQUFFO1lBQ0wsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztZQUN0QixPQUFPLEVB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V0FBVyxDQUFDLFVBQVUsQ0FBQyxLQUFNLENBQUMsQ0FBQTtRQUNoQyxDQUFDLENBQUMsQ0FBQTtRQUVGLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIscUJBQXFCLEVBQUUsQ0FBQTtZQUN2QixjQUFjLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxDQUFBO1FBQ25DLENBQUMsQ0FBQyxDQUFBO1FBRUYsT0FBTyxHQUFHLEVBQUUsQ0FBQztZQUNYLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN2QyxLQUFLLENBQUMsU0FBUyxJQUFJLGdCQUFnQixFQUFFO1lBQ3JDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLENBQUM7U0FDeEMsQ0FBQTtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBWdWUgQVBJXG5pbXBvcnQge1xuICBkZWZpbmVDb21wb25lbnQsXG4gIHdhdGNoLFxuICBoLFxuICB3aXRoRGlyZWN0aXZlcyxcbiAgY29tcHV0ZWQsXG4gIG9uTW91bnRlZCxcbiAgb25CZWZvcmVVbm1vdW50LFxuICB2U2hvdyxcbiAgVk5vZGUsXG4gIERpcmVjdGl2ZUFyZ3VtZW50cyxcbn0gZnJvbSAndnVlJ1xuXG4vLyBDb21wb3NhYmxlXG5pbXBvcnQge1xuICBhdXRvUG9zaXRpb25Qcm9wcyxcbiAgdXNlQXV0b1Bvc2l0aW9uLFxufSBmcm9tICcuLi8uLi9jb21wb3NhYmxlL3VzZS1hdXRvLXBvc2l0aW9uJ1xuaW1wb3J0IHsgYWN0aXZhdG9yUHJvcHMsIHVzZUFjdGl2YXRvciB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWFjdGl2YXRvcidcbmltcG9ydCB7IHVzZURldGFjaCB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWRldGFjaCdcbmltcG9ydCB7IHVzZUVsZXZhdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWVsZXZhdGlvbidcbmltcG9ydCB7IHVzZVRvZ2dsZSB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLXRvZ2dsZSdcbmltcG9ydCB7IHVzZVRyYW5zaXRpb24gfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlL3VzZS10cmFuc2l0aW9uJ1xuaW1wb3J0IHsgcG9zaXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLXBvc2l0aW9uJ1xuXG4vLyBIZWxwZXJzXG5pbXBvcnQgeyBjb252ZXJ0VG9Vbml0IH0gZnJvbSAnLi4vLi4vaGVscGVycydcblxuLy8gRGlyZWN0aXZlc1xuaW1wb3J0IHsgY2xpY2tPdXRzaWRlLCByZXNpemUgfSBmcm9tICcuLi8uLi9kaXJlY3RpdmVzJ1xuXG5pbXBvcnQgeyBNYXliZSB9IGZyb20gJy4uLy4uLy4uL3R5cGVzL2Jhc2UnXG5cbmV4cG9ydCBkZWZhdWx0IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LW1lbnUnLFxuICBkaXJlY3RpdmVzOiB7XG4gICAgY2xpY2tPdXRzaWRlLFxuICAgIHJlc2l6ZSxcbiAgfSxcbiAgcHJvcHM6IHtcbiAgICBtYXhIZWlnaHQ6IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAyMDAsXG4gICAgfSxcbiAgICB3aWR0aDoge1xuICAgICAgdHlwZTogW051bWJlciwgU3RyaW5nXSxcbiAgICAgIGRlZmF1bHQ6IDAsXG4gICAgfSxcbiAgICB6SW5kZXg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAxMCxcbiAgICB9LFxuICAgIG9wZW5PbkhvdmVyOiBCb29sZWFuLFxuICAgIG9wZW5PbkNsaWNrOiBCb29sZWFuLFxuICAgIG9wZW5PbkNvbnRleHRtZW51OiBCb29sZWFuLFxuICAgIGNsb3NlT25DbGljazoge1xuICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgfSxcbiAgICBlbGV2YXRpb246IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAxMCxcbiAgICB9LFxuICAgIG9mZnNldFg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAyMCxcbiAgICB9LFxuICAgIG9mZnNldFk6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAyMCxcbiAgICB9LFxuICAgIG1vZGVsVmFsdWU6IEJvb2xlYW4sXG4gICAgaW5wdXRBY3RpdmF0b3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICcnLFxuICAgIH0sXG4gICAgLi4ucG9zaXRpb25Qcm9wcygpLFxuICAgIC4uLmF1dG9Qb3NpdGlvblByb3BzKCksXG4gICAgLi4uYWN0aXZhdG9yUHJvcHMoKSxcbiAgfSxcblxuICBlbWl0czogWydzaG93JywgJ2hpZGUnXSxcblxuICBzZXR1cChwcm9wcywgeyBlbWl0LCBzbG90cyB9KSB7XG4gICAgY29uc3QgeyBlbGV2YXRpb25DbGFzc2VzIH0gPSB1c2VFbGV2YXRpb24ocHJvcHMpXG4gICAgY29uc3QgeyBpc0FjdGl2ZSB9ID0gdXNlVG9nZ2xlKHByb3BzKVxuICAgIGNvbnN0IHsgY29udGVudFJlZiwgc2V0RGltZW5zaW9ucywgZGltZW5zaW9ucyB9ID0gdXNlQXV0b1Bvc2l0aW9uKHByb3BzKVxuICAgIGNvbnN0IHsgc2V0RGV0YWNoZWQsIHJlbW92ZURldGFjaGVkIH0gPSB1c2VEZXRhY2goKVxuICAgIGNvbnN0IHtcbiAgICAgIGFjdGl2YXRvclJlZixcbiAgICAgIGdldEFjdGl2YXRvcixcbiAgICAgIGdlbkFjdGl2YXRvckxpc3RlbmVycyxcbiAgICAgIGFkZEFjdGl2YXRvckV2ZW50cyxcbiAgICAgIHJlbW92ZUFjdGl2YXRvckV2ZW50cyxcbiAgICB9ID0gdXNlQWN0aXZhdG9yKHByb3BzKVxuXG4gICAgY29uc3Qgc2V0RGltZW5zaW9uc09uID0gKGUsIGZsYWcpID0+IHtcbiAgICAgIHNldERpbWVuc2lvbnMoZ2V0QWN0aXZhdG9yKGUpISkudGhlbigoKSA9PiB7XG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSBmbGFnKSlcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgaGFuZGxlcnMgPSB7XG4gICAgICBjbGljazogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCBwcm9wcy5vcGVuT25DbGljayksXG4gICAgICBtb3VzZWVudGVyOiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsIHByb3BzLm9wZW5PbkhvdmVyKSxcbiAgICAgIG1vdXNlbGVhdmU6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgIXByb3BzLm9wZW5PbkhvdmVyKSxcbiAgICAgIGNvbnRleHRtZW51OiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsIHByb3BzLm9wZW5PbkNvbnRleHRtZW51KSxcbiAgICB9XG5cbiAgICBjb25zdCBsaXN0ZW5lcnMgPSBnZW5BY3RpdmF0b3JMaXN0ZW5lcnMocHJvcHMsIGhhbmRsZXJzKVxuXG4gICAgY29uc3QgZGlyZWN0aXZlID0gY29tcHV0ZWQoKCkgPT4ge1xuICAgICAgcmV0dXJuIGlzQWN0aXZlLnZhbHVlXG4gICAgICAgID8ge1xuICAgICAgICAgIGhhbmRsZXI6IChlKSA9PiB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIHByb3BzLmludGVybmFsQWN0aXZhdG9yICYmXG4gICAgICAgICAgICAgIGFjdGl2YXRvclJlZi52YWx1ZS5jb250YWlucyhlLnRhcmdldClcbiAgICAgICAgICAgICkgcmV0dXJuXG4gICAgICAgICAgICBpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlXG4gICAgICAgICAgfSxcbiAgICAgICAgICAgIGNsb3NlQ29uZGl0aW9uYWw6IHByb3BzLmNsb3NlT25DbGljayxcbiAgICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkXG4gICAgfSlcblxuICAgIGNvbnN0IGNhbGNXaWR0aCA9IGNvbXB1dGVkPG51bWJlciB8IHN0cmluZz4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHByb3BzLndpZHRoIHx8ICtkaW1lbnNpb25zLmNvbnRlbnQud2lkdGhcbiAgICB9KVxuXG4gICAgd2F0Y2goaXNBY3RpdmUsICh0bykgPT4ge1xuICAgICAgdG8gJiYgZW1pdCgnc2hvdycpXG4gICAgICAhdG8gJiYgZW1pdCgnaGlkZScpXG4gICAgfSlcblxuICAgIHdhdGNoKFxuICAgICAgKCkgPT4gW3Byb3BzLnBvc2l0aW9uWSwgcHJvcHMucG9zaXRpb25YXSxcbiAgICAgICgpID0+IHNldERpbWVuc2lvbnMoYWN0aXZhdG9yUmVmLnZhbHVlISlcbiAgICApXG5cbiAgICB3YXRjaChcbiAgICAgICgpID0+IHByb3BzLm1vZGVsVmFsdWUsXG4gICAgICAodG8pID0+IHtcbiAgICAgICAgaXNBY3RpdmUudmFsdWUgPSBmYWxzZVxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IChpc0FjdGl2ZS52YWx1ZSA9IHRvKSlcbiAgICAgIH1cbiAgICApXG5cbiAgICBjb25zdCBjb250ZW50Q2xhc3NlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PigoKSA9PiAoe1xuICAgICAgJ3YtbWVudV9fY29udGVudCc6IHRydWUsXG4gICAgICAuLi5lbGV2YXRpb25DbGFzc2VzLnZhbHVlLFxuICAgIH0pKVxuXG4gICAgY29uc3QgY29udGVudFN0eWxlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIHN0cmluZyB8IG51bWJlcj4+KCgpID0+ICh7XG4gICAgICB0b3A6IGNvbnZlcnRUb1VuaXQoZGltZW5zaW9ucy5jb250ZW50LnRvcCkhLFxuICAgICAgbGVmdDogY29udmVydFRvVW5pdChkaW1lbnNpb25zLmNvbnRlbnQubGVmdCkhLFxuICAgICAgekluZGV4OiBwcm9wcy56SW5kZXgsXG4gICAgfSkpIGFzIGFueVxuXG4gICAgY29uc3Qgb25Db250ZW50Q2xpY2sgPSAoKSA9PiB7XG4gICAgICBpc0FjdGl2ZS52YWx1ZSA9ICFwcm9wcy5jbG9zZU9uQ2xpY2tcbiAgICB9XG5cbiAgICBjb25zdCBvblJlc2l6ZSA9ICgpID0+IHtcbiAgICAgIGlmICghaXNBY3RpdmUudmFsdWUpIHJldHVyblxuICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHNldERpbWVuc2lvbnMoYWN0aXZhdG9yUmVmLnZhbHVlISkpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuQWN0aXZhdG9yU2xvdCA9ICgpOiBNYXliZTxWTm9kZT4gPT4ge1xuICAgICAgaWYgKHNsb3RzLmFjdGl2YXRvcikge1xuICAgICAgICBjb25zdCBzbG90Q29udGVudCA9IHNsb3RzLmFjdGl2YXRvcih7IG9uOiBsaXN0ZW5lcnMgfSlcblxuICAgICAgICBpZiAodHlwZW9mIHNsb3RDb250ZW50IVswXS50eXBlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgIHJldHVybiBoKCdkaXYnLCB7IHJlZjogYWN0aXZhdG9yUmVmIH0sIGgoc2xvdENvbnRlbnQhWzBdKSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBoKHNsb3RDb250ZW50IVswXSwgeyByZWY6IGFjdGl2YXRvclJlZiB9KVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbnVsbFxuICAgIH1cblxuICAgIGNvbnN0IGdlbkNvbnRlbnRTbG90ID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgcmVmOiBjb250ZW50UmVmLFxuICAgICAgICBjbGFzczogY29udGVudENsYXNzZXMudmFsdWUsXG4gICAgICAgIHN0eWxlOiBjb250ZW50U3R5bGVzLnZhbHVlLFxuICAgICAgICBvbkNsaWNrOiBvbkNvbnRlbnRDbGljayxcbiAgICAgIH1cblxuICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPSBoKFxuICAgICAgICAnZGl2JyxcbiAgICAgICAge1xuICAgICAgICAgIGNsYXNzOiAndi1tZW51X19zbG90JyxcbiAgICAgICAgICBzdHlsZToge1xuICAgICAgICAgICAgbWF4SGVpZ2h0OiBjb252ZXJ0VG9Vbml0KHByb3BzLm1heEhlaWdodCksXG4gICAgICAgICAgICB3aWR0aDogY29udmVydFRvVW5pdChjYWxjV2lkdGgudmFsdWUpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIFtzbG90cy5kZWZhdWx0ICYmIHNsb3RzLmRlZmF1bHQoKV1cbiAgICAgIClcblxuICAgICAgY29uc3QgY29udGVudCA9IGgoJ2RpdicsIHByb3BzRGF0YSwgc2xvdENvbnRlbnQpXG5cbiAgICAgIGNvbnN0IGRpcmVjdGl2ZXM6IERpcmVjdGl2ZUFyZ3VtZW50cyA9IFtcbiAgICAgICAgW3ZTaG93LCBpc0FjdGl2ZS52YWx1ZV0sXG4gICAgICAgIFtyZXNpemUsIG9uUmVzaXplXSxcbiAgICAgICAgW2NsaWNrT3V0c2lkZSwgZGlyZWN0aXZlLnZhbHVlXSxcbiAgICAgIF1cblxuICAgICAgcmV0dXJuIHdpdGhEaXJlY3RpdmVzKGNvbnRlbnQsIGRpcmVjdGl2ZXMpXG4gICAgfVxuXG4gICAgb25Nb3VudGVkKCgpID0+IHtcbiAgICAgIGFjdGl2YXRvclJlZi52YWx1ZSA9IGdldEFjdGl2YXRvcigpXG5cbiAgICAgIGFkZEFjdGl2YXRvckV2ZW50cygpXG4gICAgICBzZXREZXRhY2hlZChjb250ZW50UmVmLnZhbHVlISlcbiAgICB9KVxuXG4gICAgb25CZWZvcmVVbm1vdW50KCgpID0+IHtcbiAgICAgIHJlbW92ZUFjdGl2YXRvckV2ZW50cygpXG4gICAgICByZW1vdmVEZXRhY2hlZChjb250ZW50UmVmLnZhbHVlISlcbiAgICB9KVxuXG4gICAgcmV0dXJuICgpID0+IFtcbiAgICAgIGgoJ2RpdicsIHsgY2xhc3M6IHsgJ3YtbWVudSc6IHRydWUgfSB9KSxcbiAgICAgIHNsb3RzLmFjdGl2YXRvciAmJiBnZW5BY3RpdmF0b3JTbG90KCksXG4gICAgICB1c2VUcmFuc2l0aW9uKGdlbkNvbnRlbnRTbG90KCksICdmYWRlJyksXG4gICAgXVxuICB9LFxufSlcbiJdfQ==