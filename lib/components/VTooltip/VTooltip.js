import { h, shallowRef, reactive, watch, withDirectives, defineComponent, computed, onMounted, vShow, } from 'vue';
import { useToggle } from '../../composables/use-toggle';
import { useColors } from '../../composables/use-colors';
import { useActivator } from '../../composables/use-activator';
import { useTransition } from '../../composables/use-transition';
import { elevationProps, useElevation } from '../../composables/use-elevation';
import { positionProps } from '../../composables/use-position';
import { convertToUnit } from '../../helpers';
import { transitions } from '../../services/transitions';
export default defineComponent({
    name: 'v-tooltip',
    props: {
        openOnHover: {
            type: Boolean,
            default: true,
        },
        color: {
            type: String,
            default: 'grey lighten-1',
        },
        zIndex: [Number, String],
        maxWidth: [Number, String],
        minWidth: [Number, String],
        modelValue: Boolean,
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        ...elevationProps(),
        ...positionProps(),
    },
    setup(props, { slots }) {
        const tooltip = reactive({});
        const activator = reactive({});
        const tooltipRef = shallowRef(null);
        const { isActive } = useToggle(props);
        const { elevationClasses } = useElevation(props);
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const { activatorRef, getActivatorSizes, genActivatorListeners } = useActivator(props);
        const handlers = {
            mouseenter: () => (isActive.value = true),
            mouseleave: () => (isActive.value = false),
        };
        const listeners = genActivatorListeners(props, handlers);
        const classes = computed(() => ({
            'v-tooltip': true,
            'v-tooltip--top': props.top,
            'v-tooltip--right': props.right,
            'v-tooltip--left': props.left,
            'v-tooltip--bottom': props.bottom,
            ...elevationClasses.value,
            ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
        }));
        const computeTopPosition = computed(() => {
            return ((props.top
                ? activator.top - tooltip.height
                : props.bottom
                    ? activator.top + activator.height
                    : activator.top + (activator.height - tooltip.height) / 2) +
                +props.offsetY);
        });
        const computeLeftPosition = computed(() => {
            return ((props.left
                ? activator.left - tooltip.width
                : props.right
                    ? activator.left + activator.width
                    : activator.left + (activator.width - tooltip.width) / 2) +
                +props.offsetX);
        });
        const styles = computed(() => ({
            top: tooltip.top ? convertToUnit(tooltip.top) : '',
            left: tooltip.top ? convertToUnit(tooltip.left) : '',
            maxWidth: !!props.maxWidth ? `${props.maxWidth}px` : '',
            minWidth: !!props.minWidth ? `${props.minWidth}px` : '',
            zIndex: props.zIndex,
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        function genActivator() {
            const slotContent = slots.activator &&
                slots.activator({
                    on: listeners,
                });
            return h(slotContent[0], { ref: activatorRef });
        }
        function genContent() {
            const propsData = {
                class: classes.value,
                style: styles.value,
                ref: tooltipRef,
            };
            return withDirectives(h('span', propsData, slots.default && slots.default()), [[vShow, isActive.value]]);
        }
        function setTooltipPosition() {
            if (tooltipRef.value) {
                tooltip.width = tooltipRef.value.offsetWidth;
                tooltip.height = tooltipRef.value.offsetHeight;
                tooltip.top = computeTopPosition.value;
                tooltip.left = computeLeftPosition.value;
            }
        }
        onMounted(() => {
            watch(() => isActive.value, (to) => {
                if (to) {
                    const { left, top, height, width } = getActivatorSizes();
                    activator.left = left;
                    activator.top = top;
                    activator.height = height;
                    activator.width = width;
                    tooltip.top = 0;
                    tooltip.left = 0;
                    requestAnimationFrame(setTooltipPosition);
                }
            }, { immediate: true });
        });
        return () => {
            const content = useTransition(genContent(), isActive.value ? transitions.SCALE_IN : transitions.FADE);
            return [content, genActivator()];
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlRvb2x0aXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy92dWVsYW5kL3NyYy9jb21wb25lbnRzL1ZUb29sdGlwL1ZUb29sdGlwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxDQUFDLEVBQ0QsVUFBVSxFQUNWLFFBQVEsRUFDUixLQUFLLEVBQ0wsY0FBYyxFQUNkLGVBQWUsRUFDZixRQUFRLEVBQ1IsU0FBUyxFQUNULEtBQUssR0FDTixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUN4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQTtBQUNoRSxPQUFPLEVBQUUsY0FBYyxFQUFFLFlBQVksRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQzlFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQU85RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzdDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUl4RCxlQUFlLGVBQWUsQ0FBQztJQUM3QixJQUFJLEVBQUUsV0FBVztJQUVqQixLQUFLLEVBQUU7UUFDTCxXQUFXLEVBQUU7WUFDWCxJQUFJLEVBQUUsT0FBTztZQUNiLE9BQU8sRUFBRSxJQUFJO1NBQ2Q7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxnQkFBZ0I7U0FDMUI7UUFDRCxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1FBQ3hCLFFBQVEsRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7UUFDMUIsUUFB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LElBQUksR0FBRyxJQUFjLENBQUE7b0JBQy9CLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FBYSxDQUFBO29CQUM3QixTQUFTLENBQUMsTUFBTSxHQUFHLE1BQWdCLENBQUE7b0JBQ25DLFNBQVMsQ0FBQyxLQUFLLEdBQUcsS0FBZSxDQUFBO29CQUVqQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtvQkFDZixPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQTtvQkFFaEIscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtpQkFDMUM7WUFDSCxDQUFDLEVBQ0QsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQ3BCLENBQUE7UUFDSCxDQUFDLENBQUMsQ0FBQTtRQUVGLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUMzQixVQUFVLEVBQVcsRUFDckIsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDekQsQ0FBQTtZQUVELE9BQU8sQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQTtRQUNsQyxDQUFDLENBQUE7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVnVlIEFQSVxuaW1wb3J0IHtcbiAgaCxcbiAgc2hhbGxvd1JlZixcbiAgcmVhY3RpdmUsXG4gIHdhdGNoLFxuICB3aXRoRGlyZWN0aXZlcyxcbiAgZGVmaW5lQ29tcG9uZW50LFxuICBjb21wdXRlZCxcbiAgb25Nb3VudGVkLFxuICB2U2hvdyxcbn0gZnJvbSAndnVlJ1xuXG4vLyBFZmZlY3RzXG5pbXBvcnQgeyB1c2VUb2dnbGUgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtdG9nZ2xlJ1xuaW1wb3J0IHsgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWNvbG9ycydcbmltcG9ydCB7IHVzZUFjdGl2YXRvciB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1hY3RpdmF0b3InXG5pbXBvcnQgeyB1c2VUcmFuc2l0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXRyYW5zaXRpb24nXG5pbXBvcnQgeyBlbGV2YXRpb25Qcm9wcywgdXNlRWxldmF0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWVsZXZhdGlvbidcbmltcG9ydCB7IHBvc2l0aW9uUHJvcHMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtcG9zaXRpb24nXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBPZmZzZXRTaXplcyB9IGZyb20gJy4uLy4uL3R5cGVzJ1xuaW1wb3J0IHsgVk5vZGUgfSBmcm9tICd2dWUnXG5cbi8vIEhlbHBlcnNcbmltcG9ydCB7IGNvbnZlcnRUb1VuaXQgfSBmcm9tICcuLi8uLi9oZWxwZXJzJ1xuXG4vLyBTZXJ2aWNlc1xuaW1wb3J0IHsgdHJhbnNpdGlvbnMgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90cmFuc2l0aW9ucydcblxuLy8gVE9ETyBmaXggYmVoYXZpb3Igb24gd2luZG93IHJlc2l6ZSBpZiB2LW1vZGVsIHVzZWQgb24gY29tcG9uZW50XG5cbmV4cG9ydCBkZWZhdWx0IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LXRvb2x0aXAnLFxuXG4gIHByb3BzOiB7XG4gICAgb3Blbk9uSG92ZXI6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICBkZWZhdWx0OiB0cnVlLFxuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICdncmV5IGxpZ2h0ZW4tMScsXG4gICAgfSxcbiAgICB6SW5kZXg6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgbWF4V2lkdGg6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgbWluV2lkdGg6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgbW9kZWxWYWx1ZTogQm9vbGVhbixcbiAgICBvZmZzZXRYOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMjAsXG4gICAgfSxcbiAgICBvZmZzZXRZOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMjAsXG4gICAgfSxcbiAgICAuLi5lbGV2YXRpb25Qcm9wcygpLFxuICAgIC4uLnBvc2l0aW9uUHJvcHMoKSxcbiAgfSBhcyBhbnksXG5cbiAgc2V0dXAocHJvcHMsIHsgc2xvdHMgfSkge1xuICAgIGNvbnN0IHRvb2x0aXAgPSByZWFjdGl2ZTxQYXJ0aWFsPE9mZnNldFNpemVzPj4oe30pXG4gICAgY29uc3QgYWN0aXZhdG9yID0gcmVhY3RpdmU8UGFydGlhbDxPZmZzZXRTaXplcz4+KHt9KVxuXG4gICAgY29uc3QgdG9vbHRpcFJlZiA9IHNoYWxsb3dSZWY8SFRNTEVsZW1lbnQgfCBudWxsPihudWxsKVxuXG4gICAgY29uc3QgeyBpc0FjdGl2ZSB9ID0gdXNlVG9nZ2xlKHByb3BzKVxuICAgIGNvbnN0IHsgZWxldmF0aW9uQ2xhc3NlcyB9ID0gdXNlRWxldmF0aW9uKHByb3BzKVxuICAgIGNvbnN0IHsgc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yLCBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IgfSA9IHVzZUNvbG9ycygpXG4gICAgY29uc3QgeyBhY3RpdmF0b3JSZWYsIGdldEFjdGl2YXRvclNpemVzLCBnZW5BY3RpdmF0b3JMaXN0ZW5lcnMgfSA9XG4gICAgICB1c2VBY3RpdmF0b3IocHJvcHMpXG5cbiAgICBjb25zdCBoYW5kbGVycyA9IHtcbiAgICAgIG1vdXNlZW50ZXI6ICgpID0+IChpc0FjdGl2ZS52YWx1ZSA9IHRydWUpLFxuICAgICAgbW91c2VsZWF2ZTogKCkgPT4gKGlzQWN0aXZlLnZhbHVlID0gZmFsc2UpLFxuICAgIH1cblxuICAgIGNvbnN0IGxpc3RlbmVycyA9IGdlbkFjdGl2YXRvckxpc3RlbmVycyhwcm9wcywgaGFuZGxlcnMpXG5cbiAgICBjb25zdCBjbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+ICh7XG4gICAgICAndi10b29sdGlwJzogdHJ1ZSxcbiAgICAgICd2LXRvb2x0aXAtLXRvcCc6IHByb3BzLnRvcCxcbiAgICAgICd2LXRvb2x0aXAtLXJpZ2h0JzogcHJvcHMucmlnaHQsXG4gICAgICAndi10b29sdGlwLS1sZWZ0JzogcHJvcHMubGVmdCxcbiAgICAgICd2LXRvb2x0aXAtLWJvdHRvbSc6IHByb3BzLmJvdHRvbSxcbiAgICAgIC4uLmVsZXZhdGlvbkNsYXNzZXMudmFsdWUsXG4gICAgICAuLi4ocHJvcHMuY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IocHJvcHMuY29sb3IpIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3QgY29tcHV0ZVRvcFBvc2l0aW9uID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICAocHJvcHMudG9wXG4gICAgICAgICAgPyBhY3RpdmF0b3IhLnRvcCEgLSB0b29sdGlwLmhlaWdodCFcbiAgICAgICAgICA6IHByb3BzLmJvdHRvbVxuICAgICAgICAgID8gYWN0aXZhdG9yLnRvcCEgKyBhY3RpdmF0b3IuaGVpZ2h0IVxuICAgICAgICAgIDogYWN0aXZhdG9yLnRvcCEgKyAoYWN0aXZhdG9yLmhlaWdodCEgLSB0b29sdGlwLmhlaWdodCEpIC8gMikgK1xuICAgICAgICArcHJvcHMub2Zmc2V0WVxuICAgICAgKVxuICAgIH0pXG5cbiAgICBjb25zdCBjb21wdXRlTGVmdFBvc2l0aW9uID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gKFxuICAgICAgICAocHJvcHMubGVmdFxuICAgICAgICAgID8gYWN0aXZhdG9yLmxlZnQhIC0gdG9vbHRpcC53aWR0aCFcbiAgICAgICAgICA6IHByb3BzLnJpZ2h0XG4gICAgICAgICAgPyBhY3RpdmF0b3IubGVmdCEgKyBhY3RpdmF0b3Iud2lkdGghXG4gICAgICAgICAgOiBhY3RpdmF0b3IubGVmdCEgKyAoYWN0aXZhdG9yLndpZHRoISAtIHRvb2x0aXAud2lkdGghKSAvIDIpICtcbiAgICAgICAgK3Byb3BzLm9mZnNldFhcbiAgICAgIClcbiAgICB9KVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4oKCkgPT4gKHtcbiAgICAgIHRvcDogdG9vbHRpcC50b3AgPyAoY29udmVydFRvVW5pdCh0b29sdGlwLnRvcCkgYXMgc3RyaW5nKSA6ICcnLFxuICAgICAgbGVmdDogdG9vbHRpcC50b3AgPyAoY29udmVydFRvVW5pdCh0b29sdGlwLmxlZnQhKSBhcyBzdHJpbmcpIDogJycsXG4gICAgICBtYXhXaWR0aDogISFwcm9wcy5tYXhXaWR0aCA/IGAke3Byb3BzLm1heFdpZHRofXB4YCA6ICcnLFxuICAgICAgbWluV2lkdGg6ICEhcHJvcHMubWluV2lkdGggPyBgJHtwcm9wcy5taW5XaWR0aH1weGAgOiAnJyxcbiAgICAgIHpJbmRleDogcHJvcHMuekluZGV4LFxuICAgICAgLi4uKHByb3BzLmNvbG9yID8gc2V0QmFja2dyb3VuZENzc0NvbG9yKHByb3BzLmNvbG9yKSA6IHt9KSxcbiAgICB9KSlcblxuICAgIGZ1bmN0aW9uIGdlbkFjdGl2YXRvcigpOiBWTm9kZSB8IG51bGwge1xuICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPVxuICAgICAgICBzbG90cy5hY3RpdmF0b3IgJiZcbiAgICAgICAgc2xvdHMuYWN0aXZhdG9yKHtcbiAgICAgICAgICBvbjogbGlzdGVuZXJzLFxuICAgICAgICB9KVxuXG4gICAgICByZXR1cm4gaChzbG90Q29udGVudCFbMF0sIHsgcmVmOiBhY3RpdmF0b3JSZWYgfSlcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZW5Db250ZW50KCk6IFZOb2RlIHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMudmFsdWUsXG4gICAgICAgIHN0eWxlOiBzdHlsZXMudmFsdWUsXG4gICAgICAgIHJlZjogdG9vbHRpcFJlZixcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHdpdGhEaXJlY3RpdmVzKFxuICAgICAgICBoKCdzcGFuJywgcHJvcHNEYXRhLCBzbG90cy5kZWZhdWx0ICYmIHNsb3RzLmRlZmF1bHQoKSksXG4gICAgICAgIFtbdlNob3csIGlzQWN0aXZlLnZhbHVlXV1cbiAgICAgIClcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRUb29sdGlwUG9zaXRpb24oKSB7XG4gICAgICBpZiAodG9vbHRpcFJlZi52YWx1ZSkge1xuICAgICAgICB0b29sdGlwLndpZHRoID0gdG9vbHRpcFJlZi52YWx1ZSEub2Zmc2V0V2lkdGhcbiAgICAgICAgdG9vbHRpcC5oZWlnaHQgPSB0b29sdGlwUmVmLnZhbHVlIS5vZmZzZXRIZWlnaHRcbiAgICAgICAgdG9vbHRpcC50b3AgPSBjb21wdXRlVG9wUG9zaXRpb24udmFsdWVcbiAgICAgICAgdG9vbHRpcC5sZWZ0ID0gY29tcHV0ZUxlZnRQb3NpdGlvbi52YWx1ZVxuICAgICAgfVxuICAgIH1cblxuICAgIG9uTW91bnRlZCgoKSA9PiB7XG4gICAgICB3YXRjaChcbiAgICAgICAgKCkgPT4gaXNBY3RpdmUudmFsdWUsXG4gICAgICAgICh0bykgPT4ge1xuICAgICAgICAgIGlmICh0bykge1xuICAgICAgICAgICAgY29uc3QgeyBsZWZ0LCB0b3AsIGhlaWdodCwgd2lkdGggfSA9IGdldEFjdGl2YXRvclNpemVzKClcblxuICAgICAgICAgICAgYWN0aXZhdG9yLmxlZnQgPSBsZWZ0IGFzIG51bWJlclxuICAgICAgICAgICAgYWN0aXZhdG9yLnRvcCA9IHRvcCBhcyBudW1iZXJcbiAgICAgICAgICAgIGFjdGl2YXRvci5oZWlnaHQgPSBoZWlnaHQgYXMgbnVtYmVyXG4gICAgICAgICAgICBhY3RpdmF0b3Iud2lkdGggPSB3aWR0aCBhcyBudW1iZXJcblxuICAgICAgICAgICAgdG9vbHRpcC50b3AgPSAwXG4gICAgICAgICAgICB0b29sdGlwLmxlZnQgPSAwXG5cbiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShzZXRUb29sdGlwUG9zaXRpb24pXG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB7IGltbWVkaWF0ZTogdHJ1ZSB9XG4gICAgICApXG4gICAgfSlcblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBjb250ZW50ID0gdXNlVHJhbnNpdGlvbihcbiAgICAgICAgZ2VuQ29udGVudCgpIGFzIFZOb2RlLFxuICAgICAgICBpc0FjdGl2ZS52YWx1ZSA/IHRyYW5zaXRpb25zLlNDQUxFX0lOIDogdHJhbnNpdGlvbnMuRkFERVxuICAgICAgKVxuXG4gICAgICByZXR1cm4gW2NvbnRlbnQsIGdlbkFjdGl2YXRvcigpXVxuICAgIH1cbiAgfSxcbn0pXG4iXX0=