import { h, watch, computed, defineComponent, reactive } from 'vue';
import { useColors } from '../../composables/use-colors';
import { VDataTableHeader } from './VDataTableHeader';
import { VDataTableBody } from './VDataTableBody';
import { VDataTableFooter } from './VDataTableFooter';
import { addScopedSlot } from '../../helpers';
export default defineComponent({
    name: 'v-data-table',
    props: {
        cols: {
            type: Array,
            default: () => [],
        },
        rows: {
            type: Array,
            default: () => [],
        },
        showSequence: Boolean,
        showCheckbox: Boolean,
        align: {
            type: String,
            validator: (val) => ['left', 'center', 'right'].includes(val),
        },
        color: {
            type: String,
            default: '',
        },
        headerOptions: {
            type: Object,
            default: () => ({}),
        },
        footerOptions: {
            type: Object,
            default: () => ({}),
        },
        customFilter: Function,
    },
    emits: [
        'last-page',
        'select:row',
        'click:row',
        'dblclick:row',
        'contextmenu:row',
    ],
    setup(props, { slots, emit }) {
        const data = reactive({
            cols: [],
            rows: [],
            checkedRows: [],
            rowsOnPage: 20,
            page: 1,
            isAllRowsChecked: false,
        });
        const { setBackgroundCssColor, setBackgroundClassNameColor } = useColors();
        const filters = {};
        const classes = computed(() => ({
            'v-data-table': true,
            ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
        }));
        const styles = computed(() => ({
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        const headerOptions = computed(() => ({
            color: props.color,
            dark: props.dark,
            ...props.headerOptions,
        }));
        const footerOptions = computed(() => ({
            color: props.color,
            dark: props.dark,
            ...props.footerOptions,
        }));
        const pages = computed(() => {
            return Math.ceil(data.rows?.length / data.rowsOnPage);
        });
        const firstOnPage = computed(() => {
            return data.page === 1 ? 1 : (data.page - 1) * data.rowsOnPage + 1;
        });
        const lastOnPage = computed(() => {
            return data.page * data.rowsOnPage > data.rows?.length
                ? data.rows?.length
                : data.page * data.rowsOnPage;
        });
        const pageCorrection = computed(() => {
            if ((data.page - 1) * data.rowsOnPage > data.rows?.length) {
                return Math.ceil((data.page * data.rowsOnPage - data.rows?.length) / data.rowsOnPage);
            }
            return null;
        });
        watch(() => props.cols, (to) => (data.cols = to), { immediate: true });
        watch(() => props.rows, (to) => (data.rows = to), { immediate: true });
        const onSelectAll = (value) => {
            data.isAllRowsChecked = value;
            data.rows.forEach((row) => (row.checked = value));
        };
        const onSelect = (rows) => {
            data.checkedRows = rows;
            emit('select:row', data.checkedRows);
        };
        const onPrevPage = (num) => {
            data.page = data.page > 1 ? data.page + num : data.page;
        };
        const onNextPage = (num) => {
            if (data.rows.length - data.page * data.rowsOnPage > 0) {
                data.page += num;
            }
        };
        const onSort = (col) => {
            if (col.sorted) {
                col.sorted = !col.sorted;
                return sortColumn(col);
            }
            data.cols.forEach((c) => (c.sorted = col.key === c.key));
            sortColumn(col);
        };
        const sortColumn = (col) => {
            if (!col.sorted) {
                return data.rows?.reverse();
            }
            const executor = col.sort ||
                ((a, b) => {
                    if (col.format)
                        return col.format(a) > col.format(b) ? 1 : -1;
                    if (col.sorted)
                        return a[col.key] > b[col.key] ? 1 : -1;
                });
            data.rows?.sort(executor);
        };
        const onFilter = ({ value, col }) => {
            if (!value && filters[col.key])
                delete filters[col.key];
            if (value)
                filters[col.key] = value;
            if (col.filter) {
                return (data.rows = col.filter({ value, col }));
            }
            if (props.customFilter) {
                return props.customFilter(filters);
            }
            if (!Object.keys(filters).length) {
                return (data.rows = props.rows);
            }
            data.rows = filterRows(props.rows, props.cols);
            data.page = 1;
        };
        const onSelectRowsCount = (count) => {
            data.rowsOnPage = count;
        };
        const filterRows = (rows, cols) => {
            const filterKeys = Object.keys(filters);
            return rows.reduce((acc, row) => {
                const rowResults = [];
                filterKeys.forEach((key) => {
                    const { format } = cols.find((col) => col.key === key);
                    const value = format ? format(row) : row[key];
                    const rowKeyValue = `${value}`.toLowerCase();
                    const filterValue = `${filters[key]}`.toLowerCase();
                    if (rowKeyValue.includes(filterValue)) {
                        rowResults.push(row[key]);
                    }
                });
                if (rowResults.length === filterKeys.length &&
                    rowResults.every((value) => !!value)) {
                    acc.push(row);
                }
                return acc;
            }, []);
        };
        const genTableTools = () => {
            const propsData = { class: 'v-data-table__toolbar' };
            return h('div', propsData, {
                default: () => slots.toolbar && slots.toolbar(),
            });
        };
        const genTableHeader = () => {
            const propsData = {
                cols: data.cols,
                color: props.color,
                showCheckbox: props.showCheckbox,
                dark: props.dark,
                align: props.align,
                showSequence: props.showSequence,
                options: headerOptions.value,
                onFilter,
                onSort,
                onSelectAll,
            };
            const content = data.cols.reduce((acc, col) => {
                const slotName = `${col.key}-filter`;
                if (col && slots[slotName]) {
                    acc[slotName] = addScopedSlot(slotName, slots);
                }
                return acc;
            }, {});
            content.header = addScopedSlot('header', slots);
            return h(VDataTableHeader, propsData, content);
        };
        const genTableBody = () => {
            const propsData = {
                cols: data.cols,
                rows: data.rows,
                page: data.page,
                rowsOnPage: data.rowsOnPage,
                showCheckbox: props.showCheckbox,
                checkAllRows: data.isAllRowsChecked,
                align: props.align,
                dark: props.dark,
                showSequence: props.showSequence,
                color: props.color,
                onSelect,
                ['onClick:row']: (e) => emit('click:row', e),
                ['onDblclick:row']: (e) => emit('dblclick:row', e),
                ['onContextmenu:row']: (e) => emit('contextmenu:row', e),
            };
            const content = props.cols.reduce((acc, col) => {
                if (col && slots[col.key]) {
                    acc[col.key] = addScopedSlot(col.key, slots);
                }
                return acc;
            }, {});
            return h(VDataTableBody, propsData, content);
        };
        const genTableFooter = () => {
            const propsData = {
                pages: pages.value,
                page: data.page,
                firstOnPage: firstOnPage.value,
                lastOnPage: lastOnPage.value,
                pageCorrection: pageCorrection.value,
                rowsOnPage: data.rowsOnPage,
                rowsLength: data.rows?.length,
                options: footerOptions.value,
                onPrevPage,
                onNextPage,
                onSelectRowsCount,
                onLastPage: () => emit('last-page', props.rows.length),
                onCorrectPage: (val) => (data.page += val),
            };
            const content = slots['pagination-text']
                ? {
                    ['pagination-text']: () => slots['pagination-text'] &&
                        slots['pagination-text']({
                            start: firstOnPage.value,
                            last: lastOnPage.value,
                            length: data.rows?.length,
                        }),
                }
                : '';
            return h(VDataTableFooter, propsData, content);
        };
        const genTableInner = () => {
            const propsData = {
                class: 'v-data-table__inner',
            };
            return h('div', propsData, [genTableHeader(), genTableBody()]);
        };
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
            };
            return h('div', propsData, [
                slots.toolbar && genTableTools(),
                genTableInner(),
                genTableFooter(),
            ]);
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3Z1ZWxhbmQvc3JjL2NvbXBvbmVudHMvVkRhdGFUYWJsZS9WRGF0YVRhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsUUFBUSxFQUFFLE1BQU0sS0FBSyxDQUFBO0FBR25FLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUl4RCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQTtBQUNyRCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUE7QUFDakQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sb0JBQW9CLENBQUE7QUFHckQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQTtBQXFCN0MsZUFBZSxlQUFlLENBQUM7SUFDN0IsSUFBSSxFQUFFLGNBQWM7SUFDcEIsS0FBSyxFQUFFO1FBQ0wsSUFBSSxFQUFFO1lBQ0osSUFBSSxFQUFFLEtBQUs7WUFDWCxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRTtTQUNsQjtRQUNELElBQUksRUFBRTtZQUNKLElBQUksRUFBRSxLQUFLO1lBQ1gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUU7U0FDbEI7UUFDRCxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsT0FBTztRQUNyQixLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLFNBQVMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7U0FDOUQ7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8s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QU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztnQkFDcEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO2FBQ3BCLENBQUE7WUFFRCxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFO2dCQUN6QixLQUFLLENBQUMsT0FBTyxJQUFJLGFBQWEsRUFBRTtnQkFDaEMsYUFBYSxFQUFFO2dCQUNmLGNBQWMsRUFBRTthQUNqQixDQUFDLENBQUE7UUFDSixDQUFDLENBQUE7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVnVlIEFQSVxuaW1wb3J0IHsgaCwgd2F0Y2gsIGNvbXB1dGVkLCBkZWZpbmVDb21wb25lbnQsIHJlYWN0aXZlIH0gZnJvbSAndnVlJ1xuXG4vLyBFZmZlY3RzXG5pbXBvcnQgeyB1c2VDb2xvcnMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtY29sb3JzJ1xuLy8gaW1wb3J0IHsgdXNlVGhlbWUgfSBmcm9tICcuLi8uLi9lZmZlY3RzL3VzZS10aGVtZSdcblxuLy8gQ29tcG9uZW50c1xuaW1wb3J0IHsgVkRhdGFUYWJsZUhlYWRlciB9IGZyb20gJy4vVkRhdGFUYWJsZUhlYWRlcidcbmltcG9ydCB7IFZEYXRhVGFibGVCb2R5IH0gZnJvbSAnLi9WRGF0YVRhYmxlQm9keSdcbmltcG9ydCB7IFZEYXRhVGFibGVGb290ZXIgfSBmcm9tICcuL1ZEYXRhVGFibGVGb290ZXInXG5cbi8vIEhlbHBlcnNcbmltcG9ydCB7IGFkZFNjb3BlZFNsb3QgfSBmcm9tICcuLi8uLi9oZWxwZXJzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUsIFByb3BUeXBlIH0gZnJvbSAndnVlJ1xuaW1wb3J0IHtcbiAgRGF0YUNvbHVtbixcbiAgRGF0YUNvbHVtblByb3BzLFxuICBGb290ZXJPcHRpb25zLFxuICBIZWFkZXJPcHRpb25zLFxuICBUYWJsZUZpbHRlcixcbn0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnXG5cbnR5cGUgVGFibGVTdGF0ZSA9IHtcbiAgY29sczogRGF0YUNvbHVtbltdXG4gIHJvd3M6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXVxuICBjaGVja2VkUm93czogeyBba2V5OiBzdHJpbmddOiBhbnkgfVtdXG4gIHJvd3NPblBhZ2U6IG51bWJlclxuICBwYWdlOiBudW1iZXJcbiAgaXNBbGxSb3dzQ2hlY2tlZDogYm9vbGVhblxufVxuXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1kYXRhLXRhYmxlJyxcbiAgcHJvcHM6IHtcbiAgICBjb2xzOiB7XG4gICAgICB0eXBlOiBBcnJheSxcbiAgICAgIGRlZmF1bHQ6ICgpID0+IFtdLFxuICAgIH0sXG4gICAgcm93czoge1xuICAgICAgdHlwZTogQXJyYXksXG4gICAgICBkZWZhdWx0OiAoKSA9PiBbXSxcbiAgICB9LFxuICAgIHNob3dTZXF1ZW5jZTogQm9vbGVhbixcbiAgICBzaG93Q2hlY2tib3g6IEJvb2xlYW4sXG4gICAgYWxpZ246IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIHZhbGlkYXRvcjogKHZhbCkgPT4gWydsZWZ0JywgJ2NlbnRlcicsICdyaWdodCddLmluY2x1ZGVzKHZhbCksXG4gICAgfSxcbiAgICBjb2xvcjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICBoZWFkZXJPcHRpb25zOiB7XG4gICAgICB0eXBlOiBPYmplY3QgYXMgUHJvcFR5cGU8SGVhZGVyT3B0aW9ucz4sXG4gICAgICBkZWZhdWx0OiAoKSA9PiAoe30pLFxuICAgIH0sXG4gICAgZm9vdGVyT3B0aW9uczoge1xuICAgICAgdHlwZTogT2JqZWN0IGFzIFByb3BUeXBlPEZvb3Rlck9wdGlvbnM+LFxuICAgICAgZGVmYXVsdDogKCkgPT4gKHt9KSxcbiAgICB9LFxuICAgIGN1c3RvbUZpbHRlcjogRnVuY3Rpb24sXG4gIH0gYXMgYW55LFxuXG4gIGVtaXRzOiBbXG4gICAgJ2xhc3QtcGFnZScsXG4gICAgJ3NlbGVjdDpyb3cnLFxuICAgICdjbGljazpyb3cnLFxuICAgICdkYmxjbGljazpyb3cnLFxuICAgICdjb250ZXh0bWVudTpyb3cnLFxuICBdLFxuXG4gIHNldHVwKHByb3BzLCB7IHNsb3RzLCBlbWl0IH0pIHtcbiAgICBjb25zdCBkYXRhID0gcmVhY3RpdmU8VGFibGVTdGF0ZT4oe1xuICAgICAgY29sczogW10sXG4gICAgICByb3dzOiBbXSxcbiAgICAgIGNoZWNrZWRSb3dzOiBbXSxcbiAgICAgIHJvd3NPblBhZ2U6IDIwLFxuICAgICAgcGFnZTogMSxcbiAgICAgIGlzQWxsUm93c0NoZWNrZWQ6IGZhbHNlLFxuICAgIH0pXG5cbiAgICBjb25zdCB7IHNldEJhY2tncm91bmRDc3NDb2xvciwgc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yIH0gPSB1c2VDb2xvcnMoKVxuXG4gICAgY29uc3QgZmlsdGVycyA9IHt9XG5cbiAgICBjb25zdCBjbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+ICh7XG4gICAgICAndi1kYXRhLXRhYmxlJzogdHJ1ZSxcbiAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBzdHlsZXMgPSBjb21wdXRlZCgoKSA9PiAoe1xuICAgICAgLi4uKHByb3BzLmNvbG9yID8gc2V0QmFja2dyb3VuZENzc0NvbG9yKHByb3BzLmNvbG9yKSA6IHt9KSxcbiAgICB9KSlcblxuICAgIGNvbnN0IGhlYWRlck9wdGlvbnMgPSBjb21wdXRlZDxIZWFkZXJPcHRpb25zPigoKSA9PiAoe1xuICAgICAgY29sb3I6IHByb3BzLmNvbG9yLFxuICAgICAgZGFyazogcHJvcHMuZGFyayxcbiAgICAgIC4uLnByb3BzLmhlYWRlck9wdGlvbnMsXG4gICAgfSkpXG5cbiAgICBjb25zdCBmb290ZXJPcHRpb25zID0gY29tcHV0ZWQ8Rm9vdGVyT3B0aW9ucz4oKCkgPT4gKHtcbiAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgIGRhcms6IHByb3BzLmRhcmssXG4gICAgICAuLi5wcm9wcy5mb290ZXJPcHRpb25zLFxuICAgIH0pKVxuXG4gICAgY29uc3QgcGFnZXMgPSBjb21wdXRlZDxudW1iZXI+KCgpID0+IHtcbiAgICAgIHJldHVybiBNYXRoLmNlaWwoZGF0YS5yb3dzPy5sZW5ndGggLyBkYXRhLnJvd3NPblBhZ2UpXG4gICAgfSlcblxuICAgIGNvbnN0IGZpcnN0T25QYWdlID0gY29tcHV0ZWQ8bnVtYmVyPigoKSA9PiB7XG4gICAgICByZXR1cm4gZGF0YS5wYWdlID09PSAxID8gMSA6IChkYXRhLnBhZ2UgLSAxKSAqIGRhdGEucm93c09uUGFnZSArIDFcbiAgICB9KVxuXG4gICAgY29uc3QgbGFzdE9uUGFnZSA9IGNvbXB1dGVkPG51bWJlcj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGRhdGEucGFnZSAqIGRhdGEucm93c09uUGFnZSA+IGRhdGEucm93cz8ubGVuZ3RoXG4gICAgICAgID8gZGF0YS5yb3dzPy5sZW5ndGhcbiAgICAgICAgOiBkYXRhLnBhZ2UgKiBkYXRhLnJvd3NPblBhZ2VcbiAgICB9KVxuXG4gICAgY29uc3QgcGFnZUNvcnJlY3Rpb24gPSBjb21wdXRlZDxudW1iZXIgfCBudWxsPigoKSA9PiB7XG4gICAgICBpZiAoKGRhdGEucGFnZSAtIDEpICogZGF0YS5yb3dzT25QYWdlID4gZGF0YS5yb3dzPy5sZW5ndGgpIHtcbiAgICAgICAgcmV0dXJuIE1hdGguY2VpbChcbiAgICAgICAgICAoZGF0YS5wYWdlICogZGF0YS5yb3dzT25QYWdlIC0gZGF0YS5yb3dzPy5sZW5ndGgpIC8gZGF0YS5yb3dzT25QYWdlLFxuICAgICAgICApXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBudWxsXG4gICAgfSlcblxuICAgIHdhdGNoKFxuICAgICAgKCkgPT4gcHJvcHMuY29scyxcbiAgICAgICh0bykgPT4gKGRhdGEuY29scyA9IHRvKSxcbiAgICAgIHsgaW1tZWRpYXRlOiB0cnVlIH0sXG4gICAgKVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5yb3dzLFxuICAgICAgKHRvKSA9PiAoZGF0YS5yb3dzID0gdG8pLFxuICAgICAgeyBpbW1lZGlhdGU6IHRydWUgfSxcbiAgICApXG5cbiAgICBjb25zdCBvblNlbGVjdEFsbCA9ICh2YWx1ZTogYm9vbGVhbikgPT4ge1xuICAgICAgZGF0YS5pc0FsbFJvd3NDaGVja2VkID0gdmFsdWVcbiAgICAgIGRhdGEucm93cy5mb3JFYWNoKChyb3cpID0+IChyb3cuY2hlY2tlZCA9IHZhbHVlKSlcbiAgICB9XG5cbiAgICBjb25zdCBvblNlbGVjdCA9IDxUIGV4dGVuZHMgVGFibGVTdGF0ZVsncm93cyddPihyb3dzOiBUKSA9PiB7XG4gICAgICBkYXRhLmNoZWNrZWRSb3dzID0gcm93c1xuICAgICAgZW1pdCgnc2VsZWN0OnJvdycsIGRhdGEuY2hlY2tlZFJvd3MpXG4gICAgfVxuXG4gICAgY29uc3Qgb25QcmV2UGFnZSA9IChudW06IG51bWJlcikgPT4ge1xuICAgICAgZGF0YS5wYWdlID0gZGF0YS5wYWdlID4gMSA/IGRhdGEucGFnZSArIG51bSA6IGRhdGEucGFnZVxuICAgIH1cblxuICAgIGNvbnN0IG9uTmV4dFBhZ2UgPSAobnVtOiBudW1iZXIpID0+IHtcbiAgICAgIGlmIChkYXRhLnJvd3MubGVuZ3RoIC0gZGF0YS5wYWdlICogZGF0YS5yb3dzT25QYWdlID4gMCkge1xuICAgICAgICBkYXRhLnBhZ2UgKz0gbnVtXG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3Qgb25Tb3J0ID0gPFQgZXh0ZW5kcyBEYXRhQ29sdW1uLCBTIGV4dGVuZHMgRGF0YUNvbHVtblByb3BzPihcbiAgICAgIGNvbDogVCAmIFMsXG4gICAgKSA9PiB7XG4gICAgICBpZiAoY29sLnNvcnRlZCkge1xuICAgICAgICBjb2wuc29ydGVkID0gIWNvbC5zb3J0ZWRcbiAgICAgICAgcmV0dXJuIHNvcnRDb2x1bW4oY29sKVxuICAgICAgfVxuXG4gICAgICBkYXRhLmNvbHMuZm9yRWFjaCgoYzogVCAmIFMpID0+IChjLnNvcnRlZCA9IGNvbC5rZXkgPT09IGMua2V5KSlcblxuICAgICAgc29ydENvbHVtbihjb2wpXG4gICAgfVxuXG4gICAgY29uc3Qgc29ydENvbHVtbiA9IDxUIGV4dGVuZHMgRGF0YUNvbHVtbiwgUyBleHRlbmRzIERhdGFDb2x1bW5Qcm9wcz4oXG4gICAgICBjb2w6IFQgJiBTLFxuICAgICkgPT4ge1xuICAgICAgaWYgKCFjb2wuc29ydGVkKSB7XG4gICAgICAgIHJldHVybiBkYXRhLnJvd3M/LnJldmVyc2UoKVxuICAgICAgfVxuXG4gICAgICBjb25zdCBleGVjdXRvciA9XG4gICAgICAgIGNvbC5zb3J0IHx8XG4gICAgICAgICgoYSwgYikgPT4ge1xuICAgICAgICAgIGlmIChjb2wuZm9ybWF0KSByZXR1cm4gY29sLmZvcm1hdChhKSA+IGNvbC5mb3JtYXQoYikgPyAxIDogLTFcbiAgICAgICAgICBpZiAoY29sLnNvcnRlZCkgcmV0dXJuIGFbY29sLmtleV0gPiBiW2NvbC5rZXldID8gMSA6IC0xXG4gICAgICAgIH0pXG5cbiAgICAgIGRhdGEucm93cz8uc29ydChleGVjdXRvciBhcyBhbnkpXG4gICAgfVxuXG4gICAgY29uc3Qgb25GaWx0ZXIgPSAoeyB2YWx1ZSwgY29sIH06IFRhYmxlRmlsdGVyKSA9PiB7XG4gICAgICBpZiAoIXZhbHVlICYmIGZpbHRlcnNbY29sLmtleV0pIGRlbGV0ZSBmaWx0ZXJzW2NvbC5rZXldXG5cbiAgICAgIGlmICh2YWx1ZSkgZmlsdGVyc1tjb2wua2V5XSA9IHZhbHVlXG5cbiAgICAgIGlmIChjb2wuZmlsdGVyKSB7XG4gICAgICAgIHJldHVybiAoZGF0YS5yb3dzID0gY29sLmZpbHRlcih7IHZhbHVlLCBjb2wgfSkpXG4gICAgICB9XG4gICAgICBpZiAocHJvcHMuY3VzdG9tRmlsdGVyKSB7XG4gICAgICAgIHJldHVybiBwcm9wcy5jdXN0b21GaWx0ZXIoZmlsdGVycyBhcyBhbnkpXG4gICAgICB9XG4gICAgICBpZiAoIU9iamVjdC5rZXlzKGZpbHRlcnMpLmxlbmd0aCkge1xuICAgICAgICByZXR1cm4gKGRhdGEucm93cyA9IHByb3BzLnJvd3MpXG4gICAgICB9XG5cbiAgICAgIGRhdGEucm93cyA9IGZpbHRlclJvd3MocHJvcHMucm93cywgcHJvcHMuY29scylcbiAgICAgIGRhdGEucGFnZSA9IDFcbiAgICB9XG5cbiAgICBjb25zdCBvblNlbGVjdFJvd3NDb3VudCA9IChjb3VudDogbnVtYmVyKSA9PiB7XG4gICAgICBkYXRhLnJvd3NPblBhZ2UgPSBjb3VudFxuICAgIH1cblxuICAgIGNvbnN0IGZpbHRlclJvd3MgPSA8VCwgQyBleHRlbmRzIERhdGFDb2x1bW4+KHJvd3M6IFRbXSwgY29sczogQ1tdKSA9PiB7XG4gICAgICBjb25zdCBmaWx0ZXJLZXlzID0gT2JqZWN0LmtleXMoZmlsdGVycylcblxuICAgICAgcmV0dXJuIHJvd3MucmVkdWNlKChhY2MsIHJvdykgPT4ge1xuICAgICAgICBjb25zdCByb3dSZXN1bHRzOiBUW10gPSBbXVxuXG4gICAgICAgIGZpbHRlcktleXMuZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICAgICAgY29uc3QgeyBmb3JtYXQgfSA9IGNvbHMuZmluZCgoY29sKSA9PiBjb2wua2V5ID09PSBrZXkpIGFzIERhdGFDb2x1bW5cblxuICAgICAgICAgIGNvbnN0IHZhbHVlID0gZm9ybWF0ID8gZm9ybWF0KHJvdykgOiByb3dba2V5XVxuXG4gICAgICAgICAgY29uc3Qgcm93S2V5VmFsdWUgPSBgJHsgdmFsdWUgfWAudG9Mb3dlckNhc2UoKVxuICAgICAgICAgIGNvbnN0IGZpbHRlclZhbHVlID0gYCR7IGZpbHRlcnNba2V5XSB9YC50b0xvd2VyQ2FzZSgpXG5cbiAgICAgICAgICBpZiAocm93S2V5VmFsdWUuaW5jbHVkZXMoZmlsdGVyVmFsdWUpKSB7XG4gICAgICAgICAgICByb3dSZXN1bHRzLnB1c2gocm93W2tleV0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICByb3dSZXN1bHRzLmxlbmd0aCA9PT0gZmlsdGVyS2V5cy5sZW5ndGggJiZcbiAgICAgICAgICByb3dSZXN1bHRzLmV2ZXJ5KCh2YWx1ZSkgPT4gISF2YWx1ZSlcbiAgICAgICAgKSB7XG4gICAgICAgICAgYWNjLnB1c2gocm93KVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwgW10gYXMgVFtdKVxuICAgIH1cblxuICAgIGNvbnN0IGdlblRhYmxlVG9vbHMgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0geyBjbGFzczogJ3YtZGF0YS10YWJsZV9fdG9vbGJhcicgfVxuXG4gICAgICByZXR1cm4gaCgnZGl2JywgcHJvcHNEYXRhLCB7XG4gICAgICAgIGRlZmF1bHQ6ICgpID0+IHNsb3RzLnRvb2xiYXIgJiYgc2xvdHMudG9vbGJhcigpLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UYWJsZUhlYWRlciA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNvbHM6IGRhdGEuY29scyxcbiAgICAgICAgY29sb3I6IHByb3BzLmNvbG9yLFxuICAgICAgICBzaG93Q2hlY2tib3g6IHByb3BzLnNob3dDaGVja2JveCxcbiAgICAgICAgZGFyazogcHJvcHMuZGFyayxcbiAgICAgICAgYWxpZ246IHByb3BzLmFsaWduLFxuICAgICAgICBzaG93U2VxdWVuY2U6IHByb3BzLnNob3dTZXF1ZW5jZSxcbiAgICAgICAgb3B0aW9uczogaGVhZGVyT3B0aW9ucy52YWx1ZSxcbiAgICAgICAgb25GaWx0ZXIsXG4gICAgICAgIG9uU29ydCxcbiAgICAgICAgb25TZWxlY3RBbGwsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBkYXRhLmNvbHMucmVkdWNlKChhY2MsIGNvbCkgPT4ge1xuICAgICAgICBjb25zdCBzbG90TmFtZSA9IGAkeyBjb2wua2V5IH0tZmlsdGVyYFxuXG4gICAgICAgIGlmIChjb2wgJiYgc2xvdHNbc2xvdE5hbWVdKSB7XG4gICAgICAgICAgYWNjW3Nsb3ROYW1lXSA9IGFkZFNjb3BlZFNsb3Qoc2xvdE5hbWUsIHNsb3RzKVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwge30gYXMgYW55KVxuXG4gICAgICBjb250ZW50LmhlYWRlciA9IGFkZFNjb3BlZFNsb3QoJ2hlYWRlcicsIHNsb3RzKVxuXG4gICAgICByZXR1cm4gaChWRGF0YVRhYmxlSGVhZGVyLCBwcm9wc0RhdGEsIGNvbnRlbnQpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuVGFibGVCb2R5ID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY29sczogZGF0YS5jb2xzLFxuICAgICAgICByb3dzOiBkYXRhLnJvd3MsXG4gICAgICAgIHBhZ2U6IGRhdGEucGFnZSxcbiAgICAgICAgcm93c09uUGFnZTogZGF0YS5yb3dzT25QYWdlLFxuICAgICAgICBzaG93Q2hlY2tib3g6IHByb3BzLnNob3dDaGVja2JveCxcbiAgICAgICAgY2hlY2tBbGxSb3dzOiBkYXRhLmlzQWxsUm93c0NoZWNrZWQsXG4gICAgICAgIGFsaWduOiBwcm9wcy5hbGlnbixcbiAgICAgICAgZGFyazogcHJvcHMuZGFyayxcbiAgICAgICAgc2hvd1NlcXVlbmNlOiBwcm9wcy5zaG93U2VxdWVuY2UsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5jb2xvcixcbiAgICAgICAgb25TZWxlY3QsXG4gICAgICAgIFsnb25DbGljazpyb3cnXTogKGUpID0+IGVtaXQoJ2NsaWNrOnJvdycsIGUpLFxuICAgICAgICBbJ29uRGJsY2xpY2s6cm93J106IChlKSA9PiBlbWl0KCdkYmxjbGljazpyb3cnLCBlKSxcbiAgICAgICAgWydvbkNvbnRleHRtZW51OnJvdyddOiAoZSkgPT4gZW1pdCgnY29udGV4dG1lbnU6cm93JywgZSksXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBwcm9wcy5jb2xzLnJlZHVjZSgoYWNjLCBjb2wpID0+IHtcbiAgICAgICAgaWYgKGNvbCAmJiBzbG90c1tjb2wua2V5XSkge1xuICAgICAgICAgIGFjY1tjb2wua2V5XSA9IGFkZFNjb3BlZFNsb3QoY29sLmtleSwgc2xvdHMpXG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGFjY1xuICAgICAgfSwge30pXG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVCb2R5LCBwcm9wc0RhdGEsIGNvbnRlbnQpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuVGFibGVGb290ZXIgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBwYWdlczogcGFnZXMudmFsdWUsXG4gICAgICAgIHBhZ2U6IGRhdGEucGFnZSxcbiAgICAgICAgZmlyc3RPblBhZ2U6IGZpcnN0T25QYWdlLnZhbHVlLFxuICAgICAgICBsYXN0T25QYWdlOiBsYXN0T25QYWdlLnZhbHVlLFxuICAgICAgICBwYWdlQ29ycmVjdGlvbjogcGFnZUNvcnJlY3Rpb24udmFsdWUsXG4gICAgICAgIHJvd3NPblBhZ2U6IGRhdGEucm93c09uUGFnZSxcbiAgICAgICAgcm93c0xlbmd0aDogZGF0YS5yb3dzPy5sZW5ndGgsXG4gICAgICAgIG9wdGlvbnM6IGZvb3Rlck9wdGlvbnMudmFsdWUsXG4gICAgICAgIG9uUHJldlBhZ2UsXG4gICAgICAgIG9uTmV4dFBhZ2UsXG4gICAgICAgIG9uU2VsZWN0Um93c0NvdW50LFxuICAgICAgICBvbkxhc3RQYWdlOiAoKSA9PiBlbWl0KCdsYXN0LXBhZ2UnLCBwcm9wcy5yb3dzLmxlbmd0aCksXG4gICAgICAgIG9uQ29ycmVjdFBhZ2U6ICh2YWwpID0+IChkYXRhLnBhZ2UgKz0gdmFsKSxcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29udGVudCA9IHNsb3RzWydwYWdpbmF0aW9uLXRleHQnXVxuICAgICAgICA/IHtcbiAgICAgICAgICBbJ3BhZ2luYXRpb24tdGV4dCddOiAoKSA9PlxuICAgICAgICAgICAgc2xvdHNbJ3BhZ2luYXRpb24tdGV4dCddICYmXG4gICAgICAgICAgICBzbG90c1sncGFnaW5hdGlvbi10ZXh0J10oe1xuICAgICAgICAgICAgICBzdGFydDogZmlyc3RPblBhZ2UudmFsdWUsXG4gICAgICAgICAgICAgIGxhc3Q6IGxhc3RPblBhZ2UudmFsdWUsXG4gICAgICAgICAgICAgIGxlbmd0aDogZGF0YS5yb3dzPy5sZW5ndGgsXG4gICAgICAgICAgICB9KSxcbiAgICAgICAgfVxuICAgICAgICA6ICcnXG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVGb290ZXIsIHByb3BzRGF0YSwgY29udGVudClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UYWJsZUlubmVyID0gKCk6IFZOb2RlID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6ICd2LWRhdGEtdGFibGVfX2lubmVyJyxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoJ2RpdicsIHByb3BzRGF0YSwgW2dlblRhYmxlSGVhZGVyKCksIGdlblRhYmxlQm9keSgpXSlcbiAgICB9XG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjbGFzczogY2xhc3Nlcy52YWx1ZSxcbiAgICAgICAgc3R5bGU6IHN0eWxlcy52YWx1ZSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoJ2RpdicsIHByb3BzRGF0YSwgW1xuICAgICAgICBzbG90cy50b29sYmFyICYmIGdlblRhYmxlVG9vbHMoKSxcbiAgICAgICAgZ2VuVGFibGVJbm5lcigpLFxuICAgICAgICBnZW5UYWJsZUZvb3RlcigpLFxuICAgICAgXSlcbiAgICB9XG4gIH0sXG59KVxuIl19