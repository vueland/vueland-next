import { defineComponent, watch, h, withDirectives, computed, onMounted, onBeforeUnmount, vShow, } from 'vue';
import { autoPositionProps, useAutoPosition, } from '../../composables/use-auto-position';
import { activatorProps, useActivator } from '../../composables/use-activator';
import { useDetach } from '../../composables/use-detach';
import { useElevation } from '../../composables/use-elevation';
import { useToggle } from '../../composables/use-toggle';
import { useTransition } from '../../composables/use-transition';
import { positionProps } from '../../composables/use-position';
import { convertToUnit } from '../../helpers';
import { clickOutside, resize } from '../../directives';
export default defineComponent({
    name: 'v-menu',
    directives: {
        clickOutside,
        resize,
    },
    props: {
        maxHeight: {
            type: [Number, String],
            default: 200,
        },
        width: {
            type: [Number, String],
            default: 0,
        },
        zIndex: {
            type: [String, Number],
            default: 10,
        },
        openOnHover: Boolean,
        openOnClick: Boolean,
        openOnContextmenu: Boolean,
        closeOnClick: {
            type: Boolean,
            default: true,
        },
        elevation: {
            type: [Number, String],
            default: 10,
        },
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        modelValue: Boolean,
        inputActivator: {
            type: String,
            default: '',
        },
        ...positionProps(),
        ...autoPositionProps(),
        ...activatorProps(),
    },
    emits: ['show', 'hide'],
    setup(props, { emit, slots }) {
        const { elevationClasses } = useElevation(props);
        const { isActive } = useToggle(props);
        const { contentRef, setDimensions, dimensions } = useAutoPosition(props);
        const { setDetached, removeDetached } = useDetach();
        const { activatorRef, getActivator, genActivatorListeners, addActivatorEvents, removeActivatorEvents, } = useActivator(props);
        const setDimensionsOn = (e, flag) => {
            setDimensions(getActivator(e)).then(() => {
                requestAnimationFrame(() => (isActive.value = flag));
            });
        };
        const handlers = {
            click: (e) => setDimensionsOn(e, props.openOnClick),
            mouseenter: (e) => setDimensionsOn(e, props.openOnHover),
            mouseleave: (e) => setDimensionsOn(e, !props.openOnHover),
            contextmenu: (e) => setDimensionsOn(e, props.openOnContextmenu),
        };
        const listeners = genActivatorListeners(props, handlers);
        const directive = computed(() => {
            return isActive.value
                ? {
                    handler: (e) => {
                        if (props.internalActivator &&
                            activatorRef.value.contains(e.target))
                            return;
                        isActive.value = false;
                    },
                    closeConditional: props.closeOnClick,
                }
                : undefined;
        });
        const calcWidth = computed(() => {
            return props.width || +dimensions.content.width;
        });
        watch(isActive, (to) => {
            to && emit('show');
            !to && emit('hide');
        });
        watch(() => [props.positionY, props.positionX], () => setDimensions(activatorRef.value));
        watch(() => props.modelValue, (to) => {
            isActive.value = false;
            setTimeout(() => (isActive.value = to));
        });
        const contentClasses = computed(() => ({
            'v-menu__content': true,
            ...elevationClasses.value,
        }));
        const contentStyles = computed(() => ({
            top: convertToUnit(dimensions.content.top),
            left: convertToUnit(dimensions.content.left),
            zIndex: props.zIndex,
        }));
        const onContentClick = () => {
            isActive.value = !props.closeOnClick;
        };
        const onResize = () => {
            if (!isActive.value)
                return;
            requestAnimationFrame(() => setDimensions(activatorRef.value));
        };
        const genActivatorSlot = () => {
            if (slots.activator) {
                const slotContent = slots.activator({ on: listeners });
                if (typeof slotContent[0].type === 'object') {
                    return h('div', { ref: activatorRef }, h(slotContent[0]));
                }
                return h(slotContent[0], { ref: activatorRef });
            }
            return null;
        };
        const genContentSlot = () => {
            const propsData = {
                ref: contentRef,
                class: contentClasses.value,
                style: contentStyles.value,
                onClick: onContentClick,
            };
            const slotContent = h('div', {
                class: 'v-menu__slot',
                style: {
                    maxHeight: convertToUnit(props.maxHeight),
                    width: convertToUnit(calcWidth.value),
                },
            }, [slots.default && slots.default()]);
            const content = h('div', propsData, slotContent);
            const directives = [
                [vShow, isActive.value],
                [resize, onResize],
                [clickOutside, directive.value],
            ];
            return withDirectives(content, directives);
        };
        onMounted(() => {
            activatorRef.value = getActivator();
            addActivatorEvents();
            setDetached(contentRef.value);
        });
        onBeforeUnmount(() => {
            removeActivatorEvents();
            removeDetached(contentRef.value);
        });
        return () => [
            h('div', { class: { 'v-menu': true } }),
            slots.activator && genActivatorSlot(),
            useTransition(genContentSlot(), 'fade'),
        ];
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVk1lbnUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wYWNrYWdlcy92dWVsYW5kL3NyYy9jb21wb25lbnRzL1ZNZW51L1ZNZW51LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFDTCxlQUFlLEVBQ2YsS0FBSyxFQUNMLENBQUMsRUFDRCxjQUFjLEVBQ2QsUUFBUSxFQUNSLFNBQVMsRUFDVCxlQUFlLEVBQ2YsS0FBSyxHQUdOLE1BQU0sS0FBSyxDQUFBO0FBR1osT0FBTyxFQUNMLGlCQUFpQixFQUNqQixlQUFlLEdBQ2hCLE1BQU0scUNBQXFDLENBQUE7QUFDNUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUM5RSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sOEJBQThCLENBQUE7QUFDeEQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlDQUFpQyxDQUFBO0FBQzlELE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUN4RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFDaEUsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGdDQUFnQyxDQUFBO0FBRzlELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFHN0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUV2RCxlQUFlLGVBQWUsQ0FBQztJQUM3QixJQUFJLEVBQUUsUUFBUTtJQUNkLFVBQVUsRUFBRTtRQUNWLFlBQVk7UUFDWixNQUFNO0tBQ1A7SUFDRCxLQUFLLEVBQUU7UUFDTCxTQUFTLEVBQUU7WUFDVCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxHQUFHO1NBQ2I7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDO1NBQ1g7UUFDRCxNQUFNLEVBQUU7WUFDTixJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxXQUFXLEVBQUUsT0FBTztRQUNwQixXQUFXLEVBQUUsT0FBTztRQUNwQixpQkFBaUIsRUFBRSxPQUFPO1FBQzFCLFlBQVksRUFBRTtZQUNaLElBQUksRUFBRSxPQUFPO1lBQ2IsT0FBTyxFQUFFLElBQUk7U0FDZDtRQUNELFNBQVMsRUFBRTtZQUNULElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELE9BQU8sRUFBRTtZQUNQLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELE9BQU8sRUFBRTtZQUNQLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELFVBQVUsRUFBRSxPQUFPO1FBQ25CLGNBQWMsRUFBRTtZQUNkLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELEdBQUcsYUFBYSxFQUFFO1FBQ2xCLEdBQUcsaUJBQWlCLEVBQUU7UUFDdEIsR0FBRyxjQUFjLEVBQUU7S0FDcEI7SUFFRCxLQUFLLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO0lBRXZCLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFO1FBQzFCLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNoRCxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3JDLE1BQU0sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLFVBQVUsRUFBRSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUN4RSxNQUFNLEVBQUUsV0FBVyxFQUFFLGNBQWMsRUFBRSxHQUFHLFNBQVMsRUFBRSxDQUFBO1FBQ25ELE1BQU0sRUFDSixZQUFZLEVBQ1osWUFBWSxFQUNaLHFCQUFxQixFQUNyQixrQkFBa0IsRUFDbEIscUJBQXFCLEdBQ3RCLEdBQUcsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBRXZCLE1BQU0sZUFBZSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ2xDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUN4QyxxQkFBcUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQTtZQUN0RCxDQUFDLENBQUMsQ0FBQTtRQUNKLENBQUMsQ0FBQTtRQUVELE1BQU0sUUFBUSxHQUFHO1lBQ2YsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDbkQsVUFBVSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxXQUFXLENBQUM7WUFDeEQsVUFBVSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQztZQUN6RCxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLGlCQUFpQixDQUFDO1NBQ2hFLENBQUE7UUFFRCxNQUFNLFNBQVMsR0FBRyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFFeEQsTUFBTSxTQUFTLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUM5QixPQUFPLFFBQVEsQ0FBQyxLQUFLO2dCQUNuQixDQUFDLENBQUM7b0JBQ0EsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUU7d0JBQ2IsSUFDRSxLQUFLLENBQUMsaUJBQWlCOzRCQUN2QixZQUFZLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDOzRCQUNyQyxPQUFNO3dCQUNSLFFBQVEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFBO29CQUN4QixDQUFDO29CQUNDLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxZQUFZO2lCQUNyQztnQkFDSCxDQUFDLENBQUMsU0FBUyxDQUFBO1FBQ2YsQ0FBQyxDQUFDLENBQUE7UUFFRixNQUFNLFNBQVMsR0FBRyxRQUFRLENBQWtCLEdBQUcsRUFBRTtZQUMvQyxPQUFPLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQTtRQUNqRCxDQUFDLENBQUMsQ0FBQTtRQUVGLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLEVBQUUsRUFBRTtZQUNyQixFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQ2xCLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUNyQixDQUFDLENBQUMsQ0FBQTtRQUVGLEtBQUssQ0FDSCxHQUFHLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxFQUN4QyxHQUFHLEVBQUUsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLEtBQU0sQ0FBQyxDQUN6QyxDQUFBO1FBRUQsS0FBSyxDQUNILEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQ3RCLENBQUMsRUFBRSxFQUFFLEVBQUU7WUFDTCxRQUFRLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQTtZQUN0QixVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUE7UUFDekMsQ0FBQyxDQUNGLENBQUE7UUFFRCxNQUFNLGNBQWMsR0FBRyxRQUFRLENBQTBCLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDOUQsaUJBQWlCLEVBQUUsSUFBSTtZQUN2QixHQUFHLGdCQUFnQixDQUFDLEtBQUs7U0FDMUIsQ0FBQyxDQUFDLENBQUE7UUFFSCxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQWtDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDckUsR0FBRyxFQUFFLGFBQWEsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBRTtZQUMzQyxJQUFJLEVBQUUsYUFBYSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFFO1lBQzdDLE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtTQUNyQixDQUFDLENBQVEsQ0FBQTtRQUVWLE1BQU0sY0FBYyxHQUFHLEdBQUcsRUFBRTtZQUMxQixRQUFRLENBQUMsS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQTtRQUN0QyxDQUFDLENBQUE7UUFFRCxNQUFNLFFBQVEsR0FBRyxHQUFHLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLO2dCQUFFLE9BQU07WUFDM0IscUJBQXFCLENBQUMsR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxLQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ2pFLENBQUMsQ0FBQTtRQUVELE1BQU0sZ0JBQWdCLEdBQUcsR0FBaUIsRUFBRTtZQUMxQyxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUU7Z0JBQ25CLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQTtnQkFFdEQsSUFBSSxPQUFPLFdBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssUUFBUSxFQUFFO29CQUM1QyxPQUFPLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLFdBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7aUJBQzNEO2dCQUVELE9BQU8sQ0FBQyxDQUFDLFdBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsQ0FBQyxDQUFBO2FBQ2pEO1lBRUQsT0FBTyxJQUFJLENBQUE7UUFDYixDQUFDLENBQUE7UUFFRCxNQUFNLGNBQWMsR0FBRyxHQUFVLEVBQUU7WUFDakMsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLEdBQUcsRUFBRSxVQUFVO2dCQUNmLEtBQUssRUFBRSxjQUFjLENBQUMsS0FBSztnQkFDM0IsS0FBSyxFQUFFLGFBQWEsQ0FBQyxLQUFLO2dCQUMxQixPQUFPLEVBQUUsY0FBYzthQUN4QixDQUFBO1lBRUQsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUNuQixLQUFLLEVBQ0w7Z0JBQ0UsS0FBSyxFQUFFLGNBQWM7Z0JBQ3JCLEtBQUssRUFBRTtvQkFDTCxTQUFTLEVBQUUsYUFBYSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7b0JBQ3pDLEtBQUssRUFBRSxhQUFhLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztpQkFDdEM7YUFDRixFQUNELENBQUMsS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FDbkMsQ0FBQTtZQUVELE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsU0FBUyxFQUFFLFdBQVcsQ0FBQyxDQUFBO1lBRWhELE1BQU0sVUFBVSxHQUF1QjtnQkFDckMsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQztnQkFDdkIsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDO2dCQUNsQixDQUFDLFlBQVksRUFBRSxTQUFTLENBQUMsS0FBSyxDQUFDO2FBQ2hDLENBQUE7WUFFRCxPQUFPLGNBQWMsQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLENBQUE7UUFDNUMsQ0FBQyxDQUFBO1FBRUQsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNiLFlBQVksQ0FBQyxLQUFLLEdBQUcsWUFBWSxFQUFFLENBQUE7WUFFbkMsa0JBQWtCLEVBQUUsQ0FBQTtZQUNwQixXQUFXLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxDQUFBO1FBQ2hDLENBQUMsQ0FBQyxDQUFBO1FBRUYsZUFBZSxDQUFDLEdBQUcsRUFBRTtZQUNuQixxQkFBcUIsRUFBRSxDQUFBO1lBQ3ZCLGNBQWMsQ0FBQyxVQUFVLENBQUMsS0FBTSxDQUFDLENBQUE7UUFDbkMsQ0FBQyxDQUFDLENBQUE7UUFFRixPQUFPLEdBQUcsRUFBRSxDQUFDO1lBQ1gsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO1lBQ3ZDLEtBQUssQ0FBQyxTQUFTLElBQUksZ0JBQWdCLEVBQUU7WUFDckMsYUFBYSxDQUFDLGNBQWMsRUFBRSxFQUFFLE1BQU0sQ0FBQztTQUN4QyxDQUFBO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7XG4gIGRlZmluZUNvbXBvbmVudCxcbiAgd2F0Y2gsXG4gIGgsXG4gIHdpdGhEaXJlY3RpdmVzLFxuICBjb21wdXRlZCxcbiAgb25Nb3VudGVkLFxuICBvbkJlZm9yZVVubW91bnQsXG4gIHZTaG93LFxuICBWTm9kZSxcbiAgRGlyZWN0aXZlQXJndW1lbnRzLFxufSBmcm9tICd2dWUnXG5cbi8vIENvbXBvc2FibGVcbmltcG9ydCB7XG4gIGF1dG9Qb3NpdGlvblByb3BzLFxuICB1c2VBdXRvUG9zaXRpb24sXG59IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1hdXRvLXBvc2l0aW9uJ1xuaW1wb3J0IHsgYWN0aXZhdG9yUHJvcHMsIHVzZUFjdGl2YXRvciB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1hY3RpdmF0b3InXG5pbXBvcnQgeyB1c2VEZXRhY2ggfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtZGV0YWNoJ1xuaW1wb3J0IHsgdXNlRWxldmF0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLWVsZXZhdGlvbidcbmltcG9ydCB7IHVzZVRvZ2dsZSB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS10b2dnbGUnXG5pbXBvcnQgeyB1c2VUcmFuc2l0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXRyYW5zaXRpb24nXG5pbXBvcnQgeyBwb3NpdGlvblByb3BzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXBvc2l0aW9uJ1xuXG4vLyBIZWxwZXJzXG5pbXBvcnQgeyBjb252ZXJ0VG9Vbml0IH0gZnJvbSAnLi4vLi4vaGVscGVycydcblxuLy8gRGlyZWN0aXZlc1xuaW1wb3J0IHsgY2xpY2tPdXRzaWRlLCByZXNpemUgfSBmcm9tICcuLi8uLi9kaXJlY3RpdmVzJ1xuXG5leHBvcnQgZGVmYXVsdCBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1tZW51JyxcbiAgZGlyZWN0aXZlczoge1xuICAgIGNsaWNrT3V0c2lkZSxcbiAgICByZXNpemUsXG4gIH0sXG4gIHByb3BzOiB7XG4gICAgbWF4SGVpZ2h0OiB7XG4gICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgICAgZGVmYXVsdDogMjAwLFxuICAgIH0sXG4gICAgd2lkdGg6IHtcbiAgICAgIHR5cGU6IFtOdW1iZXIsIFN0cmluZ10sXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgekluZGV4OiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMTAsXG4gICAgfSxcbiAgICBvcGVuT25Ib3ZlcjogQm9vbGVhbixcbiAgICBvcGVuT25DbGljazogQm9vbGVhbixcbiAgICBvcGVuT25Db250ZXh0bWVudTogQm9vbGVhbixcbiAgICBjbG9zZU9uQ2xpY2s6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICBkZWZhdWx0OiB0cnVlLFxuICAgIH0sXG4gICAgZWxldmF0aW9uOiB7XG4gICAgICB0eXBlOiBbTnVtYmVyLCBTdHJpbmddLFxuICAgICAgZGVmYXVsdDogMTAsXG4gICAgfSxcbiAgICBvZmZzZXRYOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMjAsXG4gICAgfSxcbiAgICBvZmZzZXRZOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMjAsXG4gICAgfSxcbiAgICBtb2RlbFZhbHVlOiBCb29sZWFuLFxuICAgIGlucHV0QWN0aXZhdG9yOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJyxcbiAgICB9LFxuICAgIC4uLnBvc2l0aW9uUHJvcHMoKSxcbiAgICAuLi5hdXRvUG9zaXRpb25Qcm9wcygpLFxuICAgIC4uLmFjdGl2YXRvclByb3BzKCksXG4gIH0sXG5cbiAgZW1pdHM6IFsnc2hvdycsICdoaWRlJ10sXG5cbiAgc2V0dXAocHJvcHMsIHsgZW1pdCwgc2xvdHMgfSkge1xuICAgIGNvbnN0IHsgZWxldmF0aW9uQ2xhc3NlcyB9ID0gdXNlRWxldmF0aW9uKHByb3BzKVxuICAgIGNvbnN0IHsgaXNBY3RpdmUgfSA9IHVzZVRvZ2dsZShwcm9wcylcbiAgICBjb25zdCB7IGNvbnRlbnRSZWYsIHNldERpbWVuc2lvbnMsIGRpbWVuc2lvbnMgfSA9IHVzZUF1dG9Qb3NpdGlvbihwcm9wcylcbiAgICBjb25zdCB7IHNldERldGFjaGVkLCByZW1vdmVEZXRhY2hlZCB9ID0gdXNlRGV0YWNoKClcbiAgICBjb25zdCB7XG4gICAgICBhY3RpdmF0b3JSZWYsXG4gICAgICBnZXRBY3RpdmF0b3IsXG4gICAgICBnZW5BY3RpdmF0b3JMaXN0ZW5lcnMsXG4gICAgICBhZGRBY3RpdmF0b3JFdmVudHMsXG4gICAgICByZW1vdmVBY3RpdmF0b3JFdmVudHMsXG4gICAgfSA9IHVzZUFjdGl2YXRvcihwcm9wcylcblxuICAgIGNvbnN0IHNldERpbWVuc2lvbnNPbiA9IChlLCBmbGFnKSA9PiB7XG4gICAgICBzZXREaW1lbnNpb25zKGdldEFjdGl2YXRvcihlKSEpLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gKGlzQWN0aXZlLnZhbHVlID0gZmxhZykpXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGhhbmRsZXJzID0ge1xuICAgICAgY2xpY2s6IChlKSA9PiBzZXREaW1lbnNpb25zT24oZSwgcHJvcHMub3Blbk9uQ2xpY2spLFxuICAgICAgbW91c2VlbnRlcjogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCBwcm9wcy5vcGVuT25Ib3ZlciksXG4gICAgICBtb3VzZWxlYXZlOiAoZSkgPT4gc2V0RGltZW5zaW9uc09uKGUsICFwcm9wcy5vcGVuT25Ib3ZlciksXG4gICAgICBjb250ZXh0bWVudTogKGUpID0+IHNldERpbWVuc2lvbnNPbihlLCBwcm9wcy5vcGVuT25Db250ZXh0bWVudSksXG4gICAgfVxuXG4gICAgY29uc3QgbGlzdGVuZXJzID0gZ2VuQWN0aXZhdG9yTGlzdGVuZXJzKHByb3BzLCBoYW5kbGVycylcblxuICAgIGNvbnN0IGRpcmVjdGl2ZSA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICAgIHJldHVybiBpc0FjdGl2ZS52YWx1ZVxuICAgICAgICA/IHtcbiAgICAgICAgICBoYW5kbGVyOiAoZSkgPT4ge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICBwcm9wcy5pbnRlcm5hbEFjdGl2YXRvciAmJlxuICAgICAgICAgICAgICBhY3RpdmF0b3JSZWYudmFsdWUuY29udGFpbnMoZS50YXJnZXQpXG4gICAgICAgICAgICApIHJldHVyblxuICAgICAgICAgICAgaXNBY3RpdmUudmFsdWUgPSBmYWxzZVxuICAgICAgICAgIH0sXG4gICAgICAgICAgICBjbG9zZUNvbmRpdGlvbmFsOiBwcm9wcy5jbG9zZU9uQ2xpY2ssXG4gICAgICAgICAgfVxuICAgICAgICA6IHVuZGVmaW5lZFxuICAgIH0pXG5cbiAgICBjb25zdCBjYWxjV2lkdGggPSBjb21wdXRlZDxudW1iZXIgfCBzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy53aWR0aCB8fCArZGltZW5zaW9ucy5jb250ZW50LndpZHRoXG4gICAgfSlcblxuICAgIHdhdGNoKGlzQWN0aXZlLCAodG8pID0+IHtcbiAgICAgIHRvICYmIGVtaXQoJ3Nob3cnKVxuICAgICAgIXRvICYmIGVtaXQoJ2hpZGUnKVxuICAgIH0pXG5cbiAgICB3YXRjaChcbiAgICAgICgpID0+IFtwcm9wcy5wb3NpdGlvblksIHByb3BzLnBvc2l0aW9uWF0sXG4gICAgICAoKSA9PiBzZXREaW1lbnNpb25zKGFjdGl2YXRvclJlZi52YWx1ZSEpXG4gICAgKVxuXG4gICAgd2F0Y2goXG4gICAgICAoKSA9PiBwcm9wcy5tb2RlbFZhbHVlLFxuICAgICAgKHRvKSA9PiB7XG4gICAgICAgIGlzQWN0aXZlLnZhbHVlID0gZmFsc2VcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSB0bykpXG4gICAgICB9XG4gICAgKVxuXG4gICAgY29uc3QgY29udGVudENsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4gKHtcbiAgICAgICd2LW1lbnVfX2NvbnRlbnQnOiB0cnVlLFxuICAgICAgLi4uZWxldmF0aW9uQ2xhc3Nlcy52YWx1ZSxcbiAgICB9KSlcblxuICAgIGNvbnN0IGNvbnRlbnRTdHlsZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBudW1iZXI+PigoKSA9PiAoe1xuICAgICAgdG9wOiBjb252ZXJ0VG9Vbml0KGRpbWVuc2lvbnMuY29udGVudC50b3ApISxcbiAgICAgIGxlZnQ6IGNvbnZlcnRUb1VuaXQoZGltZW5zaW9ucy5jb250ZW50LmxlZnQpISxcbiAgICAgIHpJbmRleDogcHJvcHMuekluZGV4LFxuICAgIH0pKSBhcyBhbnlcblxuICAgIGNvbnN0IG9uQ29udGVudENsaWNrID0gKCkgPT4ge1xuICAgICAgaXNBY3RpdmUudmFsdWUgPSAhcHJvcHMuY2xvc2VPbkNsaWNrXG4gICAgfVxuXG4gICAgY29uc3Qgb25SZXNpemUgPSAoKSA9PiB7XG4gICAgICBpZiAoIWlzQWN0aXZlLnZhbHVlKSByZXR1cm5cbiAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiBzZXREaW1lbnNpb25zKGFjdGl2YXRvclJlZi52YWx1ZSEpKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkFjdGl2YXRvclNsb3QgPSAoKTogTWF5YmU8Vk5vZGU+ID0+IHtcbiAgICAgIGlmIChzbG90cy5hY3RpdmF0b3IpIHtcbiAgICAgICAgY29uc3Qgc2xvdENvbnRlbnQgPSBzbG90cy5hY3RpdmF0b3IoeyBvbjogbGlzdGVuZXJzIH0pXG5cbiAgICAgICAgaWYgKHR5cGVvZiBzbG90Q29udGVudCFbMF0udHlwZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICByZXR1cm4gaCgnZGl2JywgeyByZWY6IGFjdGl2YXRvclJlZiB9LCBoKHNsb3RDb250ZW50IVswXSkpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaChzbG90Q29udGVudCFbMF0sIHsgcmVmOiBhY3RpdmF0b3JSZWYgfSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBnZW5Db250ZW50U2xvdCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIHJlZjogY29udGVudFJlZixcbiAgICAgICAgY2xhc3M6IGNvbnRlbnRDbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogY29udGVudFN0eWxlcy52YWx1ZSxcbiAgICAgICAgb25DbGljazogb25Db250ZW50Q2xpY2ssXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHNsb3RDb250ZW50ID0gaChcbiAgICAgICAgJ2RpdicsXG4gICAgICAgIHtcbiAgICAgICAgICBjbGFzczogJ3YtbWVudV9fc2xvdCcsXG4gICAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAgIG1heEhlaWdodDogY29udmVydFRvVW5pdChwcm9wcy5tYXhIZWlnaHQpLFxuICAgICAgICAgICAgd2lkdGg6IGNvbnZlcnRUb1VuaXQoY2FsY1dpZHRoLnZhbHVlKSxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgICBbc2xvdHMuZGVmYXVsdCAmJiBzbG90cy5kZWZhdWx0KCldXG4gICAgICApXG5cbiAgICAgIGNvbnN0IGNvbnRlbnQgPSBoKCdkaXYnLCBwcm9wc0RhdGEsIHNsb3RDb250ZW50KVxuXG4gICAgICBjb25zdCBkaXJlY3RpdmVzOiBEaXJlY3RpdmVBcmd1bWVudHMgPSBbXG4gICAgICAgIFt2U2hvdywgaXNBY3RpdmUudmFsdWVdLFxuICAgICAgICBbcmVzaXplLCBvblJlc2l6ZV0sXG4gICAgICAgIFtjbGlja091dHNpZGUsIGRpcmVjdGl2ZS52YWx1ZV0sXG4gICAgICBdXG5cbiAgICAgIHJldHVybiB3aXRoRGlyZWN0aXZlcyhjb250ZW50LCBkaXJlY3RpdmVzKVxuICAgIH1cblxuICAgIG9uTW91bnRlZCgoKSA9PiB7XG4gICAgICBhY3RpdmF0b3JSZWYudmFsdWUgPSBnZXRBY3RpdmF0b3IoKVxuXG4gICAgICBhZGRBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgc2V0RGV0YWNoZWQoY29udGVudFJlZi52YWx1ZSEpXG4gICAgfSlcblxuICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7XG4gICAgICByZW1vdmVBY3RpdmF0b3JFdmVudHMoKVxuICAgICAgcmVtb3ZlRGV0YWNoZWQoY29udGVudFJlZi52YWx1ZSEpXG4gICAgfSlcblxuICAgIHJldHVybiAoKSA9PiBbXG4gICAgICBoKCdkaXYnLCB7IGNsYXNzOiB7ICd2LW1lbnUnOiB0cnVlIH0gfSksXG4gICAgICBzbG90cy5hY3RpdmF0b3IgJiYgZ2VuQWN0aXZhdG9yU2xvdCgpLFxuICAgICAgdXNlVHJhbnNpdGlvbihnZW5Db250ZW50U2xvdCgpLCAnZmFkZScpLFxuICAgIF1cbiAgfSxcbn0pXG4iXX0=