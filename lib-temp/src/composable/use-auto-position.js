import { ref, reactive, computed } from 'vue';
export function autoPositionProps() {
    return {
        positionX: {
            type: Number,
            default: 0,
        },
        positionY: {
            type: Number,
            default: 0,
        },
    };
}
export function useAutoPosition(props) {
    const dimensions = reactive({
        activator: {
            top: 0,
            left: 0,
            bottom: 0,
            right: 0,
            width: 0,
            height: 0,
        },
        content: {
            top: 0,
            left: 0,
            bottom: 0,
            right: 0,
            width: 0,
            height: 0,
        },
        pageYOffset: 0,
        pageWidth: 0,
    });
    const contentRef = ref(null);
    const offsetY = +props.offsetY;
    let activator;
    let content;
    let contentBottomPoint = 0;
    function getRect(el) {
        const rect = el.getBoundingClientRect();
        return {
            top: rect.top,
            left: rect.left,
            bottom: rect.bottom,
            right: rect.right,
            width: rect.width,
            height: rect.height,
        };
    }
    const isAbsolutePositioned = computed(() => {
        return !!props.positionY || !!props.positionX;
    });
    function getInnerHeight() {
        if (!window)
            return 0;
        return innerHeight || document.documentElement.clientHeight;
    }
    function getScrollTop() {
        if (!window)
            return 0;
        return pageYOffset || document.documentElement.scrollTop;
    }
    function getScrollLeft() {
        if (!window)
            return 0;
        return pageXOffset || document.documentElement.scrollLeft;
    }
    function getContentAbsoluteBottomPoint() {
        return dimensions.content.height + props.positionY + getScrollTop();
    }
    function getContentBottomPoint() {
        const { activator, content } = dimensions;
        if (props.bottom) {
            return content.height + activator.top + activator.height;
        }
        return content.height + activator.top;
    }
    function calcContentBottomPosition() {
        const fullHeight = getScrollTop() + getInnerHeight();
        const contentBottomPosition = isAbsolutePositioned.value
            ? getContentAbsoluteBottomPoint()
            : getContentBottomPoint();
        return fullHeight - contentBottomPosition;
    }
    function calcLeftPosition() {
        if (props.positionX)
            return props.positionX + getScrollLeft();
        return dimensions.activator.left;
    }
    function calcAbsoluteTop() {
        const topPosition = props.positionY + getScrollTop();
        if (offsetY >= contentBottomPoint) {
            return topPosition + contentBottomPoint - offsetY;
        }
        return topPosition;
    }
    function calcBottomPosition() {
        const { activator, content } = dimensions;
        if (offsetY >= contentBottomPoint) {
            return activator.top - content.height - offsetY;
        }
        return activator.top + activator.height + offsetY;
    }
    function calcAutoBottomPosition() {
        if (offsetY >= contentBottomPoint) {
            return dimensions.activator.top + contentBottomPoint - offsetY;
        }
        return dimensions.activator.top;
    }
    function calcPositionY() {
        contentBottomPoint = calcContentBottomPosition();
        if (props.positionY)
            return calcAbsoluteTop();
        if (props.bottom)
            return calcBottomPosition();
        return calcAutoBottomPosition();
    }
    function snapShot(cb) {
        requestAnimationFrame(() => {
            if (!content || content.style.display !== 'none')
                return cb();
            content.style.display = 'inline-block';
            cb();
            content.style.display = 'none';
        });
    }
    function updateDimensions() {
        return new Promise((resolve) => {
            snapShot(() => {
                activator && setActivatorDimensions();
                content && setContentDimensions();
                resolve();
            });
        });
    }
    function setActivatorDimensions() {
        dimensions.activator = getRect(activator);
        dimensions.activator.height = activator.offsetHeight;
        dimensions.activator.top = dimensions.activator.top + getScrollTop();
        dimensions.activator.left = dimensions.activator.left + getScrollLeft();
    }
    function setContentDimensions() {
        const rect = activator ? dimensions.activator : getRect(content);
        dimensions.content.height = content.offsetHeight;
        dimensions.content.top = calcPositionY();
        dimensions.content.left = calcLeftPosition();
        dimensions.content.width = rect.width;
    }
    function setDimensions(activatorEl) {
        if (!activator && !content) {
            activator = activatorEl;
            content = contentRef.value;
        }
        return updateDimensions();
    }
    return {
        dimensions,
        contentRef,
        setDimensions,
        updateDimensions,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLWF1dG8tcG9zaXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tcG9zYWJsZS91c2UtYXV0by1wb3NpdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFVN0MsTUFBTSxVQUFVLGlCQUFpQjtJQUMvQixPQUFPO1FBQ0wsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsQ0FBQztTQUNYO1FBQ0QsU0FBUyxFQUFFO1lBQ1QsSUFBSSxFQUFFLE1BQU07WUFDWixPQUFPLEVBQUUsQ0FBQztTQUNYO0tBQ0YsQ0FBQTtBQUNILENBQUM7QUFFRCxNQUFNLFVBQVUsZUFBZSxDQUFDLEtBQUs7SUFDbkMsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFpQjtRQUMxQyxTQUFTLEVBQUU7WUFDVCxHQUFHLEVBQUUsQ0FBQztZQUNOLElBQUksRUFBRSxDQUFDO1lBQ1AsTUFBTSxFQUFFLENBQUM7WUFDVCxLQUFLLEVBQUUsQ0FBQztZQUNSLEtBQUssRUFBRSxDQUFDO1lBQ1IsTUFBTSxFQUFFLENBQUM7U0FDVjtRQUNELE9BQU8sRUFBRTtZQUNQLEdBQUcsRUFBRSxDQUFDO1lBQ04sSUFBSSxFQUFFLENBQUM7WUFDUCxNQUFNLEVBQUUsQ0FBQztZQUNULEtBQUssRUFBRSxDQUFDO1lBQ1IsS0FBSyxFQUFFLENBQUM7WUFDUixNQUFNLEVBQUUsQ0FBQztTQUNWO1FBQ0QsV0FBVyxFQUFFLENBQUM7UUFDZCxTQUFTLEVBQUUsQ0FBQztLQUNiLENBQUMsQ0FBQTtJQUVGLE1BQU0sVUFBVSxHQUFHLEdBQUcsQ0FBcUIsSUFBSSxDQUFDLENBQUE7SUFDaEQsTUFBTSxPQUFPLEdBQVcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFBO0lBR3RDLElBQUksU0FBc0IsQ0FBQTtJQUMxQixJQUFJLE9B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QUFFLENBQUE7SUFDM0IsQ0FBQztJQUVELE9BQU87UUFDTCxVQUFVO1FBQ1YsVUFBVTtRQUNWLGFBQWE7UUFDYixnQkFBZ0I7S0FDakIsQ0FBQTtBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyByZWYsIHJlYWN0aXZlLCBjb21wdXRlZCB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7IERpbWVuc2lvbnMgfSBmcm9tICcuLi8uLi90eXBlcydcblxudHlwZSBNYWluRGltZW5zaW9ucyA9IHtcbiAgYWN0aXZhdG9yOiBEaW1lbnNpb25zXG4gIGNvbnRlbnQ6IERpbWVuc2lvbnNcbiAgcGFnZVlPZmZzZXQ6IG51bWJlclxuICBwYWdlV2lkdGg6IG51bWJlclxufVxuXG5leHBvcnQgZnVuY3Rpb24gYXV0b1Bvc2l0aW9uUHJvcHMoKSB7XG4gIHJldHVybiB7XG4gICAgcG9zaXRpb25YOiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gICAgcG9zaXRpb25ZOiB7XG4gICAgICB0eXBlOiBOdW1iZXIsXG4gICAgICBkZWZhdWx0OiAwLFxuICAgIH0sXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZUF1dG9Qb3NpdGlvbihwcm9wcykge1xuICBjb25zdCBkaW1lbnNpb25zID0gcmVhY3RpdmU8TWFpbkRpbWVuc2lvbnM+KHtcbiAgICBhY3RpdmF0b3I6IHtcbiAgICAgIHRvcDogMCxcbiAgICAgIGxlZnQ6IDAsXG4gICAgICBib3R0b206IDAsXG4gICAgICByaWdodDogMCxcbiAgICAgIHdpZHRoOiAwLFxuICAgICAgaGVpZ2h0OiAwLFxuICAgIH0sXG4gICAgY29udGVudDoge1xuICAgICAgdG9wOiAwLFxuICAgICAgbGVmdDogMCxcbiAgICAgIGJvdHRvbTogMCxcbiAgICAgIHJpZ2h0OiAwLFxuICAgICAgd2lkdGg6IDAsXG4gICAgICBoZWlnaHQ6IDAsXG4gICAgfSxcbiAgICBwYWdlWU9mZnNldDogMCxcbiAgICBwYWdlV2lkdGg6IDAsXG4gIH0pXG5cbiAgY29uc3QgY29udGVudFJlZiA9IHJlZjxIVE1MRWxlbWVudCB8IG51bGw+KG51bGwpXG4gIGNvbnN0IG9mZnNldFk6IG51bWJlciA9ICtwcm9wcy5vZmZzZXRZXG4gIC8vIGNvbnN0IG9mZnNldFg6IG51bWJlciA9ICtwcm9wcy5vZmZzZXRYXG5cbiAgbGV0IGFjdGl2YXRvcjogSFRNTEVsZW1lbnRcbiAgbGV0IGNvbnRlbnQ6IEhUTUxFbGVtZW50XG4gIGxldCBjb250ZW50Qm90dG9tUG9pbnQ6IG51bWJlciA9IDBcblxuICBmdW5jdGlvbiBnZXRSZWN0KGVsOiBIVE1MRWxlbWVudCkge1xuICAgIGNvbnN0IHJlY3QgPSBlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHRvcDogcmVjdC50b3AsXG4gICAgICBsZWZ0OiByZWN0LmxlZnQsXG4gICAgICBib3R0b206IHJlY3QuYm90dG9tLFxuICAgICAgcmlnaHQ6IHJlY3QucmlnaHQsXG4gICAgICB3aWR0aDogcmVjdC53aWR0aCxcbiAgICAgIGhlaWdodDogcmVjdC5oZWlnaHQsXG4gICAgfVxuICB9XG5cbiAgY29uc3QgaXNBYnNvbHV0ZVBvc2l0aW9uZWQgPSBjb21wdXRlZDxib29sZWFuPigoKSA9PiB7XG4gICAgcmV0dXJuICEhcHJvcHMucG9zaXRpb25ZIHx8ICEhcHJvcHMucG9zaXRpb25YXG4gIH0pXG5cbiAgZnVuY3Rpb24gZ2V0SW5uZXJIZWlnaHQoKTogbnVtYmVyIHtcbiAgICBpZiAoIXdpbmRvdykgcmV0dXJuIDBcblxuICAgIHJldHVybiBpbm5lckhlaWdodCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0XG4gIH1cblxuICBmdW5jdGlvbiBnZXRTY3JvbGxUb3AoKTogbnVtYmVyIHtcbiAgICBpZiAoIXdpbmRvdykgcmV0dXJuIDBcblxuICAgIHJldHVybiBwYWdlWU9mZnNldCB8fCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc2Nyb2xsVG9wXG4gIH1cblxuICBmdW5jdGlvbiBnZXRTY3JvbGxMZWZ0KCk6IG51bWJlciB7XG4gICAgaWYgKCF3aW5kb3cpIHJldHVybiAwXG5cbiAgICByZXR1cm4gcGFnZVhPZmZzZXQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnRcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldENvbnRlbnRBYnNvbHV0ZUJvdHRvbVBvaW50KCkge1xuICAgIHJldHVybiBkaW1lbnNpb25zLmNvbnRlbnQuaGVpZ2h0ICsgcHJvcHMucG9zaXRpb25ZICsgZ2V0U2Nyb2xsVG9wKClcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldENvbnRlbnRCb3R0b21Qb2ludCgpIHtcbiAgICBjb25zdCB7IGFjdGl2YXRvciwgY29udGVudCB9ID0gZGltZW5zaW9uc1xuXG4gICAgaWYgKHByb3BzLmJvdHRvbSkge1xuICAgICAgcmV0dXJuIGNvbnRlbnQuaGVpZ2h0ICsgYWN0aXZhdG9yLnRvcCArIGFjdGl2YXRvci5oZWlnaHRcbiAgICB9XG5cbiAgICByZXR1cm4gY29udGVudC5oZWlnaHQgKyBhY3RpdmF0b3IudG9wXG4gIH1cblxuICBmdW5jdGlvbiBjYWxjQ29udGVudEJvdHRvbVBvc2l0aW9uKCkge1xuICAgIGNvbnN0IGZ1bGxIZWlnaHQgPSBnZXRTY3JvbGxUb3AoKSArIGdldElubmVySGVpZ2h0KClcblxuICAgIGNvbnN0IGNvbnRlbnRCb3R0b21Qb3NpdGlvbiA9IGlzQWJzb2x1dGVQb3NpdGlvbmVkLnZhbHVlXG4gICAgICA/IGdldENvbnRlbnRBYnNvbHV0ZUJvdHRvbVBvaW50KClcbiAgICAgIDogZ2V0Q29udGVudEJvdHRvbVBvaW50KClcblxuICAgIHJldHVybiBmdWxsSGVpZ2h0IC0gY29udGVudEJvdHRvbVBvc2l0aW9uXG4gIH1cblxuICBmdW5jdGlvbiBjYWxjTGVmdFBvc2l0aW9uKCk6IG51bWJlciB7XG4gICAgaWYgKHByb3BzLnBvc2l0aW9uWCkgcmV0dXJuIHByb3BzLnBvc2l0aW9uWCArIGdldFNjcm9sbExlZnQoKVxuXG4gICAgcmV0dXJuIGRpbWVuc2lvbnMuYWN0aXZhdG9yLmxlZnRcbiAgfVxuXG4gIGZ1bmN0aW9uIGNhbGNBYnNvbHV0ZVRvcCgpIHtcbiAgICBjb25zdCB0b3BQb3NpdGlvbiA9IHByb3BzLnBvc2l0aW9uWSArIGdldFNjcm9sbFRvcCgpXG5cbiAgICBpZiAob2Zmc2V0WSA+PSBjb250ZW50Qm90dG9tUG9pbnQpIHtcbiAgICAgIHJldHVybiB0b3BQb3NpdGlvbiArIGNvbnRlbnRCb3R0b21Qb2ludCAtIG9mZnNldFlcbiAgICB9XG5cbiAgICByZXR1cm4gdG9wUG9zaXRpb25cbiAgfVxuXG4gIGZ1bmN0aW9uIGNhbGNCb3R0b21Qb3NpdGlvbigpIHtcbiAgICBjb25zdCB7IGFjdGl2YXRvciwgY29udGVudCB9ID0gZGltZW5zaW9uc1xuXG4gICAgaWYgKG9mZnNldFkgPj0gY29udGVudEJvdHRvbVBvaW50KSB7XG4gICAgICByZXR1cm4gYWN0aXZhdG9yLnRvcCAtIGNvbnRlbnQuaGVpZ2h0IC0gb2Zmc2V0WVxuICAgIH1cblxuICAgIHJldHVybiBhY3RpdmF0b3IudG9wICsgYWN0aXZhdG9yLmhlaWdodCArIG9mZnNldFlcbiAgfVxuXG4gIGZ1bmN0aW9uIGNhbGNBdXRvQm90dG9tUG9zaXRpb24oKSB7XG4gICAgaWYgKG9mZnNldFkgPj0gY29udGVudEJvdHRvbVBvaW50KSB7XG4gICAgICByZXR1cm4gZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wICsgY29udGVudEJvdHRvbVBvaW50IC0gb2Zmc2V0WVxuICAgIH1cblxuICAgIHJldHVybiBkaW1lbnNpb25zLmFjdGl2YXRvci50b3BcbiAgfVxuXG4gIGZ1bmN0aW9uIGNhbGNQb3NpdGlvblkoKTogbnVtYmVyIHtcbiAgICBjb250ZW50Qm90dG9tUG9pbnQgPSBjYWxjQ29udGVudEJvdHRvbVBvc2l0aW9uKClcblxuICAgIGlmIChwcm9wcy5wb3NpdGlvblkpIHJldHVybiBjYWxjQWJzb2x1dGVUb3AoKVxuXG4gICAgaWYgKHByb3BzLmJvdHRvbSkgcmV0dXJuIGNhbGNCb3R0b21Qb3NpdGlvbigpXG5cbiAgICByZXR1cm4gY2FsY0F1dG9Cb3R0b21Qb3NpdGlvbigpXG4gIH1cblxuICBmdW5jdGlvbiBzbmFwU2hvdChjYjogKCkgPT4gYW55KSB7XG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmICghY29udGVudCB8fCBjb250ZW50LnN0eWxlLmRpc3BsYXkgIT09ICdub25lJykgcmV0dXJuIGNiKClcbiAgICAgIGNvbnRlbnQuc3R5bGUuZGlzcGxheSA9ICdpbmxpbmUtYmxvY2snXG4gICAgICBjYigpXG4gICAgICBjb250ZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSdcbiAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gdXBkYXRlRGltZW5zaW9ucygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIHNuYXBTaG90KCgpID0+IHtcbiAgICAgICAgYWN0aXZhdG9yICYmIHNldEFjdGl2YXRvckRpbWVuc2lvbnMoKVxuICAgICAgICBjb250ZW50ICYmIHNldENvbnRlbnREaW1lbnNpb25zKClcbiAgICAgICAgcmVzb2x2ZSgpXG4gICAgICB9KVxuICAgIH0pXG4gIH1cblxuICBmdW5jdGlvbiBzZXRBY3RpdmF0b3JEaW1lbnNpb25zKCkge1xuICAgIGRpbWVuc2lvbnMuYWN0aXZhdG9yID0gZ2V0UmVjdChhY3RpdmF0b3IpXG5cbiAgICBkaW1lbnNpb25zLmFjdGl2YXRvci5oZWlnaHQgPSBhY3RpdmF0b3Iub2Zmc2V0SGVpZ2h0XG4gICAgZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wID0gZGltZW5zaW9ucy5hY3RpdmF0b3IudG9wICsgZ2V0U2Nyb2xsVG9wKClcbiAgICBkaW1lbnNpb25zLmFjdGl2YXRvci5sZWZ0ID0gZGltZW5zaW9ucy5hY3RpdmF0b3IubGVmdCArIGdldFNjcm9sbExlZnQoKVxuICB9XG5cbiAgZnVuY3Rpb24gc2V0Q29udGVudERpbWVuc2lvbnMoKSB7XG4gICAgY29uc3QgcmVjdCA9IGFjdGl2YXRvciA/IGRpbWVuc2lvbnMuYWN0aXZhdG9yIDogZ2V0UmVjdChjb250ZW50KVxuXG4gICAgZGltZW5zaW9ucy5jb250ZW50LmhlaWdodCA9IGNvbnRlbnQub2Zmc2V0SGVpZ2h0XG4gICAgZGltZW5zaW9ucy5jb250ZW50LnRvcCA9IGNhbGNQb3NpdGlvblkoKVxuICAgIGRpbWVuc2lvbnMuY29udGVudC5sZWZ0ID0gY2FsY0xlZnRQb3NpdGlvbigpXG4gICAgZGltZW5zaW9ucy5jb250ZW50LndpZHRoID0gcmVjdC53aWR0aFxuICB9XG5cbiAgZnVuY3Rpb24gc2V0RGltZW5zaW9ucyhhY3RpdmF0b3JFbDogSFRNTEVsZW1lbnQpIHtcbiAgICBpZiAoIWFjdGl2YXRvciAmJiAhY29udGVudCkge1xuICAgICAgYWN0aXZhdG9yID0gYWN0aXZhdG9yRWxcbiAgICAgIGNvbnRlbnQgPSBjb250ZW50UmVmLnZhbHVlIVxuICAgIH1cblxuICAgIHJldHVybiB1cGRhdGVEaW1lbnNpb25zKClcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgZGltZW5zaW9ucyxcbiAgICBjb250ZW50UmVmLFxuICAgIHNldERpbWVuc2lvbnMsXG4gICAgdXBkYXRlRGltZW5zaW9ucyxcbiAgfVxufVxuIl19