import { h, computed, withDirectives, defineComponent } from 'vue';
import { useColors } from '../../composables/use-colors';
import { useIcons } from '../../composables/use-icons';
import { VIcon } from '../VIcon';
import { VCheckbox } from '../VCheckbox';
import { VDataTableCell } from './VDataTableCell';
import { VTextField } from '../VTextField';
import { vShow } from 'vue';
import { clickOutside } from '../../directives/v-click-outside';
import { useTransition } from '../../composables/use-transition';
import { transitions } from '../../services/transitions';
export const VDataTableHeader = defineComponent({
    name: 'v-data-table-header',
    props: {
        showSequence: Boolean,
        showCheckbox: Boolean,
        cols: Array,
        colWidth: {
            type: [String, Number],
            default: 125,
        },
        align: String,
        options: Object,
    },
    emits: ['sort', 'filter', 'select-all', 'update:cols'],
    setup(props, { emit, slots }) {
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const { icons } = useIcons();
        const _cache = {};
        const classes = computed(() => ({
            'v-data-table__header': true,
            ...(props.options.color
                ? setBackgroundClassNameColor(props.options.color)
                : {}),
        }));
        const styles = computed(() => ({
            ...(props.options.color
                ? setBackgroundCssColor(props.options.color)
                : {}),
        }));
        const computedContentColor = computed(() => {
            return props.options.dark
                ? props.options?.contentColor || 'white'
                : props.options?.contentColor;
        });
        const cols = computed(() => [...props.cols]);
        const onSort = (item) => {
            emit('sort', item);
        };
        const onInput = ($value, col) => {
            col.filtered = !!$value;
            _cache[col.title] = $value;
            console.log(_cache);
            emit('filter', { value: $value, col });
        };
        const showFilter = (item) => {
            if (item.showFilter)
                return;
            item.showFilter = true;
        };
        const genSortButton = (item) => {
            const classes = {
                'v-data-table-col__actions-sort': true,
                'v-data-table-col__actions-sort--active': item.sorted,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$arrowUp,
                onClick: () => onSort(item),
            };
            return h(VIcon, propsData);
        };
        const genFilterButton = (item) => {
            const classes = {
                'v-data-table-col__actions-filter': true,
                'v-data-table-col__actions-filter--active': item.filtered,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$filter,
                color: !item.cellClass ? computedContentColor.value : '',
                onClick: () => showFilter(item),
            };
            return h(VIcon, propsData);
        };
        const genHeaderActions = (item) => {
            return h('span', { class: 'v-data-table-col__actions' }, [
                item.sortable && genSortButton(item),
                item.filterable && genFilterButton(item),
            ]);
        };
        const genFilterInput = (col) => {
            const propsData = {
                modelValue: _cache[col.title],
                label: 'search',
                dark: props.options.dark,
                color: !col.cellClass ? computedContentColor.value : '',
                prependIcon: icons.$search,
                clearable: true,
                onInput: ($value) => onInput($value, col),
            };
            return h(VTextField, propsData);
        };
        const genFilterWrapper = (col) => {
            const color = props.options.dark
                ? props.options?.color || 'grey darken-3'
                : props.options?.color || 'white';
            const slotName = `${col.key}-filter`;
            const filterSlot = slots[slotName] && slots[slotName]({
                filter: (event) => onInput(event, col),
            });
            const directive = col.showFilter
                ? {
                    handler: () => setTimeout(() => (col.showFilter = false)),
                    closeConditional: false,
                }
                : undefined;
            const propsData = {
                class: {
                    'v-data-table-col__filter': !filterSlot,
                    'v-data-table-col__custom-filter': !!filterSlot,
                    'elevation-5': true,
                    [col.cellClass]: !!col.cellClass,
                    ...(color ? setBackgroundClassNameColor(color) : {}),
                },
                style: {
                    ...(color ? setBackgroundCssColor(color) : {}),
                },
            };
            return (col.filterable &&
                withDirectives(h('div', propsData, filterSlot || genFilterInput(col)), [
                    [clickOutside, directive],
                    [vShow, col.showFilter],
                ]));
        };
        const genHeaderTitle = (col) => {
            return h('div', { class: 'v-data-table-col__title' }, col.title);
        };
        const genNumberCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__number': true,
                    [props.cellClass]: !!props.cellClass,
                },
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            return h(VDataTableCell, propsData, { default: () => 'â„–' });
        };
        const genCheckboxCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__checkbox': true,
                    [props.cellClass]: !!props.cellClass,
                },
                dark: props.options.dark,
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            const content = {
                default: () => h(VCheckbox, {
                    color: computedContentColor.value,
                    onChange: (e) => emit('select-all', e),
                }),
            };
            return h(VDataTableCell, propsData, content);
        };
        const genHeaderCell = (col) => {
            const propsData = {
                dark: props.options.dark,
                class: {
                    'v-data-table-col': true,
                    'v-data-table-col--sorted': col.sorted,
                    [col.cellClass]: !!col.cellClass,
                },
                contentColor: !col.cellClass ? computedContentColor.value : '',
                color: !col.cellClass ? props.options.color : '',
                width: col.width,
                resizeable: col.resizeable,
                resizerColor: props.options?.resizerColor,
                align: col.align || props.align,
                onResize: ($size) => (col.width = $size),
            };
            return h(VDataTableCell, propsData, {
                default: () => [
                    genHeaderTitle(col),
                    genHeaderActions(col),
                    useTransition(genFilterWrapper(col), transitions.FADE),
                ],
            });
        };
        const genHeaderChildren = () => {
            const children = [];
            const headerSlot = slots.header && slots.header(props);
            props.showSequence && children.push(genNumberCell());
            props.showCheckbox && children.push(genCheckboxCell());
            cols.value.forEach((col) => {
                col.width = col.width || props.colWidth;
                if (!col.hasOwnProperty('show')) {
                    col.show = !col.show;
                }
                !headerSlot[0].children &&
                    col.show &&
                    children.push(genHeaderCell(col));
            });
            headerSlot[0].children && children.push(headerSlot);
            return children;
        };
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
            };
            return h('div', propsData, genHeaderChildren());
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZUhlYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL3Z1ZWxhbmQvc3JjL2NvbXBvbmVudHMvVkRhdGFUYWJsZS9WRGF0YVRhYmxlSGVhZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxDQUFDLEVBQUUsUUFBUSxFQUFFLGNBQWMsRUFBRSxlQUFlLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFHbEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3hELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQTtBQUd0RCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQ2hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxjQUFjLENBQUE7QUFDeEMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFHMUMsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLEtBQUssQ0FBQTtBQUMzQixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFLL0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBQ2hFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQTtBQUV4RCxNQUFNLENBQUMsTUFBTSxnQkFBZ0IsR0FBRyxlQUFlLENBQUM7SUFDOUMsSUFBSSxFQUFFLHFCQUFxQjtJQUUzQixLQUFLLEVBQUU7UUFDTCxZQUFZLEVBQUUsT0FBTztRQUNyQixZQUFZLEVBQUUsT0FBTztRQUNyQixJQUFJLEVBQUUsS0FBSztRQUNYLFFBQVEsRUFBRTtZQUNSLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7WUFDdEIsT0FBTyxFQUFFLEdBQUc7U0FDYjtRQUNELEtB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QyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVnVlIEFQSVxuaW1wb3J0IHsgaCwgY29tcHV0ZWQsIHdpdGhEaXJlY3RpdmVzLCBkZWZpbmVDb21wb25lbnQgfSBmcm9tICd2dWUnXG5cbi8vIEVmZmVjdHNcbmltcG9ydCB7IHVzZUNvbG9ycyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1jb2xvcnMnXG5pbXBvcnQgeyB1c2VJY29ucyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS1pY29ucydcblxuLy8gQ29tcG9uZW50c1xuaW1wb3J0IHsgVkljb24gfSBmcm9tICcuLi9WSWNvbidcbmltcG9ydCB7IFZDaGVja2JveCB9IGZyb20gJy4uL1ZDaGVja2JveCdcbmltcG9ydCB7IFZEYXRhVGFibGVDZWxsIH0gZnJvbSAnLi9WRGF0YVRhYmxlQ2VsbCdcbmltcG9ydCB7IFZUZXh0RmllbGQgfSBmcm9tICcuLi9WVGV4dEZpZWxkJ1xuXG4vLyBEaXJlY3RpdmVzXG5pbXBvcnQgeyB2U2hvdyB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7IGNsaWNrT3V0c2lkZSB9IGZyb20gJy4uLy4uL2RpcmVjdGl2ZXMvdi1jbGljay1vdXRzaWRlJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUgfSBmcm9tICd2dWUnXG5pbXBvcnQgeyBEYXRhQ29sdW1uIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnXG5pbXBvcnQgeyB1c2VUcmFuc2l0aW9uIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXRyYW5zaXRpb24nXG5pbXBvcnQgeyB0cmFuc2l0aW9ucyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RyYW5zaXRpb25zJ1xuXG5leHBvcnQgY29uc3QgVkRhdGFUYWJsZUhlYWRlciA9IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LWRhdGEtdGFibGUtaGVhZGVyJyxcblxuICBwcm9wczoge1xuICAgIHNob3dTZXF1ZW5jZTogQm9vbGVhbixcbiAgICBzaG93Q2hlY2tib3g6IEJvb2xlYW4sXG4gICAgY29sczogQXJyYXksXG4gICAgY29sV2lkdGg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAxMjUsXG4gICAgfSxcbiAgICBhbGlnbjogU3RyaW5nLFxuICAgIG9wdGlvbnM6IE9iamVjdCxcbiAgfSBhcyBhbnksXG5cbiAgZW1pdHM6IFsnc29ydCcsICdmaWx0ZXInLCAnc2VsZWN0LWFsbCcsICd1cGRhdGU6Y29scyddLFxuXG4gIHNldHVwKHByb3BzLCB7IGVtaXQsIHNsb3RzIH0pIHtcbiAgICBjb25zdCB7IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvciwgc2V0QmFja2dyb3VuZENzc0NvbG9yIH0gPSB1c2VDb2xvcnMoKVxuICAgIGNvbnN0IHsgaWNvbnMgfSA9IHVzZUljb25zKClcbiAgICBjb25zdCBfY2FjaGUgPSB7fVxuXG4gICAgY29uc3QgY2xhc3NlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PigoKSA9PiAoe1xuICAgICAgJ3YtZGF0YS10YWJsZV9faGVhZGVyJzogdHJ1ZSxcbiAgICAgIC4uLihwcm9wcy5vcHRpb25zLmNvbG9yXG4gICAgICAgID8gc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yKHByb3BzLm9wdGlvbnMuY29sb3IpXG4gICAgICAgIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQoKCkgPT4gKHtcbiAgICAgIC4uLihwcm9wcy5vcHRpb25zLmNvbG9yXG4gICAgICAgID8gc2V0QmFja2dyb3VuZENzc0NvbG9yKHByb3BzLm9wdGlvbnMuY29sb3IpXG4gICAgICAgIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3QgY29tcHV0ZWRDb250ZW50Q29sb3IgPSBjb21wdXRlZDxzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy5vcHRpb25zLmRhcmtcbiAgICAgICAgPyBwcm9wcy5vcHRpb25zPy5jb250ZW50Q29sb3IgfHwgJ3doaXRlJ1xuICAgICAgICA6IHByb3BzLm9wdGlvbnM/LmNvbnRlbnRDb2xvclxuICAgIH0pXG5cbiAgICBjb25zdCBjb2xzID0gY29tcHV0ZWQ8RGF0YUNvbHVtbltdPigoKSA9PiBbLi4ucHJvcHMuY29sc10pXG5cbiAgICBjb25zdCBvblNvcnQgPSAoaXRlbSkgPT4ge1xuICAgICAgZW1pdCgnc29ydCcsIGl0ZW0pXG4gICAgfVxuXG4gICAgY29uc3Qgb25JbnB1dCA9ICgkdmFsdWUsIGNvbCkgPT4ge1xuICAgICAgY29sLmZpbHRlcmVkID0gISEkdmFsdWVcbiAgICAgIF9jYWNoZVtjb2wudGl0bGVdID0gJHZhbHVlXG4gICAgICBjb25zb2xlLmxvZyhfY2FjaGUpXG4gICAgICBlbWl0KCdmaWx0ZXInLCB7IHZhbHVlOiAkdmFsdWUsIGNvbCB9KVxuICAgIH1cblxuICAgIGNvbnN0IHNob3dGaWx0ZXIgPSAoaXRlbSkgPT4ge1xuICAgICAgaWYgKGl0ZW0uc2hvd0ZpbHRlcikgcmV0dXJuXG4gICAgICBpdGVtLnNob3dGaWx0ZXIgPSB0cnVlXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuU29ydEJ1dHRvbiA9IChpdGVtKSA9PiB7XG4gICAgICBjb25zdCBjbGFzc2VzID0ge1xuICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fYWN0aW9ucy1zb3J0JzogdHJ1ZSxcbiAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2FjdGlvbnMtc29ydC0tYWN0aXZlJzogaXRlbS5zb3J0ZWQsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xpY2thYmxlOiB0cnVlLFxuICAgICAgICBjbGFzczogY2xhc3NlcyxcbiAgICAgICAgaWNvbjogaWNvbnMuJGFycm93VXAsXG4gICAgICAgIG9uQ2xpY2s6ICgpID0+IG9uU29ydChpdGVtKSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkljb24sIHByb3BzRGF0YSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5GaWx0ZXJCdXR0b24gPSAoaXRlbSkgPT4ge1xuICAgICAgY29uc3QgY2xhc3NlcyA9IHtcbiAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2FjdGlvbnMtZmlsdGVyJzogdHJ1ZSxcbiAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2FjdGlvbnMtZmlsdGVyLS1hY3RpdmUnOiBpdGVtLmZpbHRlcmVkLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsaWNrYWJsZTogdHJ1ZSxcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMsXG4gICAgICAgIGljb246IGljb25zLiRmaWx0ZXIsXG4gICAgICAgIGNvbG9yOiAhaXRlbS5jZWxsQ2xhc3MgPyBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSA6ICcnLFxuICAgICAgICBvbkNsaWNrOiAoKSA9PiBzaG93RmlsdGVyKGl0ZW0pLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWSWNvbiwgcHJvcHNEYXRhKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkhlYWRlckFjdGlvbnMgPSAoaXRlbSkgPT4ge1xuICAgICAgcmV0dXJuIGgoJ3NwYW4nLCB7IGNsYXNzOiAndi1kYXRhLXRhYmxlLWNvbF9fYWN0aW9ucycgfSwgW1xuICAgICAgICBpdGVtLnNvcnRhYmxlICYmIGdlblNvcnRCdXR0b24oaXRlbSksXG4gICAgICAgIGl0ZW0uZmlsdGVyYWJsZSAmJiBnZW5GaWx0ZXJCdXR0b24oaXRlbSksXG4gICAgICBdKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkZpbHRlcklucHV0ID0gKGNvbCkgPT4ge1xuICAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgbW9kZWxWYWx1ZTogX2NhY2hlW2NvbC50aXRsZV0sXG4gICAgICAgIGxhYmVsOiAnc2VhcmNoJyxcbiAgICAgICAgZGFyazogcHJvcHMub3B0aW9ucy5kYXJrLFxuICAgICAgICBjb2xvcjogIWNvbC5jZWxsQ2xhc3MgPyBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSA6ICcnLFxuICAgICAgICBwcmVwZW5kSWNvbjogaWNvbnMuJHNlYXJjaCxcbiAgICAgICAgY2xlYXJhYmxlOiB0cnVlLFxuICAgICAgICBvbklucHV0OiAoJHZhbHVlKSA9PiBvbklucHV0KCR2YWx1ZSwgY29sKSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVlRleHRGaWVsZCwgcHJvcHNEYXRhKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkZpbHRlcldyYXBwZXIgPSAoY29sKSA9PiB7XG4gICAgICBjb25zdCBjb2xvciA9IHByb3BzLm9wdGlvbnMuZGFya1xuICAgICAgICA/IHByb3BzLm9wdGlvbnM/LmNvbG9yIHx8ICdncmV5IGRhcmtlbi0zJ1xuICAgICAgICA6IHByb3BzLm9wdGlvbnM/LmNvbG9yIHx8ICd3aGl0ZSdcblxuICAgICAgY29uc3Qgc2xvdE5hbWUgPSBgJHsgY29sLmtleSB9LWZpbHRlcmBcblxuICAgICAgY29uc3QgZmlsdGVyU2xvdCA9IHNsb3RzW3Nsb3ROYW1lXSAmJiBzbG90c1tzbG90TmFtZV0hKHtcbiAgICAgICAgZmlsdGVyOiAoZXZlbnQpID0+IG9uSW5wdXQoZXZlbnQsIGNvbCksXG4gICAgICB9KVxuXG4gICAgICBjb25zdCBkaXJlY3RpdmUgPSBjb2wuc2hvd0ZpbHRlclxuICAgICAgICA/IHtcbiAgICAgICAgICBoYW5kbGVyOiAoKSA9PiBzZXRUaW1lb3V0KCgpID0+IChjb2wuc2hvd0ZpbHRlciA9IGZhbHNlKSksXG4gICAgICAgICAgY2xvc2VDb25kaXRpb25hbDogZmFsc2UsXG4gICAgICAgIH1cbiAgICAgICAgOiB1bmRlZmluZWRcblxuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjbGFzczoge1xuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sX19maWx0ZXInOiAhZmlsdGVyU2xvdCxcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fY3VzdG9tLWZpbHRlcic6ICEhZmlsdGVyU2xvdCxcbiAgICAgICAgICAnZWxldmF0aW9uLTUnOiB0cnVlLFxuICAgICAgICAgIFtjb2wuY2VsbENsYXNzXTogISFjb2wuY2VsbENsYXNzLFxuICAgICAgICAgIC4uLihjb2xvciA/IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvcihjb2xvcikgOiB7fSksXG4gICAgICAgIH0sXG4gICAgICAgIHN0eWxlOiB7XG4gICAgICAgICAgLi4uKGNvbG9yID8gc2V0QmFja2dyb3VuZENzc0NvbG9yKGNvbG9yKSA6IHt9KSxcbiAgICAgICAgfSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIChcbiAgICAgICAgY29sLmZpbHRlcmFibGUgJiZcbiAgICAgICAgd2l0aERpcmVjdGl2ZXMoaCgnZGl2JywgcHJvcHNEYXRhLCBmaWx0ZXJTbG90IHx8IGdlbkZpbHRlcklucHV0KGNvbCkpLCBbXG4gICAgICAgICAgW2NsaWNrT3V0c2lkZSwgZGlyZWN0aXZlXSxcbiAgICAgICAgICBbdlNob3csIGNvbC5zaG93RmlsdGVyXSxcbiAgICAgICAgXSlcbiAgICAgIClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJUaXRsZSA9IChjb2wpOiBWTm9kZSA9PiB7XG4gICAgICByZXR1cm4gaCgnZGl2JywgeyBjbGFzczogJ3YtZGF0YS10YWJsZS1jb2xfX3RpdGxlJyB9LCBjb2wudGl0bGUpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuTnVtYmVyQ2VsbCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGFsaWduOiAnY2VudGVyJyxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fbnVtYmVyJzogdHJ1ZSxcbiAgICAgICAgICBbcHJvcHMuY2VsbENsYXNzXTogISFwcm9wcy5jZWxsQ2xhc3MsXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnRlbnRDb2xvcjogY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5vcHRpb25zLmNvbG9yLFxuICAgICAgICB3aWR0aDogNTAsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVDZWxsLCBwcm9wc0RhdGEsIHsgZGVmYXVsdDogKCkgPT4gJ+KElicgfSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5DaGVja2JveENlbGwgPSAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGFsaWduOiAnY2VudGVyJyxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fY2hlY2tib3gnOiB0cnVlLFxuICAgICAgICAgIFtwcm9wcy5jZWxsQ2xhc3NdOiAhIXByb3BzLmNlbGxDbGFzcyxcbiAgICAgICAgfSxcbiAgICAgICAgZGFyazogcHJvcHMub3B0aW9ucy5kYXJrLFxuICAgICAgICBjb250ZW50Q29sb3I6IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlLFxuICAgICAgICBjb2xvcjogcHJvcHMub3B0aW9ucy5jb2xvcixcbiAgICAgICAgd2lkdGg6IDUwLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBjb250ZW50ID0ge1xuICAgICAgICBkZWZhdWx0OiAoKSA9PlxuICAgICAgICAgIGgoVkNoZWNrYm94LCB7XG4gICAgICAgICAgICBjb2xvcjogY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUsXG4gICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IGVtaXQoJ3NlbGVjdC1hbGwnLCBlKSxcbiAgICAgICAgICB9KSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkRhdGFUYWJsZUNlbGwsIHByb3BzRGF0YSwgY29udGVudClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJDZWxsID0gKGNvbCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBkYXJrOiBwcm9wcy5vcHRpb25zLmRhcmssXG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2wnOiB0cnVlLFxuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sLS1zb3J0ZWQnOiBjb2wuc29ydGVkLFxuICAgICAgICAgIFtjb2wuY2VsbENsYXNzXTogISFjb2wuY2VsbENsYXNzLFxuICAgICAgICB9LFxuICAgICAgICBjb250ZW50Q29sb3I6ICFjb2wuY2VsbENsYXNzID8gY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUgOiAnJyxcbiAgICAgICAgY29sb3I6ICFjb2wuY2VsbENsYXNzID8gcHJvcHMub3B0aW9ucy5jb2xvciA6ICcnLFxuICAgICAgICB3aWR0aDogY29sLndpZHRoLFxuICAgICAgICByZXNpemVhYmxlOiBjb2wucmVzaXplYWJsZSxcbiAgICAgICAgcmVzaXplckNvbG9yOiBwcm9wcy5vcHRpb25zPy5yZXNpemVyQ29sb3IsXG4gICAgICAgIGFsaWduOiBjb2wuYWxpZ24gfHwgcHJvcHMuYWxpZ24sXG4gICAgICAgIG9uUmVzaXplOiAoJHNpemUpID0+IChjb2wud2lkdGggPSAkc2l6ZSksXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVDZWxsLCBwcm9wc0RhdGEsIHtcbiAgICAgICAgZGVmYXVsdDogKCkgPT4gW1xuICAgICAgICAgIGdlbkhlYWRlclRpdGxlKGNvbCksXG4gICAgICAgICAgZ2VuSGVhZGVyQWN0aW9ucyhjb2wpLFxuICAgICAgICAgIHVzZVRyYW5zaXRpb24oZ2VuRmlsdGVyV3JhcHBlcihjb2wpLCB0cmFuc2l0aW9ucy5GQURFKSxcbiAgICAgICAgXSxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuSGVhZGVyQ2hpbGRyZW4gPSAoKSA9PiB7XG4gICAgICBjb25zdCBjaGlsZHJlbjogVk5vZGVbXSA9IFtdXG4gICAgICBjb25zdCBoZWFkZXJTbG90ID0gc2xvdHMuaGVhZGVyICYmIHNsb3RzLmhlYWRlcihwcm9wcylcblxuICAgICAgcHJvcHMuc2hvd1NlcXVlbmNlICYmIGNoaWxkcmVuLnB1c2goZ2VuTnVtYmVyQ2VsbCgpKVxuICAgICAgcHJvcHMuc2hvd0NoZWNrYm94ICYmIGNoaWxkcmVuLnB1c2goZ2VuQ2hlY2tib3hDZWxsKCkpXG5cbiAgICAgIGNvbHMudmFsdWUhLmZvckVhY2goKGNvbDogRGF0YUNvbHVtbikgPT4ge1xuICAgICAgICBjb2wud2lkdGggPSBjb2wud2lkdGggfHwgcHJvcHMuY29sV2lkdGhcblxuICAgICAgICBpZiAoIWNvbC5oYXNPd25Qcm9wZXJ0eSgnc2hvdycpKSB7XG4gICAgICAgICAgY29sLnNob3cgPSAhY29sLnNob3dcbiAgICAgICAgfVxuXG4gICAgICAgICFoZWFkZXJTbG90IVswXS5jaGlsZHJlbiAmJlxuICAgICAgICBjb2wuc2hvdyAmJlxuICAgICAgICBjaGlsZHJlbi5wdXNoKGdlbkhlYWRlckNlbGwoY29sKSlcbiAgICAgIH0pXG5cbiAgICAgIGhlYWRlclNsb3QhWzBdLmNoaWxkcmVuICYmIGNoaWxkcmVuLnB1c2goaGVhZGVyU2xvdCBhcyBhbnkpXG5cbiAgICAgIHJldHVybiBjaGlsZHJlblxuICAgIH1cblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiBjbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogc3R5bGVzLnZhbHVlLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaCgnZGl2JywgcHJvcHNEYXRhLCBnZW5IZWFkZXJDaGlsZHJlbigpKVxuICAgIH1cbiAgfSxcbn0pXG4iXX0=