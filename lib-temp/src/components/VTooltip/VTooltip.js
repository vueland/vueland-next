import { h, ref, reactive, watch, computed, withDirectives, defineComponent, onMounted, vShow, } from 'vue';
import { useToggle } from '../../composable/use-toggle';
import { useColors } from '../../composable/use-colors';
import { useActivator } from '../../composable/use-activator';
import { useTransition } from '../../composable/use-transition';
import { elevationProps, useElevation } from '../../composable/use-elevation';
import { positionProps } from '../../composable/use-position';
import { convertToUnit } from '../../helpers';
import { transitions } from '../../services/transitions';
export const VTooltip = defineComponent({
    name: 'v-tooltip',
    props: {
        openOnHover: {
            type: Boolean,
            default: true,
        },
        color: {
            type: String,
            default: 'grey lighten-1',
        },
        zIndex: [Number, String],
        maxWidth: [Number, String],
        minWidth: [Number, String],
        modelValue: Boolean,
        offsetX: {
            type: [String, Number],
            default: 20,
        },
        offsetY: {
            type: [String, Number],
            default: 20,
        },
        ...elevationProps(),
        ...positionProps(),
    },
    setup(props, { slots }) {
        const tooltip = reactive({});
        const activator = reactive({});
        const tooltipRef = ref(null);
        const { isActive } = useToggle(props);
        const { elevationClasses } = useElevation(props);
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const { activatorRef, getActivatorSizes, genActivatorListeners } = useActivator(props);
        const handlers = {
            mouseenter: () => (isActive.value = true),
            mouseleave: () => (isActive.value = false),
        };
        const listeners = genActivatorListeners(props, handlers);
        const classes = computed(() => ({
            'v-tooltip': true,
            'v-tooltip--top': props.top,
            'v-tooltip--right': props.right,
            'v-tooltip--left': props.left,
            'v-tooltip--bottom': props.bottom,
            ...elevationClasses.value,
            ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
        }));
        const computeTopPosition = computed(() => {
            return ((props.top
                ? activator.top - tooltip.height
                : props.bottom
                    ? activator.top + activator.height
                    : activator.top + (activator.height - tooltip.height) / 2) +
                +props.offsetY);
        });
        const computeLeftPosition = computed(() => {
            return ((props.left
                ? activator.left - tooltip.width
                : props.right
                    ? activator.left + activator.width
                    : activator.left + (activator.width - tooltip.width) / 2) +
                +props.offsetX);
        });
        const styles = computed(() => ({
            top: tooltip.top ? convertToUnit(tooltip.top) : '',
            left: tooltip.top ? convertToUnit(tooltip.left) : '',
            maxWidth: !!props.maxWidth ? `${props.maxWidth}px` : '',
            minWidth: !!props.minWidth ? `${props.minWidth}px` : '',
            zIndex: props.zIndex,
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        function genActivator() {
            const slotContent = slots.activator &&
                slots.activator({
                    on: listeners,
                });
            return h(slotContent[0], { ref: activatorRef });
        }
        function genContent() {
            const propsData = {
                class: classes.value,
                style: styles.value,
                ref: tooltipRef,
            };
            return withDirectives(h('span', propsData, slots.default && slots.default()), [[vShow, isActive.value]]);
        }
        function setTooltipPosition() {
            if (tooltipRef.value) {
                tooltip.width = tooltipRef.value.offsetWidth;
                tooltip.height = tooltipRef.value.offsetHeight;
                tooltip.top = computeTopPosition.value;
                tooltip.left = computeLeftPosition.value;
            }
        }
        onMounted(() => {
            watch(() => isActive.value, (to) => {
                if (to) {
                    const { left, top, height, width } = getActivatorSizes();
                    activator.left = left;
                    activator.top = top;
                    activator.height = height;
                    activator.width = width;
                    tooltip.top = 0;
                    tooltip.left = 0;
                    requestAnimationFrame(setTooltipPosition);
                }
            }, { immediate: true });
        });
        return () => {
            const content = useTransition(genContent(), isActive.value ? transitions.SCALE_IN : transitions.FADE);
            return [content, genActivator()];
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlRvb2x0aXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tcG9uZW50cy9WVG9vbHRpcC9WVG9vbHRpcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsQ0FBQyxFQUNELEdBQUcsRUFDSCxRQUFRLEVBQ1IsS0FBSyxFQUNMLFFBQVEsRUFDUixjQUFjLEVBQ2QsZUFBZSxFQUNmLFNBQVMsRUFDVCxLQUFLLEdBQ04sTUFBTSxLQUFLLENBQUE7QUFHWixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFDdkQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFBO0FBQ3ZELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM3RCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUNBQWlDLENBQUE7QUFDL0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxZQUFZLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQTtBQUM3RSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sK0JBQStCLENBQUE7QUFPN0QsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQTtBQUc3QyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUE7QUFJeEQsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFHLGVBQWUsQ0FBQztJQUN0QyxJQUFJLEVBQUUsV0FBVztJQUVqQixLQUFLLEVBQUU7UUFDTCxXQUFXLEVBQUU7WUFDWCxJQUFJLEVBQUUsT0FBTztZQUNiLE9BQU8sRUFBRSxJQUFJO1NBQ2Q7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxnQkFBZ0I7U0FDMUI7UUFDRCxNQUFNLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1FBQ3hCLFFBQVEsRUFBRSxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUM7UUFDMUIsUUFBUSxFQUFFLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQztRQUMxQixVQUFVLEVBQUUsT0FBTztRQUNuQixPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxHQUFHLGNBQWMsRUFBRTtRQUNuQixHQUFHLGFBQWEsRUFBRTtLQUNaO0lBRVIsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRTtRQUNwQixNQUFNLE9BQU8sR0FBRyxRQUFRLENBQXVCLEVBQUUsQ0FBQyxDQUFBO1FBQ2xELE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBdUIsRUFBRSxDQUFDLENBQUE7UUFFcEQsTUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFxQixJQUFJLENBQUMsQ0FBQTtRQUVoRCxNQUFNLEVBQUUsUUFBUSxFQUFFLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ3JDLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUNoRCxNQUFNLEVBQUUsMkJBQTJCLEVBQUUscUJBQXFCLEVBQUUsR0FBRyxTQUFTLEVBQUUsQ0FBQTtRQUMxRSxNQUFNLEVBQUUsWUFBWSxFQUFFLGlCQUFpQixFQUFFLHFCQUFxQixFQUFFLEdBQzlELFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUVyQixNQUFNLFFBQVEsR0FBRztZQUNmLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ3pDLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1NBQzNDLENBQUE7UUFFRCxNQUFNLFNBQVMsR0FBRyxxQkFBcUIsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUE7UUFFeEQsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUEwQixHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELFdBQVcsRUFBRSxJQUFJO1lBQ2pCLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQzNCLGtCQUFrQixFQUFFLEtBQUssQ0FBQyxLQUFLO1lBQy9CLGlCQUFpQixFQUFFLEtBQUssQ0FBQyxJQUFJO1lBQzdCLG1CQUFtQixFQUFFLEtBQUssQ0FBQyxNQUFNO1lBQ2pDLEdBQUcsZ0JBQWdCLENBQUMsS0FBSztZQUN6QixHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsMkJBQTJCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDakUsQ0FBQyxDQUFDLENBQUE7UUFFSCxNQUFNLGtCQUFrQixHQUFHLFFBQVEsQ0FBUyxHQUFHLEVBQUU7WUFDL0MsT0FBTyxDQUNMLENBQUMsS0FBSyxDQUFDLEdBQUc7Z0JBQ1IsQ0FBQyxDQUFDLFNBQVUsQ0FBQyxHQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU87Z0JBQ25DLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTTtvQkFDZCxDQUFDLENBQUMsU0FBUyxDQUFDLEdBQUksR0FBRyxTQUFTLENBQUMsTUFBTztvQkFDcEMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxHQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsTUFBTyxHQUFHLE9BQU8sQ0FBQyxNQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQy9ELENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FDZixDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFFRixNQUFNLG1CQUFtQixHQUFHLFFBQVEsQ0FBUyxHQUFHLEVBQUU7WUFDaEQsT0FBTyxDQUNMLENBQUMsS0FBSyxDQUFDLElBQUk7Z0JBQ1QsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFLLEdBQUcsT0FBTyxDQUFDLEtBQU07Z0JBQ2xDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSztvQkFDYixDQUFDLENBQUMsU0FBUyxDQUFDLElBQUssR0FBRyxTQUFTLENBQUMsS0FBTTtvQkFDcEMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFLLEdBQUcsQ0FBQyxTQUFTLENBQUMsS0FBTSxHQUFHLE9BQU8sQ0FBQyxLQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzlELENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FDZixDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFFRixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQXlCLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDckQsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDOUQsSUFBSSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFFLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSyxDQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDakUsUUFBUSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUN2RCxRQUFRLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ3ZELE1BQU0sRUFBRSxLQUFLLENBQUMsTUFBTTtZQUNwQixHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7U0FDM0QsQ0FBQyxDQUFDLENBQUE7UUFFSCxTQUFTLFlBQVk7WUFDbkIsTUFBTSxXQUFXLEdBQ2YsS0FBSyxDQUFDLFNBQVM7Z0JBQ2YsS0FBSyxDQUFDLFNBQVMsQ0FBQztvQkFDZCxFQUFFLEVBQUUsU0FBUztpQkFDZCxDQUFDLENBQUE7WUFFSixPQUFPLENBQUMsQ0FBQyxXQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQTtRQUNsRCxDQUFDO1FBRUQsU0FBUyxVQUFVO1lBQ2pCLE1BQU0sU0FBUyxHQUFHO2dCQUNoQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7Z0JBQ3BCLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSztnQkFDbkIsR0FBRyxFQUFFLFVBQVU7YUFDaEIsQ0FBQTtZQUVELE9BQU8sY0FBYyxDQUNuQixDQUFDLENBQUMsTUFBTSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxFQUN0RCxDQUFDLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUMxQixDQUFBO1FBQ0gsQ0FBQztRQUVELFNBQVMsa0JBQWtCO1lBQ3pCLElBQUksVUFBVSxDQUFDLEtBQUssRUFBRTtnQkFDcEIsT0FBTyxDQUFDLEtBQUssR0FBRyxVQUFVLENBQUMsS0FBTSxDQUFDLFdBQVcsQ0FBQTtnQkFDN0MsT0FBTyxDQUFDLE1BQU0sR0FBRyxVQUFVLENBQUMsS0FBTSxDQUFDLFlBQVksQ0FBQTtnQkFDL0MsT0FBTyxDQUFDLEdBQUcsR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUE7Z0JBQ3RDLE9BQU8sQ0FBQyxJQUFJLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUFBO2FBQ3pDO1FBQ0gsQ0FBQztRQUVELFNBQVMsQ0FBQyxHQUFHLEVBQUU7WUFDYixLQUFLLENBQ0gsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssRUFDcEIsQ0FBQyxFQUFFLEVBQUUsRUFBRTtnQkFDTCxJQUFJLEVBQUUsRUFBRTtvQkFDTixNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsS0FBSyxFQUFFLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQTtvQkFFeEQsU0FBUyxDQUFDLElBQUksR0FBRyxJQUFjLENBQUE7b0JBQy9CLFNBQVMsQ0FBQyxHQUFHLEdBQUcsR0FBYSxDQUFBO29CQUM3QixTQUFTLENBQUMsTUFBTSxHQUFHLE1BQWdCLENBQUE7b0JBQ25DLFNBQVMsQ0FBQyxLQUFLLEdBQUcsS0FBZSxDQUFBO29CQUVqQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQTtvQkFDZixPQUFPLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQTtvQkFFaEIscUJBQXFCLENBQUMsa0JBQWtCLENBQUMsQ0FBQTtpQkFDMUM7WUFDSCxDQUFDLEVBQ0QsRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLENBQ3BCLENBQUE7UUFDSCxDQUFDLENBQUMsQ0FBQTtRQUVGLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUMzQixVQUFVLEVBQVcsRUFDckIsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDekQsQ0FBQTtZQUVELE9BQU8sQ0FBQyxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQTtRQUNsQyxDQUFDLENBQUE7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVnVlIEFQSVxuaW1wb3J0IHtcbiAgaCxcbiAgcmVmLFxuICByZWFjdGl2ZSxcbiAgd2F0Y2gsXG4gIGNvbXB1dGVkLFxuICB3aXRoRGlyZWN0aXZlcyxcbiAgZGVmaW5lQ29tcG9uZW50LFxuICBvbk1vdW50ZWQsXG4gIHZTaG93LFxufSBmcm9tICd2dWUnXG5cbi8vIEVmZmVjdHNcbmltcG9ydCB7IHVzZVRvZ2dsZSB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLXRvZ2dsZSdcbmltcG9ydCB7IHVzZUNvbG9ycyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWNvbG9ycydcbmltcG9ydCB7IHVzZUFjdGl2YXRvciB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWFjdGl2YXRvcidcbmltcG9ydCB7IHVzZVRyYW5zaXRpb24gfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlL3VzZS10cmFuc2l0aW9uJ1xuaW1wb3J0IHsgZWxldmF0aW9uUHJvcHMsIHVzZUVsZXZhdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWVsZXZhdGlvbidcbmltcG9ydCB7IHBvc2l0aW9uUHJvcHMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlL3VzZS1wb3NpdGlvbidcblxuLy8gVHlwZXNcbmltcG9ydCB7IE9mZnNldFNpemVzIH0gZnJvbSAnLi4vLi4vLi4vdHlwZXMnXG5pbXBvcnQgeyBWTm9kZSB9IGZyb20gJ3Z1ZSdcblxuLy8gSGVscGVyc1xuaW1wb3J0IHsgY29udmVydFRvVW5pdCB9IGZyb20gJy4uLy4uL2hlbHBlcnMnXG5cbi8vIFNlcnZpY2VzXG5pbXBvcnQgeyB0cmFuc2l0aW9ucyB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3RyYW5zaXRpb25zJ1xuXG4vLyBUT0RPIGZpeCBiZWhhdmlvciBvbiB3aW5kb3cgcmVzaXplIGlmIHYtbW9kZWwgdXNlZCBvbiBjb21wb25lbnRcblxuZXhwb3J0IGNvbnN0IFZUb29sdGlwID0gZGVmaW5lQ29tcG9uZW50KHtcbiAgbmFtZTogJ3YtdG9vbHRpcCcsXG5cbiAgcHJvcHM6IHtcbiAgICBvcGVuT25Ib3Zlcjoge1xuICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgfSxcbiAgICBjb2xvcjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJ2dyZXkgbGlnaHRlbi0xJyxcbiAgICB9LFxuICAgIHpJbmRleDogW051bWJlciwgU3RyaW5nXSxcbiAgICBtYXhXaWR0aDogW051bWJlciwgU3RyaW5nXSxcbiAgICBtaW5XaWR0aDogW051bWJlciwgU3RyaW5nXSxcbiAgICBtb2RlbFZhbHVlOiBCb29sZWFuLFxuICAgIG9mZnNldFg6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAyMCxcbiAgICB9LFxuICAgIG9mZnNldFk6IHtcbiAgICAgIHR5cGU6IFtTdHJpbmcsIE51bWJlcl0sXG4gICAgICBkZWZhdWx0OiAyMCxcbiAgICB9LFxuICAgIC4uLmVsZXZhdGlvblByb3BzKCksXG4gICAgLi4ucG9zaXRpb25Qcm9wcygpLFxuICB9IGFzIGFueSxcblxuICBzZXR1cChwcm9wcywgeyBzbG90cyB9KSB7XG4gICAgY29uc3QgdG9vbHRpcCA9IHJlYWN0aXZlPFBhcnRpYWw8T2Zmc2V0U2l6ZXM+Pih7fSlcbiAgICBjb25zdCBhY3RpdmF0b3IgPSByZWFjdGl2ZTxQYXJ0aWFsPE9mZnNldFNpemVzPj4oe30pXG5cbiAgICBjb25zdCB0b29sdGlwUmVmID0gcmVmPEhUTUxFbGVtZW50IHwgbnVsbD4obnVsbClcblxuICAgIGNvbnN0IHsgaXNBY3RpdmUgfSA9IHVzZVRvZ2dsZShwcm9wcylcbiAgICBjb25zdCB7IGVsZXZhdGlvbkNsYXNzZXMgfSA9IHVzZUVsZXZhdGlvbihwcm9wcylcbiAgICBjb25zdCB7IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvciwgc2V0QmFja2dyb3VuZENzc0NvbG9yIH0gPSB1c2VDb2xvcnMoKVxuICAgIGNvbnN0IHsgYWN0aXZhdG9yUmVmLCBnZXRBY3RpdmF0b3JTaXplcywgZ2VuQWN0aXZhdG9yTGlzdGVuZXJzIH0gPVxuICAgICAgdXNlQWN0aXZhdG9yKHByb3BzKVxuXG4gICAgY29uc3QgaGFuZGxlcnMgPSB7XG4gICAgICBtb3VzZWVudGVyOiAoKSA9PiAoaXNBY3RpdmUudmFsdWUgPSB0cnVlKSxcbiAgICAgIG1vdXNlbGVhdmU6ICgpID0+IChpc0FjdGl2ZS52YWx1ZSA9IGZhbHNlKSxcbiAgICB9XG5cbiAgICBjb25zdCBsaXN0ZW5lcnMgPSBnZW5BY3RpdmF0b3JMaXN0ZW5lcnMocHJvcHMsIGhhbmRsZXJzKVxuXG4gICAgY29uc3QgY2xhc3NlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIGJvb2xlYW4+PigoKSA9PiAoe1xuICAgICAgJ3YtdG9vbHRpcCc6IHRydWUsXG4gICAgICAndi10b29sdGlwLS10b3AnOiBwcm9wcy50b3AsXG4gICAgICAndi10b29sdGlwLS1yaWdodCc6IHByb3BzLnJpZ2h0LFxuICAgICAgJ3YtdG9vbHRpcC0tbGVmdCc6IHByb3BzLmxlZnQsXG4gICAgICAndi10b29sdGlwLS1ib3R0b20nOiBwcm9wcy5ib3R0b20sXG4gICAgICAuLi5lbGV2YXRpb25DbGFzc2VzLnZhbHVlLFxuICAgICAgLi4uKHByb3BzLmNvbG9yID8gc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yKHByb3BzLmNvbG9yKSA6IHt9KSxcbiAgICB9KSlcblxuICAgIGNvbnN0IGNvbXB1dGVUb3BQb3NpdGlvbiA9IGNvbXB1dGVkPG51bWJlcj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgKHByb3BzLnRvcFxuICAgICAgICAgID8gYWN0aXZhdG9yIS50b3AhIC0gdG9vbHRpcC5oZWlnaHQhXG4gICAgICAgICAgOiBwcm9wcy5ib3R0b21cbiAgICAgICAgICA/IGFjdGl2YXRvci50b3AhICsgYWN0aXZhdG9yLmhlaWdodCFcbiAgICAgICAgICA6IGFjdGl2YXRvci50b3AhICsgKGFjdGl2YXRvci5oZWlnaHQhIC0gdG9vbHRpcC5oZWlnaHQhKSAvIDIpICtcbiAgICAgICAgK3Byb3BzLm9mZnNldFlcbiAgICAgIClcbiAgICB9KVxuXG4gICAgY29uc3QgY29tcHV0ZUxlZnRQb3NpdGlvbiA9IGNvbXB1dGVkPG51bWJlcj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgKHByb3BzLmxlZnRcbiAgICAgICAgICA/IGFjdGl2YXRvci5sZWZ0ISAtIHRvb2x0aXAud2lkdGghXG4gICAgICAgICAgOiBwcm9wcy5yaWdodFxuICAgICAgICAgID8gYWN0aXZhdG9yLmxlZnQhICsgYWN0aXZhdG9yLndpZHRoIVxuICAgICAgICAgIDogYWN0aXZhdG9yLmxlZnQhICsgKGFjdGl2YXRvci53aWR0aCEgLSB0b29sdGlwLndpZHRoISkgLyAyKSArXG4gICAgICAgICtwcm9wcy5vZmZzZXRYXG4gICAgICApXG4gICAgfSlcblxuICAgIGNvbnN0IHN0eWxlcyA9IGNvbXB1dGVkPFJlY29yZDxzdHJpbmcsIHN0cmluZz4+KCgpID0+ICh7XG4gICAgICB0b3A6IHRvb2x0aXAudG9wID8gKGNvbnZlcnRUb1VuaXQodG9vbHRpcC50b3ApIGFzIHN0cmluZykgOiAnJyxcbiAgICAgIGxlZnQ6IHRvb2x0aXAudG9wID8gKGNvbnZlcnRUb1VuaXQodG9vbHRpcC5sZWZ0ISkgYXMgc3RyaW5nKSA6ICcnLFxuICAgICAgbWF4V2lkdGg6ICEhcHJvcHMubWF4V2lkdGggPyBgJHtwcm9wcy5tYXhXaWR0aH1weGAgOiAnJyxcbiAgICAgIG1pbldpZHRoOiAhIXByb3BzLm1pbldpZHRoID8gYCR7cHJvcHMubWluV2lkdGh9cHhgIDogJycsXG4gICAgICB6SW5kZXg6IHByb3BzLnpJbmRleCxcbiAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldEJhY2tncm91bmRDc3NDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgfSkpXG5cbiAgICBmdW5jdGlvbiBnZW5BY3RpdmF0b3IoKTogVk5vZGUgfCBudWxsIHtcbiAgICAgIGNvbnN0IHNsb3RDb250ZW50ID1cbiAgICAgICAgc2xvdHMuYWN0aXZhdG9yICYmXG4gICAgICAgIHNsb3RzLmFjdGl2YXRvcih7XG4gICAgICAgICAgb246IGxpc3RlbmVycyxcbiAgICAgICAgfSlcblxuICAgICAgcmV0dXJuIGgoc2xvdENvbnRlbnQhWzBdLCB7IHJlZjogYWN0aXZhdG9yUmVmIH0pXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2VuQ29udGVudCgpOiBWTm9kZSB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiBjbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogc3R5bGVzLnZhbHVlLFxuICAgICAgICByZWY6IHRvb2x0aXBSZWYsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB3aXRoRGlyZWN0aXZlcyhcbiAgICAgICAgaCgnc3BhbicsIHByb3BzRGF0YSwgc2xvdHMuZGVmYXVsdCAmJiBzbG90cy5kZWZhdWx0KCkpLFxuICAgICAgICBbW3ZTaG93LCBpc0FjdGl2ZS52YWx1ZV1dXG4gICAgICApXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2V0VG9vbHRpcFBvc2l0aW9uKCkge1xuICAgICAgaWYgKHRvb2x0aXBSZWYudmFsdWUpIHtcbiAgICAgICAgdG9vbHRpcC53aWR0aCA9IHRvb2x0aXBSZWYudmFsdWUhLm9mZnNldFdpZHRoXG4gICAgICAgIHRvb2x0aXAuaGVpZ2h0ID0gdG9vbHRpcFJlZi52YWx1ZSEub2Zmc2V0SGVpZ2h0XG4gICAgICAgIHRvb2x0aXAudG9wID0gY29tcHV0ZVRvcFBvc2l0aW9uLnZhbHVlXG4gICAgICAgIHRvb2x0aXAubGVmdCA9IGNvbXB1dGVMZWZ0UG9zaXRpb24udmFsdWVcbiAgICAgIH1cbiAgICB9XG5cbiAgICBvbk1vdW50ZWQoKCkgPT4ge1xuICAgICAgd2F0Y2goXG4gICAgICAgICgpID0+IGlzQWN0aXZlLnZhbHVlLFxuICAgICAgICAodG8pID0+IHtcbiAgICAgICAgICBpZiAodG8pIHtcbiAgICAgICAgICAgIGNvbnN0IHsgbGVmdCwgdG9wLCBoZWlnaHQsIHdpZHRoIH0gPSBnZXRBY3RpdmF0b3JTaXplcygpXG5cbiAgICAgICAgICAgIGFjdGl2YXRvci5sZWZ0ID0gbGVmdCBhcyBudW1iZXJcbiAgICAgICAgICAgIGFjdGl2YXRvci50b3AgPSB0b3AgYXMgbnVtYmVyXG4gICAgICAgICAgICBhY3RpdmF0b3IuaGVpZ2h0ID0gaGVpZ2h0IGFzIG51bWJlclxuICAgICAgICAgICAgYWN0aXZhdG9yLndpZHRoID0gd2lkdGggYXMgbnVtYmVyXG5cbiAgICAgICAgICAgIHRvb2x0aXAudG9wID0gMFxuICAgICAgICAgICAgdG9vbHRpcC5sZWZ0ID0gMFxuXG4gICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoc2V0VG9vbHRpcFBvc2l0aW9uKVxuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgeyBpbW1lZGlhdGU6IHRydWUgfVxuICAgICAgKVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY29uc3QgY29udGVudCA9IHVzZVRyYW5zaXRpb24oXG4gICAgICAgIGdlbkNvbnRlbnQoKSBhcyBWTm9kZSxcbiAgICAgICAgaXNBY3RpdmUudmFsdWUgPyB0cmFuc2l0aW9ucy5TQ0FMRV9JTiA6IHRyYW5zaXRpb25zLkZBREVcbiAgICAgIClcblxuICAgICAgcmV0dXJuIFtjb250ZW50LCBnZW5BY3RpdmF0b3IoKV1cbiAgICB9XG4gIH0sXG59KVxuIl19