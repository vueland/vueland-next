import { h, computed, withDirectives, defineComponent } from 'vue';
import { useColors } from '../../composables/use-colors';
import { useIcons } from '../../composables/use-icons';
import { VIcon } from '../VIcon';
import { VCheckbox } from '../VCheckbox';
import { VDataTableCell } from './VDataTableCell';
import { VTextField } from '../VTextField';
import { vShow } from 'vue';
import { vClickOutside } from '../../directives/v-click-outside';
import { useTransition } from '../../composables/use-transition';
import { transitions } from '../../services/transitions';
export const VDataTableHeader = defineComponent({
    name: 'v-data-table-header',
    props: {
        showSequence: Boolean,
        showCheckbox: Boolean,
        cols: Array,
        colWidth: {
            type: [String, Number],
            default: 125,
        },
        align: String,
        options: Object,
    },
    emits: ['sort', 'filter', 'select-all', 'update:cols'],
    setup(props, { emit, slots }) {
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const { icons } = useIcons();
        const _cache = {};
        const classes = computed(() => ({
            'v-data-table__header': true,
            ...(props.options.color
                ? setBackgroundClassNameColor(props.options.color)
                : {}),
        }));
        const styles = computed(() => ({
            ...(props.options.color
                ? setBackgroundCssColor(props.options.color)
                : {}),
        }));
        const computedContentColor = computed(() => {
            return props.options.dark
                ? props.options?.contentColor || 'white'
                : props.options?.contentColor;
        });
        const cols = computed(() => [...props.cols]);
        const onSort = (item) => {
            emit('sort', item);
        };
        const onInput = ($value, col) => {
            col.filtered = !!$value;
            _cache[col.title] = $value;
            console.log(_cache);
            emit('filter', { value: $value, col });
        };
        const showFilter = (item) => {
            if (item.showFilter)
                return;
            item.showFilter = true;
        };
        const genSortButton = (item) => {
            const classes = {
                'v-data-table-col__actions-sort': true,
                'v-data-table-col__actions-sort--active': item.sorted,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$arrowUp,
                onClick: () => onSort(item),
            };
            return h(VIcon, propsData);
        };
        const genFilterButton = (item) => {
            const classes = {
                'v-data-table-col__actions-filter': true,
                'v-data-table-col__actions-filter--active': item.filtered,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$filter,
                color: !item.cellClass ? computedContentColor.value : '',
                onClick: () => showFilter(item),
            };
            return h(VIcon, propsData);
        };
        const genHeaderActions = (item) => {
            return h('span', { class: 'v-data-table-col__actions' }, [
                item.sortable && genSortButton(item),
                item.filterable && genFilterButton(item),
            ]);
        };
        const genFilterInput = (col) => {
            const propsData = {
                modelValue: _cache[col.title],
                label: 'search',
                dark: props.options.dark,
                color: !col.cellClass ? computedContentColor.value : '',
                prependIcon: icons.$search,
                clearable: true,
                onInput: ($value) => onInput($value, col),
            };
            return h(VTextField, propsData);
        };
        const genFilterWrapper = (col) => {
            const color = props.options.dark
                ? props.options?.color || 'grey darken-3'
                : props.options?.color || 'white';
            const slotName = `${col.key}-filter`;
            const filterSlot = slots[slotName] && slots[slotName]({
                filter: (event) => onInput(event, col),
            });
            const directive = col.showFilter
                ? {
                    handler: () => setTimeout(() => (col.showFilter = false)),
                    closeConditional: false,
                }
                : undefined;
            const propsData = {
                class: {
                    'v-data-table-col__filter': !filterSlot,
                    'v-data-table-col__custom-filter': !!filterSlot,
                    'elevation-5': true,
                    [col.cellClass]: !!col.cellClass,
                    ...(color ? setBackgroundClassNameColor(color) : {}),
                },
                style: {
                    ...(color ? setBackgroundCssColor(color) : {}),
                },
            };
            return (col.filterable &&
                withDirectives(h('div', propsData, filterSlot || genFilterInput(col)), [
                    [vClickOutside, directive],
                    [vShow, col.showFilter],
                ]));
        };
        const genHeaderTitle = (col) => {
            return h('div', { class: 'v-data-table-col__title' }, col.title);
        };
        const genNumberCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__number': true,
                    [props.cellClass]: !!props.cellClass,
                },
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            return h(VDataTableCell, propsData, { default: () => 'â„–' });
        };
        const genCheckboxCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__checkbox': true,
                    [props.cellClass]: !!props.cellClass,
                },
                dark: props.options.dark,
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            const content = {
                default: () => h(VCheckbox, {
                    color: computedContentColor.value,
                    onChange: (e) => emit('select-all', e),
                }),
            };
            return h(VDataTableCell, propsData, content);
        };
        const genHeaderCell = (col) => {
            const propsData = {
                dark: props.options.dark,
                class: {
                    'v-data-table-col': true,
                    'v-data-table-col--sorted': col.sorted,
                    [col.cellClass]: !!col.cellClass,
                },
                contentColor: !col.cellClass ? computedContentColor.value : '',
                color: !col.cellClass ? props.options.color : '',
                width: col.width,
                resizeable: col.resizeable,
                resizerColor: props.options?.resizerColor,
                align: col.align || props.align,
                onResize: ($size) => (col.width = $size),
            };
            return h(VDataTableCell, propsData, {
                default: () => [
                    genHeaderTitle(col),
                    genHeaderActions(col),
                    useTransition(genFilterWrapper(col), transitions.FADE),
                ],
            });
        };
        const genHeaderChildren = () => {
            const children = [];
            const headerSlot = slots.header && slots.header(props);
            props.showSequence && children.push(genNumberCell());
            props.showCheckbox && children.push(genCheckboxCell());
            cols.value.forEach((col) => {
                col.width = col.width || props.colWidth;
                if (!col.hasOwnProperty('show')) {
                    col.show = !col.show;
                }
                !headerSlot[0].children &&
                    col.show &&
                    children.push(genHeaderCell(col));
            });
            headerSlot[0].children && children.push(headerSlot);
            return children;
        };
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
            };
            return h('div', propsData, genHeaderChildren());
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZUhlYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZEYXRhVGFibGUvVkRhdGFUYWJsZUhlYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sS0FBSyxDQUFBO0FBR2xFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQTtBQUN4RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFHdEQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUNoQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBQ3hDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFDM0IsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBS2hFLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQTtBQUNoRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUE7QUFFeEQsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsZUFBZSxDQUFDO0lBQzlDLElBQUksRUFBRSxxQkFBcUI7SUFFM0IsS0FBSyxFQUFFO1FBQ0wsWUFBWSxFQUFFLE9BQU87UUFDckIsWUFBWSxFQUFFLE9BQU87UUFDckIsSUFBSSxFQUFFLEtBQUs7UUFDWCxRQUFRLEVBQUU7WUFDUixJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxHQUFHO1NBQ2I7UUFDRCxLQUFLLEVBQUUsTUFBTTtRQUNiLE9BQU8s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IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7IGgsIGNvbXB1dGVkLCB3aXRoRGlyZWN0aXZlcywgZGVmaW5lQ29tcG9uZW50IH0gZnJvbSAndnVlJ1xuXG4vLyBFZmZlY3RzXG5pbXBvcnQgeyB1c2VDb2xvcnMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtY29sb3JzJ1xuaW1wb3J0IHsgdXNlSWNvbnMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtaWNvbnMnXG5cbi8vIENvbXBvbmVudHNcbmltcG9ydCB7IFZJY29uIH0gZnJvbSAnLi4vVkljb24nXG5pbXBvcnQgeyBWQ2hlY2tib3ggfSBmcm9tICcuLi9WQ2hlY2tib3gnXG5pbXBvcnQgeyBWRGF0YVRhYmxlQ2VsbCB9IGZyb20gJy4vVkRhdGFUYWJsZUNlbGwnXG5pbXBvcnQgeyBWVGV4dEZpZWxkIH0gZnJvbSAnLi4vVlRleHRGaWVsZCdcblxuLy8gRGlyZWN0aXZlc1xuaW1wb3J0IHsgdlNob3cgfSBmcm9tICd2dWUnXG5pbXBvcnQgeyB2Q2xpY2tPdXRzaWRlIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy92LWNsaWNrLW91dHNpZGUnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7IERhdGFDb2x1bW4gfSBmcm9tICcuLi8uLi8uLi90eXBlcydcbmltcG9ydCB7IHVzZVRyYW5zaXRpb24gfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtdHJhbnNpdGlvbidcbmltcG9ydCB7IHRyYW5zaXRpb25zIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvdHJhbnNpdGlvbnMnXG5cbmV4cG9ydCBjb25zdCBWRGF0YVRhYmxlSGVhZGVyID0gZGVmaW5lQ29tcG9uZW50KHtcbiAgbmFtZTogJ3YtZGF0YS10YWJsZS1oZWFkZXInLFxuXG4gIHByb3BzOiB7XG4gICAgc2hvd1NlcXVlbmNlOiBCb29sZWFuLFxuICAgIHNob3dDaGVja2JveDogQm9vbGVhbixcbiAgICBjb2xzOiBBcnJheSxcbiAgICBjb2xXaWR0aDoge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDEyNSxcbiAgICB9LFxuICAgIGFsaWduOiBTdHJpbmcsXG4gICAgb3B0aW9uczogT2JqZWN0LFxuICB9IGFzIGFueSxcblxuICBlbWl0czogWydzb3J0JywgJ2ZpbHRlcicsICdzZWxlY3QtYWxsJywgJ3VwZGF0ZTpjb2xzJ10sXG5cbiAgc2V0dXAocHJvcHMsIHsgZW1pdCwgc2xvdHMgfSkge1xuICAgIGNvbnN0IHsgc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yLCBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IgfSA9IHVzZUNvbG9ycygpXG4gICAgY29uc3QgeyBpY29ucyB9ID0gdXNlSWNvbnMoKVxuICAgIGNvbnN0IF9jYWNoZSA9IHt9XG5cbiAgICBjb25zdCBjbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+ICh7XG4gICAgICAndi1kYXRhLXRhYmxlX19oZWFkZXInOiB0cnVlLFxuICAgICAgLi4uKHByb3BzLm9wdGlvbnMuY29sb3JcbiAgICAgICAgPyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IocHJvcHMub3B0aW9ucy5jb2xvcilcbiAgICAgICAgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBzdHlsZXMgPSBjb21wdXRlZCgoKSA9PiAoe1xuICAgICAgLi4uKHByb3BzLm9wdGlvbnMuY29sb3JcbiAgICAgICAgPyBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IocHJvcHMub3B0aW9ucy5jb2xvcilcbiAgICAgICAgOiB7fSksXG4gICAgfSkpXG5cbiAgICBjb25zdCBjb21wdXRlZENvbnRlbnRDb2xvciA9IGNvbXB1dGVkPHN0cmluZz4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHByb3BzLm9wdGlvbnMuZGFya1xuICAgICAgICA/IHByb3BzLm9wdGlvbnM/LmNvbnRlbnRDb2xvciB8fCAnd2hpdGUnXG4gICAgICAgIDogcHJvcHMub3B0aW9ucz8uY29udGVudENvbG9yXG4gICAgfSlcblxuICAgIGNvbnN0IGNvbHMgPSBjb21wdXRlZDxEYXRhQ29sdW1uW10+KCgpID0+IFsuLi5wcm9wcy5jb2xzXSlcblxuICAgIGNvbnN0IG9uU29ydCA9IChpdGVtKSA9PiB7XG4gICAgICBlbWl0KCdzb3J0JywgaXRlbSlcbiAgICB9XG5cbiAgICBjb25zdCBvbklucHV0ID0gKCR2YWx1ZSwgY29sKSA9PiB7XG4gICAgICBjb2wuZmlsdGVyZWQgPSAhISR2YWx1ZVxuICAgICAgX2NhY2hlW2NvbC50aXRsZV0gPSAkdmFsdWVcbiAgICAgIGNvbnNvbGUubG9nKF9jYWNoZSlcbiAgICAgIGVtaXQoJ2ZpbHRlcicsIHsgdmFsdWU6ICR2YWx1ZSwgY29sIH0pXG4gICAgfVxuXG4gICAgY29uc3Qgc2hvd0ZpbHRlciA9IChpdGVtKSA9PiB7XG4gICAgICBpZiAoaXRlbS5zaG93RmlsdGVyKSByZXR1cm5cbiAgICAgIGl0ZW0uc2hvd0ZpbHRlciA9IHRydWVcbiAgICB9XG5cbiAgICBjb25zdCBnZW5Tb3J0QnV0dG9uID0gKGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IGNsYXNzZXMgPSB7XG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLXNvcnQnOiB0cnVlLFxuICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fYWN0aW9ucy1zb3J0LS1hY3RpdmUnOiBpdGVtLnNvcnRlZCxcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjbGlja2FibGU6IHRydWUsXG4gICAgICAgIGNsYXNzOiBjbGFzc2VzLFxuICAgICAgICBpY29uOiBpY29ucy4kYXJyb3dVcCxcbiAgICAgICAgb25DbGljazogKCkgPT4gb25Tb3J0KGl0ZW0pLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWSWNvbiwgcHJvcHNEYXRhKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkZpbHRlckJ1dHRvbiA9IChpdGVtKSA9PiB7XG4gICAgICBjb25zdCBjbGFzc2VzID0ge1xuICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fYWN0aW9ucy1maWx0ZXInOiB0cnVlLFxuICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fYWN0aW9ucy1maWx0ZXItLWFjdGl2ZSc6IGl0ZW0uZmlsdGVyZWQsXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xpY2thYmxlOiB0cnVlLFxuICAgICAgICBjbGFzczogY2xhc3NlcyxcbiAgICAgICAgaWNvbjogaWNvbnMuJGZpbHRlcixcbiAgICAgICAgY29sb3I6ICFpdGVtLmNlbGxDbGFzcyA/IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlIDogJycsXG4gICAgICAgIG9uQ2xpY2s6ICgpID0+IHNob3dGaWx0ZXIoaXRlbSksXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZJY29uLCBwcm9wc0RhdGEpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuSGVhZGVyQWN0aW9ucyA9IChpdGVtKSA9PiB7XG4gICAgICByZXR1cm4gaCgnc3BhbicsIHsgY2xhc3M6ICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zJyB9LCBbXG4gICAgICAgIGl0ZW0uc29ydGFibGUgJiYgZ2VuU29ydEJ1dHRvbihpdGVtKSxcbiAgICAgICAgaXRlbS5maWx0ZXJhYmxlICYmIGdlbkZpbHRlckJ1dHRvbihpdGVtKSxcbiAgICAgIF0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuRmlsdGVySW5wdXQgPSAoY29sKSA9PiB7XG4gICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBtb2RlbFZhbHVlOiBfY2FjaGVbY29sLnRpdGxlXSxcbiAgICAgICAgbGFiZWw6ICdzZWFyY2gnLFxuICAgICAgICBkYXJrOiBwcm9wcy5vcHRpb25zLmRhcmssXG4gICAgICAgIGNvbG9yOiAhY29sLmNlbGxDbGFzcyA/IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlIDogJycsXG4gICAgICAgIHByZXBlbmRJY29uOiBpY29ucy4kc2VhcmNoLFxuICAgICAgICBjbGVhcmFibGU6IHRydWUsXG4gICAgICAgIG9uSW5wdXQ6ICgkdmFsdWUpID0+IG9uSW5wdXQoJHZhbHVlLCBjb2wpLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWVGV4dEZpZWxkLCBwcm9wc0RhdGEpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuRmlsdGVyV3JhcHBlciA9IChjb2wpID0+IHtcbiAgICAgIGNvbnN0IGNvbG9yID0gcHJvcHMub3B0aW9ucy5kYXJrXG4gICAgICAgID8gcHJvcHMub3B0aW9ucz8uY29sb3IgfHwgJ2dyZXkgZGFya2VuLTMnXG4gICAgICAgIDogcHJvcHMub3B0aW9ucz8uY29sb3IgfHwgJ3doaXRlJ1xuXG4gICAgICBjb25zdCBzbG90TmFtZSA9IGAkeyBjb2wua2V5IH0tZmlsdGVyYFxuXG4gICAgICBjb25zdCBmaWx0ZXJTbG90ID0gc2xvdHNbc2xvdE5hbWVdICYmIHNsb3RzW3Nsb3ROYW1lXSEoe1xuICAgICAgICBmaWx0ZXI6IChldmVudCkgPT4gb25JbnB1dChldmVudCwgY29sKSxcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IGRpcmVjdGl2ZSA9IGNvbC5zaG93RmlsdGVyXG4gICAgICAgID8ge1xuICAgICAgICAgIGhhbmRsZXI6ICgpID0+IHNldFRpbWVvdXQoKCkgPT4gKGNvbC5zaG93RmlsdGVyID0gZmFsc2UpKSxcbiAgICAgICAgICBjbG9zZUNvbmRpdGlvbmFsOiBmYWxzZSxcbiAgICAgICAgfVxuICAgICAgICA6IHVuZGVmaW5lZFxuXG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2ZpbHRlcic6ICFmaWx0ZXJTbG90LFxuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sX19jdXN0b20tZmlsdGVyJzogISFmaWx0ZXJTbG90LFxuICAgICAgICAgICdlbGV2YXRpb24tNSc6IHRydWUsXG4gICAgICAgICAgW2NvbC5jZWxsQ2xhc3NdOiAhIWNvbC5jZWxsQ2xhc3MsXG4gICAgICAgICAgLi4uKGNvbG9yID8gc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yKGNvbG9yKSA6IHt9KSxcbiAgICAgICAgfSxcbiAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAuLi4oY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IoY29sb3IpIDoge30pLFxuICAgICAgICB9LFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gKFxuICAgICAgICBjb2wuZmlsdGVyYWJsZSAmJlxuICAgICAgICB3aXRoRGlyZWN0aXZlcyhoKCdkaXYnLCBwcm9wc0RhdGEsIGZpbHRlclNsb3QgfHwgZ2VuRmlsdGVySW5wdXQoY29sKSksIFtcbiAgICAgICAgICBbdkNsaWNrT3V0c2lkZSwgZGlyZWN0aXZlXSxcbiAgICAgICAgICBbdlNob3csIGNvbC5zaG93RmlsdGVyXSxcbiAgICAgICAgXSlcbiAgICAgIClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJUaXRsZSA9IChjb2wpOiBWTm9kZSA9PiB7XG4gICAgICByZXR1cm4gaCgnZGl2JywgeyBjbGFzczogJ3YtZGF0YS10YWJsZS1jb2xfX3RpdGxlJyB9LCBjb2wudGl0bGUpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuTnVtYmVyQ2VsbCA9ICgpOiBWTm9kZSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGFsaWduOiAnY2VudGVyJyxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fbnVtYmVyJzogdHJ1ZSxcbiAgICAgICAgICBbcHJvcHMuY2VsbENsYXNzXTogISFwcm9wcy5jZWxsQ2xhc3MsXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnRlbnRDb2xvcjogY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUsXG4gICAgICAgIGNvbG9yOiBwcm9wcy5vcHRpb25zLmNvbG9yLFxuICAgICAgICB3aWR0aDogNTAsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVDZWxsLCBwcm9wc0RhdGEsIHsgZGVmYXVsdDogKCkgPT4gJ+KElicgfSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5DaGVja2JveENlbGwgPSAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGFsaWduOiAnY2VudGVyJyxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fY2hlY2tib3gnOiB0cnVlLFxuICAgICAgICAgIFtwcm9wcy5jZWxsQ2xhc3NdOiAhIXByb3BzLmNlbGxDbGFzcyxcbiAgICAgICAgfSxcbiAgICAgICAgZGFyazogcHJvcHMub3B0aW9ucy5kYXJrLFxuICAgICAgICBjb250ZW50Q29sb3I6IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlLFxuICAgICAgICBjb2xvcjogcHJvcHMub3B0aW9ucy5jb2xvcixcbiAgICAgICAgd2lkdGg6IDUwLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBjb250ZW50ID0ge1xuICAgICAgICBkZWZhdWx0OiAoKSA9PlxuICAgICAgICAgIGgoVkNoZWNrYm94LCB7XG4gICAgICAgICAgICBjb2xvcjogY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUsXG4gICAgICAgICAgICBvbkNoYW5nZTogKGUpID0+IGVtaXQoJ3NlbGVjdC1hbGwnLCBlKSxcbiAgICAgICAgICB9KSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkRhdGFUYWJsZUNlbGwsIHByb3BzRGF0YSwgY29udGVudClcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJDZWxsID0gKGNvbCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBkYXJrOiBwcm9wcy5vcHRpb25zLmRhcmssXG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2wnOiB0cnVlLFxuICAgICAgICAgICd2LWRhdGEtdGFibGUtY29sLS1zb3J0ZWQnOiBjb2wuc29ydGVkLFxuICAgICAgICAgIFtjb2wuY2VsbENsYXNzXTogISFjb2wuY2VsbENsYXNzLFxuICAgICAgICB9LFxuICAgICAgICBjb250ZW50Q29sb3I6ICFjb2wuY2VsbENsYXNzID8gY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUgOiAnJyxcbiAgICAgICAgY29sb3I6ICFjb2wuY2VsbENsYXNzID8gcHJvcHMub3B0aW9ucy5jb2xvciA6ICcnLFxuICAgICAgICB3aWR0aDogY29sLndpZHRoLFxuICAgICAgICByZXNpemVhYmxlOiBjb2wucmVzaXplYWJsZSxcbiAgICAgICAgcmVzaXplckNvbG9yOiBwcm9wcy5vcHRpb25zPy5yZXNpemVyQ29sb3IsXG4gICAgICAgIGFsaWduOiBjb2wuYWxpZ24gfHwgcHJvcHMuYWxpZ24sXG4gICAgICAgIG9uUmVzaXplOiAoJHNpemUpID0+IChjb2wud2lkdGggPSAkc2l6ZSksXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZEYXRhVGFibGVDZWxsLCBwcm9wc0RhdGEsIHtcbiAgICAgICAgZGVmYXVsdDogKCkgPT4gW1xuICAgICAgICAgIGdlbkhlYWRlclRpdGxlKGNvbCksXG4gICAgICAgICAgZ2VuSGVhZGVyQWN0aW9ucyhjb2wpLFxuICAgICAgICAgIHVzZVRyYW5zaXRpb24oZ2VuRmlsdGVyV3JhcHBlcihjb2wpLCB0cmFuc2l0aW9ucy5GQURFKSxcbiAgICAgICAgXSxcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuSGVhZGVyQ2hpbGRyZW4gPSAoKSA9PiB7XG4gICAgICBjb25zdCBjaGlsZHJlbjogVk5vZGVbXSA9IFtdXG4gICAgICBjb25zdCBoZWFkZXJTbG90ID0gc2xvdHMuaGVhZGVyICYmIHNsb3RzLmhlYWRlcihwcm9wcylcblxuICAgICAgcHJvcHMuc2hvd1NlcXVlbmNlICYmIGNoaWxkcmVuLnB1c2goZ2VuTnVtYmVyQ2VsbCgpKVxuICAgICAgcHJvcHMuc2hvd0NoZWNrYm94ICYmIGNoaWxkcmVuLnB1c2goZ2VuQ2hlY2tib3hDZWxsKCkpXG5cbiAgICAgIGNvbHMudmFsdWUhLmZvckVhY2goKGNvbDogRGF0YUNvbHVtbikgPT4ge1xuICAgICAgICBjb2wud2lkdGggPSBjb2wud2lkdGggfHwgcHJvcHMuY29sV2lkdGhcblxuICAgICAgICBpZiAoIWNvbC5oYXNPd25Qcm9wZXJ0eSgnc2hvdycpKSB7XG4gICAgICAgICAgY29sLnNob3cgPSAhY29sLnNob3dcbiAgICAgICAgfVxuXG4gICAgICAgICFoZWFkZXJTbG90IVswXS5jaGlsZHJlbiAmJlxuICAgICAgICBjb2wuc2hvdyAmJlxuICAgICAgICBjaGlsZHJlbi5wdXNoKGdlbkhlYWRlckNlbGwoY29sKSlcbiAgICAgIH0pXG5cbiAgICAgIGhlYWRlclNsb3QhWzBdLmNoaWxkcmVuICYmIGNoaWxkcmVuLnB1c2goaGVhZGVyU2xvdCBhcyBhbnkpXG5cbiAgICAgIHJldHVybiBjaGlsZHJlblxuICAgIH1cblxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsYXNzOiBjbGFzc2VzLnZhbHVlLFxuICAgICAgICBzdHlsZTogc3R5bGVzLnZhbHVlLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaCgnZGl2JywgcHJvcHNEYXRhLCBnZW5IZWFkZXJDaGlsZHJlbigpKVxuICAgIH1cbiAgfSxcbn0pXG4iXX0=