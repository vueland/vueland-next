import { defineComponent, h, watch, inject, computed, onBeforeMount, onBeforeUnmount, } from 'vue';
import { validationProps } from '../../composables/use-validation';
import { useColors, colorProps } from '../../composables/use-colors';
import { useInputStates } from '../../composables/use-input-states';
import { useTransition } from '../../composables/use-transition';
import { VLabel } from '../VLabel';
import { VIcon } from '../VIcon';
export default defineComponent({
    name: 'v-input',
    components: {
        VLabel,
        VIcon,
    },
    inheritAttrs: false,
    props: {
        label: {
            type: String,
            default: '',
        },
        prependIcon: {
            type: String,
            default: '',
        },
        appendIcon: {
            type: String,
            default: '',
        },
        disabled: Boolean,
        focused: Boolean,
        readonly: Boolean,
        file: Boolean,
        hints: {
            type: Boolean,
            default: true,
        },
        hintMessage: {
            type: String,
            default: '',
        },
        textColor: {
            type: String,
            default: '',
        },
        ...validationProps(),
        ...colorProps(),
    },
    setup(props, { attrs, emit, slots, expose }) {
        const { setTextCssColor, setTextClassNameColor } = useColors();
        const { inputState, errorState, isDisabled, isReadonly, stateClasses, validate, onFocus, onBlur } = useInputStates(props, { attrs, emit });
        const form = inject('form', null);
        const textClassColor = setTextClassNameColor(props.textColor);
        const textCssColor = setTextCssColor(props.textColor);
        const hasPrependIcon = computed(() => {
            return !!props.prependIcon || !!slots['prepend-icon'];
        });
        const hasAppendIcon = computed(() => {
            return !!props.appendIcon || !!slots['append-icon'];
        });
        const classes = computed(() => ({
            'v-input': true,
            'v-input--focused': inputState.focused && !isReadonly.value,
            'v-input--disabled': isDisabled.value,
            'v-input--readonly': isReadonly.value,
            'v-input--file': props.file,
            'v-input--has-prepend-icon': hasPrependIcon.value,
            'v-input--has-append-icon': hasAppendIcon.value,
            'v-input--not-valid': !!errorState.innerError,
            ...stateClasses.value,
            ...(!props.disabled && !errorState.innerError ? setTextClassNameColor(props.color) : {}),
            ...attrs.class,
        }));
        const styles = computed(() => ({
            ...(!props.disabled && !errorState.innerError ? setTextCssColor(props.color) : {}),
            ...attrs.style,
        }));
        watch(() => props.value, (to) => inputState.value = to);
        const genLabel = () => {
            const label = h(VLabel, {
                class: 'v-label--on-input',
                disabled: isDisabled.value,
                focused: inputState.focused,
                color: !errorState.innerError ? props.color : '',
            }, {
                default: () => props.label,
            });
            return h('div', { class: 'v-input__label' }, [label]);
        };
        const genIcon = (iconName, clickable = false) => {
            return h(VIcon, {
                icon: iconName,
                size: 16,
                disabled: props.disabled,
                clickable,
            });
        };
        const genPrependIcon = () => {
            let content;
            if (props.prependIcon) {
                content = genIcon(props.prependIcon);
            }
            else {
                content = slots['prepend-icon']?.();
            }
            return content ?
                h('div', { class: 'v-input__prepend-icon' }, content)
                : null;
        };
        const genAppendIcon = () => {
            let content;
            if (props.appendIcon) {
                content = genIcon(props.appendIcon);
            }
            else {
                content = slots['append-icon']?.();
            }
            return content ?
                h('div', { class: 'v-input__append-icon' }, content)
                : null;
        };
        const genTextFieldSlot = () => {
            const prependIconContent = genPrependIcon();
            const appendIconContent = genAppendIcon();
            const { disabled } = props;
            const textFieldContent = slots['text-field']?.({
                textCssColor,
                textClassColor,
                disabled,
            });
            return h('div', { class: 'v-input__text-field' }, [prependIconContent, textFieldContent, appendIconContent]);
        };
        const genHintMessage = () => {
            return !!errorState.innerErrorMessage ? h('span', { class: 'v-input__hints-message' }, [errorState.innerErrorMessage]) : null;
        };
        const genHints = () => {
            return h('div', { class: 'v-input__hints' }, useTransition(genHintMessage(), 'fade'));
        };
        const genSelectSlot = () => {
            return slots.select ?
                h('div', { class: 'v-input__selects' }, slots.select?.())
                : null;
        };
        onBeforeMount(() => {
            if (props.rules)
                form?.add(validate);
        });
        onBeforeUnmount(() => {
            form?.remove(validate);
        });
        expose({
            onFocus,
            onBlur,
        });
        return () => h('div', { class: classes.value, style: styles.value }, [
            genLabel(),
            genTextFieldSlot(),
            genHints(),
            genSelectSlot(),
        ]);
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVklucHV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2NvbXBvbmVudHMvVklucHV0L1ZJbnB1dC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsZUFBZSxFQUNmLENBQUMsRUFDRCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFFBQVEsRUFDUixhQUFhLEVBQ2IsZUFBZSxHQUVoQixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQTtBQUNsRSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxNQUFNLDhCQUE4QixDQUFBO0FBQ3BFLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQTtBQUNuRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0NBQWtDLENBQUE7QUFHaEUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLFdBQVcsQ0FBQTtBQUNsQyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBT2hDLGVBQWUsZUFBZSxDQUFDO0lBQzdCLElBQUksRUFBRSxTQUFTO0lBQ2YsVUFBVSxFQUFFO1FBQ1YsTUFBTTtRQUNOLEtBQUs7S0FDTjtJQUNELFlBQVksRUFBRSxLQUFLO0lBQ25CLEtBQUssRUFBRTtRQUNMLEtBQUssRUFBRTtZQUNMLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELFdBQVcsRUFBRTtZQUNYLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELFVBQVUsRUFBRTtZQUNWLElBQUksRUFBRSxNQUFNO1lBQ1osT0FBTyxFQUFFLEVBQUU7U0FDWjtRQUNELFFBQVEsRUFBRSxPQUFPO1FBQ2pCLE9BQU8sRUFBRSxPQUFPO1FBQ2hCLFFBQVEsRUFBRSxPQUFPO1FBQ2pCLElBQUksRUFBRSxPQUFPO1FBQ2IsS0FBSyxFQUFFO1lBQ0wsSUFBSSxF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Q0FDRixDQUFBO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7XG4gIGRlZmluZUNvbXBvbmVudCxcbiAgaCxcbiAgd2F0Y2gsXG4gIGluamVjdCxcbiAgY29tcHV0ZWQsXG4gIG9uQmVmb3JlTW91bnQsXG4gIG9uQmVmb3JlVW5tb3VudCxcbiAgVk5vZGUsXG59IGZyb20gJ3Z1ZSdcblxuLy8gQ29tcG9zYWJsZVxuaW1wb3J0IHsgdmFsaWRhdGlvblByb3BzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZXMvdXNlLXZhbGlkYXRpb24nXG5pbXBvcnQgeyB1c2VDb2xvcnMsIGNvbG9yUHJvcHMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtY29sb3JzJ1xuaW1wb3J0IHsgdXNlSW5wdXRTdGF0ZXMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlcy91c2UtaW5wdXQtc3RhdGVzJ1xuaW1wb3J0IHsgdXNlVHJhbnNpdGlvbiB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGVzL3VzZS10cmFuc2l0aW9uJ1xuXG4vLyBDb21wb25lbnRzXG5pbXBvcnQgeyBWTGFiZWwgfSBmcm9tICcuLi9WTGFiZWwnXG5pbXBvcnQgeyBWSWNvbiB9IGZyb20gJy4uL1ZJY29uJ1xuXG50eXBlIEZvcm0gPSB7XG4gIGFkZDogKGl0ZW06ICh2YWw/OiBhbnkpID0+IGJvb2xlYW4gfCB2b2lkKSA9PiB2b2lkXG4gIHJlbW92ZTogKGl0ZW06ICh2YWw/OiBhbnkpID0+IGJvb2xlYW4gfCB2b2lkKSA9PiB2b2lkXG59XG5cbmV4cG9ydCBkZWZhdWx0IGRlZmluZUNvbXBvbmVudCh7XG4gIG5hbWU6ICd2LWlucHV0JyxcbiAgY29tcG9uZW50czoge1xuICAgIFZMYWJlbCxcbiAgICBWSWNvbixcbiAgfSxcbiAgaW5oZXJpdEF0dHJzOiBmYWxzZSxcbiAgcHJvcHM6IHtcbiAgICBsYWJlbDoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICBwcmVwZW5kSWNvbjoge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICBhcHBlbmRJY29uOiB7XG4gICAgICB0eXBlOiBTdHJpbmcsXG4gICAgICBkZWZhdWx0OiAnJyxcbiAgICB9LFxuICAgIGRpc2FibGVkOiBCb29sZWFuLFxuICAgIGZvY3VzZWQ6IEJvb2xlYW4sXG4gICAgcmVhZG9ubHk6IEJvb2xlYW4sXG4gICAgZmlsZTogQm9vbGVhbixcbiAgICBoaW50czoge1xuICAgICAgdHlwZTogQm9vbGVhbixcbiAgICAgIGRlZmF1bHQ6IHRydWUsXG4gICAgfSxcbiAgICBoaW50TWVzc2FnZToge1xuICAgICAgdHlwZTogU3RyaW5nLFxuICAgICAgZGVmYXVsdDogJycsXG4gICAgfSxcbiAgICB0ZXh0Q29sb3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICcnLFxuICAgIH0sXG4gICAgLi4udmFsaWRhdGlvblByb3BzKCksXG4gICAgLi4uY29sb3JQcm9wcygpLFxuICB9LFxuXG4gIHNldHVwKHByb3BzLCB7IGF0dHJzLCBlbWl0LCBzbG90cywgZXhwb3NlIH0pIHtcbiAgICBjb25zdCB7IHNldFRleHRDc3NDb2xvciwgc2V0VGV4dENsYXNzTmFtZUNvbG9yIH0gPSB1c2VDb2xvcnMoKVxuICAgIGNvbnN0IHtcbiAgICAgIGlucHV0U3RhdGUsXG4gICAgICBlcnJvclN0YXRlLFxuICAgICAgaXNEaXNhYmxlZCxcbiAgICAgIGlzUmVhZG9ubHksXG4gICAgICBzdGF0ZUNsYXNzZXMsXG4gICAgICB2YWxpZGF0ZSxcbiAgICAgIG9uRm9jdXMsXG4gICAgICBvbkJsdXJcbiAgICB9ID0gdXNlSW5wdXRTdGF0ZXMocHJvcHMsIHsgYXR0cnMsIGVtaXQgfSlcblxuICAgIGNvbnN0IGZvcm06IE1heWJlPEZvcm0+ID0gaW5qZWN0KCdmb3JtJywgbnVsbCBhcyBhbnkpXG5cbiAgICBjb25zdCB0ZXh0Q2xhc3NDb2xvciA9IHNldFRleHRDbGFzc05hbWVDb2xvcihwcm9wcy50ZXh0Q29sb3IpXG4gICAgY29uc3QgdGV4dENzc0NvbG9yID0gc2V0VGV4dENzc0NvbG9yKHByb3BzLnRleHRDb2xvcilcblxuICAgIGNvbnN0IGhhc1ByZXBlbmRJY29uID0gY29tcHV0ZWQ8Ym9vbGVhbj4oKCkgPT4ge1xuICAgICAgcmV0dXJuICEhcHJvcHMucHJlcGVuZEljb24gfHwgISFzbG90c1sncHJlcGVuZC1pY29uJ11cbiAgICB9KVxuXG4gICAgY29uc3QgaGFzQXBwZW5kSWNvbiA9IGNvbXB1dGVkPGJvb2xlYW4+KCgpID0+IHtcbiAgICAgIHJldHVybiAhIXByb3BzLmFwcGVuZEljb24gfHwgISFzbG90c1snYXBwZW5kLWljb24nXVxuICAgIH0pXG5cbiAgICBjb25zdCBjbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+ICh7XG4gICAgICAndi1pbnB1dCc6IHRydWUsXG4gICAgICAndi1pbnB1dC0tZm9jdXNlZCc6IGlucHV0U3RhdGUuZm9jdXNlZCAmJiAhaXNSZWFkb25seS52YWx1ZSxcbiAgICAgICd2LWlucHV0LS1kaXNhYmxlZCc6IGlzRGlzYWJsZWQudmFsdWUsXG4gICAgICAndi1pbnB1dC0tcmVhZG9ubHknOiBpc1JlYWRvbmx5LnZhbHVlLFxuICAgICAgJ3YtaW5wdXQtLWZpbGUnOiBwcm9wcy5maWxlLFxuICAgICAgJ3YtaW5wdXQtLWhhcy1wcmVwZW5kLWljb24nOiBoYXNQcmVwZW5kSWNvbi52YWx1ZSxcbiAgICAgICd2LWlucHV0LS1oYXMtYXBwZW5kLWljb24nOiBoYXNBcHBlbmRJY29uLnZhbHVlLFxuICAgICAgJ3YtaW5wdXQtLW5vdC12YWxpZCc6ICEhZXJyb3JTdGF0ZS5pbm5lckVycm9yLFxuICAgICAgLi4uc3RhdGVDbGFzc2VzLnZhbHVlLFxuICAgICAgLi4uKCFwcm9wcy5kaXNhYmxlZCAmJiAhZXJyb3JTdGF0ZS5pbm5lckVycm9yID8gc2V0VGV4dENsYXNzTmFtZUNvbG9yKHByb3BzLmNvbG9yKSA6IHt9KSxcbiAgICAgIC4uLihhdHRycy5jbGFzcyBhcyBvYmplY3QpLFxuICAgIH0pKVxuXG4gICAgY29uc3Qgc3R5bGVzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgc3RyaW5nPj4oKCkgPT4gKHtcbiAgICAgIC4uLighcHJvcHMuZGlzYWJsZWQgJiYgIWVycm9yU3RhdGUuaW5uZXJFcnJvciA/IHNldFRleHRDc3NDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgICAuLi4oYXR0cnMuc3R5bGUgYXMgb2JqZWN0KSxcbiAgICB9KSlcblxuICAgIHdhdGNoKFxuICAgICAgKCkgPT4gcHJvcHMudmFsdWUsXG4gICAgICAodG8pID0+IGlucHV0U3RhdGUudmFsdWUgPSB0byBhcyBzdHJpbmcsXG4gICAgKVxuXG4gICAgY29uc3QgZ2VuTGFiZWwgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgbGFiZWwgPSBoKFZMYWJlbCwge1xuICAgICAgICAgIGNsYXNzOiAndi1sYWJlbC0tb24taW5wdXQnLFxuICAgICAgICAgIGRpc2FibGVkOiBpc0Rpc2FibGVkLnZhbHVlLFxuICAgICAgICAgIGZvY3VzZWQ6IGlucHV0U3RhdGUuZm9jdXNlZCxcbiAgICAgICAgICBjb2xvcjogIWVycm9yU3RhdGUuaW5uZXJFcnJvciA/IHByb3BzLmNvbG9yIDogJycsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBkZWZhdWx0OiAoKSA9PiBwcm9wcy5sYWJlbCxcbiAgICAgICAgfSxcbiAgICAgIClcblxuICAgICAgcmV0dXJuIGgoJ2RpdicsIHsgY2xhc3M6ICd2LWlucHV0X19sYWJlbCcgfSwgW2xhYmVsXSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5JY29uID0gKGljb25OYW1lLCBjbGlja2FibGUgPSBmYWxzZSk6IFZOb2RlID0+IHtcbiAgICAgIHJldHVybiBoKFZJY29uLCB7XG4gICAgICAgIGljb246IGljb25OYW1lLFxuICAgICAgICBzaXplOiAxNixcbiAgICAgICAgZGlzYWJsZWQ6IHByb3BzLmRpc2FibGVkLFxuICAgICAgICBjbGlja2FibGUsXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGdlblByZXBlbmRJY29uID0gKCk6IE1heWJlPFZOb2RlPiA9PiB7XG4gICAgICBsZXQgY29udGVudFxuXG4gICAgICBpZiAocHJvcHMucHJlcGVuZEljb24pIHtcbiAgICAgICAgY29udGVudCA9IGdlbkljb24ocHJvcHMucHJlcGVuZEljb24pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb250ZW50ID0gc2xvdHNbJ3ByZXBlbmQtaWNvbiddPy4oKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gY29udGVudCA/XG4gICAgICAgIGgoJ2RpdicsIHsgY2xhc3M6ICd2LWlucHV0X19wcmVwZW5kLWljb24nIH0sIGNvbnRlbnQpXG4gICAgICAgIDogbnVsbFxuICAgIH1cblxuICAgIGNvbnN0IGdlbkFwcGVuZEljb24gPSAoKTogTWF5YmU8Vk5vZGU+ID0+IHtcbiAgICAgIGxldCBjb250ZW50XG5cbiAgICAgIGlmIChwcm9wcy5hcHBlbmRJY29uKSB7XG4gICAgICAgIGNvbnRlbnQgPSBnZW5JY29uKHByb3BzLmFwcGVuZEljb24pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb250ZW50ID0gc2xvdHNbJ2FwcGVuZC1pY29uJ10/LigpXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjb250ZW50ID9cbiAgICAgICAgaCgnZGl2JywgeyBjbGFzczogJ3YtaW5wdXRfX2FwcGVuZC1pY29uJyB9LCBjb250ZW50KVxuICAgICAgICA6IG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBnZW5UZXh0RmllbGRTbG90ID0gKCkgPT4ge1xuICAgICAgY29uc3QgcHJlcGVuZEljb25Db250ZW50ID0gZ2VuUHJlcGVuZEljb24oKVxuICAgICAgY29uc3QgYXBwZW5kSWNvbkNvbnRlbnQgPSBnZW5BcHBlbmRJY29uKClcbiAgICAgIGNvbnN0IHsgZGlzYWJsZWQgfSA9IHByb3BzXG5cbiAgICAgIGNvbnN0IHRleHRGaWVsZENvbnRlbnQgPSBzbG90c1sndGV4dC1maWVsZCddPy4oe1xuICAgICAgICB0ZXh0Q3NzQ29sb3IsXG4gICAgICAgIHRleHRDbGFzc0NvbG9yLFxuICAgICAgICBkaXNhYmxlZCxcbiAgICAgIH0pXG5cbiAgICAgIHJldHVybiBoKCdkaXYnLCB7IGNsYXNzOiAndi1pbnB1dF9fdGV4dC1maWVsZCcgfSxcbiAgICAgICAgW3ByZXBlbmRJY29uQ29udGVudCwgdGV4dEZpZWxkQ29udGVudCwgYXBwZW5kSWNvbkNvbnRlbnRdLFxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkhpbnRNZXNzYWdlID0gKCk6IE1heWJlPFZOb2RlPiA9PiB7XG4gICAgICByZXR1cm4gISFlcnJvclN0YXRlLmlubmVyRXJyb3JNZXNzYWdlID8gaChcbiAgICAgICAgJ3NwYW4nLFxuICAgICAgICB7IGNsYXNzOiAndi1pbnB1dF9faGludHMtbWVzc2FnZScgfSxcbiAgICAgICAgW2Vycm9yU3RhdGUuaW5uZXJFcnJvck1lc3NhZ2VdLFxuICAgICAgKSA6IG51bGxcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IaW50cyA9ICgpOiBNYXliZTxWTm9kZT4gPT4ge1xuICAgICAgcmV0dXJuIGgoXG4gICAgICAgICdkaXYnLFxuICAgICAgICB7IGNsYXNzOiAndi1pbnB1dF9faGludHMnIH0sXG4gICAgICAgIHVzZVRyYW5zaXRpb24oZ2VuSGludE1lc3NhZ2UoKSEsICdmYWRlJyksXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuU2VsZWN0U2xvdCA9ICgpOiBNYXliZTxWTm9kZT4gPT4ge1xuICAgICAgcmV0dXJuIHNsb3RzLnNlbGVjdCA/XG4gICAgICAgIGgoJ2RpdicsIHsgY2xhc3M6ICd2LWlucHV0X19zZWxlY3RzJyB9LCBzbG90cy5zZWxlY3Q/LigpKVxuICAgICAgICA6IG51bGxcbiAgICB9XG5cbiAgICBvbkJlZm9yZU1vdW50KCgpID0+IHtcbiAgICAgIGlmIChwcm9wcy5ydWxlcykgZm9ybT8uYWRkKHZhbGlkYXRlKVxuICAgIH0pXG5cbiAgICBvbkJlZm9yZVVubW91bnQoKCkgPT4ge1xuICAgICAgZm9ybT8ucmVtb3ZlKHZhbGlkYXRlKVxuICAgIH0pXG5cbiAgICBleHBvc2Uoe1xuICAgICAgb25Gb2N1cyxcbiAgICAgIG9uQmx1cixcbiAgICB9KVxuXG4gICAgcmV0dXJuICgpID0+IGgoJ2RpdicsIHsgY2xhc3M6IGNsYXNzZXMudmFsdWUsIHN0eWxlOiBzdHlsZXMudmFsdWUgfSxcbiAgICAgIFtcbiAgICAgICAgZ2VuTGFiZWwoKSxcbiAgICAgICAgZ2VuVGV4dEZpZWxkU2xvdCgpLFxuICAgICAgICBnZW5IaW50cygpLFxuICAgICAgICBnZW5TZWxlY3RTbG90KCksXG4gICAgICBdLFxuICAgIClcbiAgfSxcbn0pXG4iXX0=