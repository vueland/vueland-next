import { h, ref, computed, reactive, defineComponent, onMounted, onBeforeUnmount, } from 'vue';
import { positionProps } from '../../composable/use-position';
import { useColors } from '../../composable/use-colors';
export default defineComponent({
    name: 'v-resize',
    props: {
        emit: {
            type: Boolean,
            default: false,
        },
        customClass: {
            type: String,
        },
        minSize: {
            type: [String, Number],
            default: 50,
        },
        color: {
            type: String,
            default: 'primary',
        },
        ...positionProps(),
    },
    emits: ['resize'],
    setup(props, { emit }) {
        const data = reactive({
            parentNode: null,
            startOffset: null,
            offsetTop: 0,
            offsetLeft: 0,
            parentHeight: 0,
            parentWidth: 0,
            marginLeft: 0,
            marginTop: 0,
            left: 0,
            top: 0,
            isActive: false,
        });
        const resizeRef = ref(null);
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const classes = computed(() => {
            return {
                'v-resize': true,
                'v-resize--active': data.isActive,
                'v-resize--top': props.top,
                'v-resize--bottom': props.bottom,
                'v-resize--right': props.right,
                'v-resize--left': props.left,
                [props.customClass]: !!props.customClass,
                ...(props.color ? setBackgroundClassNameColor(props.color) : {}),
            };
        });
        const styles = computed(() => ({
            ...(props.color ? setBackgroundCssColor(props.color) : {}),
        }));
        const isDirectY = computed(() => {
            return props.top || props.bottom;
        });
        const isNeedReverse = computed(() => {
            return props.top || props.left;
        });
        const currentSize = computed(() => {
            return isDirectY.value ? data.parentHeight : data.parentWidth;
        });
        const sizeProp = computed(() => {
            return isDirectY.value ? 'height' : 'width';
        });
        const reverseDirection = computed(() => {
            return props.top ? 'top' : 'left';
        });
        const reverseOffsetKey = computed(() => {
            const side = reverseDirection.value;
            return 'offset' + side[0].toUpperCase() + side.slice(1);
        });
        const offset = computed(() => {
            return isDirectY.value ? data.offsetTop : data.offsetLeft;
        });
        const direction = computed(() => {
            return isDirectY.value ? 'clientY' : 'clientX';
        });
        function moveReverse(size) {
            const { parentNode, left, top } = data;
            const reverseTo = reverseDirection.value;
            const value = !isDirectY.value
                ? currentSize.value - size + left
                : currentSize.value - size + top;
            parentNode.style[reverseTo] = `${value}px`;
        }
        function setOrEmitSize(size) {
            if (props.emit)
                return emit('resize', size);
            data.parentNode.style[sizeProp.value] = `${size}px`;
            isNeedReverse.value && moveReverse(size);
        }
        function resize(e) {
            let size;
            if (isNeedReverse.value) {
                size =
                    currentSize.value -
                        (e[direction.value] - offset.value) +
                        data.startOffset;
            }
            else {
                size =
                    currentSize.value +
                        (e[direction.value] -
                            currentSize.value -
                            offset.value -
                            data.startOffset);
            }
            size > props.minSize && setOrEmitSize(size);
        }
        function resetMinMaxStyles() {
            if (isDirectY.value) {
                data.parentNode.style.maxHeight = '';
                data.parentNode.style.minHeight = '';
            }
            else {
                data.parentNode.style.maxWidth = '';
                data.parentNode.style.minWidth = '';
            }
        }
        function setParent() {
            const parent = resizeRef.value.parentNode;
            data.parentNode = parent;
        }
        function computeSizes() {
            const { top, left, height, width, marginLeft, marginTop } = getComputedStyle(data.parentNode);
            data.offsetTop = data.parentNode.offsetTop;
            data.offsetLeft = data.parentNode.offsetLeft;
            data.marginLeft = parseFloat(marginLeft);
            data.marginTop = parseFloat(marginTop);
            data.parentHeight = parseFloat(height);
            data.parentWidth = parseFloat(width);
            data.top = parseFloat(top);
            data.left = parseFloat(left);
        }
        function setStartPositions() {
            const side = reverseDirection.value;
            const offset = reverseOffsetKey.value;
            if (data[side] === data[offset]) {
                data.parentNode.style[side] = `${data[offset]}px`;
            }
        }
        function disableSelection(e) {
            e.preventDefault();
        }
        function initResize(e) {
            if (!data.isActive) {
                data.isActive = true;
                computeSizes();
                resetMinMaxStyles();
                setStartPositions();
                setStartOffset(e);
            }
            requestAnimationFrame(() => resize(e));
        }
        function setStartOffset(e) {
            if (isNeedReverse.value)
                data.startOffset = e[direction.value];
            else
                data.startOffset = e[direction.value] - currentSize.value;
            data.startOffset -= offset.value;
        }
        function reset() {
            data.isActive = false;
            resetMinMaxStyles();
        }
        function onMouseup() {
            reset();
            removeHandlers();
        }
        function onMousedown() {
            document.addEventListener('mousemove', initResize);
            document.addEventListener('mouseup', onMouseup);
            document.addEventListener('selectstart', disableSelection);
        }
        function removeHandlers() {
            document.removeEventListener('mousemove', initResize);
            document.removeEventListener('mouseup', onMouseup);
            document.removeEventListener('selectstart', disableSelection);
        }
        onMounted(() => {
            setParent();
        });
        onBeforeUnmount(() => {
            document.removeEventListener('mousedown', onMousedown);
        });
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
                key: 'resize',
                ref: resizeRef,
                onMousedown,
            };
            return h('div', propsData);
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVlJlc2l6ZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZSZXNpemUvVlJlc2l6ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQ0wsQ0FBQyxFQUNELEdBQUcsRUFDSCxRQUFRLEVBQ1IsUUFBUSxFQUNSLGVBQWUsRUFDZixTQUFTLEVBQ1QsZUFBZSxHQUNoQixNQUFNLEtBQUssQ0FBQTtBQUdaLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQTtBQUM3RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sNkJBQTZCLENBQUE7QUFtQnZELGVBQWUsZUFBZSxDQUFDO0lBQzdCLElBQUksRUFBRSxVQUFVO0lBRWhCLEtBQUssRUFBRTtRQUNMLElBQUksRUFBRTtZQUNKLElBQUksRUFBRSxPQUFPO1lBQ2IsT0FBTyxFQUFFLEtBQUs7U0FDZjtRQUVELFdBQVcsRUFBRTtZQUNYLElBQUksRUFBRSxNQUFNO1NBQ2I7UUFFRCxPQUFPLEVBQUU7WUFDUCxJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxFQUFFO1NBQ1o7UUFDRCxLQUFLLEVBQUU7WUFDTCxJQUFJLEVBQUUsTUFBTTtZQUNaLE9BQU8sRUFBRSxTQUFTO1NBQ25CO1FBQ0QsR0FBRyxhQUFhLEVBQUU7S0FDWjtJQUVSLEtBQUssRUFBRSxDQUFDLFFBQVEsQ0FBQztJQUVqQixLQUFLLENBQUMsS0FBSyxFQUFFLEVBQUUsSUFBSSxFQUFFO1FBQ25CLE1BQU0sSUFBSSxHQUFlLFFBQVEsQ0FBQztZQUNoQyxVQUFVLEVBQUUsSUFBSTtZQUNoQixXQUFXLEVBQUUsSUFBSTtZQUNqQixTQUFTLEVBQUUsQ0FBQztZQUNaLFVBQVUsRUFBRSxDQUFDO1lBQ2IsWUFBWSxFQUFFLENBQUM7WUFDZixXQUFXLEVBQUUsQ0FBQztZQUNkLFVBQVUsRUFBRSxDQUFDO1lBQ2IsU0FBUyxF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QUVGLGVBQWUsQ0FBQyxHQUFHLEVBQUU7WUFDbkIsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxXQUFXLENBQUMsQ0FBQTtRQUN4RCxDQUFDLENBQUMsQ0FBQTtRQUVGLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxTQUFTLEdBQUc7Z0JBQ2hCLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSztnQkFDcEIsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO2dCQUNuQixHQUFHLEVBQUUsUUFBUTtnQkFDYixHQUFHLEVBQUUsU0FBUztnQkFDZCxXQUFXO2FBQ1osQ0FBQTtZQUNELE9BQU8sQ0FBQyxDQUFDLEtBQUssRUFBRSxTQUFTLENBQUMsQ0FBQTtRQUM1QixDQUFDLENBQUE7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVnVlIEFQSVxuaW1wb3J0IHtcbiAgaCxcbiAgcmVmLFxuICBjb21wdXRlZCxcbiAgcmVhY3RpdmUsXG4gIGRlZmluZUNvbXBvbmVudCxcbiAgb25Nb3VudGVkLFxuICBvbkJlZm9yZVVubW91bnQsXG59IGZyb20gJ3Z1ZSdcblxuLy8gRWZmZWN0c1xuaW1wb3J0IHsgcG9zaXRpb25Qcm9wcyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLXBvc2l0aW9uJ1xuaW1wb3J0IHsgdXNlQ29sb3JzIH0gZnJvbSAnLi4vLi4vY29tcG9zYWJsZS91c2UtY29sb3JzJ1xuXG4vLyBUeXBlc1xuaW1wb3J0IHsgVk5vZGUgfSBmcm9tICd2dWUnXG5cbnR5cGUgUmVzaXplRGF0YSA9IHtcbiAgcGFyZW50Tm9kZTogSFRNTEVsZW1lbnQgfCBudWxsXG4gIHN0YXJ0T2Zmc2V0OiBudW1iZXIgfCBudWxsXG4gIG9mZnNldFRvcDogbnVtYmVyXG4gIG9mZnNldExlZnQ6IG51bWJlclxuICBwYXJlbnRIZWlnaHQ6IG51bWJlclxuICBwYXJlbnRXaWR0aDogbnVtYmVyXG4gIG1hcmdpbkxlZnQ6IG51bWJlclxuICBtYXJnaW5Ub3A6IG51bWJlclxuICBsZWZ0OiBudW1iZXJcbiAgdG9wOiBudW1iZXJcbiAgaXNBY3RpdmU6IGJvb2xlYW5cbn1cblxuZXhwb3J0IGRlZmF1bHQgZGVmaW5lQ29tcG9uZW50KHtcbiAgbmFtZTogJ3YtcmVzaXplJyxcblxuICBwcm9wczoge1xuICAgIGVtaXQ6IHtcbiAgICAgIHR5cGU6IEJvb2xlYW4sXG4gICAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB9LFxuXG4gICAgY3VzdG9tQ2xhc3M6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICB9LFxuXG4gICAgbWluU2l6ZToge1xuICAgICAgdHlwZTogW1N0cmluZywgTnVtYmVyXSxcbiAgICAgIGRlZmF1bHQ6IDUwLFxuICAgIH0sXG4gICAgY29sb3I6IHtcbiAgICAgIHR5cGU6IFN0cmluZyxcbiAgICAgIGRlZmF1bHQ6ICdwcmltYXJ5JyxcbiAgICB9LFxuICAgIC4uLnBvc2l0aW9uUHJvcHMoKSxcbiAgfSBhcyBhbnksXG5cbiAgZW1pdHM6IFsncmVzaXplJ10sXG5cbiAgc2V0dXAocHJvcHMsIHsgZW1pdCB9KTogKCkgPT4gVk5vZGUge1xuICAgIGNvbnN0IGRhdGE6IFJlc2l6ZURhdGEgPSByZWFjdGl2ZSh7XG4gICAgICBwYXJlbnROb2RlOiBudWxsLFxuICAgICAgc3RhcnRPZmZzZXQ6IG51bGwsXG4gICAgICBvZmZzZXRUb3A6IDAsXG4gICAgICBvZmZzZXRMZWZ0OiAwLFxuICAgICAgcGFyZW50SGVpZ2h0OiAwLFxuICAgICAgcGFyZW50V2lkdGg6IDAsXG4gICAgICBtYXJnaW5MZWZ0OiAwLFxuICAgICAgbWFyZ2luVG9wOiAwLFxuICAgICAgbGVmdDogMCxcbiAgICAgIHRvcDogMCxcbiAgICAgIGlzQWN0aXZlOiBmYWxzZSxcbiAgICB9KVxuXG4gICAgY29uc3QgcmVzaXplUmVmID0gcmVmPEhUTUxFbGVtZW50IHwgbnVsbD4obnVsbClcblxuICAgIGNvbnN0IHsgc2V0QmFja2dyb3VuZENsYXNzTmFtZUNvbG9yLCBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IgfSA9IHVzZUNvbG9ycygpXG5cbiAgICBjb25zdCBjbGFzc2VzID0gY29tcHV0ZWQ8UmVjb3JkPHN0cmluZywgYm9vbGVhbj4+KCgpID0+IHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgICd2LXJlc2l6ZSc6IHRydWUsXG4gICAgICAgICd2LXJlc2l6ZS0tYWN0aXZlJzogZGF0YS5pc0FjdGl2ZSxcbiAgICAgICAgJ3YtcmVzaXplLS10b3AnOiBwcm9wcy50b3AsXG4gICAgICAgICd2LXJlc2l6ZS0tYm90dG9tJzogcHJvcHMuYm90dG9tLFxuICAgICAgICAndi1yZXNpemUtLXJpZ2h0JzogcHJvcHMucmlnaHQsXG4gICAgICAgICd2LXJlc2l6ZS0tbGVmdCc6IHByb3BzLmxlZnQsXG4gICAgICAgIFtwcm9wcy5jdXN0b21DbGFzc106ICEhcHJvcHMuY3VzdG9tQ2xhc3MsXG4gICAgICAgIC4uLihwcm9wcy5jb2xvciA/IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvcihwcm9wcy5jb2xvcikgOiB7fSksXG4gICAgICB9XG4gICAgfSlcblxuICAgIGNvbnN0IHN0eWxlcyA9IGNvbXB1dGVkKCgpID0+ICh7XG4gICAgICAuLi4ocHJvcHMuY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ3NzQ29sb3IocHJvcHMuY29sb3IpIDoge30pLFxuICAgIH0pKVxuXG4gICAgY29uc3QgaXNEaXJlY3RZID0gY29tcHV0ZWQ8Ym9vbGVhbj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHByb3BzLnRvcCB8fCBwcm9wcy5ib3R0b21cbiAgICB9KVxuXG4gICAgY29uc3QgaXNOZWVkUmV2ZXJzZSA9IGNvbXB1dGVkPGJvb2xlYW4+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy50b3AgfHwgcHJvcHMubGVmdFxuICAgIH0pXG5cbiAgICBjb25zdCBjdXJyZW50U2l6ZSA9IGNvbXB1dGVkPG51bWJlcj4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGlzRGlyZWN0WS52YWx1ZSA/IGRhdGEucGFyZW50SGVpZ2h0ISA6IGRhdGEucGFyZW50V2lkdGghXG4gICAgfSlcblxuICAgIGNvbnN0IHNpemVQcm9wID0gY29tcHV0ZWQ8c3RyaW5nPigoKSA9PiB7XG4gICAgICByZXR1cm4gaXNEaXJlY3RZLnZhbHVlID8gJ2hlaWdodCcgOiAnd2lkdGgnXG4gICAgfSlcblxuICAgIGNvbnN0IHJldmVyc2VEaXJlY3Rpb24gPSBjb21wdXRlZDxzdHJpbmc+KCgpID0+IHtcbiAgICAgIHJldHVybiBwcm9wcy50b3AgPyAndG9wJyA6ICdsZWZ0J1xuICAgIH0pXG5cbiAgICBjb25zdCByZXZlcnNlT2Zmc2V0S2V5ID0gY29tcHV0ZWQ8c3RyaW5nPigoKSA9PiB7XG4gICAgICBjb25zdCBzaWRlID0gcmV2ZXJzZURpcmVjdGlvbi52YWx1ZVxuICAgICAgcmV0dXJuICdvZmZzZXQnICsgc2lkZVswXS50b1VwcGVyQ2FzZSgpICsgc2lkZS5zbGljZSgxKVxuICAgIH0pXG5cbiAgICBjb25zdCBvZmZzZXQgPSBjb21wdXRlZDxudW1iZXI+KCgpID0+IHtcbiAgICAgIHJldHVybiBpc0RpcmVjdFkudmFsdWUgPyBkYXRhLm9mZnNldFRvcCEgOiBkYXRhLm9mZnNldExlZnQhXG4gICAgfSlcblxuICAgIGNvbnN0IGRpcmVjdGlvbiA9IGNvbXB1dGVkPHN0cmluZz4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGlzRGlyZWN0WS52YWx1ZSA/ICdjbGllbnRZJyA6ICdjbGllbnRYJ1xuICAgIH0pXG5cbiAgICBmdW5jdGlvbiBtb3ZlUmV2ZXJzZShzaXplKSB7XG4gICAgICBjb25zdCB7IHBhcmVudE5vZGUsIGxlZnQsIHRvcCB9ID0gZGF0YVxuICAgICAgY29uc3QgcmV2ZXJzZVRvID0gcmV2ZXJzZURpcmVjdGlvbi52YWx1ZVxuXG4gICAgICBjb25zdCB2YWx1ZSA9ICFpc0RpcmVjdFkudmFsdWVcbiAgICAgICAgPyBjdXJyZW50U2l6ZS52YWx1ZSAtIHNpemUgKyBsZWZ0XG4gICAgICAgIDogY3VycmVudFNpemUudmFsdWUgLSBzaXplICsgdG9wXG5cbiAgICAgIHBhcmVudE5vZGUhLnN0eWxlW3JldmVyc2VUb10gPSBgJHt2YWx1ZX1weGBcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRPckVtaXRTaXplKHNpemUpIHtcbiAgICAgIGlmIChwcm9wcy5lbWl0KSByZXR1cm4gZW1pdCgncmVzaXplJywgc2l6ZSlcblxuICAgICAgZGF0YS5wYXJlbnROb2RlIS5zdHlsZVtzaXplUHJvcC52YWx1ZV0gPSBgJHtzaXplfXB4YFxuXG4gICAgICBpc05lZWRSZXZlcnNlLnZhbHVlICYmIG1vdmVSZXZlcnNlKHNpemUpXG4gICAgfVxuXG4gICAgZnVuY3Rpb24gcmVzaXplKGUpIHtcbiAgICAgIGxldCBzaXplXG5cbiAgICAgIGlmIChpc05lZWRSZXZlcnNlLnZhbHVlKSB7XG4gICAgICAgIHNpemUgPVxuICAgICAgICAgIGN1cnJlbnRTaXplLnZhbHVlIC1cbiAgICAgICAgICAoZVtkaXJlY3Rpb24udmFsdWVdIC0gb2Zmc2V0LnZhbHVlKSArXG4gICAgICAgICAgZGF0YS5zdGFydE9mZnNldCFcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHNpemUgPVxuICAgICAgICAgIGN1cnJlbnRTaXplLnZhbHVlICtcbiAgICAgICAgICAoZVtkaXJlY3Rpb24udmFsdWVdIC1cbiAgICAgICAgICAgIGN1cnJlbnRTaXplLnZhbHVlIC1cbiAgICAgICAgICAgIG9mZnNldC52YWx1ZSAtXG4gICAgICAgICAgICBkYXRhLnN0YXJ0T2Zmc2V0ISlcbiAgICAgIH1cblxuICAgICAgc2l6ZSA+IHByb3BzLm1pblNpemUgJiYgc2V0T3JFbWl0U2l6ZShzaXplKVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHJlc2V0TWluTWF4U3R5bGVzKCkge1xuICAgICAgaWYgKGlzRGlyZWN0WS52YWx1ZSkge1xuICAgICAgICBkYXRhLnBhcmVudE5vZGUhLnN0eWxlLm1heEhlaWdodCA9ICcnXG4gICAgICAgIGRhdGEucGFyZW50Tm9kZSEuc3R5bGUubWluSGVpZ2h0ID0gJydcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRhdGEucGFyZW50Tm9kZSEuc3R5bGUubWF4V2lkdGggPSAnJ1xuICAgICAgICBkYXRhLnBhcmVudE5vZGUhLnN0eWxlLm1pbldpZHRoID0gJydcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRQYXJlbnQoKSB7XG4gICAgICBjb25zdCBwYXJlbnQgPSByZXNpemVSZWYudmFsdWUhLnBhcmVudE5vZGVcbiAgICAgIGRhdGEucGFyZW50Tm9kZSA9IHBhcmVudCBhcyBIVE1MRWxlbWVudFxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGNvbXB1dGVTaXplcygpIHtcbiAgICAgIGNvbnN0IHsgdG9wLCBsZWZ0LCBoZWlnaHQsIHdpZHRoLCBtYXJnaW5MZWZ0LCBtYXJnaW5Ub3AgfSA9XG4gICAgICAgIGdldENvbXB1dGVkU3R5bGUoZGF0YS5wYXJlbnROb2RlISlcblxuICAgICAgZGF0YS5vZmZzZXRUb3AgPSBkYXRhLnBhcmVudE5vZGUhLm9mZnNldFRvcFxuICAgICAgZGF0YS5vZmZzZXRMZWZ0ID0gZGF0YS5wYXJlbnROb2RlIS5vZmZzZXRMZWZ0XG4gICAgICBkYXRhLm1hcmdpbkxlZnQgPSBwYXJzZUZsb2F0KG1hcmdpbkxlZnQpXG4gICAgICBkYXRhLm1hcmdpblRvcCA9IHBhcnNlRmxvYXQobWFyZ2luVG9wKVxuICAgICAgZGF0YS5wYXJlbnRIZWlnaHQgPSBwYXJzZUZsb2F0KGhlaWdodClcbiAgICAgIGRhdGEucGFyZW50V2lkdGggPSBwYXJzZUZsb2F0KHdpZHRoKVxuICAgICAgZGF0YS50b3AgPSBwYXJzZUZsb2F0KHRvcClcbiAgICAgIGRhdGEubGVmdCA9IHBhcnNlRmxvYXQobGVmdClcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRTdGFydFBvc2l0aW9ucygpIHtcbiAgICAgIGNvbnN0IHNpZGUgPSByZXZlcnNlRGlyZWN0aW9uLnZhbHVlXG4gICAgICBjb25zdCBvZmZzZXQgPSByZXZlcnNlT2Zmc2V0S2V5LnZhbHVlXG5cbiAgICAgIGlmIChkYXRhW3NpZGVdID09PSBkYXRhW29mZnNldF0pIHtcbiAgICAgICAgZGF0YS5wYXJlbnROb2RlIS5zdHlsZVtzaWRlXSA9IGAke2RhdGFbb2Zmc2V0XX1weGBcbiAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBkaXNhYmxlU2VsZWN0aW9uKGUpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIGluaXRSZXNpemUoZSkge1xuICAgICAgaWYgKCFkYXRhLmlzQWN0aXZlKSB7XG4gICAgICAgIGRhdGEuaXNBY3RpdmUgPSB0cnVlXG4gICAgICAgIGNvbXB1dGVTaXplcygpXG4gICAgICAgIHJlc2V0TWluTWF4U3R5bGVzKClcbiAgICAgICAgc2V0U3RhcnRQb3NpdGlvbnMoKVxuICAgICAgICBzZXRTdGFydE9mZnNldChlKVxuICAgICAgfVxuXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gcmVzaXplKGUpKVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHNldFN0YXJ0T2Zmc2V0KGUpIHtcbiAgICAgIGlmIChpc05lZWRSZXZlcnNlLnZhbHVlKSBkYXRhLnN0YXJ0T2Zmc2V0ID0gZVtkaXJlY3Rpb24udmFsdWVdXG4gICAgICBlbHNlIGRhdGEuc3RhcnRPZmZzZXQgPSBlW2RpcmVjdGlvbi52YWx1ZV0gLSBjdXJyZW50U2l6ZS52YWx1ZVxuXG4gICAgICBkYXRhLnN0YXJ0T2Zmc2V0ISAtPSBvZmZzZXQudmFsdWVcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZXNldCgpIHtcbiAgICAgIGRhdGEuaXNBY3RpdmUgPSBmYWxzZVxuICAgICAgcmVzZXRNaW5NYXhTdHlsZXMoKVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIG9uTW91c2V1cCgpIHtcbiAgICAgIHJlc2V0KClcbiAgICAgIHJlbW92ZUhhbmRsZXJzKClcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBvbk1vdXNlZG93bigpIHtcbiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGluaXRSZXNpemUpXG4gICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgb25Nb3VzZXVwKVxuICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2VsZWN0c3RhcnQnLCBkaXNhYmxlU2VsZWN0aW9uKVxuICAgIH1cblxuICAgIGZ1bmN0aW9uIHJlbW92ZUhhbmRsZXJzKCkge1xuICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgaW5pdFJlc2l6ZSlcbiAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCBvbk1vdXNldXApXG4gICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdzZWxlY3RzdGFydCcsIGRpc2FibGVTZWxlY3Rpb24pXG4gICAgfVxuXG4gICAgb25Nb3VudGVkKCgpID0+IHtcbiAgICAgIHNldFBhcmVudCgpXG4gICAgfSlcblxuICAgIG9uQmVmb3JlVW5tb3VudCgoKSA9PiB7XG4gICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBvbk1vdXNlZG93bilcbiAgICB9KVxuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMudmFsdWUsXG4gICAgICAgIHN0eWxlOiBzdHlsZXMudmFsdWUsXG4gICAgICAgIGtleTogJ3Jlc2l6ZScsXG4gICAgICAgIHJlZjogcmVzaXplUmVmLFxuICAgICAgICBvbk1vdXNlZG93bixcbiAgICAgIH1cbiAgICAgIHJldHVybiBoKCdkaXYnLCBwcm9wc0RhdGEpXG4gICAgfVxuICB9LFxufSlcbiJdfQ==