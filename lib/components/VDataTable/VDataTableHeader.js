import { h, computed, withDirectives, defineComponent } from 'vue';
import { useColors } from '../../composable/use-colors';
import { useIcons } from '../../composable/use-icons';
import { VIcon } from '../VIcon';
import { VCheckbox } from '../VCheckbox';
import { VDataTableCell } from './VDataTableCell';
import { VTextField } from '../VTextField';
import { vShow } from 'vue';
import { clickOutside } from '../../directives/v-click-outside';
import { useTransition } from '../../composable/use-transition';
import { transitions } from '../../services/transitions';
export const VDataTableHeader = defineComponent({
    name: 'v-data-table-header',
    props: {
        showSequence: Boolean,
        showCheckbox: Boolean,
        cols: Array,
        colWidth: {
            type: [String, Number],
            default: 125,
        },
        align: String,
        options: Object,
    },
    emits: ['sort', 'filter', 'select-all', 'update:cols'],
    setup(props, { emit, slots }) {
        const { setBackgroundClassNameColor, setBackgroundCssColor } = useColors();
        const { icons } = useIcons();
        const _cache = {};
        const classes = computed(() => ({
            'v-data-table__header': true,
            ...(props.options.color
                ? setBackgroundClassNameColor(props.options.color)
                : {}),
        }));
        const styles = computed(() => ({
            ...(props.options.color
                ? setBackgroundCssColor(props.options.color)
                : {}),
        }));
        const computedContentColor = computed(() => {
            return props.options.dark
                ? props.options?.contentColor || 'white'
                : props.options?.contentColor;
        });
        const cols = computed(() => [...props.cols]);
        const onSort = (item) => {
            emit('sort', item);
        };
        const onInput = ($value, col) => {
            col.filtered = !!$value;
            _cache[col.title] = $value;
            console.log(_cache);
            emit('filter', { value: $value, col });
        };
        const showFilter = (item) => {
            if (item.showFilter)
                return;
            item.showFilter = true;
        };
        const genSortButton = (item) => {
            const classes = {
                'v-data-table-col__actions-sort': true,
                'v-data-table-col__actions-sort--active': item.sorted,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$arrowUp,
                onClick: () => onSort(item),
            };
            return h(VIcon, propsData);
        };
        const genFilterButton = (item) => {
            const classes = {
                'v-data-table-col__actions-filter': true,
                'v-data-table-col__actions-filter--active': item.filtered,
            };
            const propsData = {
                clickable: true,
                class: classes,
                icon: icons.$filter,
                color: !item.cellClass ? computedContentColor.value : '',
                onClick: () => showFilter(item),
            };
            return h(VIcon, propsData);
        };
        const genHeaderActions = (item) => {
            return h('span', { class: 'v-data-table-col__actions' }, [
                item.sortable && genSortButton(item),
                item.filterable && genFilterButton(item),
            ]);
        };
        const genFilterInput = (col) => {
            const propsData = {
                modelValue: _cache[col.title],
                label: 'search',
                dark: props.options.dark,
                color: !col.cellClass ? computedContentColor.value : '',
                prependIcon: icons.$search,
                clearable: true,
                onInput: ($value) => onInput($value, col),
            };
            return h(VTextField, propsData);
        };
        const genFilterWrapper = (col) => {
            const color = props.options.dark
                ? props.options?.color || 'grey darken-3'
                : props.options?.color || 'white';
            const slotName = `${col.key}-filter`;
            const filterSlot = slots[slotName] && slots[slotName]({
                filter: (event) => onInput(event, col),
            });
            const directive = col.showFilter
                ? {
                    handler: () => setTimeout(() => (col.showFilter = false)),
                    closeConditional: false,
                }
                : undefined;
            const propsData = {
                class: {
                    'v-data-table-col__filter': !filterSlot,
                    'v-data-table-col__custom-filter': !!filterSlot,
                    'elevation-5': true,
                    [col.cellClass]: !!col.cellClass,
                    ...(color ? setBackgroundClassNameColor(color) : {}),
                },
                style: {
                    ...(color ? setBackgroundCssColor(color) : {}),
                },
            };
            return (col.filterable &&
                withDirectives(h('div', propsData, filterSlot || genFilterInput(col)), [
                    [clickOutside, directive],
                    [vShow, col.showFilter],
                ]));
        };
        const genHeaderTitle = (col) => {
            return h('div', { class: 'v-data-table-col__title' }, col.title);
        };
        const genNumberCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__number': true,
                    [props.cellClass]: !!props.cellClass,
                },
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            return h(VDataTableCell, propsData, { default: () => 'â„–' });
        };
        const genCheckboxCell = () => {
            const propsData = {
                align: 'center',
                class: {
                    'v-data-table-col__checkbox': true,
                    [props.cellClass]: !!props.cellClass,
                },
                dark: props.options.dark,
                contentColor: computedContentColor.value,
                color: props.options.color,
                width: 50,
            };
            const content = {
                default: () => h(VCheckbox, {
                    color: computedContentColor.value,
                    onChecked: (e) => emit('select-all', e),
                }),
            };
            return h(VDataTableCell, propsData, content);
        };
        const genHeaderCell = (col) => {
            const propsData = {
                dark: props.options.dark,
                class: {
                    'v-data-table-col': true,
                    'v-data-table-col--sorted': col.sorted,
                    [col.cellClass]: !!col.cellClass,
                },
                contentColor: !col.cellClass ? computedContentColor.value : '',
                color: !col.cellClass ? props.options.color : '',
                width: col.width,
                resizeable: col.resizeable,
                resizerColor: props.options?.resizerColor,
                align: col.align || props.align,
                onResize: ($size) => (col.width = $size),
            };
            return h(VDataTableCell, propsData, {
                default: () => [
                    genHeaderTitle(col),
                    genHeaderActions(col),
                    useTransition(genFilterWrapper(col), transitions.FADE),
                ],
            });
        };
        const genHeaderChildren = () => {
            const children = [];
            const headerSlot = slots.header && slots.header(props);
            props.showSequence && children.push(genNumberCell());
            props.showCheckbox && children.push(genCheckboxCell());
            cols.value.forEach((col) => {
                col.width = col.width || props.colWidth;
                if (!col.hasOwnProperty('show')) {
                    col.show = !col.show;
                }
                !headerSlot[0].children &&
                    col.show &&
                    children.push(genHeaderCell(col));
            });
            headerSlot[0].children && children.push(headerSlot);
            return children;
        };
        return () => {
            const propsData = {
                class: classes.value,
                style: styles.value,
            };
            return h('div', propsData, genHeaderChildren());
        };
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVkRhdGFUYWJsZUhlYWRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9jb21wb25lbnRzL1ZEYXRhVGFibGUvVkRhdGFUYWJsZUhlYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsQ0FBQyxFQUFFLFFBQVEsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sS0FBSyxDQUFBO0FBR2xFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQTtBQUN2RCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sNEJBQTRCLENBQUE7QUFHckQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUNoQyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sY0FBYyxDQUFBO0FBQ3hDLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQUNqRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBRzFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxLQUFLLENBQUE7QUFDM0IsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGtDQUFrQyxDQUFBO0FBSy9ELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQTtBQUMvRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sNEJBQTRCLENBQUE7QUFFeEQsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQUcsZUFBZSxDQUFDO0lBQzlDLElBQUksRUFBRSxxQkFBcUI7SUFFM0IsS0FBSyxFQUFFO1FBQ0wsWUFBWSxFQUFFLE9BQU87UUFDckIsWUFBWSxFQUFFLE9BQU87UUFDckIsSUFBSSxFQUFFLEtBQUs7UUFDWCxRQUFRLEVBQUU7WUFDUixJQUFJLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxHQUFHO1NBQ2I7UUFDRCxLQUFLLEVBQUUsTUFBTTtRQUNiLE9BQU8s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IjpbIi8vIFZ1ZSBBUElcbmltcG9ydCB7IGgsIGNvbXB1dGVkLCB3aXRoRGlyZWN0aXZlcywgZGVmaW5lQ29tcG9uZW50IH0gZnJvbSAndnVlJ1xuXG4vLyBFZmZlY3RzXG5pbXBvcnQgeyB1c2VDb2xvcnMgfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlL3VzZS1jb2xvcnMnXG5pbXBvcnQgeyB1c2VJY29ucyB9IGZyb20gJy4uLy4uL2NvbXBvc2FibGUvdXNlLWljb25zJ1xuXG4vLyBDb21wb25lbnRzXG5pbXBvcnQgeyBWSWNvbiB9IGZyb20gJy4uL1ZJY29uJ1xuaW1wb3J0IHsgVkNoZWNrYm94IH0gZnJvbSAnLi4vVkNoZWNrYm94J1xuaW1wb3J0IHsgVkRhdGFUYWJsZUNlbGwgfSBmcm9tICcuL1ZEYXRhVGFibGVDZWxsJ1xuaW1wb3J0IHsgVlRleHRGaWVsZCB9IGZyb20gJy4uL1ZUZXh0RmllbGQnXG5cbi8vIERpcmVjdGl2ZXNcbmltcG9ydCB7IHZTaG93IH0gZnJvbSAndnVlJ1xuaW1wb3J0IHsgY2xpY2tPdXRzaWRlIH0gZnJvbSAnLi4vLi4vZGlyZWN0aXZlcy92LWNsaWNrLW91dHNpZGUnXG5cbi8vIFR5cGVzXG5pbXBvcnQgeyBWTm9kZSB9IGZyb20gJ3Z1ZSdcbmltcG9ydCB7IERhdGFDb2x1bW4gfSBmcm9tICcuLi8uLi8uLi90eXBlcydcbmltcG9ydCB7IHVzZVRyYW5zaXRpb24gfSBmcm9tICcuLi8uLi9jb21wb3NhYmxlL3VzZS10cmFuc2l0aW9uJ1xuaW1wb3J0IHsgdHJhbnNpdGlvbnMgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy90cmFuc2l0aW9ucydcblxuZXhwb3J0IGNvbnN0IFZEYXRhVGFibGVIZWFkZXIgPSBkZWZpbmVDb21wb25lbnQoe1xuICBuYW1lOiAndi1kYXRhLXRhYmxlLWhlYWRlcicsXG5cbiAgcHJvcHM6IHtcbiAgICBzaG93U2VxdWVuY2U6IEJvb2xlYW4sXG4gICAgc2hvd0NoZWNrYm94OiBCb29sZWFuLFxuICAgIGNvbHM6IEFycmF5LFxuICAgIGNvbFdpZHRoOiB7XG4gICAgICB0eXBlOiBbU3RyaW5nLCBOdW1iZXJdLFxuICAgICAgZGVmYXVsdDogMTI1LFxuICAgIH0sXG4gICAgYWxpZ246IFN0cmluZyxcbiAgICBvcHRpb25zOiBPYmplY3QsXG4gIH0gYXMgYW55LFxuXG4gIGVtaXRzOiBbJ3NvcnQnLCAnZmlsdGVyJywgJ3NlbGVjdC1hbGwnLCAndXBkYXRlOmNvbHMnXSxcblxuICBzZXR1cChwcm9wcywgeyBlbWl0LCBzbG90cyB9KSB7XG4gICAgY29uc3QgeyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IsIHNldEJhY2tncm91bmRDc3NDb2xvciB9ID0gdXNlQ29sb3JzKClcbiAgICBjb25zdCB7IGljb25zIH0gPSB1c2VJY29ucygpXG4gICAgY29uc3QgX2NhY2hlID0ge31cblxuICAgIGNvbnN0IGNsYXNzZXMgPSBjb21wdXRlZDxSZWNvcmQ8c3RyaW5nLCBib29sZWFuPj4oKCkgPT4gKHtcbiAgICAgICd2LWRhdGEtdGFibGVfX2hlYWRlcic6IHRydWUsXG4gICAgICAuLi4ocHJvcHMub3B0aW9ucy5jb2xvclxuICAgICAgICA/IHNldEJhY2tncm91bmRDbGFzc05hbWVDb2xvcihwcm9wcy5vcHRpb25zLmNvbG9yKVxuICAgICAgICA6IHt9KSxcbiAgICB9KSlcblxuICAgIGNvbnN0IHN0eWxlcyA9IGNvbXB1dGVkKCgpID0+ICh7XG4gICAgICAuLi4ocHJvcHMub3B0aW9ucy5jb2xvclxuICAgICAgICA/IHNldEJhY2tncm91bmRDc3NDb2xvcihwcm9wcy5vcHRpb25zLmNvbG9yKVxuICAgICAgICA6IHt9KSxcbiAgICB9KSlcblxuICAgIGNvbnN0IGNvbXB1dGVkQ29udGVudENvbG9yID0gY29tcHV0ZWQ8c3RyaW5nPigoKSA9PiB7XG4gICAgICByZXR1cm4gcHJvcHMub3B0aW9ucy5kYXJrXG4gICAgICAgID8gcHJvcHMub3B0aW9ucz8uY29udGVudENvbG9yIHx8ICd3aGl0ZSdcbiAgICAgICAgOiBwcm9wcy5vcHRpb25zPy5jb250ZW50Q29sb3JcbiAgICB9KVxuXG4gICAgY29uc3QgY29scyA9IGNvbXB1dGVkPERhdGFDb2x1bW5bXT4oKCkgPT4gWy4uLnByb3BzLmNvbHNdKVxuXG4gICAgY29uc3Qgb25Tb3J0ID0gKGl0ZW0pID0+IHtcbiAgICAgIGVtaXQoJ3NvcnQnLCBpdGVtKVxuICAgIH1cblxuICAgIGNvbnN0IG9uSW5wdXQgPSAoJHZhbHVlLCBjb2wpID0+IHtcbiAgICAgIGNvbC5maWx0ZXJlZCA9ICEhJHZhbHVlXG4gICAgICBfY2FjaGVbY29sLnRpdGxlXSA9ICR2YWx1ZVxuICAgICAgY29uc29sZS5sb2coX2NhY2hlKVxuICAgICAgZW1pdCgnZmlsdGVyJywgeyB2YWx1ZTogJHZhbHVlLCBjb2wgfSlcbiAgICB9XG5cbiAgICBjb25zdCBzaG93RmlsdGVyID0gKGl0ZW0pID0+IHtcbiAgICAgIGlmIChpdGVtLnNob3dGaWx0ZXIpIHJldHVyblxuICAgICAgaXRlbS5zaG93RmlsdGVyID0gdHJ1ZVxuICAgIH1cblxuICAgIGNvbnN0IGdlblNvcnRCdXR0b24gPSAoaXRlbSkgPT4ge1xuICAgICAgY29uc3QgY2xhc3NlcyA9IHtcbiAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2FjdGlvbnMtc29ydCc6IHRydWUsXG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLXNvcnQtLWFjdGl2ZSc6IGl0ZW0uc29ydGVkLFxuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGNsaWNrYWJsZTogdHJ1ZSxcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMsXG4gICAgICAgIGljb246IGljb25zLiRhcnJvd1VwLFxuICAgICAgICBvbkNsaWNrOiAoKSA9PiBvblNvcnQoaXRlbSksXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZJY29uLCBwcm9wc0RhdGEpXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuRmlsdGVyQnV0dG9uID0gKGl0ZW0pID0+IHtcbiAgICAgIGNvbnN0IGNsYXNzZXMgPSB7XG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLWZpbHRlcic6IHRydWUsXG4gICAgICAgICd2LWRhdGEtdGFibGUtY29sX19hY3Rpb25zLWZpbHRlci0tYWN0aXZlJzogaXRlbS5maWx0ZXJlZCxcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBjbGlja2FibGU6IHRydWUsXG4gICAgICAgIGNsYXNzOiBjbGFzc2VzLFxuICAgICAgICBpY29uOiBpY29ucy4kZmlsdGVyLFxuICAgICAgICBjb2xvcjogIWl0ZW0uY2VsbENsYXNzID8gY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUgOiAnJyxcbiAgICAgICAgb25DbGljazogKCkgPT4gc2hvd0ZpbHRlcihpdGVtKSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkljb24sIHByb3BzRGF0YSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJBY3Rpb25zID0gKGl0ZW0pID0+IHtcbiAgICAgIHJldHVybiBoKCdzcGFuJywgeyBjbGFzczogJ3YtZGF0YS10YWJsZS1jb2xfX2FjdGlvbnMnIH0sIFtcbiAgICAgICAgaXRlbS5zb3J0YWJsZSAmJiBnZW5Tb3J0QnV0dG9uKGl0ZW0pLFxuICAgICAgICBpdGVtLmZpbHRlcmFibGUgJiYgZ2VuRmlsdGVyQnV0dG9uKGl0ZW0pLFxuICAgICAgXSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5GaWx0ZXJJbnB1dCA9IChjb2wpID0+IHtcbiAgICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIG1vZGVsVmFsdWU6IF9jYWNoZVtjb2wudGl0bGVdLFxuICAgICAgICBsYWJlbDogJ3NlYXJjaCcsXG4gICAgICAgIGRhcms6IHByb3BzLm9wdGlvbnMuZGFyayxcbiAgICAgICAgY29sb3I6ICFjb2wuY2VsbENsYXNzID8gY29tcHV0ZWRDb250ZW50Q29sb3IudmFsdWUgOiAnJyxcbiAgICAgICAgcHJlcGVuZEljb246IGljb25zLiRzZWFyY2gsXG4gICAgICAgIGNsZWFyYWJsZTogdHJ1ZSxcbiAgICAgICAgb25JbnB1dDogKCR2YWx1ZSkgPT4gb25JbnB1dCgkdmFsdWUsIGNvbCksXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKFZUZXh0RmllbGQsIHByb3BzRGF0YSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5GaWx0ZXJXcmFwcGVyID0gKGNvbCkgPT4ge1xuICAgICAgY29uc3QgY29sb3IgPSBwcm9wcy5vcHRpb25zLmRhcmtcbiAgICAgICAgPyBwcm9wcy5vcHRpb25zPy5jb2xvciB8fCAnZ3JleSBkYXJrZW4tMydcbiAgICAgICAgOiBwcm9wcy5vcHRpb25zPy5jb2xvciB8fCAnd2hpdGUnXG5cbiAgICAgIGNvbnN0IHNsb3ROYW1lID0gYCR7IGNvbC5rZXkgfS1maWx0ZXJgXG5cbiAgICAgIGNvbnN0IGZpbHRlclNsb3QgPSBzbG90c1tzbG90TmFtZV0gJiYgc2xvdHNbc2xvdE5hbWVdISh7XG4gICAgICAgIGZpbHRlcjogKGV2ZW50KSA9PiBvbklucHV0KGV2ZW50LCBjb2wpLFxuICAgICAgfSlcblxuICAgICAgY29uc3QgZGlyZWN0aXZlID0gY29sLnNob3dGaWx0ZXJcbiAgICAgICAgPyB7XG4gICAgICAgICAgaGFuZGxlcjogKCkgPT4gc2V0VGltZW91dCgoKSA9PiAoY29sLnNob3dGaWx0ZXIgPSBmYWxzZSkpLFxuICAgICAgICAgIGNsb3NlQ29uZGl0aW9uYWw6IGZhbHNlLFxuICAgICAgICB9XG4gICAgICAgIDogdW5kZWZpbmVkXG5cbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbF9fZmlsdGVyJzogIWZpbHRlclNsb3QsXG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2N1c3RvbS1maWx0ZXInOiAhIWZpbHRlclNsb3QsXG4gICAgICAgICAgJ2VsZXZhdGlvbi01JzogdHJ1ZSxcbiAgICAgICAgICBbY29sLmNlbGxDbGFzc106ICEhY29sLmNlbGxDbGFzcyxcbiAgICAgICAgICAuLi4oY29sb3IgPyBzZXRCYWNrZ3JvdW5kQ2xhc3NOYW1lQ29sb3IoY29sb3IpIDoge30pLFxuICAgICAgICB9LFxuICAgICAgICBzdHlsZToge1xuICAgICAgICAgIC4uLihjb2xvciA/IHNldEJhY2tncm91bmRDc3NDb2xvcihjb2xvcikgOiB7fSksXG4gICAgICAgIH0sXG4gICAgICB9XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIGNvbC5maWx0ZXJhYmxlICYmXG4gICAgICAgIHdpdGhEaXJlY3RpdmVzKGgoJ2RpdicsIHByb3BzRGF0YSwgZmlsdGVyU2xvdCB8fCBnZW5GaWx0ZXJJbnB1dChjb2wpKSwgW1xuICAgICAgICAgIFtjbGlja091dHNpZGUsIGRpcmVjdGl2ZV0sXG4gICAgICAgICAgW3ZTaG93LCBjb2wuc2hvd0ZpbHRlcl0sXG4gICAgICAgIF0pXG4gICAgICApXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuSGVhZGVyVGl0bGUgPSAoY29sKTogVk5vZGUgPT4ge1xuICAgICAgcmV0dXJuIGgoJ2RpdicsIHsgY2xhc3M6ICd2LWRhdGEtdGFibGUtY29sX190aXRsZScgfSwgY29sLnRpdGxlKVxuICAgIH1cblxuICAgIGNvbnN0IGdlbk51bWJlckNlbGwgPSAoKTogVk5vZGUgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBhbGlnbjogJ2NlbnRlcicsXG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX251bWJlcic6IHRydWUsXG4gICAgICAgICAgW3Byb3BzLmNlbGxDbGFzc106ICEhcHJvcHMuY2VsbENsYXNzLFxuICAgICAgICB9LFxuICAgICAgICBjb250ZW50Q29sb3I6IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlLFxuICAgICAgICBjb2xvcjogcHJvcHMub3B0aW9ucy5jb2xvcixcbiAgICAgICAgd2lkdGg6IDUwLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWRGF0YVRhYmxlQ2VsbCwgcHJvcHNEYXRhLCB7IGRlZmF1bHQ6ICgpID0+ICfihJYnIH0pXG4gICAgfVxuXG4gICAgY29uc3QgZ2VuQ2hlY2tib3hDZWxsID0gKCkgPT4ge1xuICAgICAgY29uc3QgcHJvcHNEYXRhID0ge1xuICAgICAgICBhbGlnbjogJ2NlbnRlcicsXG4gICAgICAgIGNsYXNzOiB7XG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2xfX2NoZWNrYm94JzogdHJ1ZSxcbiAgICAgICAgICBbcHJvcHMuY2VsbENsYXNzXTogISFwcm9wcy5jZWxsQ2xhc3MsXG4gICAgICAgIH0sXG4gICAgICAgIGRhcms6IHByb3BzLm9wdGlvbnMuZGFyayxcbiAgICAgICAgY29udGVudENvbG9yOiBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSxcbiAgICAgICAgY29sb3I6IHByb3BzLm9wdGlvbnMuY29sb3IsXG4gICAgICAgIHdpZHRoOiA1MCxcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29udGVudCA9IHtcbiAgICAgICAgZGVmYXVsdDogKCkgPT5cbiAgICAgICAgICBoKFZDaGVja2JveCwge1xuICAgICAgICAgICAgY29sb3I6IGNvbXB1dGVkQ29udGVudENvbG9yLnZhbHVlLFxuICAgICAgICAgICAgb25DaGVja2VkOiAoZSkgPT4gZW1pdCgnc2VsZWN0LWFsbCcsIGUpLFxuICAgICAgICAgIH0pLFxuICAgICAgfVxuXG4gICAgICByZXR1cm4gaChWRGF0YVRhYmxlQ2VsbCwgcHJvcHNEYXRhLCBjb250ZW50KVxuICAgIH1cblxuICAgIGNvbnN0IGdlbkhlYWRlckNlbGwgPSAoY29sKSA9PiB7XG4gICAgICBjb25zdCBwcm9wc0RhdGEgPSB7XG4gICAgICAgIGRhcms6IHByb3BzLm9wdGlvbnMuZGFyayxcbiAgICAgICAgY2xhc3M6IHtcbiAgICAgICAgICAndi1kYXRhLXRhYmxlLWNvbCc6IHRydWUsXG4gICAgICAgICAgJ3YtZGF0YS10YWJsZS1jb2wtLXNvcnRlZCc6IGNvbC5zb3J0ZWQsXG4gICAgICAgICAgW2NvbC5jZWxsQ2xhc3NdOiAhIWNvbC5jZWxsQ2xhc3MsXG4gICAgICAgIH0sXG4gICAgICAgIGNvbnRlbnRDb2xvcjogIWNvbC5jZWxsQ2xhc3MgPyBjb21wdXRlZENvbnRlbnRDb2xvci52YWx1ZSA6ICcnLFxuICAgICAgICBjb2xvcjogIWNvbC5jZWxsQ2xhc3MgPyBwcm9wcy5vcHRpb25zLmNvbG9yIDogJycsXG4gICAgICAgIHdpZHRoOiBjb2wud2lkdGgsXG4gICAgICAgIHJlc2l6ZWFibGU6IGNvbC5yZXNpemVhYmxlLFxuICAgICAgICByZXNpemVyQ29sb3I6IHByb3BzLm9wdGlvbnM/LnJlc2l6ZXJDb2xvcixcbiAgICAgICAgYWxpZ246IGNvbC5hbGlnbiB8fCBwcm9wcy5hbGlnbixcbiAgICAgICAgb25SZXNpemU6ICgkc2l6ZSkgPT4gKGNvbC53aWR0aCA9ICRzaXplKSxcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGgoVkRhdGFUYWJsZUNlbGwsIHByb3BzRGF0YSwge1xuICAgICAgICBkZWZhdWx0OiAoKSA9PiBbXG4gICAgICAgICAgZ2VuSGVhZGVyVGl0bGUoY29sKSxcbiAgICAgICAgICBnZW5IZWFkZXJBY3Rpb25zKGNvbCksXG4gICAgICAgICAgdXNlVHJhbnNpdGlvbihnZW5GaWx0ZXJXcmFwcGVyKGNvbCksIHRyYW5zaXRpb25zLkZBREUpLFxuICAgICAgICBdLFxuICAgICAgfSlcbiAgICB9XG5cbiAgICBjb25zdCBnZW5IZWFkZXJDaGlsZHJlbiA9ICgpID0+IHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuOiBWTm9kZVtdID0gW11cbiAgICAgIGNvbnN0IGhlYWRlclNsb3QgPSBzbG90cy5oZWFkZXIgJiYgc2xvdHMuaGVhZGVyKHByb3BzKVxuXG4gICAgICBwcm9wcy5zaG93U2VxdWVuY2UgJiYgY2hpbGRyZW4ucHVzaChnZW5OdW1iZXJDZWxsKCkpXG4gICAgICBwcm9wcy5zaG93Q2hlY2tib3ggJiYgY2hpbGRyZW4ucHVzaChnZW5DaGVja2JveENlbGwoKSlcblxuICAgICAgY29scy52YWx1ZSEuZm9yRWFjaCgoY29sOiBEYXRhQ29sdW1uKSA9PiB7XG4gICAgICAgIGNvbC53aWR0aCA9IGNvbC53aWR0aCB8fCBwcm9wcy5jb2xXaWR0aFxuXG4gICAgICAgIGlmICghY29sLmhhc093blByb3BlcnR5KCdzaG93JykpIHtcbiAgICAgICAgICBjb2wuc2hvdyA9ICFjb2wuc2hvd1xuICAgICAgICB9XG5cbiAgICAgICAgIWhlYWRlclNsb3QhWzBdLmNoaWxkcmVuICYmXG4gICAgICAgIGNvbC5zaG93ICYmXG4gICAgICAgIGNoaWxkcmVuLnB1c2goZ2VuSGVhZGVyQ2VsbChjb2wpKVxuICAgICAgfSlcblxuICAgICAgaGVhZGVyU2xvdCFbMF0uY2hpbGRyZW4gJiYgY2hpbGRyZW4ucHVzaChoZWFkZXJTbG90IGFzIGFueSlcblxuICAgICAgcmV0dXJuIGNoaWxkcmVuXG4gICAgfVxuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IHByb3BzRGF0YSA9IHtcbiAgICAgICAgY2xhc3M6IGNsYXNzZXMudmFsdWUsXG4gICAgICAgIHN0eWxlOiBzdHlsZXMudmFsdWUsXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBoKCdkaXYnLCBwcm9wc0RhdGEsIGdlbkhlYWRlckNoaWxkcmVuKCkpXG4gICAgfVxuICB9LFxufSlcbiJdfQ==